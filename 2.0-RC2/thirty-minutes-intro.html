<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Qi4j in 30 minutes</title><link rel="stylesheet" href="css/style.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /><link rel="home" href="index.html" title="" /><link rel="up" href="tutorials.html" title="Tutorials" /><link rel="prev" href="ten-minutes-intro.html" title="Qi4j in 10 minutes" /><link rel="next" href="two-hours-intro.html" title="Qi4j in 2 hours" />


<!-- favicon -->

<link rel="shortcut icon" href="http://qi4j.org/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="http://qi4j.org/favicon.ico" type="image/x-icon" />

<!-- style -->

<link href="css/shCore.css" rel="stylesheet" type="text/css" />
<link href="css/shCoreEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/shThemeEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/qi4j.css" rel="stylesheet" type="text/css" />

<!-- Syntax Highlighter -->

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushScala.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushGroovy.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushRuby.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>

<script type="text/javascript">
  SyntaxHighlighter.defaults['tab-size'] = 4;
  SyntaxHighlighter.defaults['gutter'] = false;
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

<!-- JQuery -->

<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>

<!-- Image Scaler -->

<script type="text/javascript" src="js/imagescaler.js"></script>

<!-- Table Styler -->

<script type="text/javascript" src="js/tablestyler.js"></script>

<!-- Qi4j WebSite Progressive Enhancement -->

<link href="css/progressive-enhancement.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.scrollTo-1.4.2.js"></script>
<script type="text/javascript" src="js/progressive-enhancement.js"></script>

<!-- Analytics -->
 <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3118496-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
 </script>

  </head><body><div xmlns="" xmlns:exsl="http://exslt.org/common" class="logo"><a href="index.html"><img src="images/logo-standard.png" /></a></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="top-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="index.html#home">Qi4j</a></span></dt><dt><span class="section"><a href="intro.html">Introduction</a></span></dt><dt><span class="section"><span xmlns="" href="tutorials.html">Tutorials</span></span></dt><dt><span class="section"><a href="javadocs.html">Javadoc</a></span></dt><dt><span class="section"><a href="samples.html">Samples</a></span></dt><dt><span class="section"><a href="core.html">Core</a></span></dt><dt><span class="section"><a href="libraries.html">Libraries</a></span></dt><dt><span class="section"><a href="extensions.html">Extensions</a></span></dt><dt><span class="section"><a href="tools.html">Tools</a></span></dt><dt><span class="section"><a href="glossary.html">Glossary </a></span></dt></dl></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="sub-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="tutorials.html#_overview">Overview</a></span></dt><dt><span class="section"><a href="two-minutes-intro.html">Qi4j in 2 minutes</a></span></dt><dt><span class="section"><a href="ten-minutes-intro.html">Qi4j in 10 minutes</a></span></dt><dt><span class="section"><span xmlns="" href="thirty-minutes-intro.html">Qi4j in 30 minutes</span></span></dt><dt><span class="section"><a href="two-hours-intro.html">Qi4j in 2 hours</a></span></dt><dt><span class="section"><a href="howto-depend-on-qi4j.html">Depend on Qi4j in your build</a></span></dt><dt><span class="section"><a href="howto-assemble-application.html">Assemble an Application</a></span></dt><dt><span class="section"><a href="tut-composites.html">Transient Composites Tutorial</a></span></dt><dt><span class="section"><a href="tut-services.html">Services Composites Tutorial</a></span></dt><dt><span class="section"><a href="howto-contextual-fragments.html">Use contextual fragments</a></span></dt><dt><span class="section"><a href="howto-leverage-properties.html">Leverage Properties</a></span></dt><dt><span class="section"><a href="howto-create-constraint.html">Create a Constraint</a></span></dt><dt><span class="section"><a href="howto-create-concern.html">Create a Concern</a></span></dt><dt><span class="section"><a href="howto-create-sideeffect.html">Create a SideEffect</a></span></dt><dt><span class="section"><a href="howto-create-entity.html">Create an Entity</a></span></dt><dt><span class="section"><a href="howto-configure-service.html">Configure a Service</a></span></dt><dt><span class="section"><a href="howto-use-io.html">Use I/O API</a></span></dt><dt><span class="section"><a href="build-system.html">Build System</a></span></dt><dt><span class="section"><a href="community-docs.html">Writing Qi4j Documentation</a></span></dt></dl></div></div><div class="section" title="Qi4j in 30 minutes"><div class="titlepage"><div><div><h3 class="title"><a id="thirty-minutes-intro"></a>Qi4j in 30 minutes</h3></div></div></div><div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the
<a class="ulink" href="http://qi4j.org/downloads.html" target="_top">Qi4j SDK sources</a>. You should start your favorite editor and find the code related to
this tutorial, run it and play with it.</p></div><p>This introduction will deepen your understanding of Qi4j, as we touches on a couple of the common features of Qi4j. It
is expected that you have gone through and understood the "Qi4j in 10 minutes" introduction.</p><p>If you want to reproduce what’s explained in this tutorial, remember to depend on the Core Runtime artifact that depends
on Core API, Core SPI, Core Bootstrap and Core Functional &amp; I/O APIs:</p><div class="table"><a id="idp3720176"></a><p class="title"><b>Table 3. Artifact</b></p><div class="table-contents"><table summary="Artifact" border="1"><colgroup><col /><col /><col /></colgroup><thead><tr><th align="left" valign="top">Group ID</th><th align="left" valign="top">Artifact ID</th><th align="left" valign="top">Version</th></tr></thead><tbody><tr><td align="left" valign="top"><p>org.qi4j.core</p></td><td align="left" valign="top"><p>org.qi4j.core.runtime</p></td><td align="left" valign="top"><p>2.0-RC2</p></td></tr></tbody></table></div></div><br class="table-break" /><p>Moreover, you’ll need an EntityStore for persistence and an Indexing engine for querying. Choose among the available
implementations listed in the <a class="xref" href="extensions.html" title="Extensions">Extensions</a> section.</p><p>See the <a class="xref" href="howto-depend-on-qi4j.html" title="Depend on Qi4j in your build">Depend on Qi4j in your build</a> tutorial for details.</p><p>We will go back to the OrderEntity example;</p><pre class="programlisting brush: java">@Concerns( { PurchaseLimitConcern.class, InventoryConcern.class } )
public interface OrderEntity
    extends Order, Confirmable,
            HasSequenceNumber, HasCustomer, HasLineItems,
            EntityComposite
{
}
</pre><p>Let’s say that this is an existing Composite, perhaps found in a library or used in a previous object, but we want to
add that it tracks all the changes to the order and the confirmation of such order.</p><p>First we need to create (or also find in a library) the mechanics of the audit trail. It could be something like this;</p><pre class="programlisting brush: java">public interface HasAuditTrail&lt;M&gt;
{
    AuditTrail&lt;M&gt; auditTrail();
}

public interface AuditTrail&lt;M&gt; extends Property&lt;List&lt;Action&lt;M&gt;&gt;&gt;
{}

public interface Action&lt;T&gt; extends ValueComposite          // [2][3]
{
    enum Type { added, removed, completed };

    @Optional Property&lt;T&gt; item();                          // [1]

    Property&lt;Type&gt; action();                               // [1]
}

public interface Trailable&lt;M&gt;
{
    void itemAdded( M item );
    void itemRemoved( M item );
    void completed();
}

public class TrailableMixin&lt;M&gt;
        implements Trailable&lt;M&gt;
{
    private @This HasAuditTrail&lt;M&gt; hasTrail;

    @Override
    public void itemAdded( M item )
    {
        addAction( item, Action.Type.added );
    }

    @Override
    public void itemRemoved( M item )
    {
        addAction( item, Action.Type.removed );
    }

    @Override
    public void completed()
    {
        addAction( null, Action.Type.completed );
    }

    private Action&lt;M&gt; addAction( M item, Action.Type type )
    {
        ValueBuilder&lt;Action&gt; builder =
                module.newValueBuilder(Action.class);       // [4]
        Action&lt;M&gt; prototype = builder.prototypeFor( Action.class );
        prototype.item().set( item );
        prototype.action().set( type );
        Action instance = builder.newInstance();
        hasTrail.auditTrail().get().add( instance );
        return instance;
    }
}
</pre><p>Quite a lot of Qi4j features are leveraged above;
[1] Property is a first class citizen in Qi4j, instead of getters/setters naming convention to declare properties.
[2] ValueComposite for Action means that it is among other things Immutable.
[3] The Action extends a Property. We call that Property subtyping and highly recommended.
[4] The CompositeBuilder creates Immutable Action instances.</p><p>We also need a Concern to hang into the methods of the Order interface.</p><pre class="programlisting brush: java">public abstract class OrderAuditTrailConcern
        extends ConcernOf&lt;Order&gt;
        implements Order
{
    @This Trailable&lt;LineItem&gt; trail;

    @Override
    public void addLineItem( LineItem item )
    {
        next.addLineItem( item );
        trail.itemAdded( item );
    }

    @Override
    public void removeLineItem( LineItem item )
    {
        next.removeLineItem( item );
        trail.itemRemoved( item );
    }

    @Override
    public void completed()
    {
        next.completed();
        trail.completed();
    }
}
</pre><p>In this case, we have chosen to make an Order specific Concern for the more generic AuditTrail subsystem, and would
belong in the client (Order) code and not with the library (AuditTrail).
Pay attention to the @This annotation for a type that is not present in the Composite type interface. This is called a
private Mixin, meaning the Mixin is only reachable from Fragments within the same Composite instance.</p><p>But the AuditTrail subsystem could provide a Generic Concern, that operates on a naming pattern (for instance). In this
case, we would move the coding of the concern from the application developer to the library developer, again increasing
the re-use value. It could look like this;</p><pre class="programlisting brush: java">public class AuditTrailConcern
        extends ConcernOf&lt;InvocationHandler&gt;
        implements InvocationHandler
{
    @This Trailable trail;

    @Override
    public Object invoke( Object proxy, Method m, Object[] args )
            throws Throwable
    {
        Object retValue = next.invoke(proxy, m, args);
        String methodName = m.getName();
        if( methodName.startsWith( "add" ) )
        {
            trail.itemAdded( args[0] );
        }
        else if( methodName.startsWith( "remove" ) )
        {
            trail.itemRemoved( args[0] );
        }
        else if( methodName.startsWith( "complete" ) ||
                methodName.startsWith( "commit" ) )
        {
            trail.completed();
        }

        return retValue;
    }
}
</pre><p>The above construct is called a Generic Concern, since it implements java.lang.reflect.InvocationHandler instead of the
interface of the domain model. The ConcernOf baseclass will also need to be of InvocationHandler type, and the
Qi4j Runtime will handle the chaining between domain model style and this generic style of interceptor call chain.</p><p>Finally, we need to declare the Concern in the OrderEntity;</p><pre class="programlisting brush: java">@Concerns({
        AuditTrailConcern.class,
        PurchaseLimitConcern.class,
        InventoryConcern.class
})

@Mixins( TrailableMixin.class )
public interface OrderEntity
        extends Order, Confirmable,
        HasSequenceNumber, HasCustomer, HasLineItems,
        EntityComposite
{
}
</pre><p>We also place it first, so that the AuditTrailConcern will be the first Concern in the interceptor chain
(a.k.a InvocationStack), so that in case any of the other Concerns throws an Exception, the AuditTrail is not updated
(In fact, the AuditTrail should perhaps be a SideEffect rather than a Concern. It is largely depending on how we define
SideEffect, since the side effect in this case is within the composite instance it is a border case.).</p><p>So let’s move on to something more complicated. As we have mentioned, EntityComposite is automatically persisted to an
underlying store (provided the Runtime is setup with one at bootstrap initialization), but how do I locate an Order?</p><p>Glad you asked. It is done via the Query API. It is important to understand that Indexing and Query are separated from
the persistence concern of storage and retrieval. This enables many performance optimization opportunities as well as a
more flexible Indexing strategy. The other thing to understand is that the Query API is using the domain model, in Java,
and not some String based query language. We have made this choice to ensure refactoring safety. In rare cases, the
Query API is not capable enough, in which case Qi4j still provides the ability to look up and execute native queries.</p><p>Let’s say that we want to find a particular Order from its SequenceNumber.</p><pre class="programlisting brush: java">import static org.qi4j.api.query.QueryExpressions.eq;
import static org.qi4j.api.query.QueryExpressions.gt;
import static org.qi4j.api.query.QueryExpressions.templateFor;

import org.qi4j.api.query.QueryBuilder;

  [...snip...]

    @Structure private UnitOfWorkFactory uowFactory; //Injected
      [...snip...]

        UnitOfWork uow = uowFactory.currentUnitOfWork();
        QueryBuilder&lt;Order&gt; builder = module.newQueryBuilder( Order.class );

        String orderNumber = "12345";
        HasSequenceNumber template = templateFor( HasSequenceNumber.class );
        builder.where( eq( template.number(), orderNumber ) );
        Query&lt;Order&gt; query = uow.newQuery( builder);

        Iterator&lt;Order&gt; result = query.iterator();

        if( result.hasNext() )
        {
            Order order = result.next();
        }
        else
        {
            // Deal with it wasn't found.
        }
</pre><p>The important bits are;</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
The QueryExpressions.templateFor() method is used to define the template used in the query upon execution. In
      this case, we choose to template only the HasSequenceNumber, an interface used in OrderEntity, but is not part of
      Order (may or may not be a good design choice).
</li><li class="listitem">
The where() clause, which has a statically imported method eq(), which builds up the expression logic, and will
      be translated into the underlying query language upon execution, which happens in the iterator() method.
</li></ul></div><p>Another example,</p><pre class="programlisting brush: java">QueryBuilder&lt;Order&gt; builder = module.newQueryBuilder( Order.class );

Calendar cal = Calendar.getInstance();
cal.setTime( new Date() );
cal.roll( Calendar.DAY_OF_MONTH, -90 );
Date last90days = cal.getTime();
Order template = templateFor( Order.class );
builder.where( gt( template.createdDate(), last90days ) );
Query&lt;Order&gt; query = uow.newQuery(builder);

for( Order order : query )
{
    report.addOrderToReport( order );
}
</pre><p>In the above case, we find the Orders that has been created in the last 90 days, and add them to a report to be
generated. This example assumes that the Order type has a Property&lt;Date&gt; createdDate() method.</p><p>Now, Orders has a relation to the CustomerComposite which is also an Entity. Let’s create a query for all customers
that has made an Order in the last 30 days;</p><pre class="programlisting brush: java">QueryBuilder&lt;HasCustomer&gt; builder = module.newQueryBuilder( HasCustomer.class );

Calendar cal = Calendar.getInstance();
cal.setTime( new Date() );
cal.roll( Calendar.MONTH, -1 );
Date lastMonth = cal.getTime();
Order template1 = templateFor( Order.class );
builder.where( gt( template1.createdDate(), lastMonth ) );
Query&lt;HasCustomer&gt; query = uow.newQuery(builder);

for( HasCustomer hasCustomer : query )
{
    report.addCustomerToReport( hasCustomer.name().get() );
}
</pre><p>This covers the most basic Query capabilities and how to use it. For Querying to work, an Indexing subsystem must be
assembled during bootstrap. At the time of this writing, only an RDF indexing subsystem exist, and is added most easily
by assembly.addAssembler( new RdfNativeSesameStoreAssembler() ).</p><p>It can be a bit confusing to see Qi4j use Java itself as a Query language, but since we have practically killed the
classes and only operate with interfaces, it is possible to do a lot of seemingly magic stuff. Just keep in mind that
it is pure Java, albeit heavy use of dynamic proxies to capture the intent of the query.</p><div class="section" title="Conclusion"><div class="titlepage"><div><div><h4 class="title"><a id="_conclusion_2"></a>Conclusion</h4></div></div></div><p>We have now explored a couple more intricate features of Qi4j, hopefully without being overwhelmed with details on how
to create applications from scratch, how to structure applications, and how the entire Qi4j Extension system works.
We have looked at how to add a Concern that uses a private Mixin, we have touched a bit on Generic Concerns, and
finally a short introduction to the Query API.</p></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="footer">(c) 2012 The Qi4j Community</div></body></html>

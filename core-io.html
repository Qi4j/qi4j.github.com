<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Core I/O API</title><link rel="stylesheet" type="text/css" href="css/style.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><link rel="home" href="index.html" title="" /><link rel="up" href="_core.html" title="Core" /><link rel="prev" href="core-functional.html" title="Core Functional API" /><link rel="next" href="core-testsupport.html" title="Core Test Support" />


<!-- favicon -->

<link rel="shortcut icon" href="http://qi4j.org/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="http://qi4j.org/favicon.ico" type="image/x-icon" />

<!-- style -->

<link href="css/shCore.css" rel="stylesheet" type="text/css" />
<link href="css/shCoreEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/shThemeEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/qi4j.css" rel="stylesheet" type="text/css" />

<!-- Syntax Highlighter -->

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushScala.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushGroovy.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushRuby.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>

<script type="text/javascript">
  SyntaxHighlighter.defaults['tab-size'] = 4;
  SyntaxHighlighter.defaults['gutter'] = false;
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

<!-- JQuery -->

<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>

<!-- Image Scaler -->

<script type="text/javascript" src="js/imagescaler.js"></script>

<!-- Table Styler -->

<script type="text/javascript" src="js/tablestyler.js"></script>

<!-- Version Switcher -->

<script type="text/javascript" src="js/versionswitcher.js"></script>

<!-- Qi4j WebSite Progressive Enhancement -->

<link href="css/progressive-enhancement.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.scrollTo-1.4.2.js"></script>
<script type="text/javascript" src="js/progressive-enhancement.js"></script>

<!-- Analytics -->
 <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3118496-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
 </script>

  </head><body><div xmlns="" xmlns:exsl="http://exslt.org/common" class="logo"><a href="index.html"><img src="images/logo-standard.png" /></a></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="top-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="index.html#home">Home</a></span></dt><dt><span class="section"><a href="news.html">News</a></span></dt><dt><span class="section"><a href="tutorials.html">Tutorials</a></span></dt><dt><span class="section"><a href="javadocs.html">Javadoc</a></span></dt><dt><span class="section"><a href="samples.html">Samples</a></span></dt><dt><span class="section"><span xmlns="" href="_core.html">Core</span></span></dt><dt><span class="section"><a href="libraries.html">Libraries</a></span></dt><dt><span class="section"><a href="extensions.html">Extensions</a></span></dt><dt><span class="section"><a href="tools.html">Tools</a></span></dt><dt><span class="section"><a href="glossary.html">Glossary </a></span></dt><dt><span class="section"><a href="community.html">Community</a></span></dt></dl></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="sub-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="_core.html#core-api">Core API</a></span></dt><dt><span class="section"><a href="core-api-metrics.html">Metrics API</a></span></dt><dt><span class="section"><a href="core-bootstrap-assembly.html">Core Bootstrap</a></span></dt><dt><span class="section"><a href="core-spi.html">Core Extension SPI</a></span></dt><dt><span class="section"><a href="core-functional.html">Core Functional API</a></span></dt><dt><span class="section"><span xmlns="" href="core-io.html">Core I/O API</span></span></dt><dt><span class="section"><a href="core-testsupport.html">Core Test Support</a></span></dt></dl></div></div><div class="section" title="Core I/O API"><div class="titlepage"><div><div><h3 class="title"><a id="core-io"></a>Core I/O API</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Qi4j Core I/O API is completely generic and not tied to the Qi4j programming model as a whole. It can be used
independently of Qi4j, together with the Qi4j Core Functional API, which the Core I/O API depends on.</p><p>The Qi4j Core I/O API tries to address the problem around shuffling data around from various I/O inputs and outputs,
possibly with transformations and filtering along the way. It was identified that there is a general mix-up of concerns
in the stereotypical I/O handling codebases that people deal with all the time. The reasoning around this, can be found
in the <a class="xref" href="howto-use-io.html" title="Use I/O API">Use I/O API</a>, and is recommended reading.</p><div class="section" title="The Problem"><div class="titlepage"><div><div><h4 class="title"><a id="_the_problem"></a>The Problem</h4></div></div></div><p>Why does I/O operations in Java have to be so complicated, with nested try/catch/finally and loops? Don’t you wish
that the operations could be expressed in a more natural way, such as;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
source.copyTo( destination );</pre><p>It seems natural to do, yet it is not present for us. We need to involve FileInputStream/FileOutputStream, wrap them
in Buffered versions of it, do out own looping, close the streams afterwards and what not. So, the java.io.File does
not have this simple feature and in the Qi4j Core API, we need to work around this limitation. We also want to
make the abstraction a little bit more encompassing than "just" files. So how does that look like then?</p></div><div class="section" title="First Examples"><div class="titlepage"><div><div><h4 class="title"><a id="_first_examples"></a>First Examples</h4></div></div></div><p>The most common inputs and outputs are collected in the org.qi4j.io.Inputs and org.qi4j.io.Outputs classes as static
factory methods, but you can create your (more about that later).</p><p>So, we want to read a text file and write the content into another text file, right? This is how it is done;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Inputs.text( source ).transferTo( Outputs.text(destination) );</pre><p>Pretty much self-explanatory, wouldn’t you say? But what happened to the handling of exceptions and closing of
resources? It is all handled inside the Qi4j Core I/O API. There is nothing you can forget to do.</p><p>Another simple example, where we want to count the number of lines in the text;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Counter&lt;String&gt; counter = new Counter&lt;String&gt;();
Inputs.text( source ).transferTo( Transforms.map(counter, Outputs.text(destination) ));
System.out.println( "Lines: " + counter.getCount() );</pre><p>The Counter is a <a class="xref" href="core-functional.html" title="Core Functional API">Function</a> which gets injected into the transfer.</p></div><div class="section" title="The 3 Parts"><div class="titlepage"><div><div><h4 class="title"><a id="_the_3_parts"></a>The 3 Parts</h4></div></div></div><p>Ok, so we have seen that the end result can become pretty compelling. How does it work?</p><p>I/O is defined as a process of moving data from an Input, via one or more Transforms to an Output. The Input could
be a File or a String, the transformation could be a filter, conversion or a function and finally the Output
destination could be a File, String or an OutputStream. It is important to note that there is a strong separation of
concern between them. Let’s look at the on at a time.</p></div><div class="section" title="org.qi4j.io.Input"><div class="titlepage"><div><div><h4 class="title"><a id="_org_qi4j_io_input"></a>org.qi4j.io.Input</h4></div></div></div><p>This interface simply has a transferTo() method, which takes an Output. The formal definition is;</p><pre class="programlisting brush: java">public interface Input&lt;T, SenderThrowableType extends Throwable&gt;
{
    &lt;ReceiverThrowableType extends Throwable&gt; void transferTo( Output&lt;? super T, ReceiverThrowableType&gt; output )
        throws SenderThrowableType, ReceiverThrowableType;
}
</pre><p>What on earth is all this genericized Exceptions? Well, it abstracts away the explicit Exception that implementations
may throw (or not). So instead of demanding that all I/O must throw the java.io.IOException, as is the case in the
JDK classes, it is up to the implementation to declare what it may throw. That is found in the SenderThrowable generic
of the interface.</p><p>But hold on a second. Why is an Input throwing a "sender" exception? Well, think again. The Input is feeding "something"
with data. It takes it from some source and "sends it" to the downstream chain, eventually reaching an Output, which
likewise is the ultimate "receiver".</p><p>So, then, the method transferTo() contains the declaration of the downstream receiver’s possible Exception
(ReceiverThrowable) which the transferTo() method may also throw as the data may not be accepted and such exception
will bubble up to the transferTo() method (the client’s view of the transfer).</p></div><div class="section" title="org.qi4j.io.Output"><div class="titlepage"><div><div><h4 class="title"><a id="_org_qi4j_io_output"></a>org.qi4j.io.Output</h4></div></div></div><p>The output interface is likewise fairly simple;</p><pre class="programlisting brush: java">public interface Output&lt;T, ReceiverThrowableType extends Throwable&gt;
{
  [...snip...]

    &lt;SenderThrowableType extends Throwable&gt; void receiveFrom( Sender&lt;? extends T, SenderThrowableType&gt; sender )
        throws ReceiverThrowableType, SenderThrowableType;
}
</pre><p>It can simply receive data from a org.qi4j.io.Sender.</p><p>Hey, hold on! Why is it not receiving from an Input? Because the Input is the client’s entry point and of no use to
the Output as such. Instead, the Output will tell the Sender (which is handed to from the Input or an transformation)
to which Receiver the content should be sent to.</p><p>Complicated? Perhaps not trivial to get your head around it at first, but the chain is;</p><p>Input passes a Sender to the Output which tells the Sender which Receiver the data should be sent to.</p><p>The reason for this is that we need to separate the concerns properly. Input is a starting point, but it emits something
which is represented by the Sender. Likewise the destination is an Output, but it receives the data via its Receiver
interface. For O/S resources, they are handled purely inside the Input and Output implementations, where are the
Sender/Receiver are effectively dealing with the data itself.</p></div><div class="section" title="org.qi4j.io.Transforms"><div class="titlepage"><div><div><h4 class="title"><a id="_org_qi4j_io_transforms"></a>org.qi4j.io.Transforms</h4></div></div></div><p>The 3 component in the Qi4j Core I/O API is the transformations that are possible. Interestingly enough, with the
above separation of concerns, we don’t need an InputOutput type that can both receive and send data. Instead, we
simply need to prepare easy to use static factory methods, which are found in the org.qi4j.io.Transforms class. Again,
it is fairly straight forward to create your own Transforms if you need something not provided here.</p><p>The current transformations available are;</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
filter - takes a Specification and only forwards data items conforming to the Specification.
</li><li class="listitem">
map - takes a org.qi4j.functional.Function to convert an item from one type to (potentially) another, and any
     possible change along the way.
</li><li class="listitem">
filteredMap - is a combination of a filter and a map. If the Specification is satisfied, the map function is
     applied, otherwise the item is passed through unaffected.
</li><li class="listitem">
lock - A wrapper which protects the Input or Output from simultaneous access. Not a transformation by itself,
     but implemented in the same fashion.
</li></ul></div><p>There are also a couple of handy map functions available, such as</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
Log
</li><li class="listitem">
ProgressLog
</li><li class="listitem">
Counter
</li><li class="listitem">
ByteBuffer2String
</li><li class="listitem">
Object2String
</li><li class="listitem">
String2Bytes
</li></ul></div></div><div class="section" title="Writing a Map Function?"><div class="titlepage"><div><div><h4 class="title"><a id="_writing_a_map_function"></a>Writing a Map Function?</h4></div></div></div><p>Let us take a closer look at the implementation of a map function, namely Counter mentioned above and also used in
the section First Example above.</p><p>The implementation is very straight forward.</p><pre class="programlisting brush: java">public static class Counter&lt;T&gt;
    implements Function&lt;T, T&gt;
{
    private volatile long count = 0;

    public long getCount()
    {
        return count;
    }

    @Override
    public T map( T t )
    {
        count++;
        return t;
    }
}
</pre><p>On each call to the map() method, increment the counter field. The client can then retrieve that value after the
transfer is complete, or in a separate thread to show progress.</p><p>Speaking of "progress", so how is the ProgressLog implemented? Glad you asked;</p><pre class="programlisting brush: java">public static class ProgressLog&lt;T&gt;
    implements Function&lt;T, T&gt;
{
    private Counter&lt;T&gt; counter;
    private Log&lt;String&gt; log;
    private final long interval;

    public ProgressLog( Logger logger, String format, long interval )
    {
        this.interval = interval;
        if( logger != null &amp;&amp; format != null )
        {
            log = new Log&lt;String&gt;( logger, format );
        }
        counter = new Counter&lt;T&gt;();
    }

    public ProgressLog( long interval )
    {
        this.interval = interval;
        counter = new Counter&lt;T&gt;();
    }

    @Override
    public T map( T t )
    {
        counter.map( t );
        if( counter.count % interval == 0 )
        {
            logProgress();
        }
        return t;
    }

    // Override this to do something other than logging the progress
    protected void logProgress()
    {
        if( log != null )
        {
            log.map( counter.count + "" );
        }
    }
}
</pre><p>It combines the Counter and the Log implementations, so that the count is forwarded to the Log at a given interval, such
as every 1000 items. This may not be what you think a ProgressLog should look like, but it serves as a good example on
how you can combine the general principles found in the Qi4j Core API package.</p></div><div class="section" title="How to write a filter specification?"><div class="titlepage"><div><div><h4 class="title"><a id="_how_to_write_a_filter_specification"></a>How to write a filter specification?</h4></div></div></div><p>The filter transform takes a specification implementation which has a very simple method, isSatisfiedBy() (read more
about that in <a class="xref" href="core-functional.html" title="Core Functional API">Function</a>.</p><pre class="programlisting brush: java">public interface Specification&lt;T&gt;
{
  [...snip...]

    boolean satisfiedBy( T item );
}
</pre><p>The only thing that the implementation need to do is return <span class="strong"><strong>true</strong></span> or <span class="strong"><strong>false</strong></span> for whether the item passed in is within
the limits of the Specification. Let’s say that you have a IntegerRangeSpecification, which could then be implemented
as</p><pre class="programlisting brush: java">public static class IntegerRangeSpecification
    implements Specification&lt;Integer&gt;
{

    private int lower;
    private int higher;

    public IntegerRangeSpecification( int lower, int higher )
    {
        this.lower = lower;
        this.higher = higher;
    }

    @Override
    public boolean satisfiedBy( Integer item )
    {
        return item &gt;= lower &amp;&amp; item &lt;= higher;
    }
}
</pre></div><div class="section" title="Ready-to-use components"><div class="titlepage"><div><div><h4 class="title"><a id="_ready_to_use_components"></a>Ready-to-use components</h4></div></div></div><p>Input and Output implementations at first glance look quite scary. Taking a closer look and it can be followed. But to
simplify for users, the org.qi4j.io.Inputs and org.qi4h.io.Outputs contains static factory methods for many useful
sources and destinations.</p></div><div class="section" title="org.qi4j.io.Inputs"><div class="titlepage"><div><div><h4 class="title"><a id="_org_qi4j_io_inputs"></a>org.qi4j.io.Inputs</h4></div></div></div><p>The current set of ready-to-use Input implementations are;</p><pre class="programlisting brush: java">
/**
 * Read lines from a UTF-8 encoded textfile.
 *
 * If the filename ends with .gz, then the data is automatically unzipped when read.
 *
 * @param source textfile with lines separated by \n character
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final File source )
  [...snip...]


/**
 * Read lines from a textfile with the given encoding.
 *
 * If the filename ends with .gz, then the data is automatically unzipped when read.
 *
 * @param source   textfile with lines separated by \n character
 * @param encoding encoding of file, e.g. "UTF-8"
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final File source, final String encoding )
  [...snip...]


/**
 * Read lines from a textfile at a given URL.
 *
 * If the content support gzip encoding, then the data is automatically unzipped when read.
 *
 * The charset in the content-type of the URL will be used for parsing. Default is UTF-8.
 *
 * @param source textfile with lines separated by \n character
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final URL source )
  [...snip...]


/**
 * Read a file using ByteBuffer of a given size. Useful for transferring raw data.
 *
 * @param source
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; byteBuffer( final File source, final int bufferSize )
  [...snip...]


/**
 * Read an inputstream using ByteBuffer of a given size.
 *
 * @param source
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; byteBuffer( final InputStream source, final int bufferSize )
  [...snip...]


/**
 * Combine many Input into one single Input. When a transfer is initiated from it all items from all inputs will be transferred
 * to the given Output.
 *
 * @param inputs
 * @param &lt;T&gt;
 * @param &lt;SenderThrowableType&gt;
 *
 * @return
 */
public static &lt;T, SenderThrowableType extends Throwable&gt; Input&lt;T, SenderThrowableType&gt; combine( final Iterable&lt;Input&lt;T, SenderThrowableType&gt;&gt; inputs )
  [...snip...]


/**
 * Create an Input that takes its items from the given Iterable.
 *
 * @param iterable
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Input&lt;T, RuntimeException&gt; iterable( final Iterable&lt;T&gt; iterable )
  [...snip...]


/**
 * Create an Input that allows a Visitor to write to an OutputStream. The stream is a BufferedOutputStream, so when enough
 * data has been gathered it will send this in chunks of the given size to the Output it is transferred to. The Visitor does not have to call
 * close() on the OutputStream, but should ensure that any wrapper streams or writers are flushed so that all data is sent.
 *
 * @param outputVisitor
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; output( final Visitor&lt;OutputStream, IOException&gt; outputVisitor,
                                                     final int bufferSize
)
</pre></div><div class="section" title="org.qi4j.io.Outputs"><div class="titlepage"><div><div><h4 class="title"><a id="_org_qi4j_io_outputs"></a>org.qi4j.io.Outputs</h4></div></div></div><p>The current set of ready-to-use Input implementations are;</p><pre class="programlisting brush: java">
/**
 * Write lines to a text file with UTF-8 encoding. Separate each line with a newline ("\n" character). If the writing or sending fails,
 * the file is deleted.
 * &lt;p/&gt;
 * If the filename ends with .gz, then the data is automatically GZipped.
 *
 * @param file the file to save the text to
 *
 * @return an Output for storing text in a file
 */
public static Output&lt;String, IOException&gt; text( final File file )
  [...snip...]


/**
 * Write lines to a text file. Separate each line with a newline ("\n" character). If the writing or sending fails,
 * the file is deleted.
 * &lt;p/&gt;
 * If the filename ends with .gz, then the data is automatically GZipped.
 *
 * @param file the file to save the text to
 *
 * @return an Output for storing text in a file
 */
public static Output&lt;String, IOException&gt; text( final File file, final String encoding )
  [...snip...]


/**
 * Write lines to a Writer. Separate each line with a newline ("\n" character).
 *
 * @param writer the Writer to write the text to
 * @return an Output for storing text in a Writer
 */
public static Output&lt;String, IOException&gt; text( final Writer writer )
  [...snip...]


/**
 * Write lines to a StringBuilder. Separate each line with a newline ("\n" character).
 *
 * @param builder the StringBuilder to append the text to
 * @return an Output for storing text in a StringBuilder
 */
public static Output&lt;String, IOException&gt; text( final StringBuilder builder )
  [...snip...]


/**
 * Write ByteBuffer data to a file. If the writing or sending of data fails the file will be deleted.
 *
 * @param file
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;ByteBuffer, IOException&gt; byteBuffer( final File file )
  [...snip...]


/**
 * Write ByteBuffer data to an OutputStream.
 *
 * @param stream
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;ByteBuffer, IOException&gt; byteBuffer( final OutputStream stream )
  [...snip...]


/**
 * Write byte array data to a file. If the writing or sending of data fails the file will be deleted.
 *
 * @param file
 * @param bufferSize
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;byte[], IOException&gt; bytes( final File file, final int bufferSize )
  [...snip...]


/**
 * Do nothing. Use this if you have all logic in filters and/or specifications
 *
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;T, RuntimeException&gt; noop()
  [...snip...]


/**
 * Use given receiver as Output. Use this if there is no need to create a "transaction" for each transfer, and no need
 * to do batch writes or similar.
 *
 * @param &lt;T&gt;
 * @param receiver receiver for this Output
 *
 * @return
 */
public static &lt;T, ReceiverThrowableType extends Throwable&gt; Output&lt;T, ReceiverThrowableType&gt; withReceiver( final Receiver&lt;T, ReceiverThrowableType&gt; receiver )
  [...snip...]


/**
 * Write objects to System.out.println.
 *
 * @return
 */
public static Output&lt;Object, RuntimeException&gt; systemOut()
  [...snip...]


/**
 * Write objects to System.err.println.
 */
public static Output&lt;Object, RuntimeException&gt; systemErr()
  [...snip...]


/**
 * Add items to a collection
 */
public static &lt;T&gt; Output&lt;T, RuntimeException&gt; collection( final Collection&lt;T&gt; collection )
</pre></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="footer">(c) 2012 The Qi4j Community</div></body></html>

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Shiro Security</title><link rel="stylesheet" type="text/css" href="css/style.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" /><link rel="home" href="index.html" title="" /><link rel="up" href="libraries.html" title="Libraries" /><link rel="prev" href="library-servlet.html" title="Servlet" /><link rel="next" href="library-shiro-web.html" title="Shiro Web Security" />


<!-- favicon -->

<link rel="shortcut icon" href="http://qi4j.org/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="http://qi4j.org/favicon.ico" type="image/x-icon" />

<!-- style -->

<link href="css/shCore.css" rel="stylesheet" type="text/css" />
<link href="css/shCoreEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/shThemeEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/qi4j.css" rel="stylesheet" type="text/css" />

<!-- Syntax Highlighter -->

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushScala.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushGroovy.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushRuby.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>

<script type="text/javascript">
  SyntaxHighlighter.defaults['tab-size'] = 4;
  SyntaxHighlighter.defaults['gutter'] = false;
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

<!-- JQuery -->

<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>

<!-- Image Scaler -->

<script type="text/javascript" src="js/imagescaler.js"></script>

<!-- Table Styler -->

<script type="text/javascript" src="js/tablestyler.js"></script>

<!-- Qi4j WebSite Progressive Enhancement -->

<link href="css/progressive-enhancement.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/jquery.scrollTo-1.4.2.js"></script>
<script type="text/javascript" src="js/progressive-enhancement.js"></script>

<!-- Analytics -->
 <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3118496-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
 </script>

  </head><body><div xmlns="" xmlns:exsl="http://exslt.org/common" class="logo"><a href="index.html"><img src="images/logo-standard.png" /></a></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="top-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="index.html#home">Qi4j</a></span></dt><dt><span class="section"><a href="intro.html">Introduction</a></span></dt><dt><span class="section"><a href="tutorials.html">Tutorials</a></span></dt><dt><span class="section"><a href="javadocs.html">Javadoc</a></span></dt><dt><span class="section"><a href="samples.html">Samples</a></span></dt><dt><span class="section"><a href="core.html">Core</a></span></dt><dt><span class="section"><span xmlns="" href="libraries.html">Libraries</span></span></dt><dt><span class="section"><a href="extensions.html">Extensions</a></span></dt><dt><span class="section"><a href="tools.html">Tools</a></span></dt><dt><span class="section"><a href="glossary.html">Glossary </a></span></dt></dl></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="sub-nav"><div xmlns="http://www.w3.org/1999/xhtml" class="toc"><dl><dt><span class="section"><a href="libraries.html#_overview_5">Overview</a></span></dt><dt><span class="section"><a href="library-alarm.html">Alarms</a></span></dt><dt><span class="section"><a href="library-caching.html">Caching</a></span></dt><dt><span class="section"><a href="library-circuitbreaker.html">Circuit Breaker</a></span></dt><dt><span class="section"><a href="library-constraints.html">Constraints</a></span></dt><dt><span class="section"><a href="library-conversion.html">Conversion</a></span></dt><dt><span class="section"><a href="library-cxf.html">CXF WebService</a></span></dt><dt><span class="section"><a href="library-eventsourcing.html">Event Sourcing</a></span></dt><dt><span class="section"><a href="library-eventsourcing-jdbm.html">Event Sourcing - JDBM</a></span></dt><dt><span class="section"><a href="library-eventsourcing-rest.html">Event Sourcing - ReST</a></span></dt><dt><span class="section"><a href="library-fileconfig.html">FileConfig</a></span></dt><dt><span class="section"><a href="library-http.html">HTTP</a></span></dt><dt><span class="section"><a href="library-jmx.html">JMX</a></span></dt><dt><span class="section"><a href="library-locking.html">Locking</a></span></dt><dt><span class="section"><a href="library-logging.html">Logging</a></span></dt><dt><span class="section"><a href="library-neo4j.html">Neo4j</a></span></dt><dt><span class="section"><a href="library-osgi.html">OSGi</a></span></dt><dt><span class="section"><a href="library-rdf.html">RDF</a></span></dt><dt><span class="section"><a href="library-rest-client.html">ReST Client</a></span></dt><dt><span class="section"><a href="library-rest-client-primer.html">ReST - HATEOAS Primer</a></span></dt><dt><span class="section"><a href="library-rest-common.html">ReST Common</a></span></dt><dt><span class="section"><a href="library-rest-server.html">ReST Server</a></span></dt><dt><span class="section"><a href="library-scheduler.html">Scheduler</a></span></dt><dt><span class="section"><a href="library-script-beanshell.html">Beanshell Scripting</a></span></dt><dt><span class="section"><a href="library-script-groovy.html">Groovy Scripting</a></span></dt><dt><span class="section"><a href="library-script-javascript.html">Javascript Scripting</a></span></dt><dt><span class="section"><a href="library-script-jruby.html">JRuby Scripting</a></span></dt><dt><span class="section"><a href="lang-scala.html">Scala Support</a></span></dt><dt><span class="section"><a href="library-servlet.html">Servlet</a></span></dt><dt><span class="section"><span xmlns="" href="library-shiro.html">Shiro Security</span></span></dt><dt><span class="section"><a href="library-shiro-web.html">Shiro Web Security</a></span></dt><dt><span class="section"><a href="library-spring.html">Spring Integration</a></span></dt><dt><span class="section"><a href="library-sql.html">SQL</a></span></dt><dt><span class="section"><a href="library-struts-codebehind.html">Struts - Code Behind</a></span></dt><dt><span class="section"><a href="library-struts-convention.html">Struts - Convention</a></span></dt><dt><span class="section"><a href="library-struts-plugin.html">Struts - Plugin</a></span></dt><dt><span class="section"><a href="library-uid.html">UID</a></span></dt><dt><span class="section"><a href="library-uowfile.html">UoWFile</a></span></dt></dl></div></div><div class="section" title="Shiro Security"><div class="titlepage"><div><div><h3 class="title"><a id="library-shiro"></a>Shiro Security</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>This library provides integration with the <a class="ulink" href="http://shiro.apache.org/" target="_top">Apache Shiro</a> Java Security Framework.</p><div class="note" title="Note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>If you are working on a HTTP based application, see the <a class="xref" href="library-shiro-web.html" title="Shiro Web Security"> Shiro Web Security Library</a> that leverages this very library
and is directly usable with the <a class="xref" href="library-http.html" title="HTTP"> HTTP Library</a>, the <a class="xref" href="library-servlet.html" title="Servlet">Servlet Library</a> or any other Servlet based stack.</p></div><p>“Apache Shiro is a powerful and easy-to-use Java security framework that performs authentication, authorization,
cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any
application – from the smallest mobile applications to the largest web and enterprise applications.” says the Apache
Shiro website.</p><p>Altough Apache Shiro can be used as-is with Qi4j Applications, this library provides integrations that can come in
handy. If your use case do not fit any of theses integrations, look at their respective code. You should find out
pretty easily how to compose the provided code to write your integration. Don’t hesitate to contribute interesting
integrations to this very library.</p><p>We invite you to read the comprehensive <a class="ulink" href="http://shiro.apache.org/documentation.html" target="_top">Apache Shiro documentation</a>, we will
mostly discuss Qi4j related matters here.</p><div class="table"><a id="idp13833632"></a><p class="title"><strong>Table 49. Artifact</strong></p><div class="table-contents"><table summary="Artifact" border="1"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /></colgroup><thead><tr><th align="left" valign="top">Group ID</th><th align="left" valign="top">Artifact ID</th><th align="left" valign="top">Version</th></tr></thead><tbody><tr><td align="left" valign="top"><p>org.qi4j.library</p></td><td align="left" valign="top"><p>org.qi4j.library.shiro-core</p></td><td align="left" valign="top"><p>2.1-SNAPSHOT</p></td></tr></tbody></table></div></div><br class="table-break" /><div class="section" title="Basic usage"><div class="titlepage"><div><div><h4 class="title"><a id="_basic_usage"></a>Basic usage</h4></div></div></div><p>For standalone applications, you can use plain Shiro easily. The only thing to do is to register a configured
SecurityManager when activating your Qi4j Application. It can be done outside the application, before its activation,
"à là" by-hand ;</p><pre class="programlisting brush: java">IniSecurityManagerFactory factory = new IniSecurityManagerFactory( "classpath:standalone-shiro.ini" );
SecurityManager securityManager = factory.getInstance();
SecurityUtils.setSecurityManager( securityManager );
</pre><p>note that this example code register the SecurityManager as a VM static singleton.</p><p>However we recommend to use the provided IniSecurityManagerService that does exactly this when activated and unregister
the SecurityManager when passivated:</p><pre class="programlisting brush: java">new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
</pre><p>You can change the INI resource path through the ShiroIniConfiguration:</p><pre class="programlisting brush: java">public interface ShiroIniConfiguration
        extends ConfigurationComposite
{

    /**
     * Resource path of the ini configuration file.
     * "classpath:", "file": and "url:" prefixes are supported.
     * Defaulted to "classpath:shiro.ini".
     */
    @Optional
    Property&lt;String&gt; iniResourcePath();

}
</pre><p>Remember that this setup use a ThreadLocal SecurityManager singleton. Among other things it means that, althoug the
IniSecurityManagerService is activated on Application activation, if you need to use Shiro in other Services that are
activated on Application activation you should tell Qi4j about this dependency by injecting the SecurityManagerService
in the laters.</p><p>Once started you must remember to register the SecurityManager in Shiro’s ThreadContext ;</p><pre class="programlisting brush: java">
@Service
private IniSecurityManagerService securityManagerService;

[...snip...]

public void interactionBegins()
{
    ThreadContext.bind( securityManagerService.getSecurityManager() );
}

[...snip...]

public void interactionEnds()
{
    ThreadContext.unbindSubject();
    ThreadContext.unbindSecurityManager();
}
</pre><p>that’s how Shiro works.</p></div><div class="section" title="Security Concern"><div class="titlepage"><div><div><h4 class="title"><a id="_security_concern"></a>Security Concern</h4></div></div></div><p>This library provides the <code class="literal">SecurityConcern</code> that should be used alongside the provided method annotations that mimic
Apache Shiro annotations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">
The <code class="literal">@RequiresAuthentication</code> annotation requires the current Subject to have been authenticated during their current
  session for the annotated class/instance/method to be accessed or invoked.
</li><li class="listitem">
The <code class="literal">@RequiresGuest</code> annotation requires the current Subject to be a "guest", that is, they are not authenticated or
  remembered from a previous session for the annotated class/instance/method to be accessed or invoked.
</li><li class="listitem">
The <code class="literal">@RequiresPermissions</code> annotation requires the current Subject be permitted one or more permissions in order to
  execute the annotated method.
</li><li class="listitem">
The <code class="literal">@RequiresRoles</code> annotation requires the current Subject to have all of the specified roles. If they do not have
  the role(s), the method will not be executed and an AuthorizationException is thrown.
</li><li class="listitem">
The <code class="literal">@RequiresUser</code> annotation requires the current Subject to be an application user for the annotated
  class/instance/method to be accessed or invoked. An <span class="emphasis"><em>application user</em></span> is defined as a Subject that has a known
  identity, either known due to being authenticated during the current session or remembered from <span class="emphasis"><em>RememberMe</em></span> services
  from a previous session.
</li></ul></div></div><div class="section" title="Realms Services"><div class="titlepage"><div><div><h4 class="title"><a id="_realms_services"></a>Realms Services</h4></div></div></div><p>All the above is sufficient as long as you use the ini file to store user credentials and permissions or a Realm that
has no dependency on your application code and can be specified in the ini file to be instanciated by Shiro outside the
Qi4j scope.</p><p>One usecase where it’s not sufficient comes quickly as you would like to provide user credentials and permissions
from Entities stored in an EntityStore or perform any custom logic involving your Qi4j Application.</p><p>Let’s look at a complete example using a Realm Service that extends one of the Shiro provided Realm which use in-memory
credientials and configuring it ;</p><pre class="programlisting brush: java">@Mixins( MyRealmMixin.class )
public interface MyRealmService
        extends Realm, ServiceComposite, ServiceActivation
{
}

[...snip...]

public class MyRealmMixin
        extends SimpleAccountRealm
        implements ServiceActivation
{

    private final PasswordService passwordService;

    public MyRealmMixin()
    {
        super();
        passwordService = new DefaultPasswordService();
        PasswordMatcher matcher = new PasswordMatcher();
        matcher.setPasswordService( passwordService );
        setCredentialsMatcher( matcher );
    }

    public void activateService()
            throws Exception
    {
        // Create a test account
        addAccount( "foo", passwordService.encryptPassword( "bar" ) );
    }

    [...snip...]


}

@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
    module.services( MyRealmService.class );

    [...snip...]

}

</pre><p>We start by defining a Realm Service and its Mixin that’s based on SimpleAccountRealm that we configure to handle hashed
passwords. For the sake of the example it is shown how to hash a password using Shiro built in mecanisms. Then comes
the Assembly where we simply reuse the Standalone Shiro Assembly and declare our Realm as a Service. It works the same
way when using the <a class="xref" href="library-shiro-web.html" title="Shiro Web Security"> Shiro Web Security Library</a>.</p><p>Note that under the hood, assembled Realm Services are added to the ones configured in the INI file.</p></div><div class="section" title="Security Domain"><div class="titlepage"><div><div><h4 class="title"><a id="_security_domain"></a>Security Domain</h4></div></div></div><p>Going further, if you want to persist credentials and permissions in an EntityStore, the Shiro Security Library
provides skeletons to easily setup some usecases consisting of Shiro setup facilities and base state model for you to
compose with.</p><div class="section" title="Passwords"><div class="titlepage"><div><div><h5 class="title"><a id="_passwords"></a>Passwords</h5></div></div></div><p>Password storage is not a simple subject. Shiro provide best practice mecanisms using salt and repeated-hashing out of
the box. It is possible to setup your Realm so that hashed passwords are stored in a future proof manner, meaning that
you can change the used algorithms while retaining compatibility with passwords already stored.</p><p>Shiro use the
<a class="ulink" href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/crypto/hash/format/Shiro1CryptFormat.html" target="_top">Shiro1CryptFormat</a>
which is a fully reversible <a class="ulink" href="http://packages.python.org/passlib/modular_crypt_format.html" target="_top">Modular Crypt Format</a> (MCF).</p><p>This library provides a <code class="literal">PasswordRealmService</code> to be used with a <code class="literal">PasswordSecurable</code>. Let’s look at a complete
example.</p><p>First you need to define your User (or Account, or whatever fits your domain), for the sake of the example we define a
UserFactory too. Note that the factory uses the PasswordService implemented by the PasswordRealm to hash the password:</p><pre class="programlisting brush: java">public interface User
        extends PasswordSecurable
{
}

[...snip...]

@Mixins( UserFactoryMixin.class )
public interface UserFactory
{

    User createNewUser( String username, String password );

}

[...snip...]

public static class UserFactoryMixin
        implements UserFactory
{

    @Structure
    private Module module;

    @Service
    private PasswordService passwordService;

    @Override
    public User createNewUser( String username, String password )
    {
        EntityBuilder&lt;User&gt; userBuilder = module.currentUnitOfWork().newEntityBuilder( User.class );
        User user = userBuilder.instance();
        user.subjectIdentifier().set( username );
        user.password().set( passwordService.encryptPassword( password ) );
        return userBuilder.newInstance();
    }

}

</pre><p>Now comes the assembly that reuse what’s described above and add both the password domain assembly plus your custom User
entity and its factory:</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
    new PasswordDomainAssembler().withConfig( configModule ).assemble( module );

    module.entities( User.class );
    module.services( UserFactory.class );

    [...snip...]

}

</pre><p>And finally here is how to create a new user and below how to perform a login:</p><pre class="programlisting brush: java">User user = userFactory.createNewUser( "foo", "bar" );

[...snip...]

Subject currentUser = SecurityUtils.getSubject();
currentUser.login( new UsernamePasswordToken( "foo", "bar" ) );

</pre><p>In this setup, password hashing use the Shiro’s default (Salted SHA-256 with 500.000 iterations). If you <span class="emphasis"><em>need</em></span> to
change this you can do it using PasswordRealmConfiguration properties:</p><pre class="programlisting brush: java">/**
 * Sets the name of the MessageDigest algorithm that will be used to compute hashes.
 */
@Optional
Property&lt;String&gt; hashAlgorithmName();

/**
 * Sets the number of hash iterations that will be performed during hash computation.
 */
@Optional
Property&lt;Integer&gt; hashIterationsCount();
</pre></div><div class="section" title="Permissions &amp; Roles"><div class="titlepage"><div><div><h5 class="title"><a id="_permissions_amp_roles"></a>Permissions &amp; Roles</h5></div></div></div><p>In the same vein, this library provide a domain state skeleton with support in <code class="literal">PasswordRealmService</code>. It allows you to
easily store roles, permissions and assignment to your accounts.</p><p>Let’s look at the previous example with permissions added.</p><p>First you need to add the RoleAssignee type to your account:</p><pre class="programlisting brush: java">public interface User
        extends PasswordSecurable, RoleAssignee
{
}

</pre><p>Assembly is straight forward:</p><pre class="programlisting brush: java">new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
new PasswordDomainAssembler().withConfig( configModule ).assemble( module );
new PermissionsDomainAssembler().assemble( module );

module.entities( User.class );
module.services( UserFactory.class );

</pre><p>And here is how to use all this:</p><pre class="programlisting brush: java">UnitOfWork uow = module.newUnitOfWork();

User user = userFactory.createNewUser( "foo", "bar" );
Role role = roleFactory.create( "role-one", "permission-one", "permission-two" );
role.assignTo( user );

uow.complete();

[...snip...]

uow = module.newUnitOfWork();

Subject currentUser = SecurityUtils.getSubject();
currentUser.login( new UsernamePasswordToken( "foo", "bar" ) );

if ( !currentUser.hasRole( "role-one" ) ) {
    fail( "User 'foo' must have 'role-one' role." );
}

if ( !currentUser.isPermitted( "permission-one" ) ) {
    fail( "User 'foo' must have 'permission-one' permission." );
}

[...snip...]

uow.discard();
</pre></div></div><div class="section" title="Other authentication mecanisms"><div class="titlepage"><div><div><h4 class="title"><a id="_other_authentication_mecanisms"></a>Other authentication mecanisms</h4></div></div></div><p>For other authentication mecanisms you can leverage Shiro extensions available in the Shiro distribution or as external
libraries. There’s support for text files, simple JDBC, LDAP, CAS SSO, OAuth, OpenID, X.509 Certificates etc…</p><p>Take the PasswordRealmService as a start and extend/rewrite it to suit your needs.</p><p>If you happen to come with a Qi4j integration that could be valuable in this very library, don’t hesitate to
contribute.</p></div><div class="section" title="Logging"><div class="titlepage"><div><div><h4 class="title"><a id="_logging_5"></a>Logging</h4></div></div></div><p>All code from this library use the <code class="literal">org.qi4j.library.shiro</code> logger.</p></div></div><div xmlns="" xmlns:exsl="http://exslt.org/common" class="footer">(c) 2012 The Qi4j Community</div></body></html>

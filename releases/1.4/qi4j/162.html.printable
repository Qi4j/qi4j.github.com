<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
   <head>
      <title>Qi4j in 30 minutes    - www.qi4j.org</title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta name="robots" content="noindex, nofollow"  />
      <meta http-equiv="imagetoolbar" content="no" />
      <meta name="DC.Identifier" scheme="URL" content="http://www.qi4j.org" />
      <meta name="DC.Language" scheme="RFC1766" content="en" />
      <meta name="DC.Format" scheme="IMT" content="text/html" />
      <meta name="DC.Type" content="text" />
      <link rel="schema.DC" href="http://purl.org/DC/elements/1.0/" />
      <style type="text/css" media="braille,embossed,handheld,print,projection,screen,speech,tty,tv">
         @import url(http://www.qi4j.org/2.6f43db4e123f11b40958000145/0/1964/SiteVision.css);
         @import url(../2.6f43db4e123f11b40958000145/auto-1-126/1964/SiteVision.css);
      </style>
      <!--[if IE]><link rel="stylesheet" type="text/css" media="screen" href="/sitevision-ie.css" /><![endif]-->
      <link rel="stylesheet" type="text/css" media="screen" href="../sitevision/ajax/jquery/plugins/fancybox/jquery.fancybox-1.3.1-mod.css" />
      <!--[if IE]><link rel="stylesheet" type="text/css" media="screen" href="/sitevision/ajax/jquery/plugins/fancybox/jquery.fancybox-1.3.1-ie.css" /><![endif]-->
      <link rel="stylesheet" type="text/css" media="screen" href="../sitevision/ajax/jquery/plugins/rating/jquery.rating.css" />
      <script type="text/javascript" src="../sitevision/util/externallinks.js"></script>
      <script type="text/javascript" src="../sitevision/ajax/jquery/jquery-1.4.2.min.js"></script>
      <script type="text/javascript" src="../sitevision/ajax/jquery/plugins/rating/jquery.rating.js"></script>
      <script type="text/javascript" src="../sitevision/ajax/jquery/plugins/metadata/jquery.metadata.min.js"></script>
      <script type="text/javascript">
         var $svjq = jQuery.noConflict();
      </script>
      <script type="text/javascript" src="../sitevision/ajax/jquery/plugins/pngfix/jquery.pngFix.pack.js"></script>
      <script type="text/javascript" src="../sitevision/ajax/jquery/plugins/fancybox/jquery.fancybox-1.3.1.pack.js"></script>
   </head>

   <body class="c0">



<div  id="svid10_6f43db4e123f11b409580001291"><div class="c1" id="svid10_6f43db4e123f11b409580002977">
<div class="c2" id="svid10_6f43db4e123f11b409580004453">
<div id="svid10_6f43db4e123f11b409580004781">
<div class="c3" id="svid12_6f43db4e123f11b409580001845"><div id="Qi4jlogo"><!-- Qi4j logo --></div><a title="Return to Qi4j homepage" href="2.html"><img alt="Qi4j" class="c4" src="../images/18.6f43db4e123f11b409580003681/logo-box.jpg" /></a></div>
<div class="c5" id="svid12_6f43db4e123f11b409580004581"><div id="Multilevellink1"><!-- Multilevellink 1 --></div>

<ul class="c6">
  <li  class="breadcrumb c7">      
          
        <a href="2.html" title="" class="breadcrumb c8" >Home</a>
    </li>
  <li  class="breadcrumb c7"> <img alt="" src="../images/18.6f43db4e123f11b409580002965/breadcrumb.gif" class="c48" />       
          
        <a href="introduction.html" title="" class="breadcrumb c48" >Introduction to Qi4j</a>
    </li>
  <li  class="breadcrumb c7"> <img alt="" src="../images/18.6f43db4e123f11b409580002965/breadcrumb.gif" class="c48" />         <span class="c48" >Qi4j in 30 minutes</span>
    </li>
</ul>
</div>
<div class="c9" id="svid12_6f43db4e123f11b409580004814"><div id="Search"><!-- Search --></div><form method="get" action="158.html" class="c19">
   <div>
      <label for="search12_6f43db4e123f11b409580004814" class="svhidden">Search</label>
      <input id="search12_6f43db4e123f11b409580004814" class="search c8"  type="text" name="query" size="20" value="Search here" onclick="if (this.value = 'Search here') this.value='';" onkeypress="" />
      <input type="submit" class="search c8" name="submit" value="Go"  />
   </div>
</form>
</div>
<div class="c10" id="svid12_6f43db4e123f11b409580004806"><div id="Printversion"><!-- Printversion --></div>

  <a class="breadcrumb" title="Printer friendly version" rel="nofollow" href="162.html.printable">

  Print |
</a></div>
<div class="c11"></div>
</div>
</div>
<div class="ielayoutfix c12"  id="svid10_6f43db4e123f11b409580004723">
<div id="svid94_6f43db4e123f11b40958000836" ><div id="svid10_6f43db4e123f11b409580003677">
<div class="c13" id="svid10_6f43db4e123f11b409580004666"><div class="c14" id="svid12_6f43db4e123f11b409580004536">
<div id="Expandingmenu"><!-- Expanding menu --></div><table summary="" cellspacing="1" cellpadding="0" class="c15">
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="17.html" class="navigation" title="Community">Community</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
            </td>
   <td class="c15">
                        <a href="9.html" class="navigation" title="News">News</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="21.html" class="navigation" title="Licensing">Licensing</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="downloads.html" class="navigation" title="Download">Download</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003861/navi-expand-no.gif" />
              </td>
   <td class="c15">
                        <a href="introduction.html" class="navigation" title="Introduction to Qi4j">Introduction to Qi4j</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c49">
 <tr>
  <td class="c50">
            </td>
   <td class="c15">
                        <a href="160.html" class="newsxmm" title="Background">Background</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c49">
 <tr>
  <td class="c50">
            </td>
   <td class="c15">
                        <a href="199.html" class="newsxmm" title="Qi4j in 2 minutes">Qi4j in 2 minutes</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c49">
 <tr>
  <td class="c50">
            </td>
   <td class="c15">
                        <a href="163.html" class="newsxmm" title="Qi4j in 10 minutes">Qi4j in 10 minutes</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c49">
 <tr>
  <td class="c50">
            </td>
   <td class="c15">
                        <a href="162.html" class="navigationxxactivex" title="Qi4j in 30 minutes">Qi4j in 30 minutes</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c49">
 <tr>
  <td class="c50">
            </td>
   <td class="c15">
                        <a href="161.html" class="newsxmm" title="Qi4j in 2 hours">Qi4j in 2 hours</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="146.html" class="navigation" title="Tutorials &amp; HowTOs">Tutorials &amp; HowTOs</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="15.html" class="navigation" title="Documentation">Documentation</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="333.html" class="navigation" title="Sandbox">Sandbox</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
            </td>
   <td class="c15">
                        <a href="336.html" class="navigation" title="Samples">Samples</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
                  <img class="c18" alt="" src="../images/18.6f43db4e123f11b409580003636/navi-expand.gif" />
              </td>
   <td class="c15">
                        <a href="sponsors.html" class="navigation" title="Sponsors">Sponsors</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
            </td>
   <td class="c15">
                        <a href="support.html" class="navigation" title="Support">Support</a>
           </td>
  </tr>
</table>
</td></tr>
<tr><td>
   <table summary="" class="c16">
 <tr>
  <td class="c17">
            </td>
   <td class="c15">
                        <a href="288.html" class="navigation" title="Latest Changes">Latest Changes</a>
           </td>
  </tr>
</table>
</td></tr>

</table>
</div>
<div class="c20" id="svid12_6f43db4e123f11b409580004771">
<div id="Text"><!-- Text --></div></div>
<div class="c29" id="svid12_58e87b6312cf378e76d8000904">
<div id="HTML"><!-- HTML --></div>


</div>
</div>
<div class="c5" id="svid10_6f43db4e123f11b409580004744"><div id="svid94_6f43db4e123f11b40958000912" ><div class="c53" id="svid10_6f43db4e123f11b409580004222">
<!-- Page content starts here --><div class="pagecontent" id="svid94_6f43db4e123f11b409580001317" ><div id="Centercolumn"><!-- Center column --></div><div class="c32" id="svid12_6f43db4e123f11b409580003582">
<div id="Heading"><!-- Heading --></div><div id="h-Qi4jin30minutes" class="sv-inline"><!-- Qi4j in 30 minutes --></div><h1 class="heading">Qi4j in 30 minutes</h1></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580003014">
<div id="Content"><!-- Content --></div><span class="normal">This introduction will deepen your understanding of Qi4j, as we touches on a couple of the common features of Qi4j. It is expected that you have gone through and understood the "Qi4j in 10 minutes" introduction.</span><p><span class="normal">We will go back to the OrderEntity example;</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580004308">
<div id="Example1"><!-- Example 1 --></div><span class="javaxcode">@Concerns({PurchaseLimitConcern.class, InventoryConcern.class})</span><br /><span class="javaxcode">public interface OrderEntity</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;extends Order, HasSequenceNumber, HasCustomer, </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HasLineItems, Confirmable, EntityComposite</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">}</span></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580004260">
<div id="Text-0"><!-- Text --></div><span class="normal">Let's say that this is an existing Composite, perhaps found in a library or used in a previous object, but we want to add that it tracks all the changes to the order and the confirmation of such order.</span><p><span class="normal">First we need to create (or also find in a library) the mechanics of the audit trail. It could be something like this;</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580004186">
<div id="Example4"><!-- Example 4 --></div><span class="javaxcode">public interface HasAuditTrail&lt;M&gt;</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;AuditTrail&lt;M&gt; auditTrail();</span><br /><span class="javaxcode">}</span><p><span class="javaxcode">public interface AuditTrail&lt;M&gt; extends Property&lt;List&lt;Action&lt;M&gt;&gt;&gt;</span><br /><span class="javaxcode">{}</span></p><p><span class="javaxcode">public interface Action&lt;T&gt; extends ValueComposite&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2][3]</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;enum Type added, removed, completed;</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;Property&lt;T&gt; item();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1]</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;Property&lt;Type&gt; action();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1]</span><br /><span class="javaxcode">}</span></p><p><span class="javaxcode">public interface Trailable&lt;M&gt;</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;void itemAdded( M item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;void itemRemoved( M item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;void completed();</span><br /><span class="javaxcode">}</span></p><p><span class="javaxcode">public class TrailableMixin&lt;M&gt;</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;implements Trailable&lt;M&gt;</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;private @This HasAuditTrail hasTrail;</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void itemAdded( M item )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addAction( item, Action.Type.added );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void itemRemoved( M item )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addAction( item, Action.Type.removed );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void completed( M item )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addAction( item, Action.Type.completed );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;private Action&lt;M&gt; addAction( M item, Action.Type type )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CompositeBuilder&lt;Action&gt; builder = </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.newCompositeBuilder( Action.class );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[4]</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Action prototype = builder.stateFor( Action.class );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prototype.item().set( item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prototype.action().set( action );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Action instance = builder.newInstance();</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hasTrail.auditTrail().get().add( instance );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580003956">
<div id="Text1"><!-- Text 1 --></div><span class="normal">Quite a lot of Qi4j features are leveraged above;</span><br /><span class="normal"><strong>[1]</strong></span><span class="normal"> Property is a first class citizen in Qi4j, instead of getters/setters naming convention to declare properties.</span><br /><span class="normal"><strong>[2]</strong></span><span class="normal"> ValueComposite for Action means that it is among other things Immutable.</span><br /><span class="normal"><strong>[3]</strong></span><span class="normal"> The Action extends a Property. We call that Property subtyping and highly recommended.</span><br /><span class="normal"><strong>[4]</strong></span><span class="normal"> The CompositeBuilder creates Immutable Action instances.</span><p><span class="normal">We also need a Concern to hang into the methods of the Order interface.</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580003729">
<div id="Text2"><!-- Text 2 --></div><span class="javaxcode">public abstract class OrderAuditTrailConcern</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;extends ConcernOf&lt;Order&gt;</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;implements Order</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;@This Trailable&lt;LineItem&gt; trail;</span><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void addLineItem( LineItem item )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next.addLineItem( item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.itemAdded( item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void removeLineItem( LineItem item )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next.removeLineItem( item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.itemRemoved( item );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void completed()</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next.completed();</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.completed();</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580003535">
<div id="Text3"><!-- Text 3 --></div><span class="normal">In this case, we have chosen to make an Order specific Concern for the more generic AuditTrail subsystem, and would belong in the client (Order) code and not with the library (AuditTrail). </span><br /><span class="normal">Pay attention to the @This annotation for a type that is not present in the Composite type interface. This is called a private Mixin, meaning the Mixin is only reachable from Fragments within the same Composite instance.</span><p><span class="normal">But the AuditTrail subsystem could provide a Generic Concern, that operates on a naming pattern (for instance). In this case, we would move the coding of the concern from the application developer to the library developer, again increasing the re-use value. It could look like this;</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580003290">
<div id="Text4"><!-- Text 4 --></div><span class="javaxcode">public class AuditTrailConcern</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;extends ConcernFor&lt;InvocationHandler&gt;</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;implements InvocationHandler</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;@This Trailable trail;</span><p><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;public void invoke( Object proxy, Method m, Object[] args )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws Exception</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next.invoke( proxy, m, args );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String methodName = m.getName();</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( methodName.startsWith( "add" ) )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.itemAdded( args[0] );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if( methodName.startsWith( "remove" ) )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.itemRemoved( args[0] );</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if( methodName.startsWith( "complete" ) ||</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;methodName.startsWith( "commit" ) )</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trail.completed();</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;}</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580002782">
<div id="Text5"><!-- Text 5 --></div><span class="normal">The above construct is called a Generic Concern, since it implements </span><span class="javaxcode">java.lang.reflect.InvocationHandler</span><span class="normal"> instead of the interface of the domain model. The </span><span class="javaxcode">ConcernOf</span><span class="normal"> baseclass will also need to be of InvocationHandler type, and the Qi4j Runtime will handle the chaining between domain model style and this generic style of interceptor call chain.</span><p><span class="normal">Finally, we need to declare the Concern in the OrderEntity;</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580003403">
<div id="Example5"><!-- Example 5 --></div><span class="javaxcode">@Concerns({</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;AuditTrailConcern.class,</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;PurchaseLimitConcern.class, </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;InventoryConcern.class</span><br /><span class="javaxcode">})</span><br /><span class="javaxcode">@Mixins( TrailableMixin.class )</span><br /><span class="javaxcode">public interface OrderEntity </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;extends Order, HasSequenceNumber, HasCustomer, </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HasLineItems, Confirmable, EntityComposite</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">}</span></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580003738">
<div id="Text6"><!-- Text 6 --></div><span class="normal">We also place it first, so that the AuditTrailConcern will be the first Concern in the interceptor chain (a.k.a InvocationStack), so that in case any of the other Concerns throws an Exception, the AuditTrail is not updated (In fact, the AuditTrail should perhaps be a SideEffect rather than a Concern. It is largely depending on how we define SideEffect, since the side effect in this case is within the composite instance it is a border case.).</span><p><span class="normal">So let's move on to something more complicated. As we have mentioned, EntityComposite is automatically persisted to an underlying store (provided the Runtime is setup with one at bootstrap initialization), but how do I locate an Order? </span><br /><span class="normal">Glad you asked. It is done via the Query API. It is important to understand that Indexing and Query are separated from the persistence concern of storage and retrieval. This enables many performance optimization opportunities as well as a more flexible Indexing strategy. The other thing to understand is that the Query API is using the domain model, in Java, and not some String based query language. We have made this choice to ensure refactoring safety. In rare cases, the Query API is not capable enough, in which case Qi4j still provides the ability to look up and execute native queries.</span></p><p><span class="normal">Let's say that we want to find a particular Order from its SequenceNumber.</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580002915">
<div id="Text7"><!-- Text 7 --></div><br /><span class="javaxcode">import static org.qi4j.api.query.QueryExpressions.eq;</span><br /><span class="javaxcode">import static org.qi4j.api.query.QueryExpressions.templateFor;</span><p><span class="javaxcode">import org.qi4j.api.query.QueryBuilder;</span><br /><span class="javaxcode">import org.qi4j.api.query.QueryBuilderFactory;</span></p><p><span class="javaxcode">:</span></p><p><span class="javaxcode">@Structure private UnitOfWorkFactory uowFactory; //Injected</span></p><p><span class="javaxcode">:</span></p><p><span class="javaxcode">UnitOfWork uow = uowFactory.currentUnitOfWork();</span><br /><span class="javaxcode">QueryBuilderFactory qbf = uow.queryBuilderFactory();</span><br /><span class="javaxcode">QueryBuilder&lt;Order&gt; builder = qbf.newQueryBuilder( Order.class );</span></p><p><span class="javaxcode">String orderNumber = "12345";</span><br /><span class="javaxcode">HasSequenceNumber template = templateFor( HasSequenceNumber.class );</span><br /><span class="javaxcode">builder.where( eq( template.number(), orderNumber ) );</span><br /><span class="javaxcode">Query&lt;Order&gt; query = builder.newQuery();</span></p><p><span class="javaxcode">Iterator&lt;Order&gt; result = query.iterator();</span></p><p><span class="javaxcode">if( result.hasNext() )</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;Order order = result.next();</span><br /><span class="javaxcode">}</span><br /><span class="javaxcode">else</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;// Deal with it wasn't found.</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580003340">
<div id="Text8"><!-- Text 8 --></div><span class="normal">The important bits are;</span><ul class="c87"><li><span class="normal">The QueryExpressions.templateFor() method is used to define the template used in the query upon execution. In this case, we choose to template only the HasSequenceNumber, an interface used in OrderEntity, but is not part of Order (may or may not be a good design choice).</span></li><li><span class="normal">The where() clause, which has a statically imported method eq(), which builds up the expression logic, and will be translated into the underlying query language upon execution, which happens in the iterator() method.</span></li></ul><p><span class="normal">Another example,</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580004223">
<div id="Copy1ofText7"><!-- Copy (1) of Text 7 --></div><span class="javaxcode">QueryBuilder&lt;Order&gt; builder = </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;qbf.newQueryBuilder( Order.class );</span><p><span class="javaxcode">Calendar cal = Calendar.getInstance();</span><br /><span class="javaxcode">cal.setTime( new Date() );</span><br /><span class="javaxcode">Date last90days = cal.roll( Calendar.DAY_OF_MONTH, -90 ); </span><br /><span class="javaxcode">Order template = templateFor( Order.class );</span><br /><span class="javaxcode">builder.where( gt( template.createdDate(), last90days ) );</span><br /><span class="javaxcode">Query&lt;Order&gt; query = builder.newQuery();</span></p><p><span class="javaxcode">for( Order order : query )</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;report.addOrderToReport( order );</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580002840">
<div id="Text9"><!-- Text 9 --></div><span class="normal">In the above case, we find the Orders that has been created in the last 90 days, and add them to a report to be generated. This example assumes that the Order type has a </span><span class="javaxcode"><strong>Property&lt;Date&gt; createdDate()</strong></span><span class="normal"> method.</span><p><span class="normal">Now, Orders has a relation to the CustomerComposite which is also an Entity. Let's create a query for all customers that has made an Order in the last 30 days;</span></p></div>
<div class="c52"></div>
<div class="c73" id="svid12_6f43db4e123f11b409580003848">
<div id="Text10"><!-- Text 10 --></div><span class="javaxcode">QueryBuilder&lt;HasCustomer&gt; builder = </span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;qbf.newQueryBuilder( HasCustomer.class );</span><p><span class="javaxcode">Calendar cal = Calendar.getInstance();</span><br /><span class="javaxcode">cal.setTime( new Date() );</span><br /><span class="javaxcode">Date lastMonth = cal.roll( Calendar.MONTH, -1 ); </span><br /><span class="javaxcode">Order template1 = templateFor( Order.class );</span><br /><span class="javaxcode">builder.</span><span class="javaxcode">where( </span><span class="javaxcode">gt( template1.createdDate(), lastMonth ) );</span><br /><span class="javaxcode">Query&lt;HasCustomer&gt; query = builder.newQuery();</span></p><p><span class="javaxcode">for( HasCustomer hasCustomer : query )</span><br /><span class="javaxcode">{</span><br /><span class="javaxcode">&nbsp;&nbsp;&nbsp;&nbsp;report.addCustomerToReport( hasCustomer.customer().get() );</span><br /><span class="javaxcode">}</span></p></div>
<div class="c52"></div>
<div id="svid12_6f43db4e123f11b409580004122">
<div id="Text11"><!-- Text 11 --></div><span class="normal">This covers the most basic Query capabilities and how to use it. For Querying to work, an Indexing subsystem must be assembled during bootstrap. At the time of this writing, only an RDF indexing subsystem exist, and is added most easily by </span><span class="javaxcode"><strong>assembly.addAssembler( new RdfNativeSesameStoreAssembler() )</strong></span><span class="normal">.</span><p><span class="normal">It can be a bit confusing to see Qi4j use Java itself as a Query language, but since we have practically killed the classes and only operate with interfaces, it is possible to do a lot of seemingly magic stuff. Just keep in mind that it is pure Java, albeit heavy use of dynamic proxies to capture the </span><span class="normal"><strong>intent</strong></span><span class="normal"> of the query.</span></p><p><!-- empty --></p><div id="h-Conclusion" class="sv-inline"><!-- Conclusion --></div><h2 class="subheading">Conclusion</h2><p><span class="normal">We have now explored a couple more intricate features of Qi4j, hopefully without being overwhelmed with details on how to create applications from scratch, how to structure applications, and how the entire Qi4j Extension system works.</span><br /><span class="normal">We have looked at how to add a Concern that uses a private Mixin, we have touched a bit on Generic Concerns, and finally a short introduction to the Query API.</span></p></div>
</div><!-- Page content stops here --></div>
</div></div>
<div class="c11"></div>
</div>
</div></div>
<div class="c44" id="svid10_6f43db4e123f11b409580004680">
<div class="c45" id="svid12_6f43db4e123f11b409580004800">
<div id="TrademarkNotice"><!-- Trademark Notice --></div><br /><span class="normal">Qi4j and the Qi4j logo are trademarks of Richard Ã–berg, Niclas Hedhman and the members of the Qi4j Core Team. See </span><a class="normal" title="Link to licensing." href="21.html">Qi4j licensing</a><span class="normal"> for more information.</span></div>
<div class="c46" id="svid12_6f43db4e123f11b409580004768">
<div id="Poweredby"><!-- Powered by --></div><span class="normal">Powered by </span><a class="normal" title="SiteVision official page (external link)" href="http://www.sitevision.se/">SiteVision<img alt="external link" src="../sitevision/util/images/externallink.png" class="c39" /></a><span class="normal">.</span></div>
<div class="c47" id="svid12_6f43db4e123f11b409580004801">
<div id="HTML-0"><!-- HTML --></div><script>
</script>
<script type="text/javascript">


</script>
</div>
</div>
</div>
</div>
<script type="text/javascript">parent.print();</script><noscript><!-- Starts a printout of this page --></noscript>


  
 



   </body>
</html>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title></title><link rel="stylesheet" type="text/css" href="docbook-xsl.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.76.1" />


<!-- favicon -->

<link rel="shortcut icon" href="http://qi4j.org/favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="icon" href="http://qi4j.org/favicon.ico" type="image/x-icon" />

<!-- style -->

<link href="css/shCore.css" rel="stylesheet" type="text/css" />
<link href="css/shCoreEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/shThemeEclipse.css" rel="stylesheet" type="text/css" />
<link href="css/qi4j.css" rel="stylesheet" type="text/css" />

<!-- Syntax Highlighter -->

<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript" src="js/shBrushScala.js"></script>
<script type="text/javascript" src="js/shBrushJScript.js"></script>
<script type="text/javascript" src="js/shBrushBash.js"></script>
<script type="text/javascript" src="js/shBrushPlain.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushGroovy.js"></script>
<script type="text/javascript" src="js/shBrushPython.js"></script>
<script type="text/javascript" src="js/shBrushRuby.js"></script>
<script type="text/javascript" src="js/shBrushCSharp.js"></script>

<script type="text/javascript">
  SyntaxHighlighter.defaults['tab-size'] = 4;
  SyntaxHighlighter.defaults['gutter'] = false;
  SyntaxHighlighter.defaults['toolbar'] = false;
  SyntaxHighlighter.all()
</script>

<!-- JQuery -->

<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>

<!-- Image Scaler -->

<script type="text/javascript" src="js/imagescaler.js"></script>

<!-- Table Styler -->

<script type="text/javascript" src="js/tablestyler.js"></script>


</head><body><div xml:lang="en" class="article" lang="en"><div class="titlepage"><hr /></div><div class="toc"><p><strong>Table of Contents</strong></p><dl><dt><span class="section"><a href="#home">1. Home</a></span></dt><dd><dl><dt><span class="section"><a href="#_what_is_qi4j">1.1. What is Qi4j™?</a></span></dt><dt><span class="section"><a href="#_principles">1.2. Principles</a></span></dt><dt><span class="section"><a href="#_behavior_depends_on_context">1.3. Behavior Depends on Context</a></span></dt><dt><span class="section"><a href="#_decoupling_is_virtue">1.4. Decoupling is Virtue</a></span></dt><dt><span class="section"><a href="#_business_rules_matters_more">1.5. Business Rules matters more</a></span></dt></dl></dd><dt><span class="section"><a href="#news">2. News</a></span></dt><dd><dl><dt><span class="section"><a href="#_news_amp_events">2.1. News &amp; Events</a></span></dt><dt><span class="section"><a href="#news-20120525">2.2. New Qi4j website!</a></span></dt><dt><span class="section"><a href="#news-20120502">2.3. Qi4j’s Future</a></span></dt><dt><span class="section"><a href="#news-20120215">2.4. @ JFokus 2012 - ReST</a></span></dt><dt><span class="section"><a href="#news-20110806">2.5. Qi4j SDK Release 1.4</a></span></dt><dt><span class="section"><a href="#news-20110415">2.6. Qi4j SDK Release 1.3</a></span></dt><dt><span class="section"><a href="#news-20110221">2.7. Qi4j moves to Gradle</a></span></dt><dt><span class="section"><a href="#news-20101023">2.8. Qi4j SDK 1.2 Released</a></span></dt><dt><span class="section"><a href="#news-20100918">2.9. @ JavaZone 2010 - ReST/DCI</a></span></dt><dt><span class="section"><a href="#news-20100830">2.10. @ Apache Roadshow Shanghai</a></span></dt><dt><span class="section"><a href="#news-20100617">2.11. Qi4j SDK 1.1 is out!</a></span></dt><dt><span class="section"><a href="#news-20100128">2.12. Qi4j SDK 1.0 has been released!</a></span></dt><dt><span class="section"><a href="#news-20100125-2">2.13. @ Øredev 2009 - DCI</a></span></dt><dt><span class="section"><a href="#news-20100125">2.14. Quicker Frameworks</a></span></dt><dt><span class="section"><a href="#news-20090903">2.15. @ JavaZone 2009 - Persistence</a></span></dt><dt><span class="section"><a href="#news-20090510">2.16. @ JFokus 2009 - COP/DDD</a></span></dt><dt><span class="section"><a href="#news-20090420">2.17. Qi4j 0.7 Released</a></span></dt><dt><span class="section"><a href="#news-20090220">2.18. Qi4j 0.6 Released</a></span></dt><dt><span class="section"><a href="#news-20090219">2.19. DDD support in Qi4j explained</a></span></dt><dt><span class="section"><a href="#news-20090110">2.20. @ Årskonference 2009</a></span></dt><dt><span class="section"><a href="#news-20090109">2.21. Qi4j 0.5 Released</a></span></dt><dt><span class="section"><a href="#news-20081117">2.22. @ Øredev 2008 - Qi4j</a></span></dt><dt><span class="section"><a href="#news-20080919">2.23. Qi4j 0.4 Released</a></span></dt><dt><span class="section"><a href="#news-20080915">2.24. @ JavaZone 2008 - COP/Qi4j</a></span></dt><dt><span class="section"><a href="#news-20080808">2.25. Qi4j 0.3 Released</a></span></dt><dt><span class="section"><a href="#news-20080606">2.26. Qi4j 0.2 Released</a></span></dt><dt><span class="section"><a href="#news-20080414">2.27. Qi4j 0.1 Released</a></span></dt><dt><span class="section"><a href="#news-20080130">2.28. @ JFokus 2008 - COP</a></span></dt><dt><span class="section"><a href="#news-20071113">2.29. @ Øredev 2007 - COP</a></span></dt></dl></dd><dt><span class="section"><a href="#tutorials">3. Tutorials</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview">3.1. Overview</a></span></dt><dt><span class="section"><a href="#two-minutes-intro">3.2. Qi4j in 2 minutes</a></span></dt><dt><span class="section"><a href="#ten-minutes-intro">3.3. Qi4j in 10 minutes</a></span></dt><dt><span class="section"><a href="#thirty-minutes-intro">3.4. Qi4j in 30 minutes</a></span></dt><dt><span class="section"><a href="#two-hours-intro">3.5. Qi4j in 2 hours</a></span></dt><dt><span class="section"><a href="#introduction-background">3.6. Background</a></span></dt><dt><span class="section"><a href="#what-is-cop">3.7. What is COP?</a></span></dt><dt><span class="section"><a href="#qi4j-cop">3.8. COP with Java and Qi4j</a></span></dt><dt><span class="section"><a href="#state-modeling">3.9. Qi4j and state modeling</a></span></dt><dt><span class="section"><a href="#what-s-an-object-anyway">3.10. What’s an Object anyway?</a></span></dt><dt><span class="section"><a href="#tut-composites">3.11. Transient Composites Tutorial</a></span></dt><dt><span class="section"><a href="#tut-services">3.12. Services Composites Tutorial</a></span></dt><dt><span class="section"><a href="#howto-depend-on-qi4j">3.13. Depend on Qi4j in your build</a></span></dt><dt><span class="section"><a href="#howto-assemble-application">3.14. Assemble an Application</a></span></dt><dt><span class="section"><a href="#howto-configure-service">3.15. Configure a Service</a></span></dt><dt><span class="section"><a href="#howto-create-entity">3.16. Create an Entity</a></span></dt><dt><span class="section"><a href="#howto-create-constraint">3.17. Create a Constraint</a></span></dt><dt><span class="section"><a href="#howto-create-concern">3.18. Create a Concern</a></span></dt><dt><span class="section"><a href="#howto-create-sideeffect">3.19. Create a SideEffect</a></span></dt><dt><span class="section"><a href="#howto-leverage-properties">3.20. Leverage Properties</a></span></dt><dt><span class="section"><a href="#howto-contextual-fragments">3.21. Use contextual fragments</a></span></dt><dt><span class="section"><a href="#howto-use-io">3.22. Use I/O API</a></span></dt><dt><span class="section"><a href="#related">3.23. Related publications &amp; projects</a></span></dt></dl></dd><dt><span class="section"><a href="#javadocs">4. Javadoc</a></span></dt><dt><span class="section"><a href="#samples">5. Samples</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_2">5.1. Overview</a></span></dt><dt><span class="section"><a href="#sample-dci">5.2. DCI Sample</a></span></dt><dt><span class="section"><a href="#sample-dci-cargo">5.3. DCI Cargo Sample</a></span></dt><dt><span class="section"><a href="#sample-forum">5.4. Forum Sample</a></span></dt><dt><span class="section"><a href="#sample-car-rental">5.5. Car Rental Sample</a></span></dt><dt><span class="section"><a href="#sample-scala">5.6. Scala Sample</a></span></dt><dt><span class="section"><a href="#sample-sql-support">5.7. SQL Support Sample</a></span></dt><dt><span class="section"><a href="#sample-struts2">5.8. Struts2 Sample</a></span></dt><dt><span class="section"><a href="#sample-swing">5.9. Swing Bindings Sample</a></span></dt></dl></dd><dt><span class="section"><a href="#core">6. Core</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_3">6.1. Overview</a></span></dt><dt><span class="section"><a href="#core-api">6.2. Core API</a></span></dt><dt><span class="section"><a href="#core-bootstrap-assembly">6.3. Core Bootstrap</a></span></dt><dt><span class="section"><a href="#core-testsupport">6.4. Core Test Support</a></span></dt><dt><span class="section"><a href="#core-functional">6.5. Core Functional API</a></span></dt><dt><span class="section"><a href="#core-io">6.6. Core I/O API</a></span></dt><dt><span class="section"><a href="#core-spi">6.7. Core Extension SPI</a></span></dt></dl></dd><dt><span class="section"><a href="#libraries">7. Libraries</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_4">7.1. Overview</a></span></dt><dt><span class="section"><a href="#library-alarm">7.2. Alarms</a></span></dt><dt><span class="section"><a href="#library-caching">7.3. Caching</a></span></dt><dt><span class="section"><a href="#library-circuitbreaker">7.4. Circuit Breaker</a></span></dt><dt><span class="section"><a href="#library-constraints">7.5. Constraints</a></span></dt><dt><span class="section"><a href="#library-conversion">7.6. Conversion</a></span></dt><dt><span class="section"><a href="#library-cxf">7.7. CXF WebService</a></span></dt><dt><span class="section"><a href="#library-eventsourcing">7.8. Event Sourcing</a></span></dt><dt><span class="section"><a href="#library-eventsourcing-jdbm">7.9. Event Sourcing - JDBM</a></span></dt><dt><span class="section"><a href="#library-eventsourcing-rest">7.10. Event Sourcing - ReST</a></span></dt><dt><span class="section"><a href="#library-fileconfig">7.11. FileConfig</a></span></dt><dt><span class="section"><a href="#library-http">7.12. HTTP</a></span></dt><dt><span class="section"><a href="#library-jmx">7.13. JMX</a></span></dt><dt><span class="section"><a href="#library-locking">7.14. Locking</a></span></dt><dt><span class="section"><a href="#library-logging">7.15. Logging</a></span></dt><dt><span class="section"><a href="#library-neo4j">7.16. Neo4j</a></span></dt><dt><span class="section"><a href="#library-osgi">7.17. OSGi</a></span></dt><dt><span class="section"><a href="#library-rdf">7.18. RDF</a></span></dt><dt><span class="section"><a href="#library-rest-client">7.19. ReST Client</a></span></dt><dt><span class="section"><a href="#library-rest-client-primer">7.20. ReST - HATEOAS Primer</a></span></dt><dt><span class="section"><a href="#library-rest-common">7.21. ReST Common</a></span></dt><dt><span class="section"><a href="#library-rest-server">7.22. ReST Server</a></span></dt><dt><span class="section"><a href="#library-scheduler">7.23. Scheduler</a></span></dt><dt><span class="section"><a href="#library-script-beanshell">7.24. Beanshell Scripting</a></span></dt><dt><span class="section"><a href="#library-script-groovy">7.25. Groovy Scripting</a></span></dt><dt><span class="section"><a href="#library-script-javascript">7.26. Javascript Scripting</a></span></dt><dt><span class="section"><a href="#library-script-jruby">7.27. JRuby Scripting</a></span></dt><dt><span class="section"><a href="#lang-scala">7.28. Scala Support</a></span></dt><dt><span class="section"><a href="#library-servlet">7.29. Servlet</a></span></dt><dt><span class="section"><a href="#library-shiro">7.30. Shiro Security</a></span></dt><dt><span class="section"><a href="#library-shiro-web">7.31. Shiro Web Security</a></span></dt><dt><span class="section"><a href="#library-spring">7.32. Spring Integration</a></span></dt><dt><span class="section"><a href="#library-sql">7.33. SQL</a></span></dt><dt><span class="section"><a href="#library-struts-codebehind">7.34. Struts - Code Behind</a></span></dt><dt><span class="section"><a href="#library-struts-convention">7.35. Struts - Convention</a></span></dt><dt><span class="section"><a href="#library-struts-plugin">7.36. Struts - Plugin</a></span></dt><dt><span class="section"><a href="#library-uid">7.37. UID</a></span></dt><dt><span class="section"><a href="#library-uowfile">7.38. UoWFile</a></span></dt></dl></dd><dt><span class="section"><a href="#extensions">8. Extensions</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_6">8.1. Overview</a></span></dt><dt><span class="section"><a href="#extension-cache-ehcache">8.2. Ehcache Cache</a></span></dt><dt><span class="section"><a href="#extension-es-file">8.3. File EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-gae">8.4. Google AppEngine EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-hazelcast">8.5. Hazelcast EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-jclouds">8.6. JClouds EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-jdbm">8.7. JDBM EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-leveldb">8.8. LevelDB EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-mongodb">8.9. MongoDB EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-neo4j">8.10. Neo4j EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-preferences">8.11. Preferences EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-redis">8.12. Redis EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-riak">8.13. Riak EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-sql">8.14. SQL EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-voldemort">8.15. Voldemort EntityStore</a></span></dt><dt><span class="section"><a href="#extension-index-elasticsearch">8.16. ElasticSearch Index/Query</a></span></dt><dt><span class="section"><a href="#extension-index-rdf">8.17. OpenRDF Index/Query</a></span></dt><dt><span class="section"><a href="#extension-index-solr">8.18. Apache Solr Index/Query</a></span></dt><dt><span class="section"><a href="#extension-indexing-sql">8.19. SQL Index/Query</a></span></dt><dt><span class="section"><a href="#extension-metrics-yammer">8.20. Yammer Metrics</a></span></dt><dt><span class="section"><a href="#extension-migration">8.21. Migration</a></span></dt><dt><span class="section"><a href="#extension-reindexer">8.22. Reindexer</a></span></dt></dl></dd><dt><span class="section"><a href="#tools">9. Tools</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview_7">9.1. Overview</a></span></dt><dt><span class="section"><a href="#tools-envisage">9.2. Envisage</a></span></dt><dt><span class="section"><a href="#tools-entity-viewer">9.3. Entity Viewer</a></span></dt></dl></dd><dt><span class="section"><a href="#glossary">10. Glossary </a></span></dt><dt><span class="section"><a href="#community">11. Community</a></span></dt><dd><dl><dt><span class="section"><a href="#community-intro">11.1. Introduction</a></span></dt><dt><span class="section"><a href="#download">11.2. Download Qi4j</a></span></dt><dt><span class="section"><a href="#help">11.3. Get Help</a></span></dt><dt><span class="section"><a href="#codebase">11.4. Codebase</a></span></dt><dt><span class="section"><a href="#participate">11.5. Participate</a></span></dt><dt><span class="section"><a href="#playing-field">11.6. Playing Field</a></span></dt><dt><span class="section"><a href="#community-contributing">11.7. Contributing to Qi4j</a></span></dt><dt><span class="section"><a href="#issue-tracker">11.8. Issue Tracker</a></span></dt><dt><span class="section"><a href="#build-system">11.9. Build System</a></span></dt><dt><span class="section"><a href="#continuous-integration">11.10. Continuous Integration</a></span></dt><dt><span class="section"><a href="#contributors">11.11. People behind Qi4j</a></span></dt><dt><span class="section"><a href="#licensing">11.12. Licensing</a></span></dt><dt><span class="section"><a href="#licensing-faq">11.13. Licensing FAQ</a></span></dt><dt><span class="section"><a href="#community-docs">11.14. Writing Qi4j Documentation</a></span></dt></dl></dd></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="home"></a>1. Home</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_what_is_qi4j">1.1. What is Qi4j™?</a></span></dt><dt><span class="section"><a href="#_principles">1.2. Principles</a></span></dt><dt><span class="section"><a href="#_behavior_depends_on_context">1.3. Behavior Depends on Context</a></span></dt><dt><span class="section"><a href="#_decoupling_is_virtue">1.4. Decoupling is Virtue</a></span></dt><dt><span class="section"><a href="#_business_rules_matters_more">1.5. Business Rules matters more</a></span></dt></dl></div><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Qi4j™ SDK 2.0 is under development. Six alphas versions later we are aiming at the first release candidate. If you
want to use 2.0 you can download builds from Qi4j™ <a class="link" href="#continuous-integration" title="11.10.&#xA0;Continuous Integration">continuous integration</a> or
<a class="link" href="#build-system" title="11.9.&#xA0;Build System">build</a> the Qi4j™ SDK from <a class="link" href="#codebase" title="11.4.&#xA0;Codebase">source</a>. Join the Google Groups <a class="link" href="#google-groups" title="Google Groups qi4j-dev forum">qi4j-dev forum</a>
to discuss and get help, or help others on <a class="ulink" href="http://stackoverflow.com/questions/tagged/qi4j" target="_top">Stackoverflow</a>.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_what_is_qi4j"></a>1.1. What is Qi4j™?</h3></div></div></div><p>The short answer is that Qi4j™ is a framework for domain centric application development, including evolved concepts
from <a class="ulink" href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_top">AOP</a>,
<a class="ulink" href="http://en.wikipedia.org/wiki/Dependency_injection" target="_top">DI</a> and <a class="ulink" href="http://en.wikipedia.org/wiki/Domain-driven_design" target="_top">DDD</a>.</p><p>Qi4j™ is an implementation of Composite Oriented Programming, using the standard Java 5 platform, without the use of
any pre-processors or new language elements. Everything you know from Java 5 still applies and you can leverage both
your experience and toolkits to become more productive with Composite Oriented Programming today.</p><p>Moreover, Qi4j™ enables Composite Oriented Programming on the Java platform, including both Java and Scala as primary
languages as well as many of the plethora of languages running on the JVM as bridged languages.</p><div class="caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/admon/caution.png" /></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>This website relates to the upcoming Qi4j™ SDK 2.0. The website related to stable
<a class="ulink" href="http://www2.qi4j.org/" target="_top">Qi4j™ SDK 1.4.x</a> is still available.</p></td></tr></table></div><p><span class="inlinemediaobject"><img src="images/intro-qi.png" alt="Qi" /></span></p><p>Qi4j™ is pronounced "chee for jay". This website is out of scope to explain the many
facets and history of Qi, so we refer the interested to read the <a class="ulink" href="http://en.wikipedia.org/wiki/Qi" target="_top">lengthy article</a> at
Wikipedia. For us, Qi is the force/energy within the body, in this case the Java platform. Something that makes Java
so much better, if it is found and channeled into a greater good.</p><p>We strongly recommend the Background article found in the <a class="xref" href="#tutorials-intro" title="Introduction to Qi4j">Introduction to Qi4j</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_principles"></a>1.2. Principles</h3></div></div></div><p>Composite Oriented Programming builds on some principles that are not addressed by Object Oriented Programming at all.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Behavior depends on Context
</li><li class="listitem">
Decoupling is a virtue
</li><li class="listitem">
Business Rules matters more.
</li><li class="listitem">
Classes are dead, long live interfaces.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_behavior_depends_on_context"></a>1.3. Behavior Depends on Context</h3></div></div></div><p>Many objects has life cycles that are more extensive than the simple model that Object Oriented Programming model wants
us to believe. A few simple examples;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
An egg becomes a chicken which in turn becomes food.
</li><li class="listitem">
I am a programmer at work, a father+husband at home, a victim in a traffic accident and hunter and pray in the jungle.
</li></ul></div><p>But it is more to it than that. The composition of the object may change over time. My home now has a garage and my car
have different kind of problems with their own state related to it.</p><p>In the programming world, we are constantly faced with change of requirements. These changes are often not related to
any real world changes, but people coming to new insights of the problem domain. OOP makes those changes a big deal,
and often we have to tear up large chunks of the model and redo the work.</p><p>But wait, there is more.</p><p>Some objects traverses different scope boundaries to the extreme. For instance, a Person will have its attributes
changing slightly over time, new abilities be learnt and so forth, that is mentioned above. But the Person will
eventually die, but that doesn’t mean that the Person object should be deleted from a system, since the "memory of"
that Person may live on for a long time. In a OOP system, we would need to transfer some of the state from a
LivingPerson class to a DeadPerson class. In Composite Oriented Programming, it is the same object with different
behavior.</p><p>We think that one of the the main flaws in OOP is that it is not object oriented at all, but in fact class oriented.
Class is the first class citizen that objects are derived from. Not objects being the first-class citizen to which
one or many classes are assigned.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_decoupling_is_virtue"></a>1.4. Decoupling is Virtue</h3></div></div></div><p>Decoupling is more important than developers in general think. If you could have every OOP class decoupled from all
other classes, it is easy to re-use that class. But when that class references another class and the chain never ends,
your chances of re-use diminishes quickly.</p><p>Object Oriented Programming is suffering a lot from this, and many mechanisms have been introduced over time to counter
this problem. But in reality, the best we can manage is subsystems of functionality, which client code can re-use. And
these subsystems tend to be infrastructure related, since domain models are less prone to be similar enough from one
project to the next, and since OOP in reality constrains the the re-use of individual domain classes, we need to re-do
the domain model from scratch ever time.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_business_rules_matters_more"></a>1.5. Business Rules matters more</h3></div></div></div><p>Smart developers often think that low-level, infrastructure and framework code is more important and more cool to work
with, than the simple domain model. But in reality, it is the Domain Model that reflects the actual need  and pays the
bills. Infrastructure is just a necessary evil to get things done.</p><p>If most developers could focus on the Business Rules and Domain Model, and not having to worry about any infrastructure
issues, such as persistence, transactions, security or the framework housing it all, the productivity would surge. Eric
Evans has written an excellent book about Domain Driven Design, where he goes through the real process that makes the
money for companies. However, it is very hard to follow that book, since one is constantly caught up in constraints
irrelevant to the domain model, introduced by the underlying framework, from the so called smart developers.</p><p><span class="inlinemediaobject"><img src="images/classes-are-dead.gif" alt="classes-are-dead.gif" /></span></p><p>Qi4j™ is trying to address the flaws of OOP and introduce Composite Oriented Programming to the world, without
introducing new programming languages, or awkward constructs. Heck, we don’t even use any XML.</p><p>Qi4j™ is not a framework. It is a new way to write code. Other people might create frameworks using Qi4j™, or create a
framework optimized for Qi4j™, but here at Qi4j™ we concentrate to make Qi4j™ behave well in existing frameworks,
application servers, platforms and environments.</p><p>You are to embark on a new journey. Enjoy!</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="news"></a>2. News</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_news_amp_events">2.1. News &amp; Events</a></span></dt><dt><span class="section"><a href="#news-20120525">2.2. New Qi4j website!</a></span></dt><dt><span class="section"><a href="#news-20120502">2.3. Qi4j’s Future</a></span></dt><dt><span class="section"><a href="#news-20120215">2.4. @ JFokus 2012 - ReST</a></span></dt><dt><span class="section"><a href="#news-20110806">2.5. Qi4j SDK Release 1.4</a></span></dt><dt><span class="section"><a href="#news-20110415">2.6. Qi4j SDK Release 1.3</a></span></dt><dt><span class="section"><a href="#news-20110221">2.7. Qi4j moves to Gradle</a></span></dt><dt><span class="section"><a href="#news-20101023">2.8. Qi4j SDK 1.2 Released</a></span></dt><dt><span class="section"><a href="#news-20100918">2.9. @ JavaZone 2010 - ReST/DCI</a></span></dt><dt><span class="section"><a href="#news-20100830">2.10. @ Apache Roadshow Shanghai</a></span></dt><dt><span class="section"><a href="#news-20100617">2.11. Qi4j SDK 1.1 is out!</a></span></dt><dt><span class="section"><a href="#news-20100128">2.12. Qi4j SDK 1.0 has been released!</a></span></dt><dt><span class="section"><a href="#news-20100125-2">2.13. @ Øredev 2009 - DCI</a></span></dt><dt><span class="section"><a href="#news-20100125">2.14. Quicker Frameworks</a></span></dt><dt><span class="section"><a href="#news-20090903">2.15. @ JavaZone 2009 - Persistence</a></span></dt><dt><span class="section"><a href="#news-20090510">2.16. @ JFokus 2009 - COP/DDD</a></span></dt><dt><span class="section"><a href="#news-20090420">2.17. Qi4j 0.7 Released</a></span></dt><dt><span class="section"><a href="#news-20090220">2.18. Qi4j 0.6 Released</a></span></dt><dt><span class="section"><a href="#news-20090219">2.19. DDD support in Qi4j explained</a></span></dt><dt><span class="section"><a href="#news-20090110">2.20. @ Årskonference 2009</a></span></dt><dt><span class="section"><a href="#news-20090109">2.21. Qi4j 0.5 Released</a></span></dt><dt><span class="section"><a href="#news-20081117">2.22. @ Øredev 2008 - Qi4j</a></span></dt><dt><span class="section"><a href="#news-20080919">2.23. Qi4j 0.4 Released</a></span></dt><dt><span class="section"><a href="#news-20080915">2.24. @ JavaZone 2008 - COP/Qi4j</a></span></dt><dt><span class="section"><a href="#news-20080808">2.25. Qi4j 0.3 Released</a></span></dt><dt><span class="section"><a href="#news-20080606">2.26. Qi4j 0.2 Released</a></span></dt><dt><span class="section"><a href="#news-20080414">2.27. Qi4j 0.1 Released</a></span></dt><dt><span class="section"><a href="#news-20080130">2.28. @ JFokus 2008 - COP</a></span></dt><dt><span class="section"><a href="#news-20071113">2.29. @ Øredev 2007 - COP</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_news_amp_events"></a>2.1. News &amp; Events</h3></div></div></div><div class="informaltable"><table cellspacing="0" cellpadding="0" border="1"><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th align="left" valign="top">Date </th><th align="left" valign="top">Announcement</th></tr></thead><tbody><tr><td align="left" valign="top"><p>2012-May-25</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20120525" title="2.2.&#xA0;New Qi4j website!">Qi4j launches new website</a></p></td></tr><tr><td align="left" valign="top"><p>2012-May-07</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20120502" title="2.3.&#xA0;Qi4j&#x2019;s Future">Qi4j Future</a></p></td></tr><tr><td align="left" valign="top"><p>2012-Feb-15</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20120215" title="2.4.&#xA0;@ JFokus 2012 - ReST">Qi4j at JFokus 2012 - ReST</a></p></td></tr><tr><td align="left" valign="top"><p>2011-Aug-06</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20110806" title="2.5.&#xA0;Qi4j SDK Release 1.4">Qi4j SDK Release 1.4</a></p></td></tr><tr><td align="left" valign="top"><p>2011-Apr-15</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20110415" title="2.6.&#xA0;Qi4j SDK Release 1.3">Qi4j SDK Release 1.3</a></p></td></tr><tr><td align="left" valign="top"><p>2011-Feb-21</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20110221" title="2.7.&#xA0;Qi4j moves to Gradle">Qi4j moves to Gradle</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Oct-23</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20101023" title="2.8.&#xA0;Qi4j SDK 1.2 Released">Qi4j SDK 1.2 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Sep-18</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100918" title="2.9.&#xA0;@ JavaZone 2010 - ReST/DCI">Qi4j at JavaZone 2010 - ReST/DCI</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Aug-30</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100830" title="2.10.&#xA0;@ Apache Roadshow Shanghai">Qi4j at Apache Roadshow Shanghai</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Jun-17</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100617" title="2.11.&#xA0;Qi4j SDK 1.1 is out!">Qi4j SDK 1.1 is out!</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Jan-28</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100128" title="2.12.&#xA0;Qi4j SDK 1.0 has been released!">Qi4j SDK 1.0 has been released!</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Jan-25</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100125-2" title="2.13.&#xA0;@ &#xD8;redev 2009 - DCI">Qi4j at Øredev 2009 : DCI in practice</a></p></td></tr><tr><td align="left" valign="top"><p>2010-Jan-25</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20100125" title="2.14.&#xA0;Quicker Frameworks">Rickard about Quicker Frameworks on the DDD website</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Sep-03</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090903" title="2.15.&#xA0;@ JavaZone 2009 - Persistence">Qi4j Persistence at JavaZone 2009</a></p></td></tr><tr><td align="left" valign="top"><p>2009-May-10</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090510" title="2.16.&#xA0;@ JFokus 2009 - COP/DDD">Qi4j at JFokus 2009 - COP/DDD</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Apr-20</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090420" title="2.17.&#xA0;Qi4j 0.7 Released">Qi4j 0.7 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Feb-20</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090220" title="2.18.&#xA0;Qi4j 0.6 Released">Qi4j 0.6 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Feb-19</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090219" title="2.19.&#xA0;DDD support in Qi4j explained">Rickard explains DDD support in Qi4j</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Jan-10</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090110" title="2.20.&#xA0;@ &#xC5;rskonference 2009">Qi4j at Årskonference 2009</a></p></td></tr><tr><td align="left" valign="top"><p>2009-Jan-09</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20090109" title="2.21.&#xA0;Qi4j 0.5 Released"> Qi4j 0.5 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Nov-17</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20081117" title="2.22.&#xA0;@ &#xD8;redev 2008 - Qi4j">Qi4j at Øredev 2008</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Sep-19</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080919" title="2.23.&#xA0;Qi4j 0.4 Released">Qi4j 0.4 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Sep-15</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080915" title="2.24.&#xA0;@ JavaZone 2008 - COP/Qi4j">Qi4j at JavaZone 2008 - COP/Qi4j</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Aug-08</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080808" title="2.25.&#xA0;Qi4j 0.3 Released">Qi4j 0.3 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Jun-06</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080606" title="2.26.&#xA0;Qi4j 0.2 Released">Qi4j 0.2 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Apr-14</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080414" title="2.27.&#xA0;Qi4j 0.1 Released">Qi4j 0.1 Released</a></p></td></tr><tr><td align="left" valign="top"><p>2008-Jan-30</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20080130" title="2.28.&#xA0;@ JFokus 2008 - COP">Qi4j at JFokus 2008 - COP</a></p></td></tr><tr><td align="left" valign="top"><p>2007-Nov-13</p></td><td align="left" valign="top"><p><a class="xref" href="#news-20071113" title="2.29.&#xA0;@ &#xD8;redev 2007 - COP">Qi4j at Øredev 2007 - COP</a></p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20120525"></a>2.2. New Qi4j website!</h3></div></div></div><p>After years with SiteVision from Senselogic, the Qi4j community has decided that SiteVision does not fulfill the needs
of this community. Primarily, SiteVision can not satisfy some really central needs of open source communities;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Learning curve for SiteVision is higher than plain text tool chains.
</li><li class="listitem">
Offline editing is not possible.
</li><li class="listitem">
Distance between Sitevision server and users introduce network latencies that makes the SiteVision experience less
than optimal.
</li><li class="listitem">
Versioning is non-trivial. Keeping old versions of the site up and running in parallel will be important as users
seek information about older versions of the Qi4j SDK online.
</li><li class="listitem">
Integration with build system and codebase in general is fairly complex process.
</li></ul></div><p>We are therefor saying a <span class="strong"><strong>Big THANK YOU</strong></span> to Senselogic and SiteVision for the time past, but we are now excited in
moving forward with a new website and an underlying toolchain for it.</p><p>The site is completely static (for now), and is built from AsciiDoc plain text documents, plus various build-time
integrations with the codebase, such as code snippets, and we will expand on this in the future, including
<span class="emphasis"><em>development status</em></span> (dev-status.xml), any version available on website, automatic example output capturing and
much more. We also hope to be able to integrate <span class="strong"><strong>Disqus</strong></span> for user commentary on every page.</p><p>Already, prior to launching the new site, the new toolchain has already proven itself worthy, as much more content
has been generated by the community within a short period of time.</p><p>"I think this is a great leap forward for us. Although content management systems are powerful, they don’t serve
the open source community needs very well.", says Niclas Hedhman, one of the Qi4j Core Team members.</p><p>"We have tried to provide a styling format that works across a large set of browsers, operating systems and devices.",
says Paul Merlin, another Core Team member who placed the final touches on the design.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_enjoy_the_new_website"></a>Enjoy the new website</h4></div></div></div><p>Any feedback is welcome, either on GitHub or qi4j-dev forum at Google Groups.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20120502"></a>2.3. Qi4j’s Future</h3></div></div></div><p>Lately, the activity in Qi4j community has been fading. Key members of the community have been caught up in many
different activities outside this community, from changing jobs to have additional personal commitments piling up.</p><p>Speculation has been circulating whether Qi4j will simply die.</p><p>Today, some of the community leaders met and decided to step up and start forging this project forward. There are
a few immediate points which will be addressed first;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
New website. Sitevision is causing more problems than it solves for us.
</li><li class="listitem">
Documentation. It has always been lacking, partly due to Sitevision’s barrier to editing. With plain text documentation
developers no longer have an excuse not to document the features in Qi4j.
</li><li class="listitem">
Roadmap to 2.0. Establish the features we want to incorporate and have done before 2.0. Effectively ensuring that
all compatibility breaking features are included.
</li></ul></div><p>We hope that these future efforts will re-instill confidence in the viability of Qi4j in your projects.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20120215"></a>2.4. @ JFokus 2012 - ReST</h3></div></div></div><p>Implementing a REST API today is important in many cases, both as an integration point to your application and as a way
for clients to access the application. But there are few frameworks out there that help you fulfil all the constraints
of REST, and therefore only makes your API a REST-wannabe. The idiom that’s often missing is HATEOAS. This session will
look at how you can build a ReSTful api and applying HATEOAS. The background of this session is the <a class="xref" href="#news-20100918" title="2.9.&#xA0;@ JavaZone 2010 - ReST/DCI">Qi4j at JavaZone 2010 - ReST/DCI</a>
presentation.</p><p><a class="ulink" href="http://www.parleys.com/#st=5&amp;id=3059&amp;sl=6" target="_top">Watch the video</a></p><p>Check the presentation slides online
<a class="ulink" href="http://www.jfokus.se/jfokus12/preso/jf12_TheRoadToRest.pdf" target="_top">http://www.jfokus.se/jfokus12/preso/jf12_TheRoadToRest.pdf</a></p><p>On a related note, back in december 2012, Rickard posted "The domain model as REST anti-pattern" in his
blog: <a class="ulink" href="http://www.jroller.com/rickard/entry/the_domain_model_as_rest" target="_top">http://www.jroller.com/rickard/entry/the_domain_model_as_rest</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20110806"></a>2.5. Qi4j SDK Release 1.4</h3></div></div></div><p>Shanghai, 5 Aug 2011 - The Qi4j community today announced Release 1.4 of the innovative Java framework, Qi4j. This release is a consolidation release of the 1.x development branch, as development focus now is directed towards 2.0. The main new features in version 1.4 is Named Associations and inclusion of an industrial automation inspired alarm system.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_summary"></a>Summary</h4></div></div></div><p>The Qi4j Release 1.4 is a consolidation release, to bring together un-released features in the 1.x development branch. This is the last feature release in 1.x, and only serious bugs will be fixed and released. The Qi4j community will now focus on version 2.0 of Qi4j, which will again sport many ground=breaking features.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_named_associations"></a>Named Associations</h4></div></div></div><p>In 1.4 it is now possible to map associations by name, and not only as a list. The name is local to the association itself, and operates very much like a Map. The entities referenced are as usual loaded lazily upon get() method.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_system"></a>Alarm System</h4></div></div></div><p>Industrial automation systems have long had alarm systems as the main mechanism for reporting problems in a large system. This metaphor is actually very well suited in today’s complex enterprise systems as well. Alarms are in Qi4j implemented as an entity with a small state machine, dictated by an Alarm Model. The Standard Alarm model has four states; Normal, Activated, Deactivate and Acknowledged. After an alarm is activated, an individual person has to acknowledge the alarm before its state return to normal.</p><p>Further work will be done in this area for aggregation, notficiation, reporting and visualization.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20110415"></a>2.6. Qi4j SDK Release 1.3</h3></div></div></div><p>Kuala Lumpur, 15 April 2011 - The Qi4j community today announced Release 1.3 of the innovative Java framework, Qi4j. This release is significant for several customers, moving to deploy Qi4j in business critical 24/7 systems. "We now feel that the core features of Qi4j are as stable as software systems ever get. Qi4j is now being deployed at a major investment bank in the risk pricing domain.", said Niclas Hedhman, co-inventor of Qi4j together with Rickard Öberg, who added "Qi4j has really proved itself in StreamFlow, and I am convinced that many of our paradigms will stand the test of time."</p><p>This release sports many new features, such as Solr Indexing, JMX integration, Circuit-breaker library, innovative API for dealing with I/O, functional paradigms and much more, but an important focus was to stabilize the many libraries and extensions.</p><p>The main new features are listed below. The community now sets its eyes ahead towards the next release(s), which will include an industrial automation alarm system, JMX aggregation for the cloud, Entity Viewers via the Rest API and a whole lot more documentation and test coverage. We all look forward to this and many other things to come from Qi4j, the most exciting, technology challenging project in the Open Source Java world.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_i_o_api"></a>I/O API</h4></div></div></div><p>Rickard Öberg is once again inventing new ways to do common things. The I/O API correctly separates the concerns of reading, writing, exception handling, transformation and filtering. This resulted in a DSL like way of writing stream handling code. The I/O API is completely independent of everything in Qi4j and may be used separately. We may release it as a separate artifact in the future.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_jmx_integration"></a>JMX Integration</h4></div></div></div><p>By addding a single line of code, you will get the application structure represented in your JMX "tree view". Starting with a "Qi4j" node, under which each Qi4j Application is listed, followed by Layers, Modules and the Composites. All Services' configuration instances are exposed and can be changed via JMX, as can services be stopped, started and restarted.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_osgi_integration"></a>OSGi Integration</h4></div></div></div><p>All of Qi4j is now OSGi-compliant. That means that all jars are OSGi bundles, with imports and exports. On top of that, this release also contains the beginning of a OSGi-specific library, which allows Qi4j Services to be exported as OSGi services and vice versa. This library is still in beta.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_circuit_breaker"></a>Circuit Breaker</h4></div></div></div><p>The CircuitBreaker library allows external resources to be monitored for health and taken <span class="emphasis"><em>offline</em></span> when facing trouble. This is also signalled via JMX for human intervention.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_solr_indexing"></a>Solr Indexing</h4></div></div></div><p>To allow free-text searches of content in entities, Qi4j now has integrated Solr via the Qi4j Indexing/Query extension mechanism. It is not possible to do generic queries via this extension, but it leveraging the Named Query feature. Free-text search enable your data in existing entitystores by using the Reindexer extension.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_unitofwork_retry"></a>UnitOfWork Retry</h4></div></div></div><p>The UnitOfWorkConcern now handles an optional UnitOfWorkRetry annotation, allowing full re-runs of work. Literally a single annotation allows developers to add retry logic (or remove the complex retry logic already in place).</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_json_format_now_handles_maps"></a>JSON format now handles Maps</h4></div></div></div><p>The JSON serializer/deserializer has been equipped to handle Maps, by named properties instead of a java serialized map as was preveiously the case. The new deserializer logic is still compatible with the old format.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_job_scheduler"></a>Job Scheduler</h4></div></div></div><p>A new library, org.qi4j.library.scheduler, can now launch jobs according to CRON formatted schedules.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_specifications_in_assembly"></a>Specifications in Assembly</h4></div></div></div><p>The ModuleAssembly system has been revised heavily, to allow different parts of the application to apply assembly information to composites. This allows for near functional programming style of setting up composites.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_iterables_utility"></a>Iterables Utility</h4></div></div></div><p>Qi4j is innovating again, with a utility to do functional programming style in Java for Iterables. In this first release, the utility only contains the most basic operations, but will be extended over time.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_release_notes_qi4j_version_1_3"></a>Release Notes - Qi4j - Version 1.3</h4></div></div></div><p><span class="strong"><strong>New Features</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-277] - JMX services
</li><li class="listitem">
[QI-281] - Solr query/indexing
</li><li class="listitem">
[QI-284] - Circuit breaker library
</li><li class="listitem">
[QI-285] - Active → Available
</li><li class="listitem">
[QI-288] - Add a concern for handling retry on ConcurentModification
</li><li class="listitem">
[QI-289] - Create a library for a job scheduler
</li><li class="listitem">
[QI-291] - New API for doing I/O
</li><li class="listitem">
[QI-295] - Exporter of Qi4j Services to OSGi
</li><li class="listitem">
[QI-296] - Importer of OSGi services into the Qi4j world.
</li><li class="listitem">
[QI-300] - Add test helper for scenarios
</li><li class="listitem">
[QI-309] - Concern to handle ConcurentEntityModificationException and retry the UnitOfWork
</li><li class="listitem">
[QI-320] - Maps in JSON format
</li><li class="listitem">
[QI-321] - Specification driven assembly
</li><li class="listitem">
[QI-341] - Support JodaTime natively in the toJSON() system.
</li></ul></div><p><span class="strong"><strong>Improvements</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-275] - Enhance the community documentation to spell out the <span class="emphasis"><em>trust issues</em></span> in Core.
</li><li class="listitem">
[QI-297] - Capture NullPointerException slightly more gracefully in ValueBuilderFactory
</li><li class="listitem">
[QI-299] - Replace ServiceQualifier method with Specification
</li><li class="listitem">
[QI-302] - Capture which class is declared final
</li><li class="listitem">
[QI-305] - ObjectDescriptor in ModuleSPI
</li><li class="listitem">
[QI-312] - Patch for Gradle build system
</li><li class="listitem">
[QI-313] - Upgrade Neo4j extension to ver 1.2
</li><li class="listitem">
[QI-317] - Obscure Exception can be improved.
</li><li class="listitem">
[QI-326] - Cobertura reports in the build.
</li><li class="listitem">
[QI-339] - Add support for variables in RDF named queries
</li></ul></div><p><span class="strong"><strong>Bug</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-272] - Changing properties in Lifecycle sometimes doesn’t work
</li><li class="listitem">
[QI-292] - ServiceLoader mechanism for Qi4j Runtime implementation is really awkward.
</li><li class="listitem">
[QI-294] - qi4j-libraries: rdf/src/main/java/org/qi4j/library/rdf/model/ApplicationVisitor.java is not compilable
</li><li class="listitem">
[QI-303] - Incorrect generics type for imported services.
</li><li class="listitem">
[QI-304] - Composite extends Serializable
</li><li class="listitem">
[QI-306] - Exception thrown when @Using on complex generic types
</li><li class="listitem">
[QI-308] - The @UnitOfWorkDiscardOn annotation does not have runtime Retention
</li><li class="listitem">
[QI-331] - BuildVersion class is in wrong package.
</li><li class="listitem">
[QI-332] - Generated POMs doesn’t include the &lt;repository&gt; sections needed.
</li><li class="listitem">
[QI-333] - Qi4j Runtime needs a way to bootstrap in OSGi
</li><li class="listitem">
[QI-334] - Maven source jars are not generated and uploaded.
</li><li class="listitem">
[QI-335] - Maven javadoc jars are not generated and uploaded
</li><li class="listitem">
[QI-337] - Package org.qi4j.api.specification is imported more than once in Core Runtime OSGi bundle declaration.
</li><li class="listitem">
[QI-340] - NPE in ModuleUnitOfWork which should be a informative Exception
</li></ul></div><p><span class="strong"><strong>Task</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-314] - Creation of proper SDK
</li><li class="listitem">
[QI-315] - Define binary tarball layout
</li><li class="listitem">
[QI-316] - Define source tarball layout
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20110221"></a>2.7. Qi4j moves to Gradle</h3></div></div></div><p>The Qi4j project has discontinued its use of Maven and introduced Gradle as its
build system.</p><p>After fighting the Maven build system for years, and constantly looking for
alternatives, the Qi4j community has finally decided to grab the bull by its
horn and throw it out of the arena. Maven imposes a very rigid model on how to
define your project, but has a weak internal model on how a build is executed.
We therefor often see conflicts between plugins, plugins make too much
assumptions and ignoring settings that are actually provided formally, and not
to even mention the fundamentally flawed versioning system.</p><p>After a few evaluations of alternatives (Gradle &amp; Buildr were the strong
contenders), we have finally settled for Gradle (<a class="ulink" href="http://www.gradle.org" target="_top">http://www.gradle.org</a> and
<a class="ulink" href="http://gradle.codehaus.org" target="_top">http://gradle.codehaus.org</a>). Contrary to Maven, Gradle provides a strong
internal model for build systems, but a flexible way to establish that model.
In essence, in Maven, the declaration is static and the execution is
ill-defined, and in Gradle the model is established programmatically and the
execution is done off the model.</p><p>This allows for a great deal more flexibility. Gradle also have nice
integration with Ant and Ivy, so Gradle’s dependency system is handled by Ivy
(without Ivy’s XML) and it is easy to use any build tool that provides an Ant
task, again programmatically.</p><p>The absence of XML is refreshing. So instead of;</p><pre class="programlisting brush: xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.qi4j.core.runtime&lt;/groupId&gt;
    &lt;artifactId&gt;qi4j-core-api&lt;/artifactId&gt;
    &lt;version&gt;1.3&lt;/version&gt;
  &lt;/dependency&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;org.qi4j.core.runtime&lt;/groupId&gt;
    &lt;artifactId&gt;qi4j-core-runtime&lt;/artifactId&gt;
    &lt;version&gt;1.3&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;</pre><p>The declaration of a dependency is done programmatically in Groovy code, so it
can even be conditional and so forth, but the normal way is;</p><pre class="programlisting brush: groovy">dependencies {
    compile "org.qi4j.core:qi4j-core-api:1.2"
    testRuntime "org.qi4j.core:qi4j-core-runtime:1.2"
}</pre><p>And YES, there is a difference between testCompile and testRuntime. 1 line
instead of Maven’s 5-6 lines per dependency. And in true Ivy fashion, one can
create one’s own scopes, although I doubt we need that in the near future.</p><p>The dependency system is worth mentioning; Since Gradle understand multi module
projects very well, again unlike Maven, it resolves the build order according
to the tasks needed. This means that an upstream module’s tests can depend on a
downstream module’s output. And even if the build is executed in the upstream
module, the downstream module will be recompiled if any changes happened in it.
You never need to worry about "Oh, I forgot to recompile X" again…</p><p>Gradle does not need an installation. The Qi4j SDK project comes with a Gradle
bootstrapper, so it will install itself. Very nice.</p><p>Qi4j is still committed to produce Maven artifacts for publishing to Maven
repositories, and the upcoming 1.3 release will be the first one using Gradle for this.</p><p>We hope that this will make Qi4j development more enjoyable.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20101023"></a>2.8. Qi4j SDK 1.2 Released</h3></div></div></div><p>The Qi4j community today announced the 3rd installment of the innovative Java
framework, Qi4j. The main new features includes, SQL EntityStore, SQL
Indexing/Querying, Caching SPI and a Service Qualifier API.</p><p>Additional to the new features, numerous improvements were made along side with
significant internal changes. Here is a break down of the more important issues;</p><p>The Cache SPI is another important new feature. The pluggable Cache SPI means
that it is equally simple to add new caching implementations as it is to add
Entity Store implementations, in fact even easier since the SPI is very simple.
The entity stores implementations that leverages the MapEntityStore layer in
the Qi4j Runtime (which most do), will automatically benefit from the plugged
in Cache.</p><p>The support of SQL has been a long-standing requested item, and thanks to new
community blood, we now have the first generation of both EntityStore
implementation as well as using SQL backends for querying and indexing. These
two implementations is a testament that the Qi4j data model is truly flexible.
The current implementation does not, however, support mapping of existing
tables and expect to <span class="emphasis"><em>own</em></span> the tables it needs. PostgreSQL and MySQL are the
first support RDBMSes, and more are bound to follow in upcoming releases.</p><p>SLF4J was introduced as a dependency in Qi4j Core, and slowly starting to add
additional debug and trace statements in the internals of Qi4j Runtime to aid
in troubleshooting.</p><p>Qi4j community has also noted a JDK bug, which surface as a
java.lang.ArrayStoreException, but is really a
java.lang.TypeNotPresentException that gets treated incorrectly deep inside
com.sun packages. This release did not manage to work around this, but we will
in the next release.</p><p>The bugs fixed are of various nature. Some of the bugs listed in the release
notes are possibly fixed prior to Qi4j 1.1, but not identified correctly. The
two most important bug fixes are QI-247, Incorrect delegation of Object methods
in TransientComposite, and QI-241 regarding the matching algorithm for
@AppliesTo. The latter may seriously affect existing applications to include
fragments when it previously didn’t.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_release_notes_qi4j_sdk_1_2"></a>Release Notes - Qi4j SDK 1.2</h4></div></div></div><p><span class="strong"><strong>New Features</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-192] - Support indexing/querying of collection properties
</li><li class="listitem">
[QI-260] - Introduce advanced cache (ehcache?) as a general purpose caching layer for all EntityStores
</li><li class="listitem">
[QI-266] - Introduction of Service Qualifier API
</li><li class="listitem">
[QI-268] - Cache SPI introduced in Core.
</li><li class="listitem">
[QI-269] - Cache Extension - Ehcache
</li></ul></div><p><span class="strong"><strong>Improvements</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-58] - Property → Property .. → .. Querying
</li><li class="listitem">
[QI-232] - Entity Type resolution is flawed
</li><li class="listitem">
[QI-249] - Visitor-pattern to work with throws -declaration
</li><li class="listitem">
[QI-263] - Replace JDK logging with SLF4J
</li><li class="listitem">
[QI-264] - Use exception handling pattern in visitors
</li><li class="listitem">
[QI-265] - Introduce SLF4J as logging framework.
</li><li class="listitem">
[QI-267] - EntityStoreSPI.applyChanges() should have the EntityStoreUnitOfWork passed along.
</li></ul></div><p><span class="strong"><strong>Bugs Fixed</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
[QI-214] - Missing implementations of newEqualsPredicate
</li><li class="listitem">
[QI-241] - AppliesTo match algorithm should be a OR condition in the targeted elements list
</li><li class="listitem">
[QI-247] - Broken delegation of Object methods in TransientComposite
</li><li class="listitem">
[QI-253] - Remaining bugs on moving to ASM
</li><li class="listitem">
[QI-254] - FragmentClassLoader causes UnsupportedClassVersionError in most tests
</li><li class="listitem">
[QI-255] - Qi4j tests do not take @Queryable(false) into account
</li><li class="listitem">
[QI-256] - UndeclaredThrowableException - possibly related to new class-generation
</li><li class="listitem">
[QI-257] - ConcernOf/SideEffectOf not working with &lt;Property&lt;SomeType&gt;&gt;
</li><li class="listitem">
[QI-259] - JSONMapEntityStore did not update lastModified in entitystate
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100918"></a>2.9. @ JavaZone 2010 - ReST/DCI</h3></div></div></div><p>Qi4j at JavaZone 2010, Oslo, Norway. Rickard Öberg presented
"Implementing a Rest API with DCI and Qi4j" at JavaZone on the 8 Sept 2010.</p><p>Implementing a REST API today is important in many cases, both as an
integration point to your application and as a way for clients to access the
application. But there are few frameworks out there that help you fulfil all
the constraints of REST, and therefore only makes your API a REST-wannabe. This
session will look at how you can use Qi4j along with the DCI pattern to
implement a truly RESTful API, that follows all the constraints. We will look
at how DCI maps to the RESTful way of thinking about web API’s, and how Qi4j
can help with the actual implementation.</p><p><a class="ulink" href="http://streaming.java.no/tcs/#page:recordingList&amp;pageNumber:1&amp;id:DD3955BC-997B-40C1-A7DC-421DB8EE6512" target="_top">Watch the video</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100830"></a>2.10. @ Apache Roadshow Shanghai</h3></div></div></div><p>Qi4j was invited to present at the Apache Roadshow Shanghai 2010, largely due
to Niclas Hedhman is currently living there and is an Apache Member. Niclas has
reflected over how the presentation was done and some reactions from the
audience. You can read all about it on his
<a class="ulink" href="http://www.jroller.com/niclas/entry/qi4j_in_shanghai_part_2" target="_top">blog</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100617"></a>2.11. Qi4j SDK 1.1 is out!</h3></div></div></div><p>Qi4j community hereby announces the availability of Release 1.1 of Qi4j Core,
Qi4j Libraries and Qi4j Extensions.</p><p>Qi4j version 1.1 is now available. It is mostly an bug fix update, some SPI
changes and a contributed EntityStore for EC2/S3 using Infinispan. The author,
Philippe Van Dyck, explains;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Infinispan memory cache eviction mechanism is based on a memory threshold (i.e. you specify 100MB of memory for the cache in the store config)
</li><li class="listitem">
RHQ monitoring with Infinispan plugin
</li><li class="listitem">
Entries are gzipped on S3
</li><li class="listitem">
Wicket load balancing is done with infinispan (custom pagestore)
</li><li class="listitem">
I use a directory structure for qi4j identities ("Entity1/key1") with a webdav interface to it, so one can mount Qi4j’s store in Mac OSX Finder.
</li><li class="listitem">
EC2 S3_PING is used in jgroups to join the cluster of qi4j stores
</li><li class="listitem">
Each Qi4j UnitOfWork is transaction backed with rollback support
</li><li class="listitem">
S3 (blobstore) access is using Infinispan synchronous and transacted mode
</li><li class="listitem">
EC2 images only contain the wicket web interface with a jetty https connector / when added to amazon elastic load balancer, Infinispan connects to the cache cluster and wicket begins to server load balanced requests - yep, just like that
</li></ul></div><p>Current performance, as reported by RHQ, from EC2 to S3, is around 60ms per
read/write from S3 (rough average). Elastic load balancing load tests with
loadStorm are not done yet. But I don’t know any NOSQL alternative offering a
<span class="strong"><strong>permanent transacted monitored compressed Finder-mounted clustered
load-balanced store</strong></span>.</p><p>Development continues towards 1.2 release, which includes better OSGi support,
dropping CGLib dependency due to classloading issues, Google AppEngine support
and hopefully the DCI support as developed in the StreamFlow project.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100128"></a>2.12. Qi4j SDK 1.0 has been released!</h3></div></div></div><p>Qi4j SDK 1.0 has now been released. After 2 years of hard work, we have finally
made an official release available. It contains all the core features of Qi4j,
such as composites made from fragments like mixins, concerns, side-effects and
constraints, and also the libraries and extensions that are useful for most
application development.</p><p>During this weeks JFokus conference in Stockholm, Sweden, the Qi4j community
released Qi4j SDK 1.0. Rickard Öberg made two presentations in association with
the conference, focusing on how Qi4j and Composite Oriented Programming makes
working with domain models on the Java platform easier compared to the usual
POJO approach typically used in todays application development.</p><p>Qi4j is a significant step forward for the Java platform, with its focus on
Domain Driven Design and support for the
<a class="ulink" href="http://www.artima.com/articles/dci_vision.html" target="_top">Data-Context-Interaction</a>
paradigm that is currently being worked on by Trygve Reenskaug as a way to
revive object-orientation.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100125-2"></a>2.13. @ Øredev 2009 - DCI</h3></div></div></div><p>In this presentation that was recorded during Øredev 2009, Rickard Öberg
presents how to use Qi4j to implement the DCI principles. DCI, or
Data-Context-Interaction, is a new paradigm created by Trygve Reenskug,
inventor of the MVC pattern.</p><p>The presentation can be found
<a class="ulink" href="http://www.oredev.org/prod/oredev/site.nsf/docsbycodename/session?opendocument&amp;sid=88EF79931A074A1AC125759A003AB0ED&amp;track=24116556E47101EAC12575A50049A141&amp;day=5" target="_top">here</a>,
and it was part of a DCI track with Trygve and Jim Coplien, who’s presentations
you can find
<a class="ulink" href="http://www.oredev.org/prod/oredev/site.nsf/docsbycodename/session?opendocument&amp;sid=B5D8BF332A282FEEC1257599003E5694&amp;track=24116556E47101EAC12575A50049A141&amp;day=5" target="_top">here</a>
and
<a class="ulink" href="http://www.oredev.org/prod/oredev/site.nsf/docsbycodename/session?opendocument&amp;sid=9986C37D739F8D39C12575940064F272&amp;track=24116556E47101EAC12575A50049A141&amp;day=5" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20100125"></a>2.14. Quicker Frameworks</h3></div></div></div><p>Usually, a framework is created to make development faster by hiding the
technical machinery underneath. Motivation behind Qi4j was very different. In
this article written by Rickard Öberg for <a class="ulink" href="http://DomainDrivenDesign.org" target="_top">DomainDrivenDesign.org</a>,
he talks about how this domain-centric application development framework makes it quicker.</p><p>You can find the article on the DDD website <a class="ulink" href="http://domaindrivendesign.org/library/oberg_2009" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090903"></a>2.15. @ JavaZone 2009 - Persistence</h3></div></div></div><p>JavaZone 2009 is held as usual in Oslo, Norway, on the 9th and 10th of
September 2009. It is set to be an exciting event, Scandinavias larges Java
Developer’s conference, but covers adjacent languages as well, such as Scala,
Groovy and JRuby. Qi4j is represented with a presentation by Niclas Hedhman
about "Qi4j Persistence" (10th Sept, 11:45). The short time available will only
allow for the basics of Qi4j Persistence to be covered, but the audience is
expected to get tantalized and curious about our great framework for rich
domain model development.</p><p>Many other great speakers, both local Norwegians as well as International ones,
will be present and all is set for a great conference, again…</p><p>Niclas will of course be available most of the conference time for face-to-face
discussions, feedback and questions on Qi4j topics.</p><p>See you in Oslo.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090510"></a>2.16. @ JFokus 2009 - COP/DDD</h3></div></div></div><p>At JFokus earlier this year Rickard Öberg was interviewed by Dan Bergh Johnsson
about Composite Oriented Programming and Qi4j.</p><p>The interview covers some of the rationale behind Composite Oriented
Programming and the Qi4j project, its focus on DDD and why Java was chosen as
language for the implementation. You can see the interview online on
<a class="ulink" href="http://www.youtube.com/watch?v=RcJqcJND42s" target="_top">YouTube</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090420"></a>2.17. Qi4j 0.7 Released</h3></div></div></div><p>Query Cleanup.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090220"></a>2.18. Qi4j 0.6 Released</h3></div></div></div><p>Goal of Full Test Coverage in Core.</p><p>Break-up of project.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090219"></a>2.19. DDD support in Qi4j explained</h3></div></div></div><p>Domain Driven Design has a special status in Qi4j, and its tactical bits are
embraced in Qi4j itself. These includes Entities, Services and Values. In
Rickard’s blog entry <a class="ulink" href="http://www.jroller.com/rickard/entry/qi4j_and_state_modeling" target="_top">Qi4j and state modeling</a>,
he covers these topics in a relatively easy to understand and pedagogic format. A highly recommended read
for people who want to get a quick overview of what Qi4j is really about.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090110"></a>2.20. @ Årskonference 2009</h3></div></div></div><p>It is indeed exciting times to be a Java developer in. Lots of stuff is
happening in the Java space and it’s hard to predict what kind of
development space we will be working in in the future.</p><p>Will all our Java code run in a cloud somewhere ?</p><p>Is “domain centric application development” the new magic wand we should
be waving at our Java code ?</p><p>Join us and meet Rickard Öberg and get an in-depth view on his new exciting
project, Qi4j (qi4j.org)</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20090109"></a>2.21. Qi4j 0.5 Released</h3></div></div></div><p>Stabilization of Core</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20081117"></a>2.22. @ Øredev 2008 - Qi4j</h3></div></div></div><p>Qi4j - code, examples and demo</p><p>Qi4j is an application development framework that promises to make it easier to
create applications using DDD. But how does it accomplish this, and to what
extent? This session will take us through the creation of a simple application
using Qi4j and discuss the different features that simplify the developers life
and makes it easier to apply agile practices.</p><p>Watch the whole session online
<a class="ulink" href="http://archive.oredev.org/topmenu/video/java/rickardobergqi4j.4.5a2d30d411ee6ffd28880001122.html" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080919"></a>2.23. Qi4j 0.4 Released</h3></div></div></div><p>CleanUp after the 0.3 changes.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080915"></a>2.24. @ JavaZone 2008 - COP/Qi4j</h3></div></div></div><p>In the current programming culture we have lost the OOP idea of objects
containing both logic and state, the idea of reuse has largely failed due to
impractical mechanisms, and combining pieces of code into larger structures
using AOP has not quite delivered on its promises. Building large-scale
software also gives us challenges with regard to complexity, enforcing
architectural rules and codebase explosion. What if we could look at what we
have and figure out a new way to address these problems, while promoting the
idea from domain oriented modeling and retaining what works with what we have
now? Composite Oriented Programing is a new way of dealing with these problems,
and this presentation will show how the Qi4j implementation on the Java
platform will enable you to get more done with less work, and in a way that
allows you to avoid the mentioned problems. It will describe the COP
terminology and show examples on how to use Qi4j to implement domain oriented
models.</p><p>See the whole presentation online
<a class="ulink" href="http://javazone.no/incogito/session/Qi4j+-+a+new+approach+to+old+problems.html" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080808"></a>2.25. Qi4j 0.3 Released</h3></div></div></div><p>The 3rd pre-final release from the Qi4j community marks a new relatively stable milestone on the continued path to a production ready system. The 0.3 release is the 3rd major re-write of the Qi4j Core Runtime, after many lessons learned from previous implementations.</p><p>"The current Qi4j Core Runtime is soooo much lighter and easier to work with, both for the Core developers as well as extensions and advanced libraries developers.", says Rickard Öberg, the Qi4j project lead. "We now have most of the ingredients in place for developers who want to delve into DDD without having to do everything from scratch. Having a toolkit to work with that speaks the same language as themselves, all the way from layers down to individual parameter constraints, makes life so much easier, and minimizes the need for translation from idea to actual code."</p><p>"We now feel confident that the Qi4j Core Runtime has a good design and is stable enough to not go through any more disruptive changes. This enables us to move away from a feature-boxed release cycle into a more agile time-boxed one. This will enable more people to participate and use the Qi4j platform.", says Niclas Hedhman. He continues; "Stefano Mazzocchi (Apache) once told me; Only projects with <span class="emphasis"><em>Bad Code, Great Vision will build strong communities</em></span>. And I think Qi4j is exactly at this point right now. The vision for a better future is extremely promising, and we have so many areas that we need help to implement. Combined with a no barrier to write and commit code/documentation for all parts except Qi4j Core, we have the setup for accelerated participation in the months to come."</p><p>With this release the Qi4j community moves from a feature-boxed release cycle into a time-boxed one. First week every month, there will be a release containing the work from previous release. Issues will be worked on in a semi-prioritized order and the participating developers are urged to keep the codebase stable towards the release date.</p><p>Rickard is keen to point out the Application Visualizer that has been started since the 0.2 release, "Another key tool which this release introduces is the beginning of the application visualizer, which automatically shows what your application look like. One of the main disadvantages of earlier frameworks is that the developers typically felt out of control and unable to see what was going on. When you have so many pieces working together it is important to get the big picture, and this is what we are now enabling."</p><p>"Our immediate next steps involves a new remote Entity Store, getting the application visualization tool ready, changes to the Query API including named and native queries, and we are looking into introducing more explicit Composite archetypes, such as TransientComposite and ValueComposite", says Rickard and then goes back coding.</p><p>The rest of us just can’t wait to see what is coming up next.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080606"></a>2.26. Qi4j 0.2 Released</h3></div></div></div><p>Full Unit Test &amp; Javadoc on Core API</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080414"></a>2.27. Qi4j 0.1 Released</h3></div></div></div><p>Freeze of Core API.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20080130"></a>2.28. @ JFokus 2008 - COP</h3></div></div></div><p>OOP neglects the need of objects to adjust its behavior depending on the
context. "John is a parent and programmer in the city, but a hunter and food in
the jungle.". Same object, different contexts. OOP has also not fulfilled its
promise of re-usability, partly due to such static behavior and partly due to
its inability to deal with fine-granularity of states and behaviors. Composite
Oriented Programming addresses these issues, and Qi4J is an implementation
available to Java programmers today.</p><p>Check the presentation slides online
<a class="ulink" href="http://www.jfokus.se/jfokus08/pres/jf08-CompositeOrientedProgrammingWithQi4j.pdf" target="_top">here</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="news-20071113"></a>2.29. @ Øredev 2007 - COP</h3></div></div></div><p>Qi4J - Composite Oriented Programming Today</p><p>OOP neglects the need of objects to adjust its behavior depending on the context. "John is a parent and programmer in the city, but a hunter and food in the jungle.". Same object, different contexts. OOP has also not fulfilled its promise of re-usability, partly due to such static behavior and partly due to its inability to deal with fine-granularity of states and behaviors.</p><p>Composite Oriented Programming addresses these issues, and Qi4J is an implementation available to Java programmers today.</p><p>See the <a class="ulink" href="http://archive.oredev.org/toppmeny/conference/java/qi4jcompositeorientedprog.4.76e8b1c6112f078db498000125951.html" target="_top">Øredev archive</a>.</p><p>This presentation has been followed by a 6 hours Workshop.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="tutorials"></a>3. Tutorials</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview">3.1. Overview</a></span></dt><dt><span class="section"><a href="#two-minutes-intro">3.2. Qi4j in 2 minutes</a></span></dt><dt><span class="section"><a href="#ten-minutes-intro">3.3. Qi4j in 10 minutes</a></span></dt><dt><span class="section"><a href="#thirty-minutes-intro">3.4. Qi4j in 30 minutes</a></span></dt><dt><span class="section"><a href="#two-hours-intro">3.5. Qi4j in 2 hours</a></span></dt><dt><span class="section"><a href="#introduction-background">3.6. Background</a></span></dt><dt><span class="section"><a href="#what-is-cop">3.7. What is COP?</a></span></dt><dt><span class="section"><a href="#qi4j-cop">3.8. COP with Java and Qi4j</a></span></dt><dt><span class="section"><a href="#state-modeling">3.9. Qi4j and state modeling</a></span></dt><dt><span class="section"><a href="#what-s-an-object-anyway">3.10. What’s an Object anyway?</a></span></dt><dt><span class="section"><a href="#tut-composites">3.11. Transient Composites Tutorial</a></span></dt><dt><span class="section"><a href="#tut-services">3.12. Services Composites Tutorial</a></span></dt><dt><span class="section"><a href="#howto-depend-on-qi4j">3.13. Depend on Qi4j in your build</a></span></dt><dt><span class="section"><a href="#howto-assemble-application">3.14. Assemble an Application</a></span></dt><dt><span class="section"><a href="#howto-configure-service">3.15. Configure a Service</a></span></dt><dt><span class="section"><a href="#howto-create-entity">3.16. Create an Entity</a></span></dt><dt><span class="section"><a href="#howto-create-constraint">3.17. Create a Constraint</a></span></dt><dt><span class="section"><a href="#howto-create-concern">3.18. Create a Concern</a></span></dt><dt><span class="section"><a href="#howto-create-sideeffect">3.19. Create a SideEffect</a></span></dt><dt><span class="section"><a href="#howto-leverage-properties">3.20. Leverage Properties</a></span></dt><dt><span class="section"><a href="#howto-contextual-fragments">3.21. Use contextual fragments</a></span></dt><dt><span class="section"><a href="#howto-use-io">3.22. Use I/O API</a></span></dt><dt><span class="section"><a href="#related">3.23. Related publications &amp; projects</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview"></a>3.1. Overview</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><p>In this section you will find a comprehensive set of tutorials about Composite
Oriented Programming using Qi4j.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tutorials-intro"></a>Introduction to Qi4j</h4></div></div></div><p>This quite long introduction to Qi4j will start by brushing up an overview of the problems Qi4j solve, teach you what
Composite Oriented Programming is and guide you through the process of writing a complete Application around an adapted
Hello World example.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#two-minutes-intro" title="3.2.&#xA0;Qi4j in 2 minutes">Qi4j in 2 minutes</a>
</li><li class="listitem">
<a class="xref" href="#ten-minutes-intro" title="3.3.&#xA0;Qi4j in 10 minutes">Qi4j in 10 minutes</a>
</li><li class="listitem">
<a class="xref" href="#thirty-minutes-intro" title="3.4.&#xA0;Qi4j in 30 minutes">Qi4j in 30 minutes</a>
</li><li class="listitem">
<a class="xref" href="#two-hours-intro" title="3.5.&#xA0;Qi4j in 2 hours">Qi4j in 2 hours</a>
</li><li class="listitem">
<a class="xref" href="#introduction-background" title="3.6.&#xA0;Background">Background</a>
</li><li class="listitem">
<a class="xref" href="#what-is-cop" title="3.7.&#xA0;What is COP?">What is COP?</a>
</li><li class="listitem">
<a class="xref" href="#what-s-an-object-anyway" title="3.10.&#xA0;What&#x2019;s an Object anyway?">What's an Object anyway?</a>
</li><li class="listitem">
<a class="xref" href="#state-modeling" title="3.9.&#xA0;Qi4j and state modeling">State Modeling</a>
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_transient_composites_tutorial"></a>Transient Composites Tutorial</h4></div></div></div><p>Throughout this set of tutorials it will be shown how to create and work with Transient Composites, which is the basic
element in Qi4j. We will refactor one HelloWorld class to take advantage of the various features in Qi4j. These
refactorings will make it easier to reuse parts of the class, and introduce new features without having to change
existing code. We will also look at some of the existing classes, or Fragments, available in Qi4j that you can reuse
so that you don’t have to write everything yourself.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#tut-composites-step1" title="Step 1 - Interface Refactoring">Step 1 - Interface Refactoring</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step2" title="Step 2 - Creating a Transient Composite">Step 2 - Creating a Transient Composite</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step3" title="Step 3 - Mixins">Step 3 - Mixins</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step4" title="Step 4 - Concerns">Step 4 - Concerns</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step5" title="Step 5 - Constraints">Step 5 - Constraints</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step6" title="Step 6 - SideEffects">Step 6 - SideEffects</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step7" title="Step 7 - Properties">Step 7 - Properties</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step8" title="Step 8 - Generic Mixins">Step 8 - Generic Mixins</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step9" title="Step 9 - Private and Abstract Mixins">Step 9 - Private and Abstract Mixins</a>
</li></ul></div><p>Each tutorial step in this series starts with the result from the previous tutorial, so you can
always look at the next tutorial step for guidance on what to do.</p><p>At the bottom of each tutorial step, the is Solutions section, which list the files you should have come to if you
have followed the instructions.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_services_composites_tutorial"></a>Services Composites Tutorial</h4></div></div></div><p>In this other set of tutorials it will be shown how to create and work with Service Composites, which are composites
that extends from the ServiceComposite class. We will refactor one a very simple Library where you can borrow and
return books to take advantage of the various features in Qi4j. These refactorings will benefit from automatic Service
activation and Configuration Entities management.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#tut-services-step1" title="Step 1 - Creating a ServiceComposite">Step 1 - Creating a ServiceComposite</a>
</li><li class="listitem">
<a class="xref" href="#tut-services-step2" title="Step 2 - Hooking into the Service Activation">Step 2 - Hooking into the Service Activation</a>
</li><li class="listitem">
<a class="xref" href="#tut-services-step3" title="Step 3 - Reading the Service Configuration">Step 3 - Reading the Service Configuration</a>
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="two-minutes-intro"></a>3.2. Qi4j in 2 minutes</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><p>To show that Qi4j is not necessarily complex, not hard to get going with and easy to deploy, we are first showing the
classic HelloWorld, as small as it can get and still be Composite Oriented Programming and not only standard OOP.</p><p>Ready, Set, Go!</p><p>Let’s say we want to do the common HelloWorld example, but with a more domain-oriented setting.
We have a Speaker interface that does the talking.
But we also need an implementation for Speaker, which we declare here via the <code class="literal">@Mixins( SpeakerMixin.class )</code>.</p><pre class="programlisting brush: java">@Mixins( SpeakerMixin.class )
public interface Speaker
{
    String sayHello();
}
</pre><p>And of course, the simple implementation of the Speaker interface.
In this case, return a String with the content "Hello, World!".</p><pre class="programlisting brush: java">public class SpeakerMixin
    implements Speaker
{
    @Override
    public String sayHello()
    {
        return "Hello, World!";
    }
}
</pre><p>So far so good. We now need to make this into something that can run. This can be done like this;</p><pre class="programlisting brush: java">public class Main
{
    public static void main( String[] args )
    {
        SingletonAssembler assembler = new SingletonAssembler() // &lt;1&gt;
        {
            @Override
            public void assemble( ModuleAssembly assembly )
                throws AssemblyException
            {
                assembly.transients( Speaker.class );           // &lt;2&gt;
            }
        };
        Speaker speaker = assembler.module().newTransient( Speaker.class ); // &lt;3&gt;
        System.out.println( speaker.sayHello() );
    }
}
</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
The SingletonAssembler is a convenience class that creates a Qi4j Runtime instance and an application with one layer
  and one module in it.
</li><li class="listitem">
We declare a TransientComposite of type <code class="literal">Speaker</code>.
</li><li class="listitem">
We create the Composite instance from the Module.
</li></ol></div><p><span class="strong"><strong>Done!</strong></span></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="ten-minutes-intro"></a>3.3. Qi4j in 10 minutes</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Qi4j does not introduce any new programming language, no additional compilers needed and all your existing tools
      work just like before. It is pure Java.
</li><li class="listitem">
Qi4j works with Composites.
</li><li class="listitem">
The equivalent of an Object instance in OOP, is a Composite instance in Qi4j.
</li><li class="listitem">
Composites are constructed from Fragments.
</li><li class="listitem">
Fragments are Mixins, Concerns, Constraints and SideEffects.
</li><li class="listitem">
Only Mixins carry Composite state. The others are shared between Composite instances.
</li></ul></div><p>Composition is done with Java interfaces and Annotations. Example;</p><pre class="programlisting brush: java">@Concerns( { PurchaseLimitConcern.class, InventoryConcern.class } )
public interface OrderEntity
    extends Order, Confirmable,
            HasSequenceNumber, HasCustomer, HasLineItems,
            EntityComposite
{
}
</pre><p>This Composite is potentially complete. The Composite interface has a Mixin declared which is always present, the
PropertyMixin, which will handle all properties we use. The two Concerns are interceptors that are placed on the
methods that they declare, for instance;</p><pre class="programlisting brush: java">public class InventoryConcern extends ConcernOf&lt;Order&gt;
    implements Order
{
    @Service
    private InventoryService inventory;

    @Override
    public void addLineItem( LineItem item )
    {
        String productCode = item.productCode().get();
        int quantity = item.quantity().get();
        inventory.remove( productCode, quantity );
        next.addLineItem( item );
    }

    @Override
    public void removeLineItem( LineItem item )
    {
        String productCode = item.productCode().get();
        int quantity = item.quantity().get();
        inventory.add( productCode, quantity );
        next.removeLineItem( item );
    }
}
</pre><p>Extending the ConcernOf is a convenience mechanism, instead of an explicit @ConcernFor annotation on a private field,
which can be used in rare occasions when you are not able to extend. This base class defines the <code class="literal">next</code> field, which is
set up by the Qi4j runtime and points to the next fragment in the call stack.</p><p>We can also see that the InventoryService is provided to the concern, which is done with dependency injection. Qi4j
also supports dependency injection via constructors and methods.</p><p>The above example is obviously doing persistence, and we have no code handling this. But Qi4j supports persistence
directly in its Core, and it is taken care of by Qi4j, since it is declared as an EntityComposite.
Nothing else is needed, provided that the Qi4j Runtime has been setup with one or more persisted EntityStores. But
we have a naming convention that EntityComposites have "Entity" as the suffix in its name.</p><p>There are other built-in Composite subtypes as well, such as ValueComposite and ServiceComposite. This distinction helps
both to communicate intent as well as having more precisely defined functionality.</p><p>Now, let’s say that we want to send a mail to <a class="ulink" href="mailto:sales@mycompany.com" target="_top">sales@mycompany.com</a> when the order is confirmed. This is a SideEffect, and
will execute after the Constraints, Concerns and Mixins. We add the SideEffect to the OrderEntity;</p><pre class="programlisting brush: java">@SideEffects( MailNotifySideEffect.class )
@Concerns( { PurchaseLimitConcern.class, InventoryConcern.class } )
public interface OrderEntity
    extends Order, Confirmable,
            HasSequenceNumber, HasCustomer, HasLineItems,
            EntityComposite
{
</pre><p>The SideEffect implementation is fairly simple.</p><pre class="programlisting brush: java">public abstract class MailNotifySideEffect extends SideEffectOf&lt;Confirmable&gt;
    implements Confirmable
{
    @Service
    private MailService mailer;

    @This
    private HasLineItems hasItems;

    @This
    private HasCustomer hasCustomer;

    @Override
    public void confirm()
    {
        StringBuilder builder = new StringBuilder();
        builder.append( "An Order has been made.\n\n\n" );
        builder.append( "Customer:" );
        builder.append( hasCustomer.name().get() );
        builder.append( "\n\nItems ordered:\n" );
        for( LineItem item : hasItems.lineItems().get() )
        {
            builder.append( item.name().get() );
            builder.append( " : " );
            builder.append( item.quantity().get() );
            builder.append( "\n" );
        }
        mailer.send( "sales@mycompany.com", builder.toString() );
    }
}
</pre><p>The MailService is dependency injected, as we have seen before.</p><p>@This is telling Qi4j that the SideEffect needs a reference to the Composite instance that it belongs to.</p><p>By asking for both the HasCustomer and the HasLineItems types, we get type-safety and don’t need to bother with casts.
In fact, Qi4j will ensure that you can’t even cast the <code class="literal">hasCustomer</code> instance to the HasLineItems type.</p><p>By not referencing the aggregated interface OrderEntity, we reduce the coupling of this SideEffect and it can be used
in any other Composite where the HasCustomer and HasLineItems combination is used, for instance in an InvoiceEntity.</p><p>So, build the report, send it via the MailService.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_conclusion"></a>Conclusion</h4></div></div></div><p>In this short introduction, we have covered the essence of Qi4j. We have looked at what is a Composite, seen some of the
Fragments in action, and how simple it is to turn a Composite into a persisted Composite, known as an EntityComposite.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="thirty-minutes-intro"></a>3.4. Qi4j in 30 minutes</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><p>This introduction will deepen your understanding of Qi4j, as we touches on a couple of the common features of Qi4j. It
is expected that you have gone through and understood the "Qi4j in 10 minutes" introduction.</p><p>We will go back to the OrderEntity example;</p><pre class="programlisting brush: java">@Concerns({PurchaseLimitConcern.class, InventoryConcern.class})
public interface OrderEntity
    extends Order, HasSequenceNumber, HasCustomer,
            HasLineItems, Confirmable, EntityComposite
{
}</pre><p>Let’s say that this is an existing Composite, perhaps found in a library or used in a previous object, but we want to
add that it tracks all the changes to the order and the confirmation of such order.</p><p>First we need to create (or also find in a library) the mechanics of the audit trail. It could be something like this;</p><pre class="programlisting brush: java">public interface HasAuditTrail&lt;M&gt;
{
    AuditTrail&lt;M&gt; auditTrail();
}

public interface AuditTrail&lt;M&gt; extends Property&lt;List&lt;Action&lt;M&gt;&gt;&gt;
{}

public interface Action&lt;T&gt; extends ValueComposite          [2][3]
{
    enum Type added, removed, completed;

    Property&lt;T&gt; item();                                    [1]

    Property&lt;Type&gt; action();                               [1]
}

public interface Trailable&lt;M&gt;
{
    void itemAdded( M item );
    void itemRemoved( M item );
    void completed();
}

public class TrailableMixin&lt;M&gt;
    implements Trailable&lt;M&gt;
{
    private @This HasAuditTrail hasTrail;

    @Override
    public void itemAdded( M item )
    {
        addAction( item, Action.Type.added );
    }

    @Override
    public void itemRemoved( M item )
    {
        addAction( item, Action.Type.removed );
    }

    @Override
    public void completed( M item )
    {
        addAction( item, Action.Type.completed );
    }

    private Action&lt;M&gt; addAction( M item, Action.Type type )
    {
        CompositeBuilder&lt;Action&gt; builder =
            factory.newCompositeBuilder( Action.class );       [4]
        Action prototype = builder.stateFor( Action.class );
        prototype.item().set( item );
        prototype.action().set( action );
        Action instance = builder.newInstance();
        hasTrail.auditTrail().get().add( instance );
     }
}</pre><p>Quite a lot of Qi4j features are leveraged above;
[1] Property is a first class citizen in Qi4j, instead of getters/setters naming convention to declare properties.
[2] ValueComposite for Action means that it is among other things Immutable.
[3] The Action extends a Property. We call that Property subtyping and highly recommended.
[4] The CompositeBuilder creates Immutable Action instances.</p><p>We also need a Concern to hang into the methods of the Order interface.</p><pre class="programlisting brush: java">public abstract class OrderAuditTrailConcern
    extends ConcernOf&lt;Order&gt;
    implements Order
{
    @This Trailable&lt;LineItem&gt; trail;

    @Override
    public void addLineItem( LineItem item )
    {
        next.addLineItem( item );
        trail.itemAdded( item );
    }

    @Override
    public void removeLineItem( LineItem item )
    {
        next.removeLineItem( item );
        trail.itemRemoved( item );
    }

    @Override
    public void completed()
    {
        next.completed();
        trail.completed();
    }
}</pre><p>In this case, we have chosen to make an Order specific Concern for the more generic AuditTrail subsystem, and would
belong in the client (Order) code and not with the library (AuditTrail).
Pay attention to the @This annotation for a type that is not present in the Composite type interface. This is called a
private Mixin, meaning the Mixin is only reachable from Fragments within the same Composite instance.</p><p>But the AuditTrail subsystem could provide a Generic Concern, that operates on a naming pattern (for instance). In this
case, we would move the coding of the concern from the application developer to the library developer, again increasing
the re-use value. It could look like this;</p><pre class="programlisting brush: java">public class AuditTrailConcern
    extends ConcernFor&lt;InvocationHandler&gt;
    implements InvocationHandler
{
    @This Trailable trail;

    @Override
    public void invoke( Object proxy, Method m, Object[] args )
       throws Exception
    {
        next.invoke( proxy, m, args );
        String methodName = m.getName();
        if( methodName.startsWith( "add" ) )
        {
            trail.itemAdded( args[0] );
        }
        else if( methodName.startsWith( "remove" ) )
        {
            trail.itemRemoved( args[0] );
        }
        else if( methodName.startsWith( "complete" ) ||
                 methodName.startsWith( "commit" ) )
        {
            trail.completed();
        }
    }
}</pre><p>The above construct is called a Generic Concern, since it implements java.lang.reflect.InvocationHandler instead of the
interface of the domain model. The ConcernOf baseclass will also need to be of InvocationHandler type, and the
Qi4j Runtime will handle the chaining between domain model style and this generic style of interceptor call chain.</p><p>Finally, we need to declare the Concern in the OrderEntity;</p><pre class="programlisting brush: java">@Concerns({
    AuditTrailConcern.class,
    PurchaseLimitConcern.class,
    InventoryConcern.class
})
@Mixins( TrailableMixin.class )
public interface OrderEntity
    extends Order, Confirmable,
            HasSequenceNumber, HasCustomer, HasLineItems,
            EntityComposite
{
}</pre><p>We also place it first, so that the AuditTrailConcern will be the first Concern in the interceptor chain
(a.k.a InvocationStack), so that in case any of the other Concerns throws an Exception, the AuditTrail is not updated
(In fact, the AuditTrail should perhaps be a SideEffect rather than a Concern. It is largely depending on how we define
SideEffect, since the side effect in this case is within the composite instance it is a border case.).</p><p>So let’s move on to something more complicated. As we have mentioned, EntityComposite is automatically persisted to an
underlying store (provided the Runtime is setup with one at bootstrap initialization), but how do I locate an Order?</p><p>Glad you asked. It is done via the Query API. It is important to understand that Indexing and Query are separated from
the persistence concern of storage and retrieval. This enables many performance optimization opportunities as well as a
more flexible Indexing strategy. The other thing to understand is that the Query API is using the domain model, in Java,
and not some String based query language. We have made this choice to ensure refactoring safety. In rare cases, the
Query API is not capable enough, in which case Qi4j still provides the ability to look up and execute native queries.</p><p>Let’s say that we want to find a particular Order from its SequenceNumber.</p><pre class="programlisting brush: java">import static org.qi4j.api.query.QueryExpressions.eq;
import static org.qi4j.api.query.QueryExpressions.templateFor;

import org.qi4j.api.query.QueryBuilder;
import org.qi4j.api.query.QueryBuilderFactory;

:

@Structure private UnitOfWorkFactory uowFactory; //Injected

:

UnitOfWork uow = uowFactory.currentUnitOfWork();
QueryBuilderFactory qbf = uow.queryBuilderFactory();
QueryBuilder&lt;Order&gt; builder = qbf.newQueryBuilder( Order.class );

String orderNumber = "12345";
HasSequenceNumber template = templateFor( HasSequenceNumber.class );
builder.where( eq( template.number(), orderNumber ) );
Query&lt;Order&gt; query = builder.newQuery();

Iterator&lt;Order&gt; result = query.iterator();

if( result.hasNext() )
{
    Order order = result.next();
}
else
{
    // Deal with it wasn't found.
}</pre><p>The important bits are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The QueryExpressions.templateFor() method is used to define the template used in the query upon execution. In
      this case, we choose to template only the HasSequenceNumber, an interface used in OrderEntity, but is not part of
      Order (may or may not be a good design choice).
</li><li class="listitem">
The where() clause, which has a statically imported method eq(), which builds up the expression logic, and will
      be translated into the underlying query language upon execution, which happens in the iterator() method.
</li></ul></div><p>Another example,</p><pre class="programlisting brush: java">QueryBuilder&lt;Order&gt; builder = qbf.newQueryBuilder( Order.class );

Calendar cal = Calendar.getInstance();
cal.setTime( new Date() );
Date last90days = cal.roll( Calendar.DAY_OF_MONTH, -90 );
Order template = templateFor( Order.class );
builder.where( gt( template.createdDate(), last90days ) );
Query&lt;Order&gt; query = builder.newQuery();

for( Order order : query )
{
    report.addOrderToReport( order );
}</pre><p>In the above case, we find the Orders that has been created in the last 90 days, and add them to a report to be
generated. This example assumes that the Order type has a Property&lt;Date&gt; createdDate() method.</p><p>Now, Orders has a relation to the CustomerComposite which is also an Entity. Let’s create a query for all customers
that has made an Order in the last 30 days;</p><pre class="programlisting brush: java">QueryBuilder&lt;HasCustomer&gt; builder = qbf.newQueryBuilder( HasCustomer.class );

Calendar cal = Calendar.getInstance();
cal.setTime( new Date() );
Date lastMonth = cal.roll( Calendar.MONTH, -1 );
Order template1 = templateFor( Order.class );
builder.where( gt( template1.createdDate(), lastMonth ) );
Query&lt;HasCustomer&gt; query = builder.newQuery();

for( HasCustomer hasCustomer : query )
{
    report.addCustomerToReport( hasCustomer.customer().get() );
}</pre><p>This covers the most basic Query capabilities and how to use it. For Querying to work, an Indexing subsystem must be
assembled during bootstrap. At the time of this writing, only an RDF indexing subsystem exist, and is added most easily
by assembly.addAssembler( new RdfNativeSesameStoreAssembler() ).</p><p>It can be a bit confusing to see Qi4j use Java itself as a Query language, but since we have practically killed the
classes and only operate with interfaces, it is possible to do a lot of seemingly magic stuff. Just keep in mind that
it is pure Java, albeit heavy use of dynamic proxies to capture the intent of the query.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_conclusion_2"></a>Conclusion</h4></div></div></div><p>We have now explored a couple more intricate features of Qi4j, hopefully without being overwhelmed with details on how
to create applications from scratch, how to structure applications, and how the entire Qi4j Extension system works.
We have looked at how to add a Concern that uses a private Mixin, we have touched a bit on Generic Concerns, and
finally a short introduction to the Query API.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="two-hours-intro"></a>3.5. Qi4j in 2 hours</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This tutorial is not written yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div><p>This introduction assumes that the "Qi4j in 10 minutes" and "Qi4j in 30 minutes" introductions has been read and
understood.</p><p>In this introduction we will touch on the core concepts of UnitOfWork, Application structure and Bootstrap API.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Persistence and UnitOfWork -
</li></ul></div><p>We have previously seen that it is easy to declare that a Composite should be persisted, but not touched on how to
interact with the underlying persistence system. This is done via EntitySessions.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Application Structure -
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
There are one Application per Qi4j instance.
</li><li class="listitem">
An Application consists of one or more Layers.
</li><li class="listitem">
Each Layer consist of one or more Modules.
</li><li class="listitem">
Layers are organized in a top-down manner, lower Layers on top of higher Layers.
</li><li class="listitem">
One must declare which Composites that each Module is responsible for.
</li><li class="listitem">
A Composite can either be private or public in the Module.
</li><li class="listitem">
A private Composite can only be reached from within the same Module.
</li><li class="listitem">
A public Composite can be reached from other Modules in the same Layer.
</li><li class="listitem">
A public Composite can be declared to be public in the Layer.
</li><li class="listitem">
A Composite that is declared public in the Layer can be reached from the Layers directly on top (not transitive
      to Layers higher up).
</li><li class="listitem">
The Application can also declare public Composites (later for SCA).
</li></ul></div></li></ul></div><p>For simpler Applications it is possible (quite easily) to create a single Layer with a single Module, but for more
complex Applications we strongly recommend the partitioned approach.</p><p>Bootstrap API</p><p>— to be continued</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="introduction-background"></a>3.6. Background</h3></div></div></div><p>Qi4j is the first Composite Oriented Programming implementation leveraging the Java 5 platform, so that everything you
know from Java 5 still applies. You can mix Qi4j with your ordinary Java code as much as you want. All your existing
Java tools works just like before, and Qi4j does not introduce any new programming language, no special development
tools needed and no XML is required.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_purpose"></a>Purpose</h4></div></div></div><p>Qi4j addresses the programming problems from the top-down, starting with the Domain Model and Business Rules needs,
and let those requirements flow downwards in the software stack and dictate the requirements for underlying layers
such as persistence, messaging, querying and more. This means that the business value developer is left to
concentrate on the domain models and the actual application bringing the value, instead of creating massive amounts
of glue code to tie underlying technologies together.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_problem_descriptions"></a>Problem Descriptions</h4></div></div></div><p>Qi4j didn’t appear out of the blue, when the founders of the project had nothing better to do. It is the result of
observation of problems in real applications, and the experience from previous attempts to address or correct these
problems, that has led to the Qi4j vision.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_object_oriented_programming_oop"></a>Object Oriented Programming (OOP)</h4></div></div></div><p>How can OOP be a problem? We and others have observed that there is a fundamental flaw in the OOP model. In fact, we
would like to even state that OOP as it is commonly practiced today is not object oriented at all. The object is not
the primary citizen, instead the class is the primary artifact. In most mainstream OOP languages, Objects are derived
from classes, not that classes are assigned to created objects. Therefore, we think it should have been called Class
Oriented Programming. We can also see this class focus in many of the technologies in Java today: in Spring you declare
class names in application contexts, JSP uses class names to declare beans and so forth.</p><p>This in turn leads to that there is no good OOP solution for the problem we describe below.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_behavior_depends_on_context_2"></a>Behavior depends on Context</h4></div></div></div><p>Once you start thinking of "Behavior depends on Context", you have a hard time understanding how people for the last 20
years or so of Object Oriented Programming (OOP) has ignored this fact.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_who_am_i"></a>Who am I?</h5></div></div></div><p>When I sitting in front of the computer, I am a software developer, but if I go out in the jungle, I am suddenly
hunter-gatherer and prey. A large set of me is the same, but my interaction with the surroundings, i.e. the context, is
very different. I need different interfaces, so to speak, in these two different contexts.</p><p>Now, the above example is perhaps a bit extreme, but we see it in everyday life of the developer. When an object is
stored in the database it is of a different class, than when it is transported to the client and possibly when it is
displayed in the GUI. We see the effect of this problem in many of the design patterns and so called "best practices"
in Java EE development. Facades, delegation, data transport objects and many more.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_coupling"></a>Coupling</h4></div></div></div><p>The OOP proponents once proclaimed that classes can be re-used, since the code is encapsulated with the class, so the
class is an independent unit which lends itself well to re-use. In reality, however, we have found that classes becomes
tightly coupled with many other classes in their neighborhood, leading to impossibilities of single class re-use. Many
tricks are introduced to minimize the "Coupling Hell", such as Inversion of Control and Dependency Injection. Although
those tools are good, the underlying problem remains.</p><p>Why do we end up with large coupled class network graphs?</p><p>Essentially, it boils down to "scope". Classes are too large, their scope is too large, and for each small functional
unit within the class, there will be additional coupling to other classes. And this often progresses to the full
boundary of the entire domain the class remains in.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_application_layer_impedance_mismatch"></a>Application layer impedance mismatch</h4></div></div></div><p>Almost all technologies used in modern software development, starts by looking at an infrastructural problem and try to
solve that the best way. This is often done in a vacuum and layers on top will be struggling to map or translate the
solution into the higher abstraction, and the higher up we get, the harder it becomes to ignore the assumptions,
problems and limitations of the underlying technologies. It is also common that the underlying technologies "bleeds"
through the layers all the way into the domain models. The "bleed" combined with the problem of using independently
developed technologies, puts a large burden on the application developer, whose job it is to bring business value. And
often, the most skilled developers end up doing the bottom layers, leaving the hardest job to the least suitable.
Another interesting consequence is that each layer needs to anticipate every single use-case - real, potential or
perceived - and deal with it in a specifiable and useful manner. This leads to overly complex solutions, compared to if
the system is built from the top layer down, where each layer beneath knows exactly what is expected from it, and only
needs to handle those use-cases.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_abstracting_away_meaning"></a>Abstracting away meaning.</h4></div></div></div><p>To paraphrase a famous proverb about a hammer: "If all you have are objects, everything looks like a dependency."
We think that increasing abstraction often also increases complexity, and that the abstraction benefits are somewhat
linear whereas the complexity negatives are exponential. So, our conclusion is that by making no distinction between
different kinds of objects, many sound technologies run into incredibly difficult problems. The implementation of the
programming platform (e.g. Java) is of course easier to implement with a hefty amount of scope reduction into as few as
possible abstractions. But that is not the situation for the user. The abstraction is then required to be reversed when
the rubber hits the road, e.g. ORM mapping must be declared explicitly by the programmer, often using separate tools
and languages.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_solution"></a>Solution</h4></div></div></div><p>We think the solution was expressed more than 2500 years ago, first by Indian scholars and slightly later by Leucippus
and Democritus. We are of course talking about atoms, and by using really small building blocks, we can express
arbitrarily complex structures.
By reducing the classes into what we in Composite Oriented Programming call Fragments, we limit the coupling network
graph substantially. Re-use of Fragments becomes a reality, and by combination of Fragments, we compose larger
structures, the Composites.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_composition"></a>Composition</h4></div></div></div><p>Composite Oriented Programming also view the object, we call it the Composite instance, as the first class citizen. The
Composite instance can be cast to any context, meaning a different behavior can be applied to the Composite instance,
without affecting its underlying state. And back. This in turn means that we can for instance create a
ServerContextualInvoiceEntity, transport that across to a client, cast it to a GuiContextualInvoiceEntity do the
modifications to the underlying state, possibly using extra interfaces and methods for interacting with the GUI
environment, and then transport the modified object back to the server, cast it back to the
ServerContextualInvoiceEntity, and then persist the changes.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_domain_driven_design_focus"></a>Domain Driven Design focus</h4></div></div></div><p>Composite Oriented Programming is heavily influenced by the book "Domain Driven Design" by Eric Evans. And we are
trying to use his analysis of the problem to provide the mechanisms needed to get the job done quicker and more
reliably. Mr Evans talks about Applications, Layers, Modules, Specifications, SideEffects and so forth, and all of
these should be present in a Composite Oriented Programming implementation, and to a large extent it is in Qi4j.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="what-is-cop"></a>3.7. What is COP?</h3></div></div></div><p>We found this very well written blog entry on the Internet, which very well describes what Composite Oriented
Programming really is.</p><p>The article uses C# and a "show by example" approach to explaining COP, and this shows clearly that COP is not
Java specific, and although Qi4j was (to our knowledge) first to introduce the name, it applies across languages and
potentially deserves one or more languages on its own.</p><p>The article is re-published here, as allowed by the
<a class="ulink" href="http://msdn.microsoft.com/en-us/windowsmobile/bb264332.aspx" target="_top">Microsoft Permissive License</a>
, more recently known as
<a class="ulink" href="http://www.opensource.org/licenses/MS-PL" target="_top">Microsoft Public License</a>. The content below
is NOT under the usual <a class="ulink" href="http://www.opensource.org/licenses/Apache-2.0" target="_top">Apache License</a>.</p><p>We would like to thank Fredrik Kalseth for his explicit approval as well.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_ulink_url_http_iridescence_no_post_composite_oriented_programming_aspx_composite_oriented_programming_ulink"></a><a class="ulink" href="http://iridescence.no/post/composite-oriented-programming.aspx" target="_top">Composite Oriented Programming</a></h4></div></div></div><p>I’ve written a series of post on AOP lately (here, here and here), and in the last part I promised to tackle mixins
and introductions in a future post. When I was doing my research for just that, I came cross a Java framework (just
humor me :p) called Qi4j (that’s <span class="emphasis"><em>chee for jay</em></span>), written by Swedish Richard Öberg, pioneering the idea of Composite
Oriented Programming, which instantly put a spell on me. Essentially, it takes the concepts from Aspect Oriented
Programming to the extreme, and for the past week I’ve dug into it with a passion. This post is the first fruits of
my labor.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_oop_is_not_object_oriented"></a>OOP is Not Object Oriented!</h5></div></div></div><p>One of the things that Richard Öberg argues, is that OOP is not really object oriented at all, but rather class
oriented. As the Qi4j website proclaims, "class is the first class citizen that objects are derived from. Not objects
being the first-class citizen to which one or many classes are assigned". Composite oriented programming (COP) then,
tries to work around this limitation by building on a set of core principles; that behavior depends on context, that
decoupling is a virtue, and that business rules matter more. For a short and abstract explanation of COP,
<a class="link" href="#introduction-background" title="3.6.&#xA0;Background">see this page</a>. In the rest of this post I’ll try and explain some of its easily graspable
benefits through a set of code examples, and then in a future post we’ll look at how I’ve morphed the AOP framework
I started developing in the previous posts in this series into a lightweight COP framework that can actually make
it compile and run.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_lead_by_example"></a>Lead by Example</h5></div></div></div><p><span class="emphasis"><em>Lets pause for a short aside: obviously the examples presented here are going to be architectured beyond any rational
sense, but the interesting part lies in seeing the bigger picture; imagine the principles presented here applied on a
much larger scale and I’m sure you can see the benefits quite clearly when we reach the end.</em></span></p><p>Imagine that we have a class Division, which knows how to divide one number by another:</p><pre class="programlisting brush: c#">public class Division
{
    public Int64 Dividend { get; set; }
    private long _divisor = 1;

    public Int64 Divisor
    {
        get { return _divisor; }
        set
        {
            if(value == 0)
            {
                throw new ArgumentException("Cannot set the divisor to 0; division by 0 is not allowed.");
            }
            _divisor = value;
        }
    }

    public Int64 Calculate()
    {
        Trace.WriteLine("Calculating the division of " + this.Dividend + " by " + this.Divisor);
        Int64 result = this.Dividend/this.Divisor;
        Trace.WriteLine("Returning result: " + result);
        return result;
    }
}</pre><p>Consider the code presented above. Do you like it? If you’ve followed the discussion on AOP in the previous posts,
then you should immediately be able to identify that there are several aspects tangled together in the above class.
We’ve got data storage (the Dividend and Divisor properties), data validation (the argument check on the Divisor
setter), business logic (the actual calculation in the Calculate method) and diagnostics (the Trace calls), all
intertwined. To what extent is this class reusable if I wanted to implement addition, subtraction or multiplication
calculations? Not very, at least not unless we refactored it. We could make the Calculate method and the properties
virtual, and thus use inheritance to modify the logic of the calculation - and since this is a tiny example, it would
probably look OK. But again, think bigger - how would this apply to a huge API? It would easily become quite difficult
to manage as things got more and more complex.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_design_by_composition"></a>Design by Composition</h5></div></div></div><p>With a COP framework, we can implement each aspect as a separate object and then treat them as <span class="emphasis"><em>mixins</em></span> which blend
together into a meaningful <span class="emphasis"><em>composite</em></span>. Sounds confusing? Lets refactor the above example using an as of yet imaginary
COP framework for .NET (which I’m currently developing and will post the source code for in a follow-up post), and
it’ll all make sense (hopefully!).</p><p>Above, we identified the four different aspects in the Division class - so let’s implement each of them. First, we
have the data storage:</p><pre class="programlisting brush: c#">public interface ICalculationDataAspect // aspect contract
{
    long Number1 { get; set; }
    long Number2 { get; set; }
}

public class CalculationDataAspect : ICalculationDataAspect // aspect implementation
{
    public long Number1 { get; set; }
    public long Number2 { get; set; }
}</pre><p>In this example, the data storage is super easy – we just provide a set of properties (using the C# 3.0 automatic
properties notation) that can hold the values in-memory. The second aspect we found, was the business logic – the
actual calculation:</p><pre class="programlisting brush: c#">public interface ICalculationLogicAspect
{
    long Calculate();
}

public class DivisionLogicAspect : ICalculationLogicAspect
{
    [AspectRef] ICalculationDataAspect _data;

    public long Calculate()
    {
        return _data.Number1 / _data.Number2;
    }
}</pre><p>Here we follow the same structure again, by defining the aspect as an interface and providing an implementation of it.
In order to perform the calculation however, we need access to the data storage aspect so that we can read out the
numbers we should perform the calculation on. Using attributes, we can tell the COP framework that we require this
reference, and it will provide it for us at runtime using some dependency injection trickery behind the scenes. It is
important to notice that we’ve now placed a <span class="emphasis"><em>constraint</em></span> on any possible composition of these aspects – the
DivisionLogicAspect now requires an ICalculationDataAspect to be present in any composition it is part of (our COP
framework will be able to validate such constraints, and tell us up front should we break any). It is still loosely
coupled however, because we only hold a constraint on the <span class="emphasis"><em>contract</em></span> of that aspect, not any specific implementation of
it. We’ll see the benefit of that distinction later.</p><p>The third aspect we have, is validation. We want to ensure that the divisor is never set to 0, because trying to divide
by zero is not a pleasant experience. Validation is a type of advice, which was introduced at length earlier in my AOP
series. We’ve seen it implemented using the IAdvice interface of my AOP framework, allowing us to dynamically hook up
to a method invocation. However, the advice we’re implementing here is specific to the data aspect, so with our COP
framework we can define it as <span class="emphasis"><em>concern</em></span> for that particular aspect, which gives us a much nicer implementation than an
AOP framework could - in particular because of its type safety. Just look at this:</p><pre class="programlisting brush: c#">public abstract class DivisionValidationConcern : ICalculationDataAspect
{
    [ConcernFor] protected ICalculationDataAspect _proceed;

    public abstract long Number1 { get; set; }

    public long Number2
    {
        get { return _proceed.Number2; }
        set
        {
            if (value == 0)
            {
                throw new ArgumentException("Cannot set the Divisor to 0 - division by zero not allowed.");
            }
            _proceed.Number2 = value; // here, we tell the framework to proceed with the call to the *real* Number2 property
        }
    }
}</pre><p>I just love that, it’s so friggin' elegant ;). Remember that an advice is allowed to control the actual method
invocation by telling the target when to proceed – we’re doing the exact same thing above, only instead of dealing with
a generic method invocation we’re actually using the interface of the aspect we’re advising to control the specific
invocation directly. In our validation, we validate the value passed into the Divisor setter, and if we find it valid
then we tell the target (represented by a field annotated with an attribute which tells the COP framework to inject the
reference into it for us, much like we did with aspects earlier) to proceed with the invocation; otherwise we throw an
exception. This particular concern is abstract, because we only wanted to advise a subset of the methods in the
interface. That’s merely a convenience offered us by the framework - under the covers it will automatically complete
our implementation of the members we left abstract.</p><p>Only one aspect remains now, and that is the logging:</p><pre class="programlisting brush: c#">public class LoggingAdvice : IAdvice
{
    public object Execute(AdviceTarget target)
    {
        Trace.WriteLine("Invoking method " + target.TargetInfo.Name + " on " + target.TargetInfo.DeclaringType.FullName);

        object retValue;

        try
        {
            retValue = target.Proceed();
        }
        catch(Exception ex)
        {
            Trace.WriteLine("Method threw exception: " + ex.Message);
            throw;
        }
        Trace.WriteLine("Method returned " + retValue);
        return retValue;
    }
}</pre><p>We’ve implement it as a regular advice, like we’ve seen earlier in AOP, because it lends itself to much wider reuse
than the validation concern did.</p><p>Having defined all our aspects separately, it is now time to put them back together again into something that can
actually do something. We call this the composite, and it is defined as follows:</p><pre class="programlisting brush: c#">[Mixin(typeof(ICalculationDataAspect), typeof(CalculationDataAspect))]
[Mixin(typeof(ICalculationLogicAspect), typeof(DivisionLogicAspect))]
[Concern(typeof(DivisionValidationConcern))]
[Concern(typeof(LoggingAdvice))]
public interface IDivision : ICalculationDataAspect, ICalculationLogicAspect
{ }</pre><p>Basically, we’ve just defined the implementation of an interface IDivision as a composition of the data and logic
aspects, and sprinkled it with the two concerns (the validation concern and the logging advice). We can now use it to
perform divisions:</p><pre class="programlisting brush: c#">IDivision division = Composer.Compose&lt;IDivision&gt;().Instantiate();
division.Number1 = 10;
division.Number2 = 2;

Int64 sum = division.Calculate();</pre><p>That’s pretty cool, no? Take a moment to just think about what doors this opens. To what extent do you think our code
is reusable <span class="emphasis"><em>now</em></span>, if we wanted to implement addition, subtraction and so forth? That’s right – all we’d need to do is
substitute the implementation of the calculation aspect with one that performs the required calculation instead of
division, and we’re done. Let’s do subtraction, for example:</p><pre class="programlisting brush: c#">public class SubtractionLogicAspect : ICalculationLogicAspect
{
    [AspectRef] ICalculationDataAspect _data;

    public long Calculate()
    {
        return _data.Number1 - _data.Number2;
    }
}</pre><p>That’s it! The rest we can reuse as is, building a new composite:</p><pre class="programlisting brush: c#">[Mixin(typeof(ICalculationDataAspect), typeof(CalculationDataAspect))]
[Mixin(typeof(ICalculationLogicAspect), typeof(SubtractionLogicAspect))]
[Pointcut(typeof(LoggingAdvice))]
public interface ISubtraction : ICalculationDataAspect, ICalculationLogicAspect
{ }</pre><p>Notice that we just left out the validation concern in this composite, as it is no longer needed. What if we wanted
our subtraction to only ever return positive numbers? Easy! We’ll just implement an absolute number concern:</p><pre class="programlisting brush: c#">public class AbsoluteNumberConcern : ICalculationLogicAspect
{
    [ConcernFor] protected ICalculationLogicAspect _proceed;

    public long Calculate()
    {
        long result = _proceed.Calculate();

        return Math.Abs(result);
    }
}</pre><p>And then update the composition to include it:</p><pre class="programlisting brush: c#">[Mixin(typeof(ICalculationDataAspect), typeof(CalculationDataAspect))]
[Mixin(typeof(ICalculationLogicAspect), typeof(SubtractionLogicAspect))]
[Concern(typeof(AbsoluteNumberConcern))]
[Pointcut(typeof(LoggingAdvice))]
public interface ISubtraction : ICalculationDataAspect, ICalculationLogicAspect
{ }</pre><p>To Be Continued…</p><p>I hope this post has whet your appetite for more on this subject, as I will certainly pursue it further in future
posts. I’ve already implemented a prototype framework that supports the above examples, which builds on my
<a class="ulink" href="http://www.iridescence.no/Posts/Implementing-an-AOP-Framework-Part-2.aspx" target="_top">previously posted AOP framework</a>, and I’ll
post the source code for that soon. If you want to dig deeper right now (and don’t mind
a bit of Java), then I suggest you head over to the Qi4j website and poke about there.
<a class="ulink" href="http://rickardoberg.wordpress.com/" target="_top">Richard Öbergs blog</a> also provides great insight.</p></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="qi4j-cop"></a>3.8. COP with Java and Qi4j</h3></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="state-modeling"></a>3.9. Qi4j and state modeling</h3></div></div></div><p>(From Rickard Oberg’s blog, <a class="ulink" href="http://www.jroller.com/rickard/entry/qi4j_and_state_modeling" target="_top">http://www.jroller.com/rickard/entry/qi4j_and_state_modeling</a>, 2009-02-19)</p><p>In the Qi4j project we strive to being able to express our domain as directly as possible, with as little translation
as possible between how we think about a domain and how it is actually coded.
This then affects our entire view of how application frameworks should be constructed, and what we consider good and
bad ways of implementing certain features.</p><p>One part which is a good example of this is persistent state modeling. In other approaches and frameworks one would
typically use POJOs for the objects, and then plain class fields for references, collections and properties.
But during modeling these are not the words we use.
If POJOs are used for both Entities and Values, which have radically different semantics, we have to always translate
in our heads when talking about them, always keeping mind what the POJO is doing in any particular context.
In Domain Driven Design terms, POJOs are not in our Ubiquitous Language.</p><p>From a DDD perspective we want to talk about Entities and Values, Properties and Associations.
If our code does not reflect this, then there is translation going on, and translation inevitably leads to information loss.
In Qi4j, where Composites and not Objects, are the basic construct, we have created specialized forms to model these
concepts more explicitly.
We have EntityComposites and ValueComposites, each with different ways of creating them and managing them.
Both EntityComposites and ValueComposites can then have Properties, as first-class objects, but Properties in
ValueComposites are always immutable.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_entities"></a>Entities</h4></div></div></div><p>Here’s an example of how you could define an EntityComposite:</p><pre class="programlisting brush: java">interface PersonEntity
  extends EntityComposite
{
  Property&lt;String&gt; givenName();
  Property&lt;String&gt; surName();
}</pre><p>With these few lines you have done what would have taken a whole lot more effort using POJOs, and what you want to
express is very explicit.
To define a property you would have had to write a field and two accessors, and if you use interfaces then those
accessors would have to be duplicated.</p><p>The EntityComposite base interface also includes an identity property for you, as that’s an intrinsic feature of
Entities, so that’s all taken care of.
So if you speak about Entities in your domain discussions, each having Properties, then you can put that down in
code pretty much as-is.
This is, to me, a huge advantage over other ways of doing it, including POJO modeling (which lose clarity), UML
modeling (which has roundtrip problems), DSL modeling (which lose tools support), and whatnot.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_roles"></a>Roles</h4></div></div></div><p>If you want to get picky about it, the above example is probably not how you would model Person. Having a name is
just one role that a Person has to play, and since Composite Oriented Programming is all about using roles and
context instead of classes you would probably do something like this instead:</p><pre class="programlisting brush: java">interface Nameable
{
   @UseDefaults Property&lt;String&gt; givenName();
   @UseDefaults @Optional Property&lt;String&gt; surName();
}

interface PersonEntity
extends Nameable, EntityComposite
{}</pre><p>I’ve extracted the ability to be Named to its own interface, and let my domain Entity extend it.
This way client code can check for "x instanceof Nameable" rather than "x instanceof PersonEntity", and then do
something intelligent with it.
By doing this, not only has Nameable become a reusable interface, but the client code that understands it has also
become reusable for all domain objects in your model that uses it!</p><p>I’ve also marked both properties as @UseDefaults.
What does this do?
Well, if you have string properties they have the annoying property of being null to begin with, compared to ints
and longs which default to 0.
We figured that this was such a useful thing that we wanted to be able to mark our properties as being able to have
their initial values be set to a default, for the type.
For Strings this is the empty string, for primitives they are what you would expect.
For Collections they are set to empty collections of the type indicated.
"@UseDefaults Property&lt;List&lt;String&gt;&gt; addresses();" would be initialized to an empty ArrayList, for example.</p><p>In addition I have set surName() to be @Optional.
In Qi4j we have defined all properties to be not-null as the default, and the same goes for all parameters in method
invocations.
If you explicitly want to allow properties to be null, so that for example "Madonna" would be an acceptable name,
then you can mark it as @Optional.
We prefer @Optional to @Nullable since it better expresses the intent from a domain perspective.
Avoiding technical terms as much as possible is a another goal (which is damn hard to reach!).</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_values"></a>Values</h4></div></div></div><p>If you want to get really picky about it, not even the above would be a real example.
You may want to encapsulate the two properties into one value instead, so that you can more easily perform validation
checks when they are updated. What you want are ValueComposites:</p><pre class="programlisting brush: java">interface NameValue
   extends ValueComposite
{
   @UseDefaults Property&lt;String&gt; givenName();
   @UseDefaults @Optional Property&lt;String&gt; surName();
}

interface Nameable
{
   Property&lt;NameValue&gt; name();
}</pre><p>Normally if you want a property to be immutable, meaning, you can set an initial value but not change it later, you
would have to mark the Property as @Immutable.
But since NameValue extends ValueComposite, which itself is marked with @Immutable, this is implicit for all subtypes
of ValueComposite, and there’s no way to "opt out" of it.</p><p>By introducing one more level in the state model you have created an easy way to access the name as a whole and hand
it around the system, instead of as two separate properties.
Since it is immutable you are also ensured that noone can change it without going through the Entity, and you can
also share instances of the name without having to worry about thread-safety.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_privatizing_state"></a>Privatizing state</h4></div></div></div><p>The above is already a great step ahead in terms of how you can model your state more easily than having to use POJOs
to sort of "fake" the features I’m describing above, and there’s also a ton of cool features and consequences of the
whole thing I’m skipping here, for brevity.
One of the problems with POJO models that usually come up is that your getters and setters get exposed to clients,
and so functionality tend to not be put in the Entities, but rather in services and helper code, thereby scattering
the Entity into a bunch of places.
What should have been a neat and tidy little package is instead a anorectic little thing whose guts lay splashed
around your code, looking all soggy and unappetizing.</p><p>What to do about this?
One of the great inventions of Qi4j, I believe, is the notion of private mixins.
That we can have mixins in an object which are explicitly HIDDEN from usage outside of it.
How can we use this for state modeling?
What you’d want to do is to model the state of an Entity as a private mixin, which is hidden from clients, and then
you write role mixins which map domain methods to that internal state. Here’s an example:</p><pre class="programlisting brush: java">@Mixins(ListablePersonMixin.class)
interface PersonEntity
   extends Listable, EntityComposite {}

interface PersonState
   extends Nameable {}

public class ListablePersonMixin
   implements Listable
{
   @This PersonState person;

   @Override
   public String listName()
   {
      String fullName = person.name().get().givenName().get();
      String sn = name().get().surName().get();
      if (sn != null) fullName += " "+sn;
      return fullName;
   }
}</pre><p>Neat huh?
@This is a dependency injection annotation, but rather than the usual generic annotations like "@Inject" and friends,
this one actually has a meaningful scope, that is, it requires that "this Entity" implements PersonState.
The reference, as it is not extended by PersonEntity, is not visible to clients of the Entity and is hence a
private mixin.
Furthermore, all of a sudden your client code doesn’t even care if your domain object is Nameable, but rather if it
is Listable.
Cool!
So you can make a UI widget for listing "stuff" that only requires that your thingie is Listable, rather than being
a PersonEntity or Nameable.</p><p>For extra credit you could move the construction of "fullName" into a method on the NameValue, so that the value is
not only a dumb data container, but can also perform useful operations on itself.
And for the performance aware, don’t worry, the mixin is lazy-loaded, so if the particular usecase handling the
Entity doesn’t need the "Listable" interface the mixin will never be instantiated.</p><p>And so much more…</p><p>The above is just a small taste of what you can do with state modeling in Qi4j.
There is also support for associations and many-associations, the notion of aggregates, and a complete pluggable
system for persistence and indexing/querying of data.
To end with, here’s a sample of how some other state modeling concepts can be expressed in Qi4j:</p><pre class="programlisting brush: java">interface PersonEntity
   extends EntityComposite
{
   Association&lt;PersonEntity&gt; father();
   @Optional Association&lt;PersonEntity&gt; spouse();
   SetAssociation&lt;PersonEntity&gt; children();
   @Aggregated ListAssociation&lt;BookNoteEntity&gt; favouriteBooks();
}

interface BookNoteEntity
   extends EntityComposite
{
  Property&lt;String&gt; note();
  Association&lt;BookEntity&gt; book();
}</pre><p>I hope they are self-explanatory.</p><p>My hope is that with Composite Oriented Programming and Qi4j we can come one step closer to being able to express our
domain as clearly as possible in code.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="what-s-an-object-anyway"></a>3.10. What’s an Object anyway?</h3></div></div></div><p>In OOP the main idea is that we should model our reality by creating Objects. Objects have state, and they have methods.
Methods in an object are used to operate on the internal state and understands the domain that is being modeled.</p><p>By contrast, in procedural programming the focus is on algorithms, which can use several data structures to perform some
task. The focus is on what is going on, rather than the "objects" involved.</p><p>With OOP it becomes more difficult to "read" algorithms, as they are spread out in many objects that interact. With
procedural programming it becomes difficult to encapsulate and reuse functionality. Both represent extremes, neither of
which is "correct". The tendency to create anemic domain models is an indication that we have lost the algorithmic view
in OOP, and there is a need for it.</p><p>The main flaw of OOP, which COP addresses, is the answer to the fundamental question "What methods should an object
have?". In traditional OOP, which really should be called "class oriented programming", the classes tend to have a
rather narcissistic point of view. Classes are allowed to dictate what methods are in there - regardless of the
algorithms which they are part of - and algorithms then need to be aware of these classes when object instances
collaborate in an algorithm. Why? This seems like complete madness to me!! Keep in mind that if there were no
algorithms, there would be no need for methods at all!! Algorithms, then, are primary, and objects are what we use as
helper structures. In philosophical terms, if there is noone around to observe the universe, there would be no need for
the universe itself!</p><p>In COP the responsibility for defining the methods is reversed: algorithms which implement interactions between objects
get to declare what roles it needs the objects to implement, and the composites can then implement these. For each role
there will be an interface, and for each composite wanting to implement a role there will be a mixin in that composite.
This mixin can be specific for that composite implementation, or it can be generic and reused. The key point is that it
is the OBSERVER of the object, meaning, the algorithm, that gets to decide what the object should be able to do.</p><p>This is the same in real life. I don’t get to decide how I communicate with you. I have to use english, and I have to
use email, and I have to send it to a specific mailing list. It is the algorithm of the interaction between us, the
Qi4j dev mailing list, that has set these rules, not <span class="strong"><strong>I</strong></span> as a participant in this interaction. The same should,
obviously, be the case for objects.</p><p>So, with the understanding that algorithms should define roles for collaborating objects, and objects should then
implement these in order to participate in these algorithms, it should be trivial to realize that what has passed for
OOP so far, in terms of "class oriented programming", where this role-focus of objects is difficult to achieve, if not
even impossible, is just plain wrong. I mean seriously, catastrophically, terminally wrong.</p><p><span class="strong"><strong>Let that sink in.</strong></span></p><p>The method that has been used so far to get around this has been the composite pattern, where one object has been
designated as "coordinator", which then delegates to a number of other objects in order to implement the various roles.
This "solution", which is caused by this fundamental flaw in "class oriented programming", is essentially a hack, and
causes a number of other problems, such as the "self schizophrenia" problem, whereby there is no way to tell where the
object really is. There is no "this" pointer that has any relevant meaning.</p><p>The Composite pattern, as implemented in COP and Qi4j, gets around this by simply saying that the composite, as a
whole, is an object. Tada, we now have a "this" pointer, and a coherent way to deal with the object graph as though it
was a single object. We are now able to get back to the strengths of the procedural approach, which allows the
implementer of the algorithm to define the roles needed for the algorithm. The roles can either be specific to an
algorithm, or they can be shared between a number of algorithms if there is a generic way for them to be expressed.</p><p><span class="strong"><strong>Goodness!</strong></span></p><p>The question now becomes: how can we use this insight to structure our composites, so that what is part of the
algorithm is not too tightly encoded in the composites, thereby making the algorithms more reusable, and making it less
necessary to read composite code when trying to understand algorithms. The assumption here is that we are going to write
more algorithms than composites, therefore it has to be easy to ready algorithms, and only when necessary dive down into
composite code.</p><p>When talking about Composites as Objects in Qi4j it is most relevant to look at Entities, since these represent physical
objects in a model, rather than algorithms or services, or other non-instance-oriented things.</p><p>If Entities should implement roles, via mixins, in order to interact with each other through algorithms, then the
majority of their behaviour should be put into those role-mixins. These are exposed publically for clients to use.
However, the state that is required to implement these roles should not be exposed publically, as they represent
implementation details that may change over time, may be different depending on role implementation, and usually has a
lot of rules regarding how it may be changed. In short, the state needs to be private to the composite.</p><p>This leads us to this typical implementation of an Entity</p><pre class="programlisting brush: java">@Mixins(SomeMixin.class)
interface MyEntity
   extends Some, Other, EntityComposite
{}</pre><p>where Some and Other are role interfaces defined by one or more algorithms. SomeMixin is the implementation of the Some
interface. There is NO interface that is defined by the author of MyEntity. Algorithms first, objects second!</p><p>The state needed for these mixins would then be put into separate interfaces, referred to by using the @This injection
in the mixins.</p><pre class="programlisting brush: java">interface SomeState
{
   Property&lt;String&gt; someProperty();
}</pre><p>These interfaces will pretty much ONLY contain state declarations. There might be some methods in there, but I can’t
see right now what they would be.</p><p>In order to be able to get an overview of all the state being implemented by the Entity we introduce a "superstate"
interface:</p><pre class="programlisting brush: java">interface MyState
   extends SomeState, OtherState, ...
{}</pre><p>This lets us see the totality of all the state that the Entity has, and can be used in the builder phase:</p><pre class="programlisting brush: java">EntityBuilder&lt;MyEntity&gt; builder = uow.newEntityBuilder(MyEntity.class);
MyState state = builder.instanceFor(MyState.class);

... init state ...

MyEntity instance = builder.newInstance();</pre><p>This lets us divide our Entity into two parts: the internal state and the external roles of the domain that the object
takes part in. Due to the support for private mixins the state is not unnecessarily exposed, and the mixin support in
general allow our role-oriented approach to modeling. The role interfaces are strongly reusable, the mixins are
generally reusable, and the state interfaces are usually reusable. This minimizes the need for us to go into the mixin
code and read it. If we have read the mixin code once, and the same mixin is reused between objects, then this makes
it easier for us to understand it the next time we see it being used in another algorithm.</p><p>To summarize thus far, we have looked at why OOP so far has not worked out, why this is the case, and how COP deals
with it, and how we can implement a better solution of Entities using Qi4j. All is well!</p><p>The next step is to start using these Entities in algorithms. Algorithms are usually stateless, or at least they don’t
have any state that survives the execution of the algorithm. There is input, some calculation, and then output. In
other words, our notion of services fit perfectly here!</p><p>Algorithms, then, should(/could?) be modeled using services. If an algorithm needs other algorithms to compute
something, that is, if a service needs another service to do something, we can accomplish this using dependency
injection, so that the user of the initial algorithm does not have to know about this implementation detail.</p><p>In a "Getting Things Done" domain model, with Projects and Actions, you might then have an algorithm like so for task
delegation:</p><pre class="programlisting brush: java">void delegate(TaskExecutor from, Completable completable, TaskExecutor to)
{
   to.inbox().createTask( createDelegatedTask( completable ) );

   completable.complete(); // Delegated task is considered done

   from.inbox().createTask( createWaitingTask( completable ) );
}</pre><p>In the above I don’t know if "from" and "to" are human users or systems that automatically execute tasks. I also don’t
know if Completable is an entire Project or a single Action. From the point of view of the algorithm I don’t need to
know! All the algorithm cares about is that the roles it needs are fulfilled somehow. This means that I will be able to
extend my domain model later on, and have it be a part of these kinds of algorithms, without having to change my
algorithms. And as long as my composites implement the role interfaces, such as TaskExecutor and Completable, they can
participate in many different algorithms that use these as a way to interact with the domain objects.</p><p>This shows the place of services, as points of contact between objects in a domain model, or more generally,
"interactions". These will change often, and will increase in number as the system grows, so it is important that they
are easy to read, and that they are easy to participate in. With a focus on roles, rather than classes, this becomes
much easier to accomplish!</p><p>With the responsibilities of entities, as objects, and services, as algorithms, more clearly defined, the last part to
deal with is how these are put together. The services, with the methods now being role-oriented, can obviously be
applied to a wide variety of entities, but we now go from general to specific. In our software each general algorithm
is typically applied to specific objects in specific use-cases.</p><p><span class="strong"><strong>How is this done?</strong></span></p><p>This is done by implementing context objects, which pick specific objects and pass them into algorithms. This is
typically a UI-centric thing, and as such is difficult to encapsulate into a single method. With the previous example we
would need to get the three objects involved, and cast them to the specific roles we are interested in. The
"TaskExecutor from" could be the user running the application, the "Completable completable" could be the currently
selected item in a list, and "TaskExecutor to" could be a user designated from a popup dialog. These three are then
taken by the context and used to execute the "delegate" interaction, which performs all the steps necessary.</p><p>The interaction method "delegate" is testable, both with mocks of the input, and with specific instances of the various
roles. The implementations are also testable, and if the same mixin is used over and over for the implementation, then
only one set of tests is needed for each role interface.</p><p>To summarize we have in COP/Qi4j a way to get the best from procedural and object-oriented programming. As we have seen
the functionality falls into three categories, the entities implementing objects, the services implementing
interactions, and the user interface implementing the context. This also maps well to the ideas of ModelViewController,
which in turn maps well to the new ideas from Mr Reenskaug (inventor of MVC) called DCI: Data-Context-Interaction. As a
side-effect of this discussion we have therefore also seen how COP/Qi4j can be used to implement DCI, which is an
important next step in understanding objects and their interactions, the fundamentals of which (I believe) are captured
on this page.</p><p>That’s it. Well done if you’ve read this far :-)</p><p>Comments and thoughts to qi4j-dev forum at Google Groups on this are highly appreciated. This is very very important topics,
and crucial to understanding/explaining why COP/Qi4j is so great! :-)</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="tut-composites"></a>3.11. Transient Composites Tutorial</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><p>Throughout this set of tutorials it will be shown how to create and work with Composites, which
is the basic element in Qi4j. We will refactor one HelloWorld class to take advantage of the various
features in Qi4j. These refactorings will make it easier to reuse parts of the class,
and introduce new features without having to change existing code. We will also look
at some of the existing classes, or Fragments, available in Qi4j that you can reuse
so that you don’t have to write everything yourself.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#tut-composites-step1" title="Step 1 - Interface Refactoring">Step 1 - Interface Refactoring</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step2" title="Step 2 - Creating a Transient Composite">Step 2 - Creating a Transient Composite</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step3" title="Step 3 - Mixins">Step 3 - Mixins</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step4" title="Step 4 - Concerns">Step 4 - Concerns</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step5" title="Step 5 - Constraints">Step 5 - Constraints</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step6" title="Step 6 - SideEffects">Step 6 - SideEffects</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step7" title="Step 7 - Properties">Step 7 - Properties</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step8" title="Step 8 - Generic Mixins">Step 8 - Generic Mixins</a>
</li><li class="listitem">
<a class="xref" href="#tut-composites-step9" title="Step 9 - Private and Abstract Mixins">Step 9 - Private and Abstract Mixins</a>
</li></ul></div><p>Each tutorial step in this series starts with the result from the previous tutorial, so you can
always look at the next tutorial step for guidance on what to do.</p><p>At the bottom of each tutorial step, the is Solutions section, which list the files you should have come to if you
have followed the instructions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step1"></a>Step 1 - Interface Refactoring</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_initial_hello_world"></a>Initial Hello World</h5></div></div></div><p>This whole tutorial describes how to step-by-step modify a typical HelloWorld "application" into a full-fledged Qi4j
Composite Oriented application. Here is the initial code of HelloWorld.</p><pre class="programlisting brush: java">
/**
 * Initial HelloWorld implementation. Everything is mixed up
 * into one class, and no interface is used.
 */
public class HelloWorld
{
    String phrase;
    String name;

    public String getPhrase()
    {
        return phrase;
    }

    public void setPhrase( String phrase )
        throws IllegalArgumentException
    {
        if( phrase == null )
        {
            throw new IllegalArgumentException( "Phrase may not be null " );
        }

        this.phrase = phrase;
    }

    public String getName()
    {
        return name;
    }

    public void setName( String name )
        throws IllegalArgumentException
    {
        if( name == null )
        {
            throw new IllegalArgumentException( "Name may not be null " );
        }

        this.name = name;
    }

    public String say()
    {
        return phrase + " " + name;
    }
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_interface_refactoring"></a>Interface refactoring</h5></div></div></div><p>In this step we start with a basic Java class, which when invoked will concatenate the two properties "phrase"
and "name". If invoked with the properties set to "Hello" and "World" respectively it will hence return "Hello World".</p><p>Qi4j relies heavily on the use of interfaces. This makes it possible for an object to externally implement a number of
interfaces which internally is backed by a number of Mixins, some of which you may have written yourself, and some of
which may have been reused. This also makes it easy to introduce Modifiers (aka "interceptors", aka "advice"), which
are Fragments which execute before and/or after the method on the Mixin is invoked.</p><p>The first task is therefore to refactor the code so that the method is implemented from an interface instead. We should
then also separate the state into one interface and the behaviour into another. This will make things easier for us
later when state and behaviour becomes implemented by separate Mixins.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Refactor the class into interface and implementation.
</li><li class="listitem">
Refactor the interface so that it extends one interface called HelloWorldBehaviour with behaviour and one called HelloWorldState with state (get/set methods).
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_2"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p><span class="strong"><strong>HelloWorld.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface aggregates the behaviour and state
 * of the HelloWorld sub-interfaces. To a client
 * this is the same as before though, since it only
 * has to deal with this interface instead of the
 * two sub-interfaces.
 */
public interface HelloWorld
    extends HelloWorldBehaviour, HelloWorldState
{
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 * The exceptions will be thrown by Qi4j automatically if
 * null is sent in as values. The parameters would have to be declared
 * as @Optional if null is allowed.
 */
public interface HelloWorldState
{
    void setPhrase( String phrase )
        throws IllegalArgumentException;

    String getPhrase();

    void setName( String name )
        throws IllegalArgumentException;

    String getName();
}
</pre><p><span class="strong"><strong>HelloWorldBehaviour.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the behaviour
 * of the HelloWorld object.
 */
public interface HelloWorldBehaviour
{
    String say();
}
</pre><p><span class="strong"><strong>HelloWorldMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * interface. The behaviour and state is mixed.
 */
public class HelloWorldMixin
    implements HelloWorld
{
    String phrase;
    String name;

    @Override
    public String say()
    {
        return getPhrase() + " " + getName();
    }

    @Override
    public void setPhrase( String phrase )
        throws IllegalArgumentException
    {
        if( phrase == null )
        {
            throw new IllegalArgumentException( "Phrase may not be null" );
        }

        this.phrase = phrase;
    }

    @Override
    public String getPhrase()
    {
        return phrase;
    }

    @Override
    public void setName( String name )
        throws IllegalArgumentException
    {
        if( name == null )
        {
            throw new IllegalArgumentException( "Name may not be null" );
        }

        this.name = name;
    }

    @Override
    public String getName()
    {
        return name;
    }
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step2" title="Step 2 - Creating a Transient Composite">Step 2 - Creating a Transient Composite</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step2"></a>Step 2 - Creating a Transient Composite</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step1" title="Step 1 - Interface Refactoring">Step 1 - Interface Refactoring</a>.</p><p>In this step we will create a TransientComposite interface that ties all pieces together. The TransientComposite
interface is a regular Java interface which extends the interfaces you want to expose from your domain model, and which
uses various annotations to declare what Fragments to include. Fragments include Mixins, Concerns, SideEffects and
Constraints. In this tutorial we will only use Mixins. When a TransientComposite is instantiated at runtime the
framework will inspect the interface to determine what the TransientComposite instance should look like in terms of
used Fragments.</p><p>In Qi4j all method parameters are considered mandatory unless marked as @Optional. Therefore you can remove the null
checks in the Mixin. If a null value is passed in an exception will be thrown by Qi4j.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Create an interface that extends the domain interface HelloWorld and org.qi4j.api.composite.TransientComposite.
</li><li class="listitem">
Add a @Mixins annotation to it with the name of the Mixin as argument.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_3"></a>Solution</h5></div></div></div><p>These ones remain unchanged:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorld.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldBehaviour.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldState.java</code>
</li></ul></div><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares all the Fragments
 * of the HelloWorld composite.
 * &lt;p/&gt;
 * Currently it only declares one Mixin.
 */
@Mixins( HelloWorldMixin.class )
public interface HelloWorldComposite
    extends HelloWorld, TransientComposite
{
}
</pre><p><span class="strong"><strong>HelloWorldMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * interface. The behaviour and state is mixed.
 */
public class HelloWorldMixin
    implements HelloWorld
{
    String phrase;
    String name;

    @Override
    public String say()
    {
        return getPhrase() + " " + getName();
    }

    @Override
    public void setPhrase( String phrase )
        throws IllegalArgumentException
    {
        if( phrase == null )
        {
            throw new IllegalArgumentException( "Phrase may not be null" );
        }

        this.phrase = phrase;
    }

    @Override
    public String getPhrase()
    {
        return phrase;
    }

    @Override
    public void setName( String name )
        throws IllegalArgumentException
    {
        if( name == null )
        {
            throw new IllegalArgumentException( "Name may not be null" );
        }

        this.name = name;
    }

    @Override
    public String getName()
    {
        return name;
    }
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step3" title="Step 3 - Mixins">Step 3 - Mixins</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step3"></a>Step 3 - Mixins</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step2" title="Step 2 - Creating a Transient Composite">Step 2 - Creating a Transient Composite</a>.</p><p>In this step we refactor the Mixin from the previous steps into two, one which serves the behaviour interface and
one which serves the state interface. This makes it possible to reuse the interfaces independently and also makes it
easier to exchange one interface implementation with another. This also allows us to specify the new Mixins as default
implementations of the interfaces by adding @Mixins annotations on them.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Refactor the Mixin into one which implement the behaviour interface and one which implements the state interface. Use the @This injection annotation to allow the behaviour to access the state.
</li><li class="listitem">
Add a @Mixins annotations on the behaviour and state interfaces which declare the Mixins as default implementations.
</li><li class="listitem">
Remove the @Mixins annotation from the TransientComposite interface.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_4"></a>Solution</h5></div></div></div><p>Only <span class="strong"><strong>HelloWorld.java</strong></span> remains unchanged.</p><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares all the Fragments
 * of the HelloWorld composite.
 * &lt;p/&gt;
 * The Mixins annotation has been moved to the respective sub-interfaces.
 * The sub-interfaces therefore declare themselves what mixin implementation
 * is preferred. This interface could still have its own Mixins annotation
 * with overrides of those defaults however.
 */
public interface HelloWorldComposite
    extends HelloWorld, TransientComposite
{
}
</pre><p><span class="strong"><strong>HelloWorldBehaviour.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the behaviour
 * of the HelloWorld object.
 * &lt;p/&gt;
 * It declares what Mixin to use as default implementation.
 */
@Mixins( HelloWorldBehaviourMixin.class )
public interface HelloWorldBehaviour
{
    String say();
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * behaviour interface.
 * &lt;p/&gt;
 * It uses a @This Dependency Injection
 * annotation to access the state of the Composite. The field
 * will be automatically injected when the Composite
 * is instantiated. Injections of resources or references
 * can be provided either to fields, constructor parameters or method parameters.
 */
public class HelloWorldBehaviourMixin
    implements HelloWorldBehaviour
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.getPhrase() + " " + state.getName();
    }
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 * The exceptions will be thrown by Qi4j automatically if
 * null is sent in as values. The parameters would have to be declared
 * as @Optional if null is allowed.
 */
@Mixins( HelloWorldStateMixin.class )
public interface HelloWorldState
{
    void setPhrase( String phrase )
        throws IllegalArgumentException;

    String getPhrase();

    void setName( String name )
        throws IllegalArgumentException;

    String getName();
}
</pre><p><span class="strong"><strong>HelloWorldStateMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * state interface.
 */
public class HelloWorldStateMixin
    implements HelloWorldState
{
    String phrase;
    String name;

    @Override
    public String getPhrase()
    {
        return phrase;
    }

    @Override
    public void setPhrase( String phrase )
    {
        this.phrase = phrase;
    }

    @Override
    public String getName()
    {
        return name;
    }

    @Override
    public void setName( String name )
    {
        this.name = name;
    }
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step4" title="Step 4 - Concerns">Step 4 - Concerns</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step4"></a>Step 4 - Concerns</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step3" title="Step 3 - Mixins">Step 3 - Mixins</a>.</p><p>In this step we refactor the mixin from the previous steps so that the result of the say() method is modified to be
prefixed with "Simon says:". To do this we need to implement a Concern for the say() method. Concerns are a type of
Modifier which modify the behaviour of the methods in Mixins. They do this by intercepting the invocation of the
TransientComposite. This allows them to change the invocation parameters, return their own values or throw their own
exceptions, and do other things which directly affect the invocation of the method.</p><p>Concerns should not perform any side-effects, such as updating state in another TransientComposite, Mixin or similar.
Any side-effects are done in SideEffects, which is another type of Modifier, which are allowed to perform side-effects
but, in contrast to Concerns, cannot change the parameters or in any other way change the result of the invocation.</p><p>Concerns are implemented in one of two ways: either create a class which directly implements the interface whose
methods should be modified, or create a generic Modifier by implementing the InvocationHandler interface (or subclass
GenericConcern which does this for you). Add an @ConcernFor dependency injection, as a field, constructor parameter
or method parameter, which has the same type as the interface the Concern implements. When the TransientComposite is
invoked the Concern will be called, allowing it to perform it’s work. If the call should proceed, then invoke the
method again on the injected object. The preferred way to do all of this is to subclass ConcernOf which does all of
this for you.</p><p>Concerns are applied by adding an @Concerns annotation on the TransientComposite, the domain interface, or the Mixin
implementation. Any of these works, and where to put it is a matter of design choice.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Create a typed concern, implement the HelloWorldBehaviour and let it modify the result of the base method by prefix the result with "Simon says:".
</li><li class="listitem">
Add an @Concerns annotation on the HelloWorldBehaviourMixin which references the Concern class.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_5"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p>These ones remain unchanged:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorld.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldBehavior.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldComposite.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldState.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldStateMixin.java</code>
</li></ul></div><p><span class="strong"><strong>HelloWorldBehaviourMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * behaviour interface.
 * &lt;p/&gt;
 * It uses a @This Dependency Injection
 * annotation to access the state of the Composite. The field
 * will be automatically injected when the Composite
 * is instantiated. Injections of resources or references
 * can be provided either to fields, constructor parameters or method parameters.
 */
@Concerns( HelloWorldBehaviourConcern.class )
public class HelloWorldBehaviourMixin
    implements HelloWorldBehaviour
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.getPhrase() + " " + state.getName();
    }
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourConcern.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is a concern that modifies the mixin behaviour.
 */
public class HelloWorldBehaviourConcern
    extends ConcernOf&lt;HelloWorldBehaviour&gt;
    implements HelloWorldBehaviour
{
    @Override
    public String say()
    {
        return "Simon says:" + next.say();
    }
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step5" title="Step 5 - Constraints">Step 5 - Constraints</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step5"></a>Step 5 - Constraints</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step4" title="Step 4 - Concerns">Step 4 - Concerns</a>.</p><p>In this step we will look at how to use Constraints. When we pass parameters to methods in regular Java code the only
restriction we can make is to denote a type. Any other constraints on the input value, such as whether the parameter is
optional, integer ranges, string regular expressions, and so on, cannot be expressed, and so we have to put this into
Javadoc, and then manually add these checks in the implementation class.</p><p>In Qi4j there is the option to use Constraints, which are further restrictions on the parameters. This is implemented
by having an annotation that describes what the Constraint does, and then an implementation class that checks whether a
specific value fulfills the Constraint or not.</p><p>There are a number of pre-written constraints in Qi4j which you can use. The null check of the original HelloWorld
version is already handled by default since Qi4j considers method parameters to be mandatory if not explicitly marked
with the @Optional annotation. So, instead of doing that check we will add other checks that are useful to make, such
as ensuring that the passed in string is not empty.</p><p>The only thing you have to do is add the annotation @NotEmpty to the method parameters you want to constrain in this
way. The annotation has a default implementation declared in it by using the @Constraints annotation. You can either
just use this, which is the common case, or override it by declaring your own @Constraints annotation in the
TransientComposite type.</p><p>You can add as many Constraint annotations you want to a parameter. All of them will be checked whenever a method is
called.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Add @NotEmpty to the state parameters.
</li></ul></div><p>Note: The previous steps had a dependency to the <a class="xref" href="#core-api" title="6.2.&#xA0;Core API"> Core API</a> only. The constraints you’ve used in this step,
introduce a new dependency to the <a class="xref" href="#library-constraints" title="7.5.&#xA0;Constraints">Constraints Library</a>, where all the constraint related classes reside. So
update your classpath settings accordingly.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_6"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p>These ones remain unchanged:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorld.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldComposite.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldStateMixin.java</code>
</li></ul></div><p><span class="strong"><strong>HelloWorldBehaviour.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the behaviour
 * of the HelloWorld object.
 * &lt;p/&gt;
 * It declares what Mixin to use as default implementation, and also the extra
 * concern to be applied.
 */
@Concerns( HelloWorldBehaviourConcern.class )
@Mixins( HelloWorldBehaviourMixin.class )
public interface HelloWorldBehaviour
{
    String say();
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * behaviour interface.
 * &lt;p/&gt;
 * It uses a @This DependencyModel Injection
 * annotation to access the state of the Composite. The field
 * will be automatically injected when the Composite
 * is instantiated. Injections of resources or references
 * can be provided either to fields, constructor parameters or method parameters.
 */
public class HelloWorldBehaviourMixin
    implements HelloWorldBehaviour
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.getPhrase() + " " + state.getName();
    }
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourConcern.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Concern validates the parameters
 * to the HelloWorldState interface.
 */
public class HelloWorldBehaviourConcern
    extends ConcernOf&lt;HelloWorldBehaviour&gt;
    implements HelloWorldBehaviour
{
    @Override
    public String say()
    {
        return "Simon says:" + next.say();
    }
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 * &lt;p/&gt;
 * The parameters are declared as @NotEmpty, so the client cannot pass in empty strings
 * as values.
 */
@Mixins( HelloWorldStateMixin.class )
public interface HelloWorldState
{
    void setPhrase( @NotEmpty String phrase )
        throws IllegalArgumentException;

    String getPhrase();

    void setName( @NotEmpty String name )
        throws IllegalArgumentException;

    String getName();
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step6" title="Step 6 - SideEffects">Step 6 - SideEffects</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step6"></a>Step 6 - SideEffects</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step5" title="Step 5 - Constraints">Step 5 - Constraints</a>.</p><p>The current say() method has a Concern that modifies its value. What if we instead want the value to be intact, but log
that value to System.out? That would be considered a side-effect of the say() method, and should hence not be done in a
Concern. It would be better to implement this in a SideEffect. SideEffects are executed after the Mixin and all Concerns
for a method are done, which means that the final result has been computed. A SideEffect can access this result value,
and then use that for further computation, but it should not change the value or throw an exception.</p><p>SideEffects can be either typed or generic, just like Concerns. In the typed case we are interested in specifying
SideEffects for one or more particular methods, whereas in the generic case the SideEffect is not really relying on what
method is being invoked. Both are useful in different scenarios.</p><p>The easiest way to implement a typed SideEffect is to subclass the SideEffectOf class. This gives you access to the
result of the real method invocation by using the "next" field, which has the same type as the interface of the method
you want the code to be a side-effect of. Note that calling "next" does not actually do anything, it only returns the
value (or throws the exception, if one was thrown from the original method) that has already been computed. Similarly,
since the method is already done, you can return anything from the SideEffect method. The framework will simply throw it
away, and also ignore any exceptions that you throw in your code.</p><p>To declare that the SideEffect should be used you add the @SideEffects annotation to either the TransientComposite type,
the Mixin type, or the Mixin implementation. Either works.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Create the SideEffect class that logs the result of say() to System.out.
</li><li class="listitem">
Add a @SideEffects annotation with the SideEffect to the HelloWorldComposite interface.
</li><li class="listitem">
Remove the Concern from the previous step.
</li><li class="listitem">
Move the HelloWorldStateMixin from the HelloWorldState to the HelloWorldComposite interface.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_7"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p>These ones remain unchanged:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorld.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldBehaviourMixin.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldStateMixin.java</code>
</li></ul></div><p><span class="strong"><strong>HelloWorldBehaviour.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the behaviour
 * of the HelloWorld object.
 */
public interface HelloWorldBehaviour
{
    String say();
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourSideEffect.java</strong></span></p><pre class="programlisting brush: java">
/**
 * As a side-effect of calling say, output the result.
 */
public class HelloWorldBehaviourSideEffect
    extends SideEffectOf&lt;HelloWorldBehaviour&gt;
    implements HelloWorldBehaviour
{
    @Override
    public String say()
    {
        System.out.println( result.say() );
        return null;
    }
}
</pre><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares transitively
 * all the Fragments of the HelloWorld composite.
 * &lt;p/&gt;
 * It declares that the HelloWorldBehaviourSideEffect should be applied.
 */
@Mixins( { HelloWorldBehaviourMixin.class, HelloWorldStateMixin.class } )
@SideEffects( HelloWorldBehaviourSideEffect.class )
public interface HelloWorldComposite
    extends HelloWorld, TransientComposite
{
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 * &lt;p/&gt;
 * The parameters are declared as @NotEmpty, so the client cannot pass in empty strings
 * as values.
 */
public interface HelloWorldState
{
    void setPhrase( @NotEmpty String phrase )
        throws IllegalArgumentException;

    String getPhrase();

    void setName( @NotEmpty String name )
        throws IllegalArgumentException;

    String getName();
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step7" title="Step 7 - Properties">Step 7 - Properties</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step7"></a>Step 7 - Properties</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step6" title="Step 6 - SideEffects">Step 6 - SideEffects</a>.</p><p>One of the goals of Qi4j is to give you domain modeling tools that allow you to more concisely use domain concepts in
code. One of the things we do rather often is model Properties of objects as getters and setters. But this is a very
weak model, and does not give you any access to metadata about the property, and also makes common tasks like UI binding
non-trivial. There is also a lot of repetition of code, which is unnecessary. Using JavaBeans conventions one typically
have to have code in five places for one property, whereas in Qi4j the same thing can be achieved with one line of code.</p><p>But lets start out easy. To declare a property you have to make a method in a mixin type that returns a value of the
type Property, and which does not take any parameters. Here’s a simple example:</p><pre class="programlisting brush: java">Property&lt;String&gt; name();</pre><p>This declares a Property of type String with the name "name". The Property interface has methods "get" and "set" to
access and mutate the value, respectively.</p><p>For now you will be responsible for implementing these methods, but later on these will be handled automatically, thus
reducing Properties to one-liners!</p><p>In the Mixin implementation of the interface with the Property declaration you should have an injection of the Property,
which is created for you by Qi4j. The injection can be done in a field like this:</p><pre class="programlisting brush: java">@State Property&lt;String&gt; name;</pre><p>The State dependency injection annotation means that Qi4j will inject the Property for you. The field has the name
"name", which matches the name in the interface, and therefore that Property is injected. You can then implement the
method trivially by just returning the "name" field.</p><p>Properties can have Constraints just like method parameters. Simply set them on the Property method instead, and they
will be applied just as before when you call "set".</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Remove JavaBeans properties from HelloWorldState.
</li><li class="listitem">
Remove HelloWorld and add the HelloWorldState and HelloWorldBehavior to the HelloWorldComposite interface.
</li><li class="listitem">
Remove the HelloWorldBehaviourSideEffect.
</li><li class="listitem">
Update the behaviour mixin to use the state interface accordingly.
</li><li class="listitem">
Add Property methods with the correct type and the @NotEmpty annotation.
</li><li class="listitem">
Update the state mixin to inject and return the properties as described above.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_8"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p>Only <code class="literal">HelloWorldBehavior.java</code> remains unchanged.</p><p>Theses ones are deleted:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorld.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldConcern.java</code>
</li></ul></div><p><span class="strong"><strong>HelloWorldBehaviourMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * behaviour interface.
 * &lt;p/&gt;
 * This version access the state using Qi4j Properties.
 */
public class HelloWorldBehaviourMixin
    implements HelloWorldBehaviour
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.phrase().get() + " " + state.name().get();
    }
}
</pre><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares transitively
 * all the Fragments of the HelloWorld composite.
 */
@Mixins( { HelloWorldBehaviourMixin.class, HelloWorldStateMixin.class } )
public interface HelloWorldComposite
    extends HelloWorldBehaviour, HelloWorldState, TransientComposite
{
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 * &lt;p/&gt;
 * The state is now declared using Properties. The @NotEmpty annotation is applied to the
 * method instead, and has the same meaning as before.
 */
public interface HelloWorldState
{
    @NotEmpty
    Property&lt;String&gt; phrase();

    @NotEmpty
    Property&lt;String&gt; name();
}
</pre><p><span class="strong"><strong>HelloWorldStateMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * state interface.
 */
public class HelloWorldStateMixin
    implements HelloWorldState
{
    @State
    private Property&lt;String&gt; phrase;
    @State
    private Property&lt;String&gt; name;

    @Override
    public Property&lt;String&gt; phrase()
    {
        return phrase;
    }

    @Override
    public Property&lt;String&gt; name()
    {
        return name;
    }
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step8" title="Step 8 - Generic Mixins">Step 8 - Generic Mixins</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step8"></a>Step 8 - Generic Mixins</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step7" title="Step 7 - Properties">Step 7 - Properties</a>.</p><p>In this step we will look at how to use generic Fragments. So far all Fragments, i.e. the Concerns, SideEffects,
and Mixins, have directly implemented the domain interface. But sometimes it is useful to be able to provide a generic
implementation of an interface. An example of this is the HelloWorldState interface. Since it only handles properties,
and the old version used the JavaBean rules for naming getters and setters we could create a mixin that handles
invocations of such methods automatically for us by storing the properties in a map and use the methods to look them up.</p><p>Implementing a generic Fragment is done by creating a class that implements the interface
java.lang.proxy.InvocationHandler. This has a single "invoke" method which is passed the object that was invoked (the
TransientComposite in this case), the method, and the arguments. The Fragment is then allowed to implement the method
any way it wants.</p><p>Since interfaces with only Properties is such a common case Qi4j already has a generic Mixin that implements the
Properties management described above, but for the builtin Property type instead of the getter/setter variant. The
class is aptly named PropertyMixin.</p><p>While we could use it, for now we will implement it ourselves to get a feel for how generic Mixins work.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Remove the HelloWorldStateMixin
</li><li class="listitem">
Add a GenericPropertyMixin, and have it implement InvocationHandler
</li><li class="listitem">
Inject "@State StateHolder state" in the mixin. The StateHolder interface will give you access to the Properties for the TransientComposite which Qi4j manages for you
</li><li class="listitem">
On call to invoke(), delegate to the StateHolder interface to get the Property for the invoked method
</li><li class="listitem">
Add an @AppliesTo annotation to the Mixin and implement the AppliesToFilter with a rule that matches only methods that return Property values.
</li><li class="listitem">
Add the mixin to the TransientComposite.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_9"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts;</p><p>These ones remain unchanged:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">HelloWorldBehaviour.java</code>
</li><li class="listitem">
<code class="literal">HelloWorldState.java</code>
</li></ul></div><p><span class="strong"><strong>GenericPropertyMixin.java</strong></span></p><pre class="programlisting brush: java">@AppliesTo( { GenericPropertyMixin.PropertyFilter.class } )
public class GenericPropertyMixin
    implements InvocationHandler
{
    @State
    private StateHolder state;

    @Override
    public Object invoke( Object proxy, Method method, Object[] args )
        throws Throwable
    {
        return state.propertyFor( method );
    }

    public static class PropertyFilter
        implements AppliesToFilter
    {
        @Override
        public boolean appliesTo( Method method, Class&lt;?&gt; mixin, Class&lt;?&gt; compositeType, Class&lt;?&gt; modifierClass )
        {
            return Property.class.isAssignableFrom( method.getReturnType() );
        }
    }
}
</pre><p><span class="strong"><strong>HelloWorldBehaviourMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the HelloWorld
 * behaviour interface.
 */
public class HelloWorldBehaviourMixin
    implements HelloWorldBehaviour
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.phrase().get() + " " + state.name().get();
    }
}
</pre><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares transitively
 * all the Fragments of the HelloWorld composite.
 * &lt;p/&gt;
 * All standard declarations have been moved to
 * the StandardAbstractEntityComposite so we don't have to repeat
 * them in all Composites.
 */
@Mixins( { HelloWorldBehaviourMixin.class, GenericPropertyMixin.class } )
public interface HelloWorldComposite
    extends HelloWorldBehaviour, HelloWorldState, TransientComposite
{
}
</pre><p>Next step is <a class="xref" href="#tut-composites-step9" title="Step 9 - Private and Abstract Mixins">Step 9 - Private and Abstract Mixins</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-composites-step9"></a>Step 9 - Private and Abstract Mixins</h4></div></div></div><p>Previous step was <a class="xref" href="#tut-composites-step8" title="Step 8 - Generic Mixins">Step 8 - Generic Mixins</a>.</p><p>Now we’re going to turn around and see how we can reduce the code needed to implement the HelloWorld example. We will
also look at how to hide the Properties from the client code, since Properties are often considered to be implementation
details that should not be exposed to clients.</p><p>The first thing we will do is remove the behaviour interface, and move the say() method to the TransientComposite type.
This forces the mixin to implement the TransientComposite type, which would normally mean that it would have to
implement all methods, including those found in the TransientComposite interface. However, since we are only really
interested in implementing the say() method we will mark this by declaring that the Mixin "implements" the
TransientComposite type, but is also "abstract". This, using pure Java semantics, makes it possible to avoid having to
implement all methods. Qi4j will during the initialization phase detect that the Mixin only handles the say() method,
and therefore only map it to that specific method. In order to instantiate the Mixin it will generate a subclass which
implements the remaining methods in the TransientComposite type, as no-ops. These will never be called however, and is
there purely for the purpose of being able to instantiate the Mixin. The Mixin is considered to be an Abstract Fragment.</p><p>To hide the state from the client we need to use what is called Private Mixins. A Private Mixin is any mixin that is
referenced by another Mixin by using the @This injection, but which is not included in the TransientComposite type. As
long as there is a Mixin implementation declared for the interface specified by the @This injection it will work, since
Qi4j can know how to implement the interface. But since it is not extended by the TransientComposite type there is no
way for a user of the TransientComposite to access it. That Mixin becomes an implementation detail. This can be used
either for encapsulation purposes, or for referencing utility mixins that help the rest of the code implement some
interface, but which itself should not be exposed.</p><p>Since the state is now hidden the initialization of the TransientComposite is a bit more tricky. Instead of just
instantiating it you have to create a TransientBuilder first, then set the state using .prototypeFor(), and then call
newInstance(). This ensures that the state can be set during construction, but not at any later point, other than
through publicly exposed methods.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Move the say() method into the TransientComposite interface.
</li><li class="listitem">
Remove the behaviour interface.
</li><li class="listitem">
Remove the HelloWorldBehaviourMixin, create a HelloWorldMixin and let the HelloWorldMixin implement the TransientComposite directly.
</li><li class="listitem">
Mark the HelloWorldMixin as abstract and implement only the say() method.
</li><li class="listitem">
Remove the HelloWorldState from the TransientComposite "extends" declaration.
</li><li class="listitem">
Remove the GenericPropertyMixin. The Property methods will be implemented by the standard PropertyMixin declared in the TransientComposite interface instead.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_solution_10"></a>Solution</h5></div></div></div><p>If you have successfully completed the task, you should end up with the following artifacts only;</p><p><span class="strong"><strong>HelloWorldComposite.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This Composite interface declares transitively
 * all the Fragments of the HelloWorld composite.
 * &lt;p/&gt;
 * The Fragments are all abstract, so it's ok to
 * put the domain methods here. Otherwise the Fragments
 * would have to implement all methods, including those in Composite.
 */
@Mixins( { HelloWorldMixin.class } )
public interface HelloWorldComposite
    extends TransientComposite
{
    String say();
}
</pre><p><span class="strong"><strong>HelloWorldMixin.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This is the implementation of the say() method. The mixin
 * is abstract so it doesn't have to implement all methods
 * from the Composite interface.
 */
public abstract class HelloWorldMixin
    implements HelloWorldComposite
{
    @This
    HelloWorldState state;

    @Override
    public String say()
    {
        return state.phrase().get() + " " + state.name().get();
    }
}
</pre><p><span class="strong"><strong>HelloWorldState.java</strong></span></p><pre class="programlisting brush: java">
/**
 * This interface contains only the state
 * of the HelloWorld object.
 */
public interface HelloWorldState
{
    @NotEmpty
    Property&lt;String&gt; phrase();

    @NotEmpty
    Property&lt;String&gt; name();
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="tut-services"></a>3.12. Services Composites Tutorial</h3></div></div></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Theses tutorials are based on actual code found in the <code class="literal">tutorials/</code> directory of the <a class="link" href="#download" title="11.2.&#xA0;Download Qi4j">Qi4j SDK sources</a>.
You should start your favorite editor and find the code related to this tutorial, run it and play with it.</p></td></tr></table></div><p>In this other set of tutorials it will be shown how to create and work with Service Composites, which are composites
that extends from the ServiceComposite class. We will refactor one a very simple Library where you can borrow and
return books to take advantage of the various features in Qi4j. These refactorings will benefit from automatic Service
activation and Configuration Entities management.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#tut-services-step1" title="Step 1 - Creating a ServiceComposite">Step 1 - Creating a ServiceComposite</a>
</li><li class="listitem">
<a class="xref" href="#tut-services-step2" title="Step 2 - Hooking into the Service Activation">Step 2 - Hooking into the Service Activation</a>
</li><li class="listitem">
<a class="xref" href="#tut-services-step3" title="Step 3 - Reading the Service Configuration">Step 3 - Reading the Service Configuration</a>
</li></ul></div><p>Each tutorial step in this series starts with the result from the previous tutorial, so you can
always look at the next tutorial step for guidance on what to do.</p><p>At the bottom of each tutorial step, the is Solutions section, which list the files you should have come to if you
have followed the instructions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-services-step1"></a>Step 1 - Creating a ServiceComposite</h4></div></div></div><p>In this tutorial we start with basic Java classes, to simulate a very simple Library where you can borrow
and return books.</p><p>Qi4j relies heavily on the use of interfaces. This makes it possible for an object
to externally implement a number of interfaces which internally is backed by a number
of Mixins, some of which you may have written yourself, and some of which may have been
reused. This is also true for services, which we are to cover in this tutorial.</p><p>The first task is therefore to refactor the code so that the methods are implemented from an
interface instead, and to essentially make the identical "application" into a Qi4j application.
We also want the Book to be a ValueComposite.</p><p>Steps for this tutorial:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Make the Book into a ValueComposite.
</li><li class="listitem">
Make the Library an interface with the same methods. We call this a MixinType.
</li><li class="listitem">
Create a LibraryMixin class, which implements the Library interface.
</li><li class="listitem">
Create a LibraryService that binds the LibraryMixin.
</li><li class="listitem">
The LibraryMixin will need to be injected with the ValueBuilderFactory in the @Structure scope.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-services-step2"></a>Step 2 - Hooking into the Service Activation</h4></div></div></div><p>Services can be "activated" and "passivated". Applications can be notified of this occurring
by Qi4j runtime by assembling them with an Activator.</p><p>Activators methods are called around "activation" and "passivation": beforeActivation,
afterActivation, beforeActivation, afterPassivation. The
ActivatorAdapter class help you keeping your code short when you only need one or two hooks.</p><p>To showcase how this works, we refactor the code to create a number of copies of the books, to be lend out
upon call to the borrowBook method, which will return null if no copy is available. The book
copies are created in the activate method.</p><p>Steps to do:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Add a createInitialData method to Library.
</li><li class="listitem">
In the implementation, create a couple of books of each title and store each copy in a HashMap&lt;String,ArrayList&lt;Book&gt;&gt;.
</li><li class="listitem">
Write an Activator&lt;ServiceReference&lt;Library&gt;&gt; class extending ActivatorAdapter.
</li><li class="listitem">
Override the afterActivation method, use the ServiceReference to get a handle on the Library and call its createInitialData method.
</li><li class="listitem">
Add the @Activators annotation to the LibraryService declaring the new LibraryActivator.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="tut-services-step3"></a>Step 3 - Reading the Service Configuration</h4></div></div></div><p>Services typically have configuration. Configurations are directly supported in Qi4j. A
ConfigurationComposite is a subtype of EntityComposite. That is because
configurations are stored in EntityStores, can be modified in runtime by client code and has
the same semantics as regular entities.</p><p>Qi4j also handles the bootstrapping of configuration for the services. If the ConfigurationComposite is
not found in the configured entity store, then Qi4j will automatically locate a properties file for each
service instance, read those properties into a ConfigurationComposite instance, save that to the
entity store and provide the values to the service. The properties file must be with the same name as
the service instance with the extension "properties" in the same package as the service.</p><p>For this exercise, create a LibraryConfiguration that contains "titles", "authors" and "copies".
The first two are a string with a comma separated list, and the "copies" is just an Integer with how many
copies are made of each title.</p><p>Steps to do.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Create a LibraryConfiguration interface that extends ConfigurationComposite, and has three Property instances named "titles", "authors" and "copies", where the first two are of String type and the last is of Integer type.
</li><li class="listitem">
Delete the LibraryActivator and remove the @Activators annotation from the LibraryService and the corresponding createInitialData method.
</li><li class="listitem">
In the LibraryMixin remove the member injection of the ValueBuilderFactory, and instead inject the ValueBuilderFactory in the constructor.
</li><li class="listitem">
Inject the LibraryConfiguration via the constructor. The injection scope is @This.
</li><li class="listitem">
Create a resource called LibraryService.properties and place it in the directory org/qi4j/tutorials/services/step4 in the classpath (for instance, src/main/resources ). Put something like this in:
    titles=Domain Driven Design, Pragmatic Programmer, Extreme Programming Explained
    authors=Eric Evans, Andy Hunt, Kent Beck
    #Number of copies of each book.
    copies=3
</li><li class="listitem">
Load initial data from the LibraryConfiguration in the LibraryMixin constructor.
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-depend-on-qi4j"></a>3.13. Depend on Qi4j in your build</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Some of Qi4j <a class="xref" href="#libraries" title="7.&#xA0;Libraries">Libraries</a> and <a class="xref" href="#extensions" title="8.&#xA0;Extensions">Extensions</a> depend on artifacts that are not deployed in central, you’ll need to
add other repositories to your build scripts accordingly.</p></td></tr></table></div><p>Release artifacts are deployed to</p><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/release/" target="_top">https://repository-qi4j.forge.cloudbees.com/release/</a>.</p><p>Snapshot artifacts are deployed to</p><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/snapshot/" target="_top">https://repository-qi4j.forge.cloudbees.com/snapshot/</a>.</p><p>As they are not deployed to central you need to add the repositories to your build scripts.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_manually"></a>Manually</h4></div></div></div><p>If you don’t rely on your build scripts dependency resolution mechanism you should <a class="xref" href="#download" title="11.2.&#xA0;Download Qi4j">Download Qi4j</a> the SDK distribution.</p><p>If you’re in manual dependency management you should be able to find out which JAR files you’ll need to add to your
projects.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_maven"></a>Using Maven</h4></div></div></div><p>First you need to register the Qi4j repositories:</p><pre class="programlisting brush: xml">&lt;!-- ... --&gt;
&lt;repositories&gt;
    &lt;!-- ... --&gt;
    &lt;repository&gt;
        &lt;id&gt;qi4j-releases&lt;/id&gt;
        &lt;url&gt;https://repository-qi4j.forge.cloudbees.com/release/&lt;/url&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
        &lt;id&gt;qi4j-snapshots&lt;/id&gt;
        &lt;url&gt;https://repository-qi4j.forge.cloudbees.com/snapshot/&lt;/url&gt;
        &lt;releases&gt;&lt;enabled&gt;false&lt;/enabled&gt;&lt;/releases&gt;
        &lt;snapshots&gt;&lt;enabled&gt;true&lt;/enabled&gt;&lt;/snapshots&gt;
    &lt;/repository&gt;
    &lt;!-- ... --&gt;
&lt;/repositories&gt;
&lt;!-- ... --&gt;</pre><p>After that you can declare dependencies on Qi4j artifacts:</p><pre class="programlisting brush: xml">&lt;!-- ... --&gt;
&lt;dependencies&gt;
    &lt;!-- ... --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.qi4j.core&lt;/groupId&gt;
        &lt;artifactId&gt;org.qi4j.core.bootstrap&lt;/artifactId&gt;
        &lt;version&gt;QI4J_VERSION&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.qi4j.core&lt;/groupId&gt;
        &lt;artifactId&gt;org.qi4j.core.runtime&lt;/artifactId&gt;
        &lt;version&gt;QI4J_VERSION&lt;/version&gt;
        &lt;scope&gt;runtime&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!-- ... --&gt;
&lt;/dependencies&gt;
&lt;!-- ... --&gt;</pre><p>Where <code class="literal">QI4J_VERSION</code> is the Qi4j version you want to use.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_gradle"></a>Using Gradle</h4></div></div></div><p>First you need to register the Qi4j repositories:</p><pre class="programlisting brush: groovy">// ...
repositories {
    // ...
    mavenRepo name: 'qi4j-releases', url: "https://repository-qi4j.forge.cloudbees.com/release/"
    mavenRepo name: 'qi4j-snapshots', url: "https://repository-qi4j.forge.cloudbees.com/snapshot/"
    // ...
}
// ...</pre><p>After that you can declare dependencies on Qi4j artifacts:</p><pre class="programlisting brush: groovy">// ...
dependencies {
    // ...
    compile "org.qi4j.core:org.qi4j.core.bootstrap:QI4J_VERSION"
    runtime "org.qi4j.core:org.qi4j.core.runtime:QI4J_VERSION"
    // ...
}
// ...</pre><p>Where <code class="literal">QI4J_VERSION</code> is the Qi4j version you want to use.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_buildr"></a>Using Buildr</h4></div></div></div><p>First you need to register the Qi4j repositories:</p><pre class="programlisting brush: ruby"># ...
repositories.remote &lt;&lt; 'https://repository-qi4j.forge.cloudbees.com/release/'
repositories.remote &lt;&lt; 'https://repository-qi4j.forge.cloudbees.com/snapshot/'
# ...</pre><p>After that you can declare dependencies on Qi4j artifacts:</p><pre class="programlisting brush: ruby"># ...
compile.with 'org.qi4j.core:org.qi4j.core.bootstrap:QI4J_VERSION'
package(:war).with :libs =&gt; 'org.qi4j.core:org.qi4j.core.runtime:QI4J_VERSION'
# ...</pre><p>Where <code class="literal">QI4J_VERSION</code> is the Qi4j version you want to use.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_sbt"></a>Using SBT</h4></div></div></div><p>First you need to register the Qi4j repositories:</p><pre class="programlisting brush: scala">// ...
resolvers += "qi4j-releases" at "https://repository-qi4j.forge.cloudbees.com/release/"
resolvers += "qi4j-snapshots" at "https://repository-qi4j.forge.cloudbees.com/snapshot/"
// ...</pre><p>After that you can declare dependencies on Qi4j artifacts:</p><pre class="programlisting brush: scala">// ...
libraryDependencies += \
    "org.qi4j.core" % "org.qi4j.core.bootstrap" % "QI4J_VERSION" \
    withSources() withJavadoc()
libraryDependencies += \
    "org.qi4j.core" % "org.qi4j.core.runtime" % "QI4J_VERSION" % "runtime" \
    withSources() withJavadoc()
// ...</pre><p>Where <code class="literal">QI4J_VERSION</code> is the Qi4j version you want to use.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_ivy"></a>Using Ivy</h4></div></div></div><p>First you need to register the Qi4j repositories in a <code class="literal">ivysettings.xml</code> file:</p><pre class="programlisting brush: xml">&lt;ivysettings&gt;
    &lt;settings defaultResolver="chain"/&gt;
    &lt;resolvers&gt;
        &lt;chain name="chain"&gt;
            &lt;!-- ... --&gt;
            &lt;ibiblio name="qi4j-releases"  m2compatible="true"
                     root="https://repository-qi4j.forge.cloudbees.com/release/"/&gt;
            &lt;ibiblio name="qi4j-snapshots" m2compatible="true"
                     root="https://repository-qi4j.forge.cloudbees.com/snapshot/"/&gt;
            &lt;!-- ... --&gt;
        &lt;/chain&gt;
    &lt;/resolvers&gt;
&lt;/ivysettings&gt;</pre><p>After that you can declare dependencies on Qi4j artifacts:</p><pre class="programlisting brush: xml">&lt;ivy-module&gt;
    &lt;!-- ... --&gt;
    &lt;dependencies&gt;
        &lt;!-- ... --&gt;
        &lt;dependency org="org.qi4j.core" name="org.qi4j.core.bootstrap"
                    rev="QI4J_VERSION"  conf="default" /&gt;
        &lt;dependency org="org.qi4j.core" name="org.qi4j.core.runtime"
                    rev="QI4J_VERSION"  conf="runtime" /&gt;
        &lt;!-- ... --&gt;
    &lt;/dependencies&gt;
    &lt;!-- ... --&gt;
&lt;/ivy-module&gt;</pre><p>Where <code class="literal">QI4J_VERSION</code> is the Qi4j version you want to use.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-assemble-application"></a>3.14. Assemble an Application</h3></div></div></div><p>We receive a lot of questions about how applications should be assembled, and since we don’t have any XML to "fill in"
and everything is to be done programmatically, it escalates the need to provide more hands-on explanation of how this is
done.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_basics"></a>Basics</h4></div></div></div><p>First let’s recap the structural requirements of Qi4j;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
There is one and only one Application instance per Qi4j Runtime.
</li><li class="listitem">
Every Application must contain one or more Layers.
</li><li class="listitem">
All Composites must be declared in one or more Modules.
</li><li class="listitem">
Each Module belong to a Layer.
</li><li class="listitem">
Layers are ordered in hierarchies, from simple to complex.
</li><li class="listitem">
Access to Composites are limited by visibility rules.
</li></ul></div><p>Ok, that was quite a handful. Let’s look at them one by one.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_application"></a>Application</h4></div></div></div><p>The first one means that for each Qi4j Runtime you start, there will be exactly one application. As far as we know, Qi4j
is fully isolated, meaning there are no static members being populated and such.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_layers"></a>Layers</h4></div></div></div><p>Layers are the super-structures of an application. We have been talking about them for decades, drawn them on paper and
whiteboards (or even black boards for those old enough), and sometimes organized the codebases along such boundaries.
But, there has been little effort to enforce the Layer mechanism in code, although it is an extremely powerful
construct. First of all it implies directional dependency and a high degree of order, spagetti code is reduced if
successfully implemented. For Qi4j, it means that we can restrict access to Composite and Object declarations, so that
higher layers can not reach them incidentally. You can enforce architecture to a high degree. You can require all
creation of composites to go through an exposed Factory, which doesn’t require the Composite to be public. And so on.
Layers have hierarchy, i.e. one layer is top of one or more layers, and is below one or more layers, except for the
layers at the top and bottom. You could have disjoint layers, which can’t access each other, meaning a couple of layers
that are both the top and bottom.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_modules"></a>Modules</h4></div></div></div><p>The Module concept has also been around forever. And in Qi4j we also makes the Modules explicit. Each Module belong to a
Layer, and for each Module you declare the Composite and Object types for that Module, together with a Visibility rule,
one of; application, layer, module.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_visibility"></a>Visibility</h4></div></div></div><p>The Visibility rules are perhaps the most powerful aspect of the above. Visibility is a mechanism that kicks in whenever
a Composite type need to be looked up. It defines both the scoping rules of the client as well as the provider. A lookup
is either a direct reference, such as</p><pre class="programlisting brush: java">EntityBuilderFactory factory = ...;
PersonEntity p = factory.newEntity( PersonEntity.class );</pre><p>or an indirect lookup, such as</p><pre class="programlisting brush: java">Person p = factory.newEntity( Person.class );</pre><p>where it will first map the Person to a reachable PersonEntity.
The algorithm is as follows;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Look in the callers Module, if there is one and only one Composite type matching, use it. If there are two or more
      Composite types matching, then throw an ambiguity exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Look in all Modules in the callers Layer. If there is one and only one Composite type that matches and is either
      Visibility.layer, then use it.  If there are two or more Composite types matching, then throw an ambiguity
      exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Look in all Layers that caller’s Layer uses. If there is one and only one Composite type that matches and is
      either Visibility.application, then use it.  If there are two or more Composite types matching, then throw an
      ambiguity exception. If there are zero, proceed to the next step.
</li><li class="listitem">
Throw a CompositeNotFoundException.
</li></ul></div><p>The underlying principle comes down to Rickard’s "Speaker Analogy", you can hear him (and not the other speakers at the
conference) because you are in the same room. I.e. if something is really close by, it is very likely that this is what
we want to use, and then the search expands outwards.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_combining_the_above"></a>Combining The Above</h4></div></div></div><p>Ok, that was a whole lot of theory and probably take you more than one read-through to fully get into your veins (slow
acting addiction).
How to structure your code is beyond the scope of this section. If you are an experienced designer, you will have done
that before, and you may have started out with good intentions at times only to find yourself in a spaghetti swamp
later, or perhaps in the also famous "Clear as Clay" or "Ball (bowl?) of Mud". Either way, you need to draw on your
experience and come up with good structure that Qi4j lets you enforce.</p><p>So, for the sake of education, we are going to look at an application that consists of many layers, each with a few
modules. See picture below.</p><p>Image of Example of Layers</p><p>Figure 1. Example of Layers</p><p>So, lets see how we code up this bit in the actual code first.</p><pre class="programlisting brush: java">public class Main
{
    private static Energy4Java qi4j;
    private static Application application;

    public static void main( String[] args )
            throws Exception
    {
        // Bootstrap Qi4j Runtime
        // Create a Qi4j Runtime
        qi4j = new Energy4Java();

        // Instantiate the Application Model.
        application = qi4j.newApplication( new ApplicationAssembler()
        {
            public ApplicationAssembly assemble(
                    ApplicationAssemblyFactory factory )
                    throws AssemblyException
            {
                ApplicationAssembly assembly =
                        factory.newApplicationAssembly();
                LayerAssembly runtime = createRuntimeLayer( assembly );
                LayerAssembly designer = createDesignerLayer( assembly );
                LayerAssembly domain = createDomainLayer( assembly );
                LayerAssembly messaging= createMessagingLayer( assembly );
                LayerAssembly persistence = createPersistenceLayer( assembly );

                // declare structure between layers
                domain.uses( messaging );
                domain.uses( persistence );
                designer.uses( persistence );
                designer.uses( domain );
                runtime.uses( domain );

                return assembly;
            }
        } );

        // We need to handle shutdown.
        installShutdownHook();

        // Activate the Application Runtime.
        application.activate();
    }

    [...snip...]

}

</pre><p>The above is the basic setup on how to structure a real-world applicaton, unless you intend to mess with the
implementations of various Qi4j systems (yes there are hooks for that too), but that is definitely beyond the scope of
this tutorial.</p><p>Now, the createXyzLayer() methods were excluded to keep the sample crisp and easy to follow. Let’s take a look at what
it could be to create the Domain Layer.</p><pre class="programlisting brush: java">private static LayerAssembly createDomainLayer( ApplicationAssembly app )
{
    LayerAssembly layer = app.layer("domain-layer");
    createAccountModule( layer );
    createInventoryModule( layer );
    createReceivablesModule( layer );
    createPayablesModule( layer );
    return layer;
}

</pre><p>We just call the layerAssembly() method, which will return either an existing Layer with that name or create a new one
if one doesn’t already exist, and then delegate to methods for creating the ModuleAssembly instances. In those method
we need to declare which Composites, Entities, Services and Objects that is in each Module.</p><pre class="programlisting brush: java">private static void createAccountModule( LayerAssembly layer )
{
    ModuleAssembly module = layer.module("account-module");

    module.entities(AccountEntity.class, EntryEntity.class);

    module.addServices(
            AccountRepositoryService.class,
            AccountFactoryService.class,
            EntryFactoryService.class,
            EntryRepositoryService.class
    ).visibleIn( Visibility.layer );
}

</pre><p>We also need to handle the shutdown case, so in the main() method we have a installShutdownHook() method call. It is
actually very, very simple;</p><pre class="programlisting brush: java">private static void installShutdownHook()
{
    Runtime.getRuntime().addShutdownHook( new Thread( new Runnable()
    {
        public void run()
        {
            if( application != null )
            {
                try
                {
                    application.passivate();
                }
                catch( Exception e )
                {
                    e.printStackTrace();
                }
            }
        }
    }) );
}
</pre><p>This concludes this tutorial. We have looked how to get the initial Qi4j runtime going, how to declare the assembly
for application model creation and finally the activation of the model itself.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-configure-service"></a>3.15. Configure a Service</h3></div></div></div><p>Qi4j supports a Configuration system for services. The configuration instance itself is an Entity and is therefor
readable, writeable and queryable, just like other Entities. This should make Configuration management much simpler,
since you can easily build GUI tools to allow editing of these in runtime. However, to simplify the initial values of
the Configuration instance, Qi4j also does the initial bootstrapping of the Configuration entity for you. This HowTo is
going to show how.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_we_need_a_service"></a>We need a Service</h4></div></div></div><p>To illustrate these features we create an TravelPlan service, which allows clients to find and make Reservations to
Destinations. For the sake of simplicity, we are leaving out the domain details…</p><pre class="programlisting brush: java">public interface TravelPlan
{
    // Domain methods, which are beyond the discussion at hand.
}
</pre><p>So, then there is the ServiceComposite…</p><pre class="programlisting brush: java">// The package is relevant to the Initial Values discussed later.
package org.niclas.hedhman.travel;
[...snip...]

@Mixins( { TravelPlanMixin.class } )
public interface TravelPlanService extends TravelPlan, ServiceComposite
{}
</pre><p>And then in the Mixin we actually need to connect to a foreign system to obtain the various details that the service
can provide to the clients. For instance, it needs a host name and port and a protocol to use. We put these into a
configuration interface.</p><pre class="programlisting brush: java">public interface TravelPlanConfiguration
{
    Property&lt;String&gt; hostName();

    @Range( min=0, max=65535 )
    Property&lt;Integer&gt; portNumber();

    @Matches( "(ssh|rlogin|telnet)" )
    Property&lt;String&gt; protocol();
}
</pre><p>We used the recommended type-safe Property subtype pattern, and for each PortNumber and Protocol we have defined a
Constraint required.</p><p>Now we can access this configuration in the TravelPlanMixin like this;</p><pre class="programlisting brush: java">import org.qi4j.api.configuration.Configuration;

public class TravelPlanMixin implements TravelPlan
{
    @This
    Configuration&lt;TravelPlanConfiguration&gt; config;

    private void foo()
    {
        TravelPlanConfiguration tpConf = config.get();
        String hostName = tpConf.hostName().get();
        // ...
    }
    [...snip...]

}
</pre><p>And from the Service point of view, it doesn’t need to worry about where the configuration really comes from. But it may
want to control when the Configuration should be refreshed, to ensure that atomic changes are happening. This is done
with the refresh() method in the Configuration interface;</p><pre class="programlisting brush: java">public void doSomething()
{
    // Refresh Configuration before reading it.
    config.refresh();

    TravelPlanConfiguration tpConf = config.get();
    // ...
}
</pre><p>This ensures that any updates to the Configuration that has occurred will be retrieved and available to the Service.
Since Configuration instance is an Entity, the UnitOfWork system will ensure that the Configuration is consistent and
not in the middle of value changes.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_initial_values"></a>Initial Values</h5></div></div></div><p>The initial Configuration instance will be created automatically behind the scenes, by reading a properties file and
create an Entity with the same identity as the identity of the service. That was a handful. Services are, as we know,
singletons and have an identity specified at assembly. Even if it is not provided, one will automatically be assigned.
The service’s "identifiedBy" will be used as the identifier for the Configuration entity and stored in the visible
EntityStore. This identity is also used to locate a properties file in the same package as the ServiceComposite belongs
to.</p><p>So, we create a properties file, where the keys are the names of the properties in TravelPlanConfiguration.</p><pre class="programlisting brush: bash"># Hostname to the TravelPlan service
hostName=niclas.hedhman.org

# Port number to use for the connection
portNumber=5439

# Protocol to use; Valid options "ssh", "rlogin", "telnet"
protocol=ssh

</pre><p>File: org/hedhman/niclas/travel/TravelPlanService.properties</p><p>Note that the file resides in the directory equivalent to the package name of the TravelPlanService.</p><p>And this would work with the standard assembly.</p><pre class="programlisting brush: java">public void assemble(ModuleAssembly module) throws AssemblyException
{
    module.addServices(TravelPlanService.class).instantiateOnStartup();
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_non_default_identity"></a>Non-default Identity</h4></div></div></div><p>If you need to use multiple instances of the same service, or that the service has a non-default Identity, then you need
to name the properties file according to the Identity of the service declaration, but the file will still need to be in
the same package as the ServiceComposite sub type, the TravelPlanService in the above example. For instance;</p><pre class="programlisting brush: java">public void assemble(ModuleAssembly module) throws AssemblyException
{
    module.addServices(TravelPlanService.class)
            .instantiateOnStartup()
            .identifiedBy("ExpediaService");

    module.addServices(TravelPlanService.class)
            .instantiateOnStartup()
            .identifiedBy("OrbitzService");
}
</pre><p>And the two files for configuration,</p><pre class="programlisting brush: bash"># Hostname to the TravelPlan service
hostName=expedia.hedhman.org

# Port number to use for the connection
portNumber=9251

# Protocol to use; Valid options "ssh", "rlogin", "telnet"
protocol=ssh
</pre><p>File: org/hedhman/niclas/travel/ExpediaService.properties</p><pre class="programlisting brush: bash"># Hostname to the TravelPlan service
hostName=orbitz.hedhman.org

# Port number to use for the connection
portNumber=7412

# Protocol to use; Valid options "ssh", "rlogin", "telnet"
protocol=rlogin
</pre><p>File: org/hedhman/niclas/travel/OrbitzService.properties</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_changing_configuration_in_runtime"></a>Changing Configuration in runtime</h4></div></div></div><p>Unlike most frameworks, the Configuration in Qi4j is an active Entity, and once the properties file has been read once
at the first(!) startup, it no longer serves any purpose. The Configuration will always be retrieved from the
EntityStore. Changes to the properties file are not taken into consideration if the Configuration entity is found in the
entity store.</p><p>But that also means that applications should not cache the configuration values, and instead read them from the
Configuration instance every time needed, and do a refresh() method call when it is safe to update the Configuration
Entity with new values.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-create-entity"></a>3.16. Create an Entity</h3></div></div></div><p>One of the most common tasks in Qi4j is the management of the life cycle of Entities. Since Qi4j is capable of
delivering much higher performance than traditional Object-Relational Mapping technologies, we also expect that people
use Entities more frequently in Qi4j applications, so it is a very important topic to cover.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_basics_first"></a>Basics First</h4></div></div></div><p>All Entity operations MUST be done within a UnitOfWork. UnitOfWorks can be nested and if underlying UnitOfWorks are not
completed (method complete()), then none of the operations will be persisted permanently.</p><p>Entity composites are subtypes of the EntityComposite interface.</p><p>Domain code typically don’t need to know of the EntityComposite types directly, and is instead using the domain specific
interface. The Visibility rules will be applied to associate the right EntityComposite when a domain type is requested.
Ambiguities are not accepted and will result in runtime exceptions.</p><p>Qi4j supports that each entity instance can have more than one entity type, and it is managed per instance. This feature
is beyond the scope of this HowTO and will be covered subsequently.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_good_practice"></a>Good Practice</h4></div></div></div><p>We have made the observation that it is good practice to separate the internal state from the observable behavior. By
this we mean that it is not a good practice to allow client code to manipulate or even view the internal states of
objects, which is such a common (bad) practice in the so called POJO world.</p><p>Instead, we recommend that the programmer defines the client requirement of what each participant within the client
context needs to conform to, and then create composites accordingly and hide all the state internal to the composite in
private mixins. By doing so, the same entity can participate in multiple contexts with different behavioral requirements
but using the same internal state.</p><p>We recommend limited use of primitive types for Properties and instead subtype the Property.</p><p>And try to use ValueComposites instead of Entities.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_entity"></a>The Entity</h4></div></div></div><p>We need an entity to illustrate how we recommend to separate internal state from public behavior and observable state.
We will for the sake of simplicity use a trivial example. Please refer to other (possibly future) HowTos on patterns on
Entity management.</p><pre class="programlisting brush: java">public interface Car
{
    @Immutable
    Association&lt;Manufacturer&gt; manufacturer();

    @Immutable
    Property&lt;String&gt; model();

    ManyAssociation&lt;Accident&gt; accidents();
}

</pre><pre class="programlisting brush: java">public interface Manufacturer
{
    Property&lt;String&gt; name();
    Property&lt;String&gt; country();

    @UseDefaults
    Property&lt;Long&gt; carsProduced();
}

</pre><pre class="programlisting brush: java">public interface Accident
{
    Property&lt;String&gt; description();
    Property&lt;Date&gt; occured();
    Property&lt;Date&gt; repaired();
}

</pre><p>Above we define a Car domain object, which is of a particular Manufacturer (also an Entity), a model and a record of
Accidents.</p><p>We will also need to define the composites for the above domain structure;</p><pre class="programlisting brush: java">public interface CarEntity extends Car, EntityComposite
{}

</pre><pre class="programlisting brush: java">public interface ManufacturerEntity extends Manufacturer, EntityComposite
{}

</pre><pre class="programlisting brush: java">public interface AccidentValue extends Accident, ValueComposite
{}

</pre><p>For this case, we define both the Car and the Manufacturer as Entities, whereas the Accident is a Value, since it is an
immutable event that can not be modified.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly"></a>Assembly</h4></div></div></div><p>All of the above must also be declared in the assembly. We MUST associate the EntityComposites with a relevant Module.
We must also assemble an EntityStore for the entire application, but that is outside the scope of this HowTo.</p><pre class="programlisting brush: java">public class MyAssembler
        implements Assembler
{
    public void assemble( ModuleAssembly module )
    {
        module.entities( CarEntity.class,
                ManufacturerEntity.class );

        module.values( AccidentValue.class );
        [...snip...]

    }
}
</pre><p>We have no other Composites involved yet, so we can proceed to look at the usage code.</p><p>We recommend that the life cycle management of entities is placed inside domain factories, one for each type and made
available as services.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_entity_factory"></a>The Entity Factory</h4></div></div></div><p>The entity factory is something you need to write yourself, but as with most things in Qi4j it will end up being a
fairly small implementation. So how is that done?</p><pre class="programlisting brush: java">public interface CarEntityFactory
{
    Car create( Manufacturer manufacturer, String model );
}</pre><p>That is just the domain interface. We now need to make the service interface, which Qi4j needs to identify services and
make it possible for the service injection later.</p><pre class="programlisting brush: java">@Mixins( { CarEntityFactoryMixin.class } )
public interface CarEntityFactoryService
        extends CarEntityFactory, ServiceComposite
{}
</pre><p>Then we need an implementation of the mixin.</p><pre class="programlisting brush: java">public class CarEntityFactoryMixin
        implements CarEntityFactory
{

</pre><p>And doing that, first of all we need to request Qi4j runtime to give us the UnitOfWorkFactory associated with the Module
that our code belongs to, and the UnitOfWork current context the execution is happening in.</p><p>Injections that are related to the Visibility rules are handled by the @Structure annotation. And the easiest way for us
to obtain a UnitOfWorkFactory is simply to;</p><pre class="programlisting brush: java">public class CarEntityFactoryMixin
        implements CarEntityFactory
{

    @Structure
    UnitOfWorkFactory uowf;
</pre><p>Here Qi4j will inject the member uowf with the correct UnitOfWorkFactory. In case we only need the UnitOfWorkFactory
during the construction, we can also request it in the same manner as constructor argument.</p><pre class="programlisting brush: java">public CarEntityFactoryMixin( @Structure UnitOfWorkFactory uowf )
{
}

</pre><p>This is important to know, since the injected member will not be available until AFTER the constructor has been
completed.</p><p>We then need to provide the implementation for the create() method.</p><pre class="programlisting brush: java">public Car create(Manufacturer manufacturer, String model)
{
    UnitOfWork uow = uowf.currentUnitOfWork();
    EntityBuilder&lt;Car&gt; builder = uow.newEntityBuilder( Car.class );

    Car prototype = builder.instance();
    prototype.manufacturer().set( manufacturer );
    prototype.model().set( model );

    return builder.newInstance();
}
</pre><p>So far so good. But how about the Manufacturer input into the create() method?</p><p>DDD promotes the use of Repositories. They are the type-safe domain interfaces into locating entities without getting
bogged down with querying infrastructure details. And one Repository per Entity type, so we keep it nice, tidy and
re-usable. So let’s create one for the Manufacturer type.</p><pre class="programlisting brush: java">public interface ManufacturerRepository
{
    Manufacturer findByIdentity(String identity);

    Manufacturer findByName(String name);
}
</pre><p>And then we repeat the process for creating a Service…</p><pre class="programlisting brush: java">@Mixins( ManufacturerRepositoryMixin.class  )
public interface ManufacturerRepositoryService
        extends ManufacturerRepository, ServiceComposite
{}
</pre><p>and a Mixin that implements it…</p><pre class="programlisting brush: java">public class ManufacturerRepositoryMixin
        implements ManufacturerRepository
{
    @Structure
    private UnitOfWorkFactory uowf;

    @Structure
    private Module module;

    public Manufacturer findByIdentity( String identity )
    {
        UnitOfWork uow = uowf.currentUnitOfWork();
        return uow.get(Manufacturer.class, identity);
    }

    public Manufacturer findByName( String name )
    {
        UnitOfWork uow = uowf.currentUnitOfWork();
        QueryBuilder&lt;Manufacturer&gt; builder =
                module.newQueryBuilder( Manufacturer.class );

        Manufacturer template = templateFor( Manufacturer.class );
        builder.where( eq( template.name(), name ) );

        Query&lt;Manufacturer&gt; query = uow.newQuery( builder);
        return query.find();
    }
}

</pre><p>But now we have introduced 2 services that also are required to be declared in the assembly. In this case, we want the
Services to be available to the application layer above, and not restricted to within this domain model.</p><pre class="programlisting brush: java">public class MyAssembler
        implements Assembler
{
    public void assemble( ModuleAssembly module )
    {
        module.entities( CarEntity.class,
                ManufacturerEntity.class );

        module.values( AccidentValue.class );
        module.addServices(
                ManufacturerRepositoryService.class,
                CarEntityFactoryService.class
        ).visibleIn( Visibility.application );
    }
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_unitofwork"></a>The UnitOfWork</h4></div></div></div><p>If you notice, there is a couple of calls to UnitOfWorkFactory.currentUnitOfWork(), but what is current UnitOfWork, and
who is setting that up?</p><p>Well, the domain layer should not worry about UoW, it is probably the responsibility of the application/service layer
sitting on top. That could be a web application creating and completing a UoW per request, or some other co-ordinator
doing long-running UnitOfWorks.</p><p>There are of course a lot more details to get all this completed, but that is beyond the scope of this HowTo.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-create-constraint"></a>3.17. Create a Constraint</h3></div></div></div><p>Constraints are defined in <a class="xref" href="#def-constraint">Constraint</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_method_constraint"></a>Method Constraint</h4></div></div></div><p>Method Constraints are declared with annotations on the method argument. The annotation itself is custom, and it is possible to make your own.</p><pre class="programlisting brush: java">public interface Dialer
{
    void callPhoneNumber(@PhoneNumber String phoneNo);

}
</pre><p>In the code above we say that we want the argument to the callPhoneNumber() method to be a valid phone number. This annotation is not built-in, so we need to declare it.</p><pre class="programlisting brush: java">@ConstraintDeclaration
@Retention( RetentionPolicy.RUNTIME )
@Target( { ElementType.PARAMETER, ElementType.ANNOTATION_TYPE, ElementType.METHOD } )
public @interface PhoneNumber
{
}
</pre><p>We then need to provide the Constraint implementation.</p><pre class="programlisting brush: java">public class PhoneNumberConstraint
        implements Constraint&lt;PhoneNumber, String&gt;
{
    public boolean isValid( PhoneNumber annotation, String number )
    {
        boolean validPhoneNumber = true; // check phone number format...
        return validPhoneNumber;  // return true if valid phone number.
    }
}
</pre><p>We also need to include the Constraint on the Composites we want to have them present.</p><pre class="programlisting brush: java">@Constraints( PhoneNumberConstraint.class )
public interface DialerComposite extends ServiceComposite, Dialer
{
}
</pre><p><span class="strong"><strong><span class="line-through">Constraints doesn’t throw any exceptions, as violation of constraints are domain specific. Instead, the Qi4j runtime will record all the violations in the InvocationContext, which is available to Concerns and Mixins. For instance;</span></strong></span></p><pre class="programlisting brush: java">public class ParameterViolationConcern
    implements InvocationHandler
{
    @Structure private InvocationContext invocation;
    @ConcernFor private InvocationHandler next;
    public Object invoke( Object proxy, Method method, Object[] args )
        throws Exception
    {
        Collection&lt;ConstraintViolation&gt; violations =
            invocation.getConstraintViolations();
        if( violations.size() &gt; 0 )
        {
            throw new MyConstraintVioaltionException( violations );
        }
        return next.invoke( proxy, method, args );
    }
}</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_property_constraint"></a>Property Constraint</h4></div></div></div><p>Property Constraints are declared on the Property method.</p><pre class="programlisting brush: java">public interface HasPhoneNumber
{
    @PhoneNumber Property&lt;String&gt; phoneNumber();
}
</pre><p>In this case, the Constraint associated with the phoneNumber() method, will be called before the set() method on that Property is called. And any ConstraintViolations will be available to Concerns declared for the Property itself. For instance;</p><pre class="programlisting brush: java">public class ParameterViolationConcern
    implements HasPhoneNumber
{
    @Structure private InvocationContext invocation;
    @ConcernFor private HasPhoneNumber next;
    @Concerns( CheckViolation.class )
    public abstract Property&lt;String&gt; phoneNumber();
    private abstract class CheckViolation
        implements Property&lt;String&gt;
    {
        @ConcernFor Property&lt;String&gt; next;
        public void set( String number )
        {
            Collection&lt;ConstraintViolation&gt; violations =
                invocation.getConstraintViolations();
            if( violations.size() &gt; 0 )
            {
                throw new MyConstraintVioaltionException( violations );
            }
            return next.set( number );
        }
    }
}</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-create-concern"></a>3.18. Create a Concern</h3></div></div></div><p>Concerns are defined in <a class="xref" href="#def-concern">Concern</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_typed_concern"></a>Typed Concern</h4></div></div></div><p>A typed Concern is a Java class that implements the MixinType it can be used on:</p><pre class="programlisting brush: java">public class InventoryConcern extends ConcernOf&lt;Order&gt;
    implements Order
{
    @Service
    private InventoryService inventory;

    @Override
    public void addLineItem( LineItem item )
    {
        String productCode = item.productCode().get();
        int quantity = item.quantity().get();
        inventory.remove( productCode, quantity );
        next.addLineItem( item );
    }

    @Override
    public void removeLineItem( LineItem item )
    {
        String productCode = item.productCode().get();
        int quantity = item.quantity().get();
        inventory.add( productCode, quantity );
        next.removeLineItem( item );
    }
}
</pre><p>The InventoryConcern is implemented as an abstract class, since we are not interested in the many other methods in the
Order interface. Extending the ConcernOf is a convenience mechanism, instead of an explicit @ConcernFor annotation on
a private field, which can be used in rare occasions when you are not able to extend. This base class defines the next
field, which is set up by the Qi4j runtime and points to the next fragment in the call stack. We can also see that the
InventoryService is provided to the concern, which is done with dependency injection. Qi4j also supports dependency
injection via constructors and methods.</p><p>It can be used as follows;</p><pre class="programlisting brush: java">@Concerns( InventoryConcern.class )
public interface Order
{
    void addLineItem( LineItem item );
    void removeLineItem( LineItem item );
    :
    :
}</pre><p>Methods of the Concern Fragment will be called before the Mixin invocation.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_generic_concern"></a>Generic Concern</h4></div></div></div><p>A generic Concern is a Java class that implements java.lang.reflect.InvocationHandler which allows it to be used on any
arbitrary MixinType.</p><pre class="programlisting brush: java">public class MyGenericConcern extends GenericConcern
{
    public Object invoke(...)
    {
        // Do whatever you want
        return next.invoke( ... );
    }
}</pre><p>It can be used as follows;</p><pre class="programlisting brush: java">@Concerns( MyGenericConcern.class )
public interface AnyMixinType
{
    :
    :
}</pre><p>Methods of the Concern Fragment will be called before the Mixin invocation.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_appliesto"></a>AppliesTo</h5></div></div></div><p>For generic Concerns that should only trigger on methods with specific annotations or fulfilling some expression, add
@AppliesTo annotation to the Concern class which points to either triggering annotation(s), or to AppliesToFilter
implementation(s).</p><p>The Concern is invoked if one of the triggering annotations is found or one of the AppliesToFilter accepts the
invocation. In other words the AppliesTo arguments are OR’ed.</p><p>Here is how the declaration goes ;</p><pre class="programlisting brush: java">@AppliesTo( { MyAnnotation.class, MyAppliesToFilter.class } )
public class MyGenericConcern extends GenericConcern
{
    public Object invoke(...)
    {
        // Do whatever you want
        return next.invoke( ... );
    }
}</pre><p>And how to use the annotation ;</p><pre class="programlisting brush: java">@Concerns( MyGenericConcern.class )
public interface AnyMixinType
{
    @MyAnnotation
    void doSomething();
    void doSomethingElse();
    :
    :
}</pre><p>Here only the doSomething() method will see the Concern applied whereas the doSomethingElse() method won’t.</p><p>Finally here is how to implement an AppliesToFilter:</p><pre class="programlisting brush: java">public class MyAppliesToFilter implements AppliesToFilter
{
    public boolean appliesTo( Method method, Class&lt;?&gt; mixin, Class&lt;?&gt; compositeType, Class&lt;?&gt; modifierClass )
    {
        boolean appliesTo; // Do whatever you want
        return appliesTo;
    }
}</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-create-sideeffect"></a>3.19. Create a SideEffect</h3></div></div></div><p>SideEffects are defined in <a class="xref" href="#def-sideeffect">SideEffect</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_typed_sideeffect"></a>Typed SideEffect</h4></div></div></div><p>A typed SideEffect is a Java class that implements the MixinType it can be used on:</p><pre class="programlisting brush: java">public abstract class MailNotifySideEffect extends SideEffectOf&lt;Confirmable&gt;
    implements Confirmable
{
    @Service
    private MailService mailer;

    @This
    private HasLineItems hasItems;

    @This
    private HasCustomer hasCustomer;

    @Override
    public void confirm()
    {
        StringBuilder builder = new StringBuilder();
        builder.append( "An Order has been made.\n\n\n" );
        builder.append( "Customer:" );
        builder.append( hasCustomer.name().get() );
        builder.append( "\n\nItems ordered:\n" );
        for( LineItem item : hasItems.lineItems().get() )
        {
            builder.append( item.name().get() );
            builder.append( " : " );
            builder.append( item.quantity().get() );
            builder.append( "\n" );
        }
        mailer.send( "sales@mycompany.com", builder.toString() );
    }
}
</pre><p>The MailNotifySideEffect is implemented as an abstract class, since we are not interested in the many other methods in
the Confirmable interface. Extending the SideEffectOf is a convenience mechanism, instead of an explicit @SideEffectFor
annotation on a private field, which can be used in rare occasions when you are not able to extend. This base class
defines the next field, which is set up by the Qi4j runtime and points to the next fragment in the call stack. We can
also see that the MailService, HasLineItems and HasCustomer are provided to the side-effect, which is done with
dependency injection. Qi4j also supports dependency injection via constructors and methods.</p><p>It can be used as follows;</p><pre class="programlisting brush: java">@SideEffects( MailNotifySideEffect.class )
public interface OrderEntity
    extends Order, HasSequenceNumber, HasCustomer,
            HasLineItems, Confirmable, EntityComposite
{
}</pre><p>Methods of the SideEffect Fragment will be called after the Mixin invocation.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_generic_sideeffect"></a>Generic SideEffect</h4></div></div></div><p>A generic SideEffect is a Java class that implements java.lang.reflect.InvocationHandler which allows it to be used on any
arbitrary MixinType.</p><pre class="programlisting brush: java">public class MyGenericSideEffect extends GenericSideEffect
{
    public Object invoke(...)
    {
        // Do whatever you want
        return next.invoke( ... );
    }
}</pre><p>It can be used as follows;</p><pre class="programlisting brush: java">@Concerns( MyGenericSideEffect.class )
public interface AnyMixinType
{
    :
    :
}</pre><p>Methods of the SideEffect Fragment will be called before the Mixin invocation.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_appliesto_2"></a>AppliesTo</h5></div></div></div><p>For generic SideEffects that should only trigger on methods with specific annotations or fulfilling some expression, add
@AppliesTo annotation to the SideEffect class which points to either triggering annotation(s), or to AppliesToFilter
implementation(s).</p><p>The SideEffect is invoked if one of the triggering annotations is found or one of the AppliesToFilter accepts the
invocation. In other words the AppliesTo arguments are OR’ed.</p><p>Here is how the declaration goes ;</p><pre class="programlisting brush: java">@AppliesTo( { MyAnnotation.class, MyAppliesToFilter.class } )
public class MyGenericSideEffect extends GenericSideEffect
{
    public Object invoke(...)
    {
        // Do whatever you want
        return next.invoke( ... );
    }
}</pre><p>And how to use the annotation ;</p><pre class="programlisting brush: java">@Concerns( MyGenericSideEffect.class )
public interface AnyMixinType
{
    @MyAnnotation
    void doSomething();
    void doSomethingElse();
    :
    :
}</pre><p>Here only the doSomething() method will see the SideEffect applied whereas the doSomethingElse() method won’t.</p><p>Finally here is how to implement an AppliesToFilter:</p><pre class="programlisting brush: java">public class MyAppliesToFilter implements AppliesToFilter
{
    public boolean appliesTo( Method method, Class&lt;?&gt; mixin, Class&lt;?&gt; compositeType, Class&lt;?&gt; modifierClass )
    {
        boolean appliesTo; // Do whatever you want
        return appliesTo;
    }
}</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-leverage-properties"></a>3.20. Leverage Properties</h3></div></div></div><p>Qi4j does not follow the JavaBeans standard for property support. Instead, a much more explicit concept is in place. The
advantages are enormous, and the only real downside is that people are already destroyed, thinking in so called POJO
terms.</p><p>So in Qi4j, instead of writing;</p><pre class="programlisting brush: java">public interface Book
{
    String getTitle();
    String getAuthor();
}
public interface MutableBook extends Book
{
    void setTitle( String title );
    void setAuthor( String author );
}</pre><p>where we need the MutableBook to be able to initialize it (known as Type 2 Dependency Injection) on creation. From our
point of view, this has many flaws. If we refactor the "Title" property, our IDE need to understand the getters and
setters concept. The good news now is that they all do, but how about meta information about the property itself. For
instance, how to define a system where a UI can get an Icon for "Author" in a generic way? All kinds of system has been
added, such as one can create a BookBean for some metadata, and then MBeans for management. Where will it end?</p><p>We think we have a much better solution, and are bold enough to abandon the getters/setters and POJOs. The above looks
like this;</p><pre class="programlisting brush: java">public interface Book
{
    @Immutable Property&lt;String&gt; title();
    @Immutable Property&lt;String&gt; author();
}</pre><p>There is more to this than meets the eye.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
@Immutable annotation signals that this can’t change.
</li><li class="listitem">
Property still have a set() method, which can be used during the initialization only.
</li><li class="listitem">
Metadata about each Property can be declared as <a class="xref" href="#def-metainfo">MetaInfo</a>.
</li></ul></div><pre class="programlisting brush: java">TransientBuilder&lt;Book&gt; builder = module.newTransientBuilder( Book.class );
Book prototype = builder.prototype();
prototype.title().set( "The Death of POJOs" );
prototype.author().set( "Niclas Hedhman" );
Book book = builder.newInstance();
String title = book.title().get();     // Retrieves the title.
book.title().set( "Long Live POJOs" ); // throws a PropertyVetoException</pre><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_persistence"></a>Persistence</h4></div></div></div><p>The Property concept also allows a much better defined persistence model. In Qi4j, only Property and Association
instances are persisted, and that makes the semantics around the persistence system very clear.</p><p>Properties reference values only, and these values must be Serializable, which means that Properties can not contain
Entities, since Entities are not Serializable. Associations are the opposite, as they must only reference Entities and
nothing else.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_metainfo"></a>MetaInfo</h4></div></div></div><p>Properties can also have typed, custom meta information associated with them. Meta information is declared once per
Property per Module. A Property is identified by its method name and the interface it is declared in.</p><p>Let’s say we want to create a generic Swing client that can show and navigate the domain model, without knowing the
actual domain model. Such Swing client will utilize a SwingInfo property info if it is available.</p><pre class="programlisting brush: java">public interface SwingInfo
{
    Icon icon( Rectangle size );
    String displayName( Locale locale );
}</pre><p>Our generic Swing UI will be mainly reflective in nature, but when it gets hold of a Property, it can simply do;</p><pre class="programlisting brush: java">private void addProperty( JPanel panel, Property&lt;?&gt; property )
{
    SwingInfo info = property.metaInfo( SwingInfo.class );
    panel.add( new Label( info.displayName( this.locale ) );
    panel.add( info.icon( this.iconSize ) );
}</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-contextual-fragments"></a>3.21. Use contextual fragments</h3></div></div></div><p>Contextual fragments are fragments that are added to the composites during assembly time. That means that they are not
present in the composite declarations, but a start-up decision what should be added. Once the application instance is
created, it is no longer possible to modify which fragments are attached.</p><p>Typical use-case is tracing and debugging. Other potential uses are additional security or context interfaces needing
access to internal mixins not originally intended for, such as GUI frameworks doing reflection on certain composites.
We strongly recommend against using this feature, as it is not needed as commonly as you may think.</p><p>Note: Constraints are not supported to be contextual at the moment.</p><p>The mixins, sideeffects and concerns are added during the bootstrap phase. It is very straight-forward;</p><pre class="programlisting brush: java">public class TraceAll
{
    public void assemble( ModuleAssembly module )
            throws AssemblyException
    {
        ServiceDeclaration decl = module.addServices( PinSearchService.class );
        if( Boolean.getBoolean( "trace.all"  ) )
        {
            decl.withConcerns( TraceAllConcern.class );
        }
    }
}

</pre><p>In the example above, we add the TraceAllConcern from the Logging Library if the system property "trace.all" is true.
If the system property is not set to true, there will be no TraceAllConcern on the PinSearchService.</p><p>Concerns that are added in this way will be at the top of the method invocation stack, i.e. will be the first one to be
called and last one to be completed.</p><p>SideEffects that are added in this way will be the last one’s to be executed.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="howto-use-io"></a>3.22. Use I/O API</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This article was written on Rickard Öberg’s blog, 6 Nov 2010</p></td></tr></table></div><p>The past week I’ve had to deal with a lot of data shuffling, both in raw form as bytes and strings, and as SPI and
domain level objects. What struck me is that it is notoriously hard to shuffle things from one place to another in a
way that is scalable, performant and handles errors correctly. And I had to do some things over and over again, like
reading strings from files.</p><p>So the thought occurred: there must be a general pattern to how this thing works, which can be extracted and put into a
library. "Reading lines from a text file" should only have to be done once, and then used in whatever scenario requires
it. Let’s take a look at a typical example of reading from one file and writing to another to see if we can find out
what the possible pieces could be:</p><pre class="programlisting brush: java">1: File source = new File( getClass().getResource( "/iotest.txt" ).getFile() );
1: File destination = File.createTempFile( "test", ".txt" );
1: destination.deleteOnExit();
2: BufferedReader reader = new BufferedReader(new FileReader(source));
3: long count = 0;
2: try
2: {
4:    BufferedWriter writer = new BufferedWriter(new FileWriter(destination));
4:    try
4:    {
2:        String line = null;
2:        while ((line = reader.readLine()) != null)
2:        {
3:            count++;
4:            writer.append( line ).append( '\n' );
2:        }
4:        writer.close();
4:    } catch (IOException e)
4:    {
4:        writer.close();
4:        destination.delete();
4:    }
2: } finally
2: {
2:     reader.close();
2: }
1: System.out.println(count)</pre><p>As the numbers to the left indicates, I’ve identified four parts in this type of code that could be separated from
each other.</p><p>1) is the client code that initiates a transfer, and which have to know the input and output source.</p><p>2) is the code that reads lines from an input.</p><p>3) is helper code that I use to keep track of what’s going on, and which I’d like to reuse no matter what kind of
transfer is being done.</p><p>4) receives the data and writes it down. In this code, if I wanted to implement batching on the read and write side I
could do so by changing the 2 and 4 parts to read/write multiple lines at a time.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_api"></a>The API</h4></div></div></div><p>Once this was identified it was mostly just a matter of putting interfaces on these pieces, and making sure they can be
easily used in many different situations. The result is as follows.</p><p>To start with we have Input:</p><pre class="programlisting brush: java">public interface Input&lt;T, SenderThrowableType extends Throwable&gt;
{
    &lt;ReceiverThrowableType extends Throwable&gt; void transferTo( Output&lt;T,ReceiverThrowableType&gt; output )
        throws SenderThrowableType, ReceiverThrowableType;
}</pre><p>Inputs, like Iterables, can be used over and over again to initiate transfers of data from one place to another, in
this case an Output. Since I want this to be generic the type of things that is sent is T, so can be anything
(byte[], String, EntityState, MyDomainObject). I also want the sender and receiver of data to be able to throw their
own exceptions, and this is marked by declaring these as generic exception types. For example, the input may want to
throw SQLException and the output IOException, if anything goes wrong. This should be strongly typed, and both sender
and receiver must know when either side screws up, so that they can recover properly and close any resources they have
opened.</p><p>On the receiving side we then have Output:</p><pre class="programlisting brush: java">public interface Output&lt;T, ReceiverThrowableType extends Throwable&gt;
{
    &lt;SenderThrowableType extends Throwable&gt; void receiveFrom(Sender&lt;T, SenderThrowableType&gt; sender)
            throws ReceiverThrowableType, SenderThrowableType;
}</pre><p>When receiveFrom is invoked by an Input, as a result of invoking transferTo on the Input, the Output should open
whatever resources it needs to write to, and then expect data to come from a Sender. Both the Input and Output must
have the same type T, so that they agree on what is being sent. We will see later how this can be handled if this is
not the case.</p><p>Next we have Sender:</p><pre class="programlisting brush: java">public interface Sender&lt;T, SenderThrowableType extends Throwable&gt;
{
    &lt;ReceiverThrowableType extends Throwable&gt; void sendTo(Receiver&lt;T, ReceiverThrowableType&gt; receiver)
        throws ReceiverThrowableType, SenderThrowableType;
}</pre><p>The Output invokes sendTo and passes in a Receiver that the Sender will use to send individual items. The sender at
this point can start transferring data of type T to the receiver, one at a time. The Receiver looks like this:</p><pre class="programlisting brush: java">public interface Receiver&lt;T, ReceiverThrowableType extends Throwable&gt;
{
    void receive(T item)
        throws ReceiverThrowableType;
}</pre><p>When the receiver gets the individual items from the sender it can either immediately write them to its underlying
resource, or batch them up. Since the receiver will know when the transfer is done (sendTo returns) it can write the
remaining batches properly and close any resource it holds.</p><p>This simple pattern, with two interfaces on the sending side and two on the receiving side, gives us the potential to
do scalable, performant and fault-tolerant transfers of data.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_standard_inputs_and_outputs"></a>Standard Inputs and Outputs</h4></div></div></div><p>So now that the above API defines the contract of sending and receiving data, I can then create a couple of standard
inputs and outputs. Let’s say, reading lines of text from a file, and writing lines of text to a file. These
implementations I can then put in static methods so they are easy to use. In the end, to make a copy of a text file
looks like this:</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Inputs.text( source ).transferTo( Outputs.text(destination) );</pre><p>One line of code that handles the reading, the writing, the cleaning up, buffering, and whatnot. Pretty nifty! The
transferTo method will throw IOException, which I can catch if I want to present any errors to the user. But actually
dealing with those errors, i.e. closing the files and potentially deleting the destination if the transfer failed, is
already handled by the Input and Output. I will never have to deal with the details of reading text from a file ever
again!</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_intercepting_the_transfer"></a>Intercepting the transfer</h4></div></div></div><p>While the above handles the basic input/output of a transfer, there are usually other things that I want to do as well.
I may want to count how many items were transferred, do some filtering, or log every 1000 items or so to see what’s
going on. Since input and output are now separated this becomes simply a matter of inserting something in the middle
that mediates the input and output. Since many of these mediations have a similar character I can put these into
standard utility methods to make them easier to use.</p><p>The first standard decorator is a filter. I will implement this by means of supplying a Specification:</p><pre class="programlisting brush: java">public static &lt;T,ReceiverThrowableType extends Throwable&gt; Output&lt;T, ReceiverThrowableType&gt; filter( final Specification&lt;T&gt; specification, final Output&lt;T, ReceiverThrowableType&gt; output)
{
   ... create an Output that filters items based on the Specification&lt;T&gt; ...
}</pre><p>Where Specification is:</p><pre class="programlisting brush: java">interface Specification&lt;T&gt;
{
     boolean test(T item);
}</pre><p>With this simple construct I can now perform transfers and easily filter out items I don’t want on the receiving side.
This example removes empty lines from a text file.</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Inputs.text( source ).transferTo( Transforms.filter(new Specification&lt;String&gt;()
{
   public boolean test(String string)
   {
      return string.length() != 0;
   }
}, Outputs.text(destination) );</pre><p>The second common operation is mapping from one type to the other. This deals with the case that one Input you have may
not match the Output you want to send to, but there’s a way to map from the input type to the output type. An example
would be to map from String to JSONObject, for example. The operation itself looks like this:</p><pre class="programlisting brush: java">public static &lt;From,To,ReceiverThrowableType extends Throwable&gt; Output&lt;From, ReceiverThrowableType&gt; map( Function&lt;From,To&gt; function, Output&lt;To, ReceiverThrowableType&gt; output)</pre><p>Where Function is defined as:</p><pre class="programlisting brush: java">interface Function&lt;From, To&gt;
{
    To map(From from);
}</pre><p>With this I can then connect an Input of Strings to an Output of JSONObject like so:</p><pre class="programlisting brush: java">Input&lt;String,IOException&gt; input = ...;
Output&lt;JSONObject,RuntimeException&gt; output = ...;
input.transferTo(Transforms.map(new String2JSON(), output);</pre><p>Where String2JSON implements Function and it’s map method converts the String into a JSONObject.</p><p>At this point we can now deal with the last part of the initial example, the counting of items. This can be implemented
as a generic Map that has the same input and output type, and just maintains a count internally that updates on every
call to map(). The example can then be written as:</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Counter&lt;String&gt; counter = new Counter&lt;String&gt;();
Inputs.text( source ).transferTo( Transforms.map(counter, Outputs.text(destination) ));
System.out.println("Nr of lines:"+counter.getCount())</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_usage_in_the_qi4j_spi"></a>Usage in the Qi4j SPI</h4></div></div></div><p>Now I can finally get back to my initial problem that led me to look into this: how to implement a good way to access
EntityStates in a Qi4j EntityStore, and perform restores of backups. The current version of accessing EntityStates look
like this:</p><pre class="programlisting brush: java">&lt;ThrowableType extends Throwable&gt; void visitEntityStates( EntityStateVisitor&lt;ThrowableType&gt; visitor, ModuleSPI module )
     throws ThrowableType;

interface EntityStateVisitor&lt;ThrowableType extends Throwable&gt;
{
  void visitEntityState( EntityState entityState )
     throws ThrowableType;
}</pre><p>This can now be replaced with:</p><pre class="programlisting brush: java">Input&lt;EntityState, EntityStoreException&gt; entityStates(ModuleSPI module);</pre><p>Because of the pattern outlined above, users of this will get more information about what’s happening in the traversal,
such as if the EntityStore raised an EntityStoreException during the traversal, which they can then handle gracefully.
It also becomes easy to add decorators such as maps and filters to users of this. Let’s say you only are interested in
EntityState’s of a given type. Then add a filter for this, without changing the consumer.</p><p>For importing backup data into an EntityStore, the interface used to look like this:</p><pre class="programlisting brush: java">interface ImportSupport
{
    ImportResult importFrom( Reader in )
            throws IOException;
}</pre><p>This ties the EntityStore to only being able to read JSON lines from Reader’s, the client will not know if the
IOException raised is due to errors in the Reader or writing in the store, and the ImportResult, which contains a list
of exceptions and count of stuff, is quite ugly to create and use. With the I/O API at hand this can now be replaced
with:</p><pre class="programlisting brush: java">interface ImportSupport
{
   Output&lt;String,EntityStoreException&gt; importJSON();
}</pre><p>To use this, given the helpers outlined above, is as simple as:</p><pre class="programlisting brush: java">File backup = ...
ImportSupport entityStore = ...
Inputs.text(backup).transferTo(entityStore.importJSON());</pre><p>If the client wants any "extras", such as counting how many objects were imported, this can be done by adding filters
as previously shown. If you only want to, say, import entities modified before a particular date (let’s say you know
some junk was introduced after a given time), then add a specification filter that performs this check. And so on.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_conclusion_3"></a>Conclusion</h4></div></div></div><p>It is quite common while developing software that you have to shuffle data or objects from one input to another output,
possible with some transformations in the middle. Usually these things have to be done from scratch, which opens up for
errors and badly applied patterns. By introducing a generic Input/Output API that encapsulates and separates these
things properly it becomes easier to perform these tasks in a scalable, performant and error-free way, and while still
allowing these tasks to be decorated with extra features when needed.</p><p>This article has outlined one way to do this, and the API and helpers that I’ve described are available in the current
Qi4j Core 1.3-SNAPSHOT in Git (see Qi4j homepage for access details). The idea is to start using it throughout Qi4j
wherever we need to do I/O of the type described here.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="related"></a>3.23. Related publications &amp; projects</h3></div></div></div><p>Qi4j addresses a wide range of concepts, the related publications and projects you’ll find in this section span accross
all theses concepts. Please note that this is not an exhaustive list but only some pointers to help you understand which
principles Qi4j is based on.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_publications"></a>Publications</h4></div></div></div><p>In chronological order, related publications:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<span class="strong"><strong>Object-oriented Software Construction</strong></span>
</p><p class="simpara">by Bertrand Meyer - 1988</p><p class="simpara">"<span class="emphasis"><em>The comprehensive reference on all aspects of object technology, from design principles to O-O techniques, Design by
Contract, O-O analysis, concurrency, persistence, abstract data types and many more. Written by a pioneer in the field,
contains an in-depth analysis of both methodological and technical issues.</em></span>"</p><p class="simpara"><a class="ulink" href="http://se.ethz.ch/~meyer/publications/index_kind.html#POOSC2" target="_top">http://se.ethz.ch/~meyer/publications/index_kind.html#POOSC2</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Object-Oriented Programming: An Objective Sense of Style</strong></span>
</p><p class="simpara">by K.  Lieberherr,  I.  IIolland,  A.  Riel - 1988</p><p class="simpara">"<span class="emphasis"><em>The "Law of Demeter" (or LoD) as it is commonly called, is really more precisely the "Law of Demeter for
Functions/Methods" (LoD-F). It is a design-style rule for object-oriented programs. Its essence is the "principle of
least knowledge" regarding the object instances used within a method.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.ccs.neu.edu/research/demeter/papers/law-of-demeter/oopsla88-law-of-demeter.pdf" target="_top">http://www.ccs.neu.edu/research/demeter/papers/law-of-demeter/oopsla88-law-of-demeter.pdf</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Designing Reusable Classes</strong></span>
</p><p class="simpara">by Ralph E. Johnson &amp; Brian Foote - 1988</p><p class="simpara">"<span class="emphasis"><em>Object-oriented programming is as much a different way of designing programs as it is a different way of designing
programming languages. […] In particular, since a major motivation for object-oriented programming is software reuse,
this paper describes how classes are developed so that they will be reusable.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.laputan.org/drc/drc.html" target="_top">http://www.laputan.org/drc/drc.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>The Open/Closed Principle</strong></span>
</p><p class="simpara">by Robert C. Martin - 1996</p><p class="simpara">"<span class="emphasis"><em>As Ivar Jacobson said: “All systems change during their life cycles. This must be borne in mind when developing
systems expected to last longer than the first version.” How can we create designs that are stable in the face of
change and that will last longer than the ﬁrst version?</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.objectmentor.com/resources/articles/ocp.pdf" target="_top">http://www.objectmentor.com/resources/articles/ocp.pdf</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>The Liskov Substitution Principle</strong></span>
</p><p class="simpara">by Robert C. Martin - 1996</p><p class="simpara">"<span class="emphasis"><em>Substitutability is a principle in object-oriented programming. It states that, in a computer program, if S is a
subtype of T, then objects of type T may be replaced with objects of type S (i.e., objects of type S may be substituted
for objects of type T) without altering any of the desirable properties of that program (correctness, task performed,
etc.)..</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.objectmentor.com/resources/articles/lsp.pdf" target="_top">http://www.objectmentor.com/resources/articles/lsp.pdf</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>The Dependency Inversion Principle</strong></span>
</p><p class="simpara">by Robert C. Martin - 1996</p><p class="simpara">"<span class="emphasis"><em>In this column, we discuss the structural implications of the Open-Closed and the Liskov Substitution principles.
The structure that results from rigorous use of these principles can be generalized into a principle all by itself.
I call it “The Dependency Inversion Principle” (DIP).</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.objectmentor.com/resources/articles/dip.pdf" target="_top">http://www.objectmentor.com/resources/articles/dip.pdf</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Aspect-Oriented Programming</strong></span>
</p><p class="simpara">by Kiczales, Gregor; John Lamping, Anurag Mendhekar, Chris Maeda, Cristina Lopes, Jean-Marc Loingtier, and John Irwin - 1997</p><p class="simpara">"<span class="emphasis"><em>We have found many programming problems for which neither procedural nor object-oriented programming techniques are
sufficient to clearly capture some of the important design decisions the program must implement. This forces the
implementation of those design decisions to be scattered throughout the code, resulting in “tangled” code that is
excessively difficult to develop and maintain. We present an analysis of why certain design decisions have been so
difficult to clearly capture in actual code. We call the properties these decisions address aspects, and show that the
reason they have been hard to capture is that they crosscut the system’s basic functionality. We present the basis for
a new programming technique, called aspect-oriented programming, that makes it possible to clearly express programs
involving such aspects, including appropriate isolation, composition and reuse of the aspect code. The discussion is
rooted in systems we have built using aspect-oriented programming.</em></span>"</p><p class="simpara"><a class="ulink" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.115.8660" target="_top">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.115.8660</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Domain-Driven Design: Tackling Complexity in the Heart of Software</strong></span>
</p><p class="simpara">by Eric Evans - 2003</p><p class="simpara">"<span class="emphasis"><em>This book provides a broad framework for making design decisions and a technical vocabulary for discussing domain
design. It is a synthesis of widely accepted best practices along with the author’s own insights and experiences.
Projects facing complex domains can use this framework to approach domain-driven design systematically.
Many people have employed domain-driven design in some form, but it will be made more effective with a systematic
approach and a shared vocabulary.</em></span>"</p><p class="simpara"><a class="ulink" href="http://domaindrivendesign.org/books/evans_2003" target="_top">http://domaindrivendesign.org/books/evans_2003</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Tell, Don’t Ask</strong></span>
</p><p class="simpara">by Andy Hunt and the Pragmatic Programmers - 2003</p><p class="simpara">"<span class="emphasis"><em>Procedural code gets information then makes decisions. Object-oriented code tells objects to do things. - Alec Sharp</em></span>"</p><p class="simpara"><a class="ulink" href="http://pragprog.com/articles/tell-dont-ask" target="_top">http://pragprog.com/articles/tell-dont-ask</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Inversion of Control Containers and the Dependency Injection pattern</strong></span>
</p><p class="simpara">by Martin Fowler - 2004</p><p class="simpara">"<span class="emphasis"><em>In the Java community there’s been a rush of lightweight containers that help to assemble components from different
projects into a cohesive application. Underlying these containers is a common pattern to how they perform the wiring,
a concept they refer under the very generic name of "Inversion of Control". In this article I dig into how this pattern
works, under the more specific name of "Dependency Injection", and contrast it with the Service Locator alternative.
The choice between them is less important than the principle of separating configuration from use.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/articles/injection.html" target="_top">http://martinfowler.com/articles/injection.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Inversion of Control</strong></span>
</p><p class="simpara">by Martin Fowler - 2005</p><p class="simpara">"<span class="emphasis"><em>Inversion of Control is a key part of what makes a framework different to a library.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/bliki/InversionOfControl.html" target="_top">http://martinfowler.com/bliki/InversionOfControl.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Applying Domain-Driven Design and Patterns</strong></span>
</p><p class="simpara">by Jimmy Nilsson - 2006</p><p class="simpara">"<span class="emphasis"><em>While Eric’s book is the definitive treatment of DDD, this book by Jimmy Nilsson takes a fresh approach to this
difficult topic. Pragmatic and full of examples, this book digs into the nitty-gritty of applying DDD.</em></span>"</p><p class="simpara"><a class="ulink" href="http://domaindrivendesign.org/books/nilsson_2006" target="_top">http://domaindrivendesign.org/books/nilsson_2006</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Domain-Driven Design Quickly</strong></span>
</p><p class="simpara">by Abel Avram &amp; Floyd Marinescu - 2007</p><p class="simpara">"<span class="emphasis"><em>Domain-Driven Design Quickly, is a 104 page condensed explanation of the basic principles of DDD, drawing heavily on
the content of Evans and Nilsson.</em></span>"</p><p class="simpara"><a class="ulink" href="http://domaindrivendesign.org/books/avram_marinescu_2007" target="_top">http://domaindrivendesign.org/books/avram_marinescu_2007</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Putting model to work</strong></span>
</p><p class="simpara">by Eric Evans - 2007</p><p class="simpara">"<span class="emphasis"><em>This talk will outline some of the foundations of domain-driven design: How models are chosen and evaluated; How
multiple models coexist; How the patterns help avoid the common pitfalls, such as overly interconnected models; How
developers and domain experts together in a DDD team engage in deeper exploration of their problem domain and make that
understanding tangible as a practical software design.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.infoq.com/presentations/model-to-work-evans" target="_top">http://www.infoq.com/presentations/model-to-work-evans</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Strategic design</strong></span>
</p><p class="simpara">by Eric Evans - 2007</p><p class="simpara">"<span class="emphasis"><em>This talk introduces two broad principles for strategic design. <span class="emphasis"><em>Context mapping</em></span> addresses the fact that different
groups model differently. <span class="emphasis"><em>Core domain</em></span> distills a shared vision of the system’s "core domain" and provides a systematic
guide to when "good enough" is good enough versus when to push for excellence.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.infoq.com/presentations/strategic-design-evans" target="_top">http://www.infoq.com/presentations/strategic-design-evans</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Clarified CQRS</strong></span>
</p><p class="simpara">by Udi Dahan - 2009</p><p class="simpara">"<span class="emphasis"><em>After listening how the community has interpreted Command-Query Responsibility Segregation I think that the time has
come for some clarification. Some have been tying it together to Event Sourcing. Most have been overlaying their
previous layered architecture assumptions on it. Here I hope to identify CQRS itself, and describe in which places it
can connect to other patterns.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.udidahan.com/2009/12/09/clarified-cqrs/" target="_top">http://www.udidahan.com/2009/12/09/clarified-cqrs/</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>The DCI Architecture: A New Vision of Object-Oriented Programming</strong></span>
</p><p class="simpara">by Trygve Reenskaug and James O. Coplien - 2009</p><p class="simpara">"<span class="emphasis"><em>Object-oriented programming was supposed to unify the perspectives of the programmer and the end user in computer
code: a boon both to usability and program comprehension. While objects capture structure well, they fail to capture
system action. DCI is a vision to capture the end user cognitive model of roles and interactions between them.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.artima.com/articles/dci_vision.html" target="_top">artima.com/articles/dci_vision.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Command and Query Responsibility Segregation</strong></span>
</p><p class="simpara">by Greg Young - 2010</p><p class="simpara">"<span class="emphasis"><em>Command and Query Responsibility Segregation uses the same definition of Commands and Queries that Meyer used and
maintains the viewpoint that they should be pure. The fundamental difference is that in CQRS objects are split into two
objects, one containing the Commands one containing the Queries.</em></span>"</p><p class="simpara"><a class="ulink" href="http://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf" target="_top">http://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Polyglot Persistence</strong></span>
</p><p class="simpara">by Martin Fowler - 2011</p><p class="simpara">"<span class="emphasis"><em>If you’re working in the enterprise application world, now is the time to start familiarizing yourself with
alternative data storage options. This won’t be a fast revolution, but I do believe the next decade will see the
database thaw progress rapidly.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/bliki/PolyglotPersistence.html" target="_top">http://martinfowler.com/bliki/PolyglotPersistence.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>CQRS</strong></span>
</p><p class="simpara">by Martin Fowler - 2011</p><p class="simpara">"<span class="emphasis"><em>CQRS stands for Command Query Responsibility Segregation. It’s a pattern that I first heard described by Greg Young.
At its heart is a simple notion that you can use a different model to update information than the model you use to read
information. This simple notion leads to some profound consequences for the design of information systems.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/bliki/CQRS.html" target="_top">http://martinfowler.com/bliki/CQRS.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Domain Event</strong></span>
</p><p class="simpara">by Martin Fowler - WIP</p><p class="simpara">"<span class="emphasis"><em>Captures the memory of something interesting which affects the domain.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/eaaDev/DomainEvent.html" target="_top">http://martinfowler.com/eaaDev/DomainEvent.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Event Sourcing</strong></span>
</p><p class="simpara">by Martin Fowler - WIP</p><p class="simpara">"<span class="emphasis"><em>Capture all changes to an application state as a sequence of events.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/eaaDev/EventSourcing.html" target="_top">http://martinfowler.com/eaaDev/EventSourcing.html</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Event Collaboration</strong></span>
</p><p class="simpara">by Martin Fowler - WIP</p><p class="simpara">"<span class="emphasis"><em>Multiple components work together by communicating with each other by sending events when their internal state
changes.</em></span>"</p><p class="simpara"><a class="ulink" href="http://martinfowler.com/eaaDev/EventCollaboration.html" target="_top">http://martinfowler.com/eaaDev/EventCollaboration.html</a></p></li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_projects"></a>Projects</h4></div></div></div><p><span class="emphasis"><em>Pêle-mêle</em></span>, inspiring, inspired, alternatives or simply related:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<span class="strong"><strong>AspectJ</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>An aspect-oriented extension to the Java programming language.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.eclipse.org/aspectj/" target="_top">eclipse.org/aspectj</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Spring Framework</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>The Spring Framework is an application framework and Inversion of Control container for the Java platform.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.springsource.org/" target="_top">springsource.org</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Google Guice</strong></span>
</p><p class="simpara">"Guice alleviates the need for factories and the use of new in your Java code"</p><p class="simpara"><a class="ulink" href="http://code.google.com/p/google-guice/" target="_top">code.google.com/p/google-guice</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Java Enterprise Edition (EJBs, CDI)</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>Java EE provides component development, web services, management, and communications APIs.</em></span>"</p><p class="simpara"><a class="ulink" href="http://docs.oracle.com/javaee/" target="_top">docs.oracle.com/javaee</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Chaplin ACT</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>Chaplin ACT is a Java class transformer which modifies classes in such a way that their instances can form composites
at runtime.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.iquality.org/chaplin/" target="_top">iquality.org/chaplin</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>JavATE</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>JavATE, the Java Domain Driven Design Framework, is a set of open source Java libraries that enables application
development using a domain driven approach.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.javate.amattioli.it/" target="_top">http://www.javate.amattioli.it/</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Bastion Framework</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>Bastion is a Java framework for implementing Domain-Driven Designed (DDD) applications.</em></span>"</p><p class="simpara"><a class="ulink" href="http://bastionframework.org/" target="_top">bastionframework.org</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Axon Framework</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>The axon framework is focussed on making life easier for developers that want to create a java application based on
the CQRS principles.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.axonframework.org/" target="_top">axonframework.org</a></p></li><li class="listitem"><p class="simpara">
<span class="strong"><strong>Jdon Framework</strong></span>
</p><p class="simpara">"<span class="emphasis"><em>Jdon Framework is a DDD( Domain-Driven Design ) + DCI + Domain Events(Event Sourcing/CQRS) framework for java.</em></span>"</p><p class="simpara"><a class="ulink" href="http://www.jdon.org/" target="_top">jdon.org</a></p></li></ul></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="javadocs"></a>4. Javadoc</h2></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="samples"></a>5. Samples</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview_2">5.1. Overview</a></span></dt><dt><span class="section"><a href="#sample-dci">5.2. DCI Sample</a></span></dt><dt><span class="section"><a href="#sample-dci-cargo">5.3. DCI Cargo Sample</a></span></dt><dt><span class="section"><a href="#sample-forum">5.4. Forum Sample</a></span></dt><dt><span class="section"><a href="#sample-car-rental">5.5. Car Rental Sample</a></span></dt><dt><span class="section"><a href="#sample-scala">5.6. Scala Sample</a></span></dt><dt><span class="section"><a href="#sample-sql-support">5.7. SQL Support Sample</a></span></dt><dt><span class="section"><a href="#sample-struts2">5.8. Struts2 Sample</a></span></dt><dt><span class="section"><a href="#sample-swing">5.9. Swing Bindings Sample</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview_2"></a>5.1. Overview</h3></div></div></div><p>The Qi4j SDK comes with several sample applications. This is a very good place
to look for code examples and recipes.</p><p>The samples are available in the <code class="literal">samples/</code> directory of the Qi4j SDK.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-dci"></a>5.2. DCI Sample</h3></div></div></div><p>Sample of how DCI (Data, Context &amp; Interaction) pattern is implemented using
Qi4j core only.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/dci" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-dci-cargo"></a>5.3. DCI Cargo Sample</h3></div></div></div><p>Sample of how DCI (Data, Context &amp; Interaction) pattern is implemented with
Qi4j, for Eric Evans DDD sample.</p><p>This sample, contributed by Marc Grue, is described in details on his
website: <a class="ulink" href="http://marcgrue.com/" target="_top">http://marcgrue.com/</a></p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/dci-cargo" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-forum"></a>5.4. Forum Sample</h3></div></div></div><p>Sample of how to build a web forum using <a class="xref" href="#library-rest-server" title="7.22.&#xA0;ReST Server"> ReST Server Library</a>,
<a class="xref" href="#extension-es-neo4j" title="8.10.&#xA0;Neo4j EntityStore"> Neo4j EntityStore</a> and <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a>.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/forum" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-car-rental"></a>5.5. Car Rental Sample</h3></div></div></div><p>Sample of implementation of a Car Rental application implemented as a Servlet
based Webapp packaged as a WAR.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/rental" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-scala"></a>5.6. Scala Sample</h3></div></div></div><p>Sample of how to use Scala with Qi4j.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/scala" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-sql-support"></a>5.7. SQL Support Sample</h3></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This sample use PostgreSQL and drop all of its data once run in order to be runnable multiple times.</p></td></tr></table></div><p>Sample of how to fully use Qi4j SQL support : <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a>, <a class="xref" href="#extension-es-sql" title="8.14.&#xA0;SQL EntityStore"> SQL EntityStore</a> and <a class="xref" href="#extension-indexing-sql" title="8.19.&#xA0;SQL Index/Query">SQL Index/Query</a>.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/sql-support" target="_top">Browse Source</a></p><p>A gradle task <code class="literal">runSample</code> is defined in this module as a shortcut to run the example. See <a class="xref" href="#build-system" title="11.9.&#xA0;Build System">Build System</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-struts2"></a>5.8. Struts2 Sample</h3></div></div></div><p>Sample of how to use the Struts2 integration.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/struts2Hello" target="_top">Browse Source</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="sample-swing"></a>5.9. Swing Bindings Sample</h3></div></div></div><p>Sample of how to write custom binders.</p><p><a class="ulink" href="https://github.com/Qi4j/qi4j-sdk/tree/develop/samples/swing" target="_top">Browse Source</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="core"></a>6. Core</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview_3">6.1. Overview</a></span></dt><dt><span class="section"><a href="#core-api">6.2. Core API</a></span></dt><dt><span class="section"><a href="#core-bootstrap-assembly">6.3. Core Bootstrap</a></span></dt><dt><span class="section"><a href="#core-testsupport">6.4. Core Test Support</a></span></dt><dt><span class="section"><a href="#core-functional">6.5. Core Functional API</a></span></dt><dt><span class="section"><a href="#core-io">6.6. Core I/O API</a></span></dt><dt><span class="section"><a href="#core-spi">6.7. Core Extension SPI</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview_3"></a>6.1. Overview</h3></div></div></div><p>The Qi4j Core is composed of several artifacts described in this section.</p><div class="figure"><a id="idp140267583561216"></a><p class="title"><strong>Figure 1. Qi4j Core Overview</strong></p><div class="figure-contents"><a class="ulink" href="images/core-overview.png" target="_top">
<span class="inlinemediaobject"><img src="images/core-overview.png" alt="core-overview.png" /></span>
</a></div></div><br class="figure-break" /><p>This figure show the Core artifacts alongside <a class="link" href="#libraries" title="7.&#xA0;Libraries">libraries</a> and <a class="link" href="#extensions" title="8.&#xA0;Extensions">extensions</a>, and, in green,
typical applications artifacts. This is not a full code dependency graph but should give you a good overview of how the
pieces fit together.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_api"></a>Core API</h4></div></div></div><p>The Qi4j Core API is the primary interface for client application code during the main execution phase, i.e. after the
application has been activated.</p><p><a class="link" href="#core-api" title="6.2.&#xA0;Core API">Learn more</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_bootstrap"></a>Core Bootstrap</h4></div></div></div><p>Qi4j has a distinct bootstrap phase, also known as the <span class="emphasis"><em>Assembly</em></span> of an application, where the applications structure
is defined programmatically. Once all the layers, modules and all the composite types in each module have been defined
the model is instantiated into an application. This enables the entire <span class="emphasis"><em>structure</em></span> system in Qi4j, where types "belongs"
to a module and visibility rules define default behaviors, enforcement of architectural integrity and much more.</p><p><a class="link" href="#core-bootstrap-assembly" title="6.3.&#xA0;Core Bootstrap">Learn more</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_test_support"></a>Core Test Support</h4></div></div></div><p>Qi4j comes with classes to help with testing. There is also some mocking support, to allow some of Qi4j’s unique
aspects to be mocked, but since Qi4j is so flexible at a fine-granular level, we have found that mocking is seldom,
if ever, needed.</p><p><a class="link" href="#core-testsupport" title="6.4.&#xA0;Core Test Support">Learn more</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_functional_api"></a>Core Functional API</h4></div></div></div><p>The Qi4j Core Functional API is a generic package to work with Iterables in a "functional programming language" style.</p><p>This package is completely independent of everything else in Qi4j and may be used on its own in any kind of environment
such as Spring or Java EE applications.</p><p><a class="link" href="#core-functional" title="6.5.&#xA0;Core Functional API">Learn more</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_i_o_api"></a>Core I/O API</h4></div></div></div><p>The Qi4j Core I/O API tries to address the problem around shuffling data around from various I/O inputs and outputs,
possibly with transformations and filtering along the way.</p><p><a class="link" href="#core-io" title="6.6.&#xA0;Core I/O API">Learn more</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_extension_spi"></a>Core Extension SPI</h4></div></div></div><p>The Qi4j Core Runtime has a number of extension points, which we call the <span class="emphasis"><em>Qi4j Core Extension SPI</em></span>. These are defined
interfaces used <span class="strong"><strong>only</strong></span> by the Core Runtime and <span class="strong"><strong>never</strong></span> directly by application code. <a class="xref" href="#extensions" title="8.&#xA0;Extensions">Extensions</a> are assembled in
applications during the bootstrap phase.</p><p><a class="link" href="#core-spi" title="6.7.&#xA0;Core Extension SPI">Learn more</a></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-api"></a>6.2. Core API</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Qi4j Core API is the primary interface for client application code during the main execution phase, i.e. after the
application has been activated.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-composition"></a>Composition</h4></div></div></div><p>Composition is at the heart of COP, and refers to two different levels of constructs;</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
the ability to assemble (compose) objects from smaller pieces, called Fragments.
</li><li class="listitem">
the construction of applications by assembling Composites into Modules and Modules into Layers.
</li></ol></div><p>In Qi4j, we use the term Assembly for the second case of composition. See separate chapter.</p><p>Composition will allow library authors a new level of flexibility in how functionality is provided to client code. More
on that later.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_fragments"></a>Fragments</h5></div></div></div><p>There are 4 types of Fragments in Qi4j;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#core-api-mixin" title="Mixin">Mixin</a> - The state carrying part of a Composite.
</li><li class="listitem">
<a class="xref" href="#core-api-constraint" title="Constraint">Constraint</a> - Rules for in and out arguments, typically used for validation.
</li><li class="listitem">
<a class="xref" href="#core-api-concern" title="Concern">Concern</a> - Interceptor of method calls. General purpose use, often for cross-cutting behaviors.
</li><li class="listitem">
<a class="xref" href="#core-api-sideeffect" title="SideEffect">SideEffect</a> - Executed after the method call has been completed, and unable to influence the
    outcome of the method call.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_composites"></a>Composites</h5></div></div></div><p>There are 4 Composite meta types. Each of these have very different characteristics and it is important to understand
these, so the right meta type is used for the right purpose.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Entity - Classic meaning. Has an Identity. Is persistable and can be referenced by the Identity. Can act as
      Aggregate. Entity supports Lifecycle interface. Equals is defined by the Identity.
</li><li class="listitem">
Value - Values are persistable when used in a Property from an Entity. Values are immutable, and equals is
      defined by the values of its fields.
</li><li class="listitem">
Service - Service is injectable to other composites and java objects. They are not persistable, but if
      referenced from an Entity or Value, a new reference to the Service will be injected when the Entity/Value is
      deserialized. Services are singletons. There are <span class="emphasis"><em>hosted</em></span> and <span class="emphasis"><em>imported</em></span> Services. The <span class="emphasis"><em>hosted</em></span> Service has
      Configuration and its life cycle controlled by the Qi4j runtime, whereas the <span class="emphasis"><em>imported</em></span> Services are external
      references.
</li><li class="listitem">
Transient - Short-lived composites that are not persistable. Equals/hashCode/toString are forwarded to the
      Mixin Type declaring those methods explicitly.
</li></ul></div><p>In versions of Qi4j prior to 2.0, composite types had to extend one of these 4 meta types, but in 2.0 and later, the
meta type interface is added dynamically during <a class="xref" href="#core-bootstrap-assembly" title="6.3.&#xA0;Core Bootstrap">Assembly</a>.
We can therefor get rid of a lot of additional types, and use Qi4j-free interfaces directly;</p><pre class="programlisting brush: java">@Mixins({BalanceCheckMixin.class, .... } )
public interface BankAccount
{
    Money checkBalance();
    :
    :
}</pre><p>and declare it with;</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
{
    module.entities( BankAccount.class );
}</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-structure"></a>Structure</h4></div></div></div><p>Qi4j promotes a conventional view of application structure, that computer science has been using for decades.</p><p>The definition is as follows;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
One Application per Qi4j runtime instance.
</li><li class="listitem">
One or more Layers per Application.
</li><li class="listitem">
Zero, one or more Modules per Layer.
</li><li class="listitem">
Zero, one or more Assemblies per Module.
</li></ul></div><p>The principle of this Structure is to assist the programmer to create well modularized applications, that are easily
extended and maintained. Qi4j will restrict access between Modules, so that code can only reach Composites and Objects
in Modules (including itself) of the same or lower Layers.</p><p>Each Layer has to be declared which lower Layer(s) it uses, and it is not allowed that a lower Layer uses a higher
Layer, i.e. cyclic references.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-value"></a>ValueComposite</h4></div></div></div><p>Usage of value objects is one of the most ignored and best return-on-investment the programmer can do. Values are
immutable and can be compared by value instead of memory reference. Concurrency is suddenly not an issue, since either
the value exists or it doesn’t, no need for synchronization. Values are typically very easy to test and very robust to
refactoring.</p><p>Qi4j defines values as a primary meta type through the ValueComposite, as we think the benefits of values are great.
The ValueComposite is very light-weight compared to the EntityComposite, and its value can still be persisted as part
of an EntityComposite via a Property.</p><p>The characteristics of a ValueComposite compared to other Composite meta types are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It is Immutable.
</li><li class="listitem">
Its equals/hashCode works on the values of the ValueComposite.
</li><li class="listitem">
Can be used as Property types, but will not be indexed and searchable.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-service"></a>Service Composite</h4></div></div></div><p>Any service added, via the ModuleAssembly.addServices(), ModuleAssembly.services() and ModuleAssembly.importServices()
methods, will have the ServiceComposite meta type added to it. In Qi4j, when we speak of <span class="emphasis"><em>Services</em></span> we mean instances
of <span class="emphasis"><em>ServiceComposite</em></span>.</p><p>Most programmers are familiar with the term "Service", and after the failure of Object Oriented Programming’s promise
to encapsulate all the behavior together with the object’s state, programmers learned that the only way to deal with
decoupling and re-use was to make the objects into data containers and deploy services that acted upon those data
containers. Very much what functions did on structs back in the C and Pascal days.</p><p>Qi4j will bring a lot of the behavior back to the Composite itself, but we still need Services for cross-composite
functionality. The Qi4j Service model is fairly simple, yet powerful and flexible enough to accommodate most
service-oriented patterns and ability to integrate well with external systems whether they are in-JVM or remote,
such as Spring, OSGi, WS-*, Rest and others.</p><p>The characteristics of a ServiceComposite compared to other Composite meta types are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It is one singleton per declaration in bootstrap.
</li><li class="listitem">
It has an identity defined in bootstrap.
</li><li class="listitem">
It has an Activation life cycle into which Activators hook.
</li><li class="listitem">
It has an optional Configuration.
</li></ul></div><p><span class="emphasis"><em>Services</em></span> in Qi4j are <span class="emphasis"><em>singletons</em></span>, one instance per definition. That means that there may exist multiple instances
of the same service type, but they can not be created on the fly in runtime, but has to be explicitly defined during
<a class="xref" href="#core-bootstrap-assembly" title="6.3.&#xA0;Core Bootstrap">Assembly</a>.</p><p>By default, <span class="emphasis"><em>Services</em></span> are not instantiated until they are used. This means that the <span class="emphasis"><em>ServiceComposite</em></span> instance itself
will not exist until someone calls a method. If a <span class="emphasis"><em>Service</em></span> needs to be instantiated when the <span class="emphasis"><em>Module</em></span> is activated, one
need to declare/call the instantiateOnStartup() method on the <span class="emphasis"><em>ServiceDescriptor</em></span> during the bootstrap.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_service_configuration"></a>Service Configuration</h5></div></div></div><p>The configuration for a service is well supported in Qi4j. See the <a class="xref" href="#core-api-service-configuration" title="Service Configuration">Service Configuration</a> chapter for details.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_service_activation"></a>Service Activation</h5></div></div></div><p>Services are activated (injected and instantiated) either on application start-up, or upon first use. This is controlled
by calling instantiateOnStartup(), this way;</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    ServiceDeclaration service = module.addServices( MyDemoService.class );
    service.instantiateOnStartup();
</pre><p>If this method is not called during assembly, the activation will occur on first service usage.</p><p>Passivation occurs when a <a class="xref" href="#core-api-module" title="Module">Module</a> is deactivated, typically because the whole application is shutting down.
Passivation occurs in the reverse order of the activation, to ensure that dependent services are still available for a
passivating service.</p><p>Activators assembled with the service will get their beforeActivation and afterActivation methods called around the
ServiceComposite activation and their beforePassivation and afterPassivation around the ServiceComposite passivation.
Member injection and constructor initialization occur during the activation. The ServiceComposite can be used from the
afterActivation to the beforePassivation method.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_identity_and_tags"></a>Identity and Tags</h5></div></div></div><p>Services has an Identity, which drives the <a class="xref" href="#core-api-service-configuration" title="Service Configuration">Service Configuration</a> system and can be used to lookup a particular service
instance. Services can also be arbitrarily tagged, via the ServiceDescriptor. Example;</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    ServiceDeclaration service = module.addServices( MyDemoService.class );
    [...snip...]

    service.taggedWith( "Important", "Drain" );
</pre><p>Tags are useful inside the application code to locate a particular service instance, in case we have many. For instance;</p><pre class="programlisting brush: java">@Service
private List&lt;ServiceReference&lt;MyDemoService&gt;&gt; services;

public MyDemoService locateImportantService()
{
    for( ServiceReference&lt;MyDemoService&gt; ref : services )
    {
        ServiceTags serviceTags = ref.metaInfo( ServiceTags.class );
        if( serviceTags.hasTag( "Important" ) )
        {
            return ref.get();
        }
    }
    return null;
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-service-configuration"></a>Service Configuration</h4></div></div></div><p>Configuration in Qi4j is for Qi4j <a class="xref" href="#core-api-service" title="Service Composite">ServiceComposite</a> only. The Configuration is stored in a visible Entity
Store and is therefor runtime modifiable and not static in properties or XML files as in most other dependency
injection frameworks.</p><p>The Configuration system itself will handle all the details with interfacing with reading and writing the configuration.
The normal UnitOfWork management is used, but handled internally by the configuration system.</p><p>In Qi4j, Configuration are strongly typed and refactoring-friendly. Configuration is read from the entity store, but if
it can not be found, then it will try to bootstrap it from a properties file, with the same name as the
ServiceDescriptor.identifiedBy(), which is set during <a class="xref" href="#core-bootstrap-assembly" title="6.3.&#xA0;Core Bootstrap">Assembly</a> and defaults to the fully qualified
classname of the <a class="xref" href="#core-api-service" title="Service Composite">ServiceComposite</a> type.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_defining_a_configuration_type"></a>Defining a Configuration Type</h5></div></div></div><p>The Configuration type is simply listing the properties that are available. The standard rules on @UseDefaults and
@Optional applies.
Example;</p><pre class="programlisting brush: java">public interface MailServiceConfiguration extends ConfigurationComposite
{
    Property&lt;String&gt; hostName();

    Property&lt;Integer&gt; port();
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_using_a_configuration_type"></a>Using a Configuration Type</h5></div></div></div><p>It is important to remember that Configuration is not static values that are set prior to application start-up and
therefor applications should not cache the values retrieved forever, but consciously know when the configuration should
be re-read.</p><p>Configuration is injected via the @This injection scope. One reasonable strategy is to read the configuration on service
activation, so by deactivating/reactivating a service, the user have a well-defined behavior to know how configuration
changes take effect. Example;</p><pre class="programlisting brush: java">@This
private Configuration&lt;MailServiceConfiguration&gt; config;

@Override
public void sendMail( @Email String to, @MinLength( 8 ) String subject, String body )
{
    config.refresh();
    MailServiceConfiguration conf = config.get();
    String hostName = conf.hostName().get();
    int port = conf.port().get();
    [...snip...]

}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_modifying_configuration"></a>Modifying Configuration</h5></div></div></div><p>Configuration is modifiable, and after the modifications have been made, the save() method on the Configuration type
must be called. Example;</p><pre class="programlisting brush: java">    void changeExternalMailService( String hostName, int port );
    [...snip...]

        @Override
        public void changeExternalMailService( String hostName, int port )
        {
            MailServiceConfiguration conf = config.get();
            conf.hostName().set( hostName );
            conf.port().set( port );
            config.save();
        }
        [...snip...]

    }
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-entity"></a>EntityComposite</h4></div></div></div><p>Entities are common in the object oriented programming world, but has never reached the stardom of Class and Object.
Instead we have seen many attempts at creating Entities on top of Java, such as EJB (3 incompatible versions), Java
Data Objects (JDO, 2 somewhat compatible versions), Java Persistence Architecture (JPA, 2 somewhat compatible versions),
Hibernate (4+ somewhat incompatible versions) and many other less known. This seems to suggest that the topic of
creating objects that survives over long periods of time is a difficult one.</p><p>Eric Evans points out in his book that Entities is a very definite and distinct concept that needs to be handled
explicitly. Composite Oriented Programming in general, and Qi4j in particular, takes this point very seriously and
makes Entities a central part of the whole system. And likewise, we are convinced that it is not possible to develop
domain-knowledge-rich applications without a conscious and well-defined strategy on Entities. So, instead of spending
endless hours trying to get Hibernate mapping to do the right thing, we introduce a Composite meta type called
EntityComposite, which all entities must derive from, and by doing so automatically become persistable, searchable,
have a lifecycle and support nested undoable modifications.</p><p>The characteristics of an EntityComposite compared to other Composite meta types are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It has an Identity.
</li><li class="listitem">
It has a LifeCycle.
</li><li class="listitem">
It is typically persisted.
</li><li class="listitem">
It can only be referenced by an Association or ManyAssociation.
</li><li class="listitem">
Its CRUD operations are bound by a UnitOfWork.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-transient"></a>TransientComposite</h4></div></div></div><p>TransientComposite is a Composite meta type for all other cases. The main characteristics are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It can not be serialized nor persisted.
</li><li class="listitem">
hashcode/equals are not treated specially and will be delegated to fragment(s) implementing those methods.
</li><li class="listitem">
It can not be used as a Property type.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-mixin"></a>Mixin</h4></div></div></div><p>Mixins are the state-carrying part of a Composite instance. The other Fragments can not retain state between method
invocations as they are shared across Composite instances.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_mixin_type"></a>Mixin Type</h5></div></div></div><p>The Mixin Type is the interface that declares the Mixin methods. Each Mixin implementation (the classes defined in
the @Mixins annotation of a Composite declaration) implements one or more methods from one or more Mixin Types.</p><p>Mixin Type can be very simple, like;</p><pre class="programlisting brush: java">public interface BankAccount
{
    Money checkBalance();
}
</pre><p>Or contain hundreds of methods, subclassed from dozens of super interfaces.</p><p>The Mixin Types of a Composite are ;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
all the aggregated interfaces of the Composite Type, minus Composite meta-type interfaces, and
</li><li class="listitem">
all private mixin referenced types.
</li></ul></div><p>There is not a 1:1 correlation between Mixin Type and Mixin implementation. One can’t even know if there are more or
less of one over the other. That is because a Mixin implementation can implement less than one, one, or more than one
Mixin Type.</p><p>It is also entirely possible that multiple implementation methods exists for a Mixin Type method. The mixin method
resolution algorithm will provide a deterministic behavior of which implementation of a method is chosen. The algorithm
is as follows;</p><p>For each declared method of all Mixin Types of a Composite;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Iterate all Mixin types declared from left to right in the declaration,
</li><li class="listitem">
Iterate all Mixin types of super-interfaces from left to right in the <span class="emphasis"><em>extends</em></span> clause,
</li><li class="listitem">
Iterate all Mixin types within one interface before succeeding to the next interface,
</li><li class="listitem">
Iterate all super-interface Mixin types before proceeding to the super-interfaces of those,
</li><li class="listitem">
Iterate all Typed Mixin implementations of all super-interfaces, before repeating the algorithm for Generic Mixin
      implementations,
</li></ul></div><p>This means that one Mixin implementation can <span class="emphasis"><em>override</em></span> a single method that a larger mixin implementation implements
together with many other methods. So, just because a mixin implements MixinTypeA.method1() and has an implementation
of MixinTypeA.method2(), doesn’t mean that method2() is mapped to that mixin. This is very important to remember. The
Envisage tool is capable of visualizing how Mixin Type methods are mapped to implementations.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_public_mixins"></a>Public Mixins</h5></div></div></div><p>Mixins are the state holders of the composite instance. Public Mixins are the mixins that are exposed to the outside
world via the CompositeType interface.</p><p><span class="strong"><strong>Each method in the CompositeType interface MUST be backed by a mixin class.</strong></span></p><p>Mixins are declared as annotations on the composite interface.</p><pre class="programlisting brush: java">@Mixins( SomethingMixin.class )
public interface Something
{}
</pre><pre class="programlisting brush: java">public class SomethingMixin
        implements Something
{
    // State is allowed.

    public void doSomething()
    {
        // do stuff...
    }
}
</pre><p>In the above sample, the SomethingMixin will be made part of the Something composite.</p><p>If we have many interfaces defining many methods, that all must be backed by a mixin implementation, we simply list all
the mixins required.</p><pre class="programlisting brush: java">@Mixins( { StartMixin.class, VehicleMixin.class } )
public interface Car extends Startable, Vehicle
{}
</pre><pre class="programlisting brush: java">public interface Startable
{
    boolean start();
    void stop();
}

</pre><pre class="programlisting brush: java">public interface Vehicle
{
    void turn(float angle);

    void accelerate(float acceleration);

    // more methods
}

</pre><p>In the example above, the VehicleMixin would need to deal with all methods defined in the Vehicle interface. That
interface could be very large, and could be totally independent concerns. So, instead we should use abstract mixins,
which are ordinary mixins but are lacking some methods. This is simply done by declaring the class abstract.</p><pre class="programlisting brush: java">@Mixins( { StartMixin.class, SpeedMixin.class, CrashResultMixin.class } )
public interface Car extends Startable, Vehicle
{}

</pre><pre class="programlisting brush: java">public interface Vehicle extends SpeedLocation, Crashable
{
}

</pre><pre class="programlisting brush: java">public interface SpeedLocation
{
    void turn(float angle);

    void accelerate(float acceleration);
}
</pre><pre class="programlisting brush: java">public abstract class SpeedMixin
        implements SpeedLocation
{
    // state for speed

    public void accelerate( float acceleration )
    {
        // logic
    }
}

</pre><p>Above the SpeedMixin only implements the accelerate() method, and Qi4j will only map that method to this mixin. The
other method of the SpeedLocation interface is not satisfied as the example is written and will generate a runtime
exception.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_private_mixins"></a>Private Mixins</h5></div></div></div><p>Public mixins expose their methods in the composite interface, and this is not always desirable. Qi4j supports
<span class="emphasis"><em>Private Mixins</em></span>, which are only visible within the composite itself. That means that other fragments in the composite
can see/use it, but it is not visible to the clients of the composite.</p><p>Private Mixins are handled automatically. When Qi4j detects a @This annotation referring to a type that is not defined
in the Composite interface, then that is a Private Mixin. The Mixin implementation class, however, must exist in the
list of Mixins in the @Mixins annotation. But often, the Private Mixin only list internal Property methods in the Mixin
Type, which will be satisfied by the standard PropertyMixin and hence always available.</p><p>This is particularly useful in Domain Driven Design, where you only want to expose domain methods, which are defined by
the context where they are used. But the state of the Mixin should not be exposed out at all. For instance, if we have
the Cargo interface like;</p><pre class="programlisting brush: java">@Mixins( CargoMixin.class )
public interface Cargo extends EntityComposite
{
    String origin();

    String destination();

    void changeDestination( String newDestination );

}

</pre><p>The interface is defined by its context, and not really exposing the internal state. So in the implementation we
probably do something like;</p><pre class="programlisting brush: java">public abstract class CargoMixin
        implements Cargo
{
    @This
    private CargoState state;

    public String origin()
    {
        return state.origin().get();
    }

    public String destination()
    {
        return state.destination().get();
    }

    public void changeDestination( String newDestination )
    {
        state.destination().set( newDestination );
    }
}

</pre><pre class="programlisting brush: java">public interface CargoState
{
    Property&lt;String&gt; origin();
    Property&lt;String&gt; destination();
}

</pre><p>So, in this typical case, we don’t need to declare the Mixin for the CargoState, as it only defines Property methods,
which are handled by the standard PropertyMixin always present.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_typed_mixin_vs_generic_mixin_implementations"></a>Typed Mixin vs Generic Mixin implementations</h5></div></div></div><p>Mixins, Concerns and SideEffects can either be "typed" or "generic". A Typed Mixin implementation implements one or
more Mixin Type interfaces, and one or more of the methods of those interfaces. A Generic Mixin implementation
implements java.lang.reflect.InvocationHandler, and can therefor be matched to any method of any interface.
Typically, AppliesTo annotation is used to filter the methods that such Generic Mixin implementation is mapped against,
and sometimes Generic Mixin implementations are "last resort".</p><p>Experience shows that Generic Mixin implementations are rare, and should only be used in extreme cases. They are
less frequent than Generic Concern or Generic SideEffect implementations, but inside the Qi4j API are a couple of
Generic Mixin implementations that are always present to make the life of the developer easier, such as PropertyMixin,
AssociationMixin, ManyAssociationMixin, NoopMixin. The first 3 are declared on the Composite and EntityComposite
interfaces and automatically included if needed. They also serve as excellent example of what they can be used for.</p><pre class="programlisting brush: java">@AppliesTo( { PropertyMixin.PropertyFilter.class } )
public final class PropertyMixin
    implements InvocationHandler
{
    @State private StateHolder state;

    public Object invoke( Object proxy, Method method, Object[] args )
        throws Throwable
    {
        return state.getProperty( method );
    }

    public static class PropertyFilter
        implements AppliesToFilter, Serializable
    {
        public boolean appliesTo( Method method, Class&lt;?&gt; mixin,
                                  Class&lt;?&gt; compositeType,
                                  Class&lt;?&gt; modifierClass )
        {
            return Property.class.isAssignableFrom( method.getReturnType() );
        }
    }
}</pre><p>Other examples that we have come across;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Mapping from Property&lt;type&gt; to POJO style "properties".
</li><li class="listitem">
Remote Service delegation.
</li><li class="listitem">
Scripting delegation, where a script will implement the Mixin Type.
</li></ul></div><p>which seems to indicate that Generic Mixin implementations are likely to be used in integration of other technologies.</p><p>Typed Mixin implementations are much preferred in general business logic, as they will be first-class citizens of
the IDE as well, for navigation, find usage, refactoring and many other common tasks. This is one of the main
advantages of the Qi4j way of doing AOP compared to AspectJ et al, where "weaving" is something bolted onto an
application’s classes via regular expressions and known naming conventions, which can change in an instance by a
developer being unaware of which PointCuts applies to his code.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-concern"></a>Concern</h4></div></div></div><p>Concerns are the equivalent of "around advice" in Aspect Oriented Programming. They are chained into an invocation
stack for each Mixin Type method and invoked after the Constraints have been executed. Since they are sitting "around"
the Mixin implementation method, they also have a chance to modify the returned result, and even skip calling the
underlying Mixin method implementation altogether.</p><p>To create a concern, you need to create a class that,</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
implements the Mixin Type (Typed Concerns) or java.lang.reflect.InvocationHandler (Generic Concerns),
</li><li class="listitem">
extend ConcernOf (Typed Concerns) or GenericConcern (Generic Concerns) [1]
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-constraint"></a>Constraint</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-sideeffect"></a>SideEffect</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-module"></a>Module</h4></div></div></div><p>Modules are logical compartments to assist developers in creating and maintaining well modularized code. A Module only
belongs to a single Layer, but many Modules can exist in the same Layer. Composite access is limited to;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Composites within the same Module, with Visibility set to Visibility.module (default).
</li><li class="listitem">
Composites from Modules in the same Layer, with Visibility set to Visibility.layer
</li><li class="listitem">
Composites from Modules in Layers below, with Visibility set to Visibility.application
</li></ul></div><p>Modules contains a lot of the Qi4j infrastructure, which are the enforcers of these wise modularization principles.</p><p>It is not possible to modify the Modules, their resolution nor binding in any way after the application starts.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-type-lookup"></a>Composite Types Lookup</h4></div></div></div><p>Composite Types Lookup can occurs when you explicitely lookup for a Composite by Type
(ex. ServiceFinder.findService(..) methods), when you ask for an injection or when you create a new composite instance.</p><p>All theses type lookup start from a Module, are lazy, cached and obey the Qi4j Visibility rules. Type Lookup works
equally accross Composite Types with some subtle differences when it comes to Services and Entities.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_object_transient_and_value_types_lookup"></a>Object, Transient and Value Types Lookup</h5></div></div></div><p>When creating or injecting Objects, Transients or Values the Type Lookup does the following:</p><p>First, if Object/Transient/Value Models exactly match the given type, the closest one (Visibility then Assembly order)
is returned. Multiple <span class="strong"><strong>exact</strong></span> matches with the same Visibility are <span class="strong"><strong>forbidden</strong></span> and result in an
AmbiguousTypeException.</p><p>Second, if Object/Transient/Value Models match a type assignable to the given type, the closest one (Visibility then
Assembly order) is returned. Multiple <span class="strong"><strong>assignable</strong></span> matches with the same Visibility are <span class="strong"><strong>forbidden</strong></span> and result in an
AmbiguousTypeException.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_entity_types_lookup"></a>Entity Types Lookup</h5></div></div></div><p>Entity Types Lookup is splitted in two use cases famillies: Creational usecases and Non-Creational usecases.</p><p><span class="strong"><strong>Creational Entity Types Lookup</strong></span></p><p>This Type Lookup takes place when creating new Entity instances from a UnitOfWork and behave exactly like
Object/Transient/Value Types Lookups.</p><p><span class="strong"><strong>Non-Creational Entity Types Lookup</strong></span></p><p>This Type Lookup takes place when fetching Entities from an EntityStore or writing queries using the Query API. The Type
Lookup is different here to allow polymorphic use of Entities and Queries.</p><p>First difference is that this Type Lookup returns an ordered collection instead of a single match.</p><p>Returned collection contains, in order, Entity Models that:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
exactly match the given type, in Visibility then Assembly order ;
</li><li class="listitem">
match a type assignable to the given type, in Visibility then Assembly order.
</li></ul></div><p>Multiple <span class="strong"><strong>exact</strong></span> matches with the same Visibility are <span class="strong"><strong>forbidden</strong></span> and result in an AmbiguousTypeException.</p><p>Multiple <span class="strong"><strong>assignable</strong></span> matches are <span class="strong"><strong>allowed</strong></span> to enable polymorphic fetches and queries.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_service_types_lookup"></a>Service Types Lookup</h5></div></div></div><p>Service Types Lookup works as follow:</p><p>Returned collection contains, in order, ServiceReferences that:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
exactly match the given type, in Visibility then Assembly order ;
</li><li class="listitem">
match a type assignable to the given type, in Visibility then Assembly order.
</li></ul></div><p>Multiple <span class="strong"><strong>exact</strong></span> matches with the same Visibility are <span class="strong"><strong>allowed</strong></span> to enable polymorphic lookup/injection.</p><p>Multiple <span class="strong"><strong>assignable</strong></span> matches with the same Visibility are <span class="strong"><strong>allowed</strong></span> for the very same reason.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-api-metrics"></a>Metrics API</h4></div></div></div><p>The Qi4j platform defines an advanced Metrics SPI to capture runtime metrics of Qi4j’s internals as well be used by
application code (via this API) to provide production metrics for operations personnel, ensuring healthy state of
the applications.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_metrics_components"></a>Metrics Components</h5></div></div></div><p>There are quite a lot of different Metrics components available, which are instantiated via factories. There is one
factory for each component type, to allow for additional components to be created in the future without breaking
compatibility in the existing implementations.</p><p>The MetricsProvider is a standard Qi4j Service and simply acquired via the @Service annotation on a field or
constructor argument.</p><pre class="programlisting brush: java">@Service
private MetricsProvider provider;
</pre><p>A Gauge is the simplest form of Metric. It is a value that the application sets, which is polled upon request. The
application need to provide the implementation of the <span class="emphasis"><em>value()</em></span> method. Gauges are genericized for type-safe value
handling.</p><p>A Gauge can represent anything, for instance, thread pool levels, queue sizes and other resource allocations. It is
useful to have separate gauges for percentage (%) and absolute numbers of the same resource. Operations are mainly
interested in being alerted when threshold are reach as a percentage, as it is otherwise too many numbers to keep
track of.</p><p>To create a Gauge, you do something like;</p><pre class="programlisting brush: java">final BlockingQueue queue = new LinkedBlockingQueue( 20 );
[...snip...]

MetricsGaugeFactory gaugeFactory = provider.createFactory( MetricsGaugeFactory.class );
MetricsGauge&lt;Integer&gt; gauge = gaugeFactory.registerGauge( getClass(), "Sample Gauge", new MetricsGauge&lt;Integer&gt;()
{
    @Override
    public Integer value()
    {
        return queue.size();
    }
} );
</pre><pre class="programlisting brush: java">MetricsCounterFactory counterFactory = provider.createFactory( MetricsCounterFactory.class );
MetricsCounter counter = counterFactory.createCounter( getClass(), "Sample Counter" );
</pre><pre class="programlisting brush: java">MetricsHistogramFactory histoFactory = provider.createFactory( MetricsHistogramFactory.class );
MetricsHistogram histogram = histoFactory.createHistogram( getClass(), "Sample Histogram" );
</pre><pre class="programlisting brush: java">MetricsMeterFactory meterFactory = provider.createFactory( MetricsMeterFactory.class );
MetricsMeter meter = meterFactory.createMeter( getClass(), "Sample Meter", "requests", TimeUnit.MINUTES );
</pre><p>Timers capture both the length of some execution as well as rate of calls. They can be used to time method calls, or
critical sections, or even HTTP requests duration and similar.</p><pre class="programlisting brush: java">MetricsTimerFactory timerFactory = provider.createFactory( MetricsTimerFactory.class );
MetricsTimer timer = timerFactory.createTimer( getClass(), "Sample Timer", TimeUnit.SECONDS, TimeUnit.HOURS );
</pre><pre class="programlisting brush: java">MetricsHealthCheckFactory healthFactory = provider.createFactory( MetricsHealthCheckFactory.class );
MetricsHealthCheck healthCheck = healthFactory.registerHealthCheck(
    getClass(),
    "Sample Healthcheck",
    new MetricsHealthCheck()
    {
        @Override
        public Result check()
            throws Exception
        {
            ServiceStatus status = pingMyService();
            return new Result( status.isOk(), status.getErrorMessage(), status.getException() );
        }
    } );
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-bootstrap-assembly"></a>6.3. Core Bootstrap</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>Qi4j has a distinct bootstrap phase, also known as the <span class="emphasis"><em>Assembly</em></span> of an application, where the applications structure
is defined programmatically. Once all the layers, modules and all the composite types in each module have been defined
the model is instantiated into an application. This enables the entire <span class="emphasis"><em>structure</em></span> system in Qi4j, where types "belongs"
to a module and visibility rules define default behaviors, enforcement of architectural integrity and much more.</p><p>The <span class="emphasis"><em>assembly</em></span> is preceeded by the creation of the <span class="emphasis"><em>Qi4j Runtime</em></span>. The <span class="emphasis"><em>assembly</em></span> can be declared fully by defining
all modules and layers, and how the layers are sitting on top of each other, OR one can utilize one of the two
convenience assemblies, one for a <span class="emphasis"><em>pancake</em></span> pattern, where all layers are top on each other, or one with a single module
in a single layer, useful for small applications, spikes and tests.</p><p>During <span class="emphasis"><em>assembly</em></span>, the application (JVM level) architecture and the application model is defined. You define which
layers exist and how they relate to each other. For each layer, you define which modules it contains. And for each
module, you define which composites are in it, and what are the visibility rules for each of these composites.</p><p>You can also;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Define default values for properties.
</li><li class="listitem">
Add additional interfaces to composites dynamically.
</li><li class="listitem">
Add concerns, mixins, constraints and side effects dynamically.
</li><li class="listitem">
Set <span class="emphasis"><em>meta information</em></span> on defined types.
</li><li class="listitem">
Import external services to be available as Qi4j services.
</li><li class="listitem">
Tag services with markers
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_objects"></a>Defining Objects</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.objects( MyObject.class ).visibleIn( Visibility.layer );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_transients"></a>Defining Transients</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.transients( MyTransient.class ).visibleIn( Visibility.layer );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_values"></a>Defining Values</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.values( MyValue.class ).visibleIn( Visibility.layer );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_entities"></a>Defining Entities</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.entities( MyEntity.class ).visibleIn( Visibility.layer );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_services"></a>Defining Services</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.services( MyService.class ).visibleIn( Visibility.layer );
}
</pre><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_tagging_services"></a>Tagging Services</h5></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    module.services( MyService.class ).taggedWith( "foo", "bar" );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_importing_external_services"></a>Importing external Services</h5></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    module.importedServices( MyService.class ).
        importedBy( InstanceImporter.class ).
        setMetaInfo( new MyService() );

    // OR

    module.objects( MyService.class );
    module.importedServices( MyService.class ).
        importedBy( NewObjectImporter.class );
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_default_values_for_properties"></a>Defining default values for Properties</h4></div></div></div><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    module.values( MyValue.class );
    MyValue myValueDefaults = module.forMixin( MyValue.class ).declareDefaults();
    myValueDefaults.foo().set( "bar" );

    module.entities( MyEntity.class );
    MyEntity myEntityDefaults = module.forMixin( MyEntity.class ).declareDefaults();
    myEntityDefaults.cathedral().set( "bazar" );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_adding_additional_interfaces_to_composites"></a>Adding additional interfaces to composites</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_adding_concerns_mixins_constraints_and_side_effects"></a>Adding concerns, mixins, constraints and side effects</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_setting_meta_information_on_assembled_types"></a>Setting meta information on assembled types</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_facilities"></a>Facilities</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_specifications"></a>Assembly Specifications</h5></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_class_scanner"></a>Class Scanner</h5></div></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_assemblers"></a>Using Assemblers</h4></div></div></div><p>Many <a class="link" href="#libraries" title="7.&#xA0;Libraries">libraries</a> and <a class="link" href="#extensions" title="8.&#xA0;Extensions">extensions</a> provides a cookie-cutter <span class="emphasis"><em>Assembler</em></span>, to simplify the set up
of such component. Often these are suitable, but sometimes they won’t fit the application in hand, in which case the
source code at least provides information of what is needed for the component to be used.</p><p>Assemblers are typically just instantiated and then call the assemble() method with the ModuleAssembly instance,
such as;</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    RestServerAssembler assembler = new RestServerAssembler();
    assembler.assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_defining_an_entity_store"></a>Defining an Entity Store</h4></div></div></div><p>Defining an <span class="emphasis"><em>Entity Store</em></span> is in principle as simple as defining a ServiceComposite implementing the EntityStore
interface. The problem is that most Entity Stores require <a class="xref" href="#core-api-service-configuration" title="Service Configuration">Service Configuration</a>, and configuration requires an
Entity Store. This chicken-and-egg problem is resolved by having an entity store available that does not require any
<a class="xref" href="#core-api-service-configuration" title="Service Configuration">Service Configuration</a>. Many <span class="emphasis"><em>Assemblers</em></span> for entity store implementations uses the MemoryEntityStore, and
effectively leaves the configuration in the properties file where <a class="xref" href="#core-api-service-configuration" title="Service Configuration">Service Configuration</a> bootstraps from. It is
possible to chain this, so that for instance the Neo4J Entity Store uses the Preferences Entity Store for its
configuration, and the Preferences Entity Store uses the Memory Entity Store (i.e. the properties file).</p><p>The point is that the entity store used for the configuration of the primary entity store used in the application is
that it must not be visible to the application itself. Sometimes it is easiest to put a Memory Entity Store in the
same module, with Visibility set to <span class="emphasis"><em>module</em></span>. Sometimes it makes sense to have an additional Configuration layer below
the infrastructure layer, which has this setup.</p><p>As mentioned above, most entity stores defines a reasonable default <span class="emphasis"><em>Assembler</em></span>, possibly with some constructor
arguments to define certain aspects. An example is the popular JdbmEntityStore, which <span class="emphasis"><em>Assembler</em></span> can be used like;</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    JdbmEntityStoreAssembler assembler = new JdbmEntityStoreAssembler( Visibility.application );
    assembler.assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_singleton_assembler"></a>Singleton Assembler</h4></div></div></div><p>Every Qi4j runtime instance consist of One Application, with one or more Layers and one or more Modules in each Layer.
So the minimal application is still one layer with one module. This is not recommended other than for testing purposes
and really trivial applications.</p><p>Let’s take a closer look at how it is put together.</p><pre class="programlisting brush: java">SingletonAssembler assembler = new SingletonAssembler()
{

    @Override
    public void assemble( ModuleAssembly module )
            throws AssemblyException
    {
        module.services( MyService.class ).identifiedBy( "Foo" );
        module.services( MyService.class ).identifiedBy( "Bar" );
        module.objects( Stuff.class );
    }

};
Module module = assembler.module();
Stuff stuff = module.newObject( Stuff.class );
</pre><p>Once the SingletonAssembler constructor returns, the Qi4j application is up and running.</p><p>The SingletonAssembler also makes common system resources available from the bootstrap code, such as
Module, UnitOfWorkFactory and others. This is possible since there is only one Module.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_pancake_assembly"></a>Pancake Assembly</h4></div></div></div><p>There is one case that stands out as a common case, and forms a reasonable middle-ground. It is where each layer sits
exactly on top of each other layer, like pancakes. Each layer will only use the layer directly below and only that
layer. For this case we have a convenience setup. You create an Assembler[][][], where the outer-most array is each
layer, the middle array is the modules in each layer, and the last array is a set of assemblers needed to put the
things togather.</p><p>Let’s look at an example;</p><pre class="programlisting brush: java">public static void main( String[] args )
        throws Exception
{
    qi4j = new Energy4Java();
    Assembler[][][] assemblers = new Assembler[][][]{
        { // View Layer
            { // Login Module
                new LoginAssembler()
            // :
            },
            { // Main Workbench Module
                new MenuAssembler(),
                new PerspectivesAssembler(),
                new ViewsAssembler()
            // :
            },
            { // Printing Module
                new ReportingAssembler(),
                new PdfAssembler()
            // :
            }
        },
        { // Application Layer
            { // Accounting Module
                new BookkeepingAssembler(),
                new CashFlowAssembler(),
                new BalanceSheetAssembler()
            // :
            },
            { // Inventory Module
                new PricingAssembler(),
                new ProductAssembler()
            // :
            }
        },
        { // Domain Layer
        // :
        },
        { // Infrastructure Layer
        // :
        }
    };
    ApplicationDescriptor model = newApplication( assemblers );
    Application runtime = model.newInstance( qi4j.spi() );
    runtime.activate();
}

private static ApplicationDescriptor newApplication( final Assembler[][][] assemblers )
        throws AssemblyException
{
    return qi4j.newApplicationModel( new ApplicationAssembler()
    {

        @Override
        public ApplicationAssembly assemble( ApplicationAssemblyFactory appFactory )
                throws AssemblyException
        {
            return appFactory.newApplicationAssembly( assemblers );
        }

    } );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_full_assembly"></a>Full Assembly</h4></div></div></div><p>Full Assembly means that you have the opportunity to create any layer/module hierarchy that are within the rules of the
Qi4j runtime. It requires more support in your code to be useful, and the example below is by no means a recommended way
to organize large application assemblies.</p><p>In principle, you first start the Qi4j runtime, call newApplication with an ApplicationAssembler instance and call
activate() on the returned application. The ApplicationAssembler instance will be called with an
ApplicationAssemblyFactory, which is used to create an ApplicationAssembly describing the application structure.</p><pre class="programlisting brush: java">private static Energy4Java qi4j;

private static Application application;

public static void main( String[] args )
        throws Exception
{
    // Create a Qi4j Runtime
    qi4j = new Energy4Java();
    application = qi4j.newApplication( new ApplicationAssembler()
    {

        @Override
        public ApplicationAssembly assemble( ApplicationAssemblyFactory appFactory )
                throws AssemblyException
        {
            ApplicationAssembly assembly = appFactory.newApplicationAssembly();
            buildAssembly( assembly );
            return assembly;
        }

    } );
    // activate the application
    application.activate();
}

static void buildAssembly( ApplicationAssembly app ) throws AssemblyException
{
    LayerAssembly webLayer = createWebLayer( app );
    LayerAssembly domainLayer = createDomainLayer( app );
    LayerAssembly persistenceLayer = createInfrastructureLayer( app );
    LayerAssembly authLayer = createAuth2Layer( app );
    LayerAssembly messagingLayer = createMessagingLayer( app );

    webLayer.uses( domainLayer );
    domainLayer.uses( authLayer );
    domainLayer.uses( persistenceLayer );
    domainLayer.uses( messagingLayer );
}

static LayerAssembly createWebLayer( ApplicationAssembly app ) throws AssemblyException
{
    LayerAssembly layer = app.layer( "web-layer" );
    createCustomerWebModule( layer );
    return layer;
}

static LayerAssembly createDomainLayer( ApplicationAssembly app ) throws AssemblyException
{
    LayerAssembly layer = app.layer( "domain-layer" );
    createCustomerDomainModule( layer );
    // :
    // :
    return layer;
}

static LayerAssembly createInfrastructureLayer( ApplicationAssembly app ) throws AssemblyException
{
    LayerAssembly layer = app.layer( "infrastructure-layer" );
    createPersistenceModule( layer );
    return layer;
}

static LayerAssembly createMessagingLayer( ApplicationAssembly app ) throws AssemblyException
{
    LayerAssembly layer = app.layer( "messaging-layer" );
    createWebServiceModule( layer );
    createMessagingPersistenceModule( layer );
    return layer;
}

static LayerAssembly createAuth2Layer( ApplicationAssembly application ) throws AssemblyException
{
    LayerAssembly layer = application.layer( "auth2-layer" );
    createAuthModule( layer );
    return layer;
}

static void createCustomerWebModule( LayerAssembly layer ) throws AssemblyException
{
    ModuleAssembly assembly = layer.module( "customer-web-module" );
    assembly.transients( CustomerViewComposite.class, CustomerEditComposite.class,
                         CustomerListViewComposite.class, CustomerSearchComposite.class );
}

static void createCustomerDomainModule( LayerAssembly layer ) throws AssemblyException
{
    ModuleAssembly assembly = layer.module( "customer-domain-module" );
    assembly.entities( CustomerEntity.class, CountryEntity.class );
    assembly.values( AddressValue.class );
}

static void createAuthModule( LayerAssembly layer ) throws AssemblyException
{
    ModuleAssembly assembly = layer.module( "auth-module" );
    new LdapAuthenticationAssembler().assemble( assembly );
    new ThrinkAuthorizationAssembler().assemble( assembly );
    new UserTrackingAuditAssembler().assemble( assembly );
}

static void createPersistenceModule( LayerAssembly layer ) throws AssemblyException
{
    ModuleAssembly assembly = layer.module( "persistence-module" );
    // Someone has created an assembler for the Neo EntityStore
    new NeoAssembler( "./neostore" ).assemble( assembly );
}

</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-testsupport"></a>6.4. Core Test Support</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-none">tests</p><p>Qi4j comes with classes to help with testing. For general development, only a couple of classes are of interest as the
others are mostly for EntityStore and Index/Query SPI implementations. There is also some mocking support, to allow
some of Qi4j’s unique aspects to be mocked, but since Qi4j is so flexible at a fine-granular level, we have found that
mocking is seldom, if ever, needed.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_your_first_testcase"></a>Your First Testcase</h4></div></div></div><p>In most cases, you will probably use the AbstractQi4jTest class to simplify starting a Qi4j test instance.</p><pre class="programlisting brush: java">public class HelloTest extends AbstractQi4jTest
{
[...snip...]

}
</pre><p>This will do all the initialization of a Qi4j runtime instance and create a single layer with a single module in it.
What goes into that module is declared in the assembly() method;</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    module.values( Hello.class );
}
</pre><p>In this case we declare that we have a ValueComposite of type org.qi4j.tutorials.hello.Hello which looks like</p><pre class="programlisting brush: java">
/**
 * This Composite interface declares a simple "Hello World" interface with a single say() method. What is being
 * said is defined in the HelloWorldState interface, which is a private mixin.
 * &lt;p/&gt;
 */
@Mixins( { Hello.HelloWorldMixin.class } )
public interface Hello
{
    String say();

    /**
     * This is the implementation of the say() method.
     */
    public abstract class HelloWorldMixin
        implements Hello
    {
        // @This reference the composite itself, and since HelloWorldState is not part of the public interface,
        // it is a private mixin.
        @This
        private State state;

        @Override
        public String say()
        {
            return state.phrase().get() + " " + state.name().get();
        }
    }

    /**
     * This interface contains only the state of the HelloWorld object.
     */
    public interface State
    {
        @NotEmpty
        @UseDefaults
        Property&lt;String&gt; phrase();

        @NotEmpty
        @UseDefaults
        Property&lt;String&gt; name();
    }
}
</pre><p>The say() method will get the <span class="emphasis"><em>phrase</em></span> and <span class="emphasis"><em>name</em></span> from its internal state (the State interface is not magical, it could
be named anything).</p><p>And then we create the actual test;</p><pre class="programlisting brush: java">@Test
public void givenHelloValueInitializedToHelloWorldWhenCallingSayExpectHelloWorld()
{
    ValueBuilder&lt;Hello&gt; builder = module.newValueBuilder( Hello.class );
    builder.prototypeFor( Hello.State.class ).phrase().set( "Hello" );
    builder.prototypeFor( Hello.State.class ).name().set( "World" );
    Hello underTest = builder.newInstance();
    String result = underTest.say();
    assertThat( result, equalTo( "Hello World" ) );
}
</pre><p>By using the prototypeFor() we can access the hidden, internal and very private state of the ValueComposite. Once the
value is created we can reach this directly.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-functional"></a>6.5. Core Functional API</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Qi4j Core Functional API is a generic package to work with Iterables in a "functional programming language" style.</p><p>This package is completely independent of everything else in Qi4j and may be used on its own in any kind of environment
such as Spring or Java EE applications.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_first_example"></a>First Example</h4></div></div></div><p>Let’s say that you have an Iterable of Integers and you want to sum them all up. Most people would create a loop and
sum it all up in something like this;</p><pre class="programlisting brush: java">Iterable&lt;Integer&gt; data = ...;

long sum = 0;
for( Long point : data ) {
    sum = sum + point;
}
System.out.println( "The sum is " + sum );</pre><p>With the Qi4j Core Functional API, you go about it in a different way. The code ends up looking like this;</p><pre class="programlisting brush: java">Iterable&lt;Number&gt; data = ...;
Long sum = forEach( data ).map( longSum() ).last();
System.out.println( "The sum is " + sum );</pre><p>And this is just the tip of the iceberg.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_big_picture"></a>The Big Picture</h4></div></div></div><p>The Qi4j Core Functional API are divided a handful of powerful concepts, especially when used together;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="strong"><strong>Iterables</strong></span> - many methods to deal with Iterable data, so that the loops in your programs can largely be removed.
</li><li class="listitem">
<span class="strong"><strong>Functions</strong></span> - f(x) and f(x,y) are well-know from mathematics and used in functional programming languages. Qi4j is
     not capable of introducing lambda calculus due to limitations in Java itself, but we can simulate a lot to allow
     people to create more readable code.
</li><li class="listitem">
<span class="strong"><strong>Specification</strong></span> - A simple concept to define the bounds of data. This is used for filtering, query and many other
     higher level abstractions.
</li><li class="listitem">
<span class="strong"><strong>Visitor</strong></span> pattern - A way to be handed the items in a collection, without having the loops. This could be for
     end result handling, distribution of intermediary values, and many other things.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_specification"></a>Specification</h4></div></div></div><p>TODO</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_function"></a>Function</h4></div></div></div><p>TODO</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_visitor_pattern"></a>Visitor Pattern</h4></div></div></div><p>TODO</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_iterables"></a>Iterables</h4></div></div></div><p>TODO</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-io"></a>6.6. Core I/O API</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Qi4j Core I/O API is completely generic and not tied to the Qi4j programming model as a whole. It can be used
independently of Qi4j, together with the Qi4j Core Functional API, which the Core I/O API depends on.</p><p>The Qi4j Core I/O API tries to address the problem around shuffling data around from various I/O inputs and outputs,
possibly with transformations and filtering along the way. It was identified that there is a general mix-up of concerns
in the stereotypical I/O handling codebases that people deal with all the time. The reasoning around this, can be found
in the <a class="xref" href="#howto-use-io" title="3.22.&#xA0;Use I/O API">Use I/O API</a>, and is recommended reading.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_problem"></a>The Problem</h4></div></div></div><p>Why does I/O operations in Java have to be so complicated, with nested try/catch/finally and loops? Don’t you wish
that the operations could be expressed in a more natural way, such as;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
source.copyTo( destination );</pre><p>It seems natural to do, yet it is not present for us. We need to involve FileInputStream/FileOutputStream, wrap them
in Buffered versions of it, do out own looping, close the streams afterwards and what not. So, the java.io.File does
not have this simple feature and in the Qi4j Core API, we need to work around this limitation. We also want to
make the abstraction a little bit more encompassing than "just" files. So how does that look like then?</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_first_examples"></a>First Examples</h4></div></div></div><p>The most common inputs and outputs are collected in the org.qi4j.io.Inputs and org.qi4j.io.Outputs classes as static
factory methods, but you can create your (more about that later).</p><p>So, we want to read a text file and write the content into another text file, right? This is how it is done;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Inputs.text( source ).transferTo( Outputs.text(destination) );</pre><p>Pretty much self-explanatory, wouldn’t you say? But what happened to the handling of exceptions and closing of
resources? It is all handled inside the Qi4j Core I/O API. There is nothing you can forget to do.</p><p>Another simple example, where we want to count the number of lines in the text;</p><pre class="programlisting brush: java">File source = ...
File destination = ...
Counter&lt;String&gt; counter = new Counter&lt;String&gt;();
Inputs.text( source ).transferTo( Transforms.map(counter, Outputs.text(destination) ));
System.out.println( "Lines: " + counter.getCount() );</pre><p>The Counter is a <a class="xref" href="#core-functional" title="6.5.&#xA0;Core Functional API">Function</a> which gets injected into the transfer.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_the_3_parts"></a>The 3 Parts</h4></div></div></div><p>Ok, so we have seen that the end result can become pretty compelling. How does it work?</p><p>I/O is defined as a process of moving data from an Input, via one or more Transforms to an Output. The Input could
be a File or a String, the transformation could be a filter, conversion or a function and finally the Output
destination could be a File, String or an OutputStream. It is important to note that there is a strong separation of
concern between them. Let’s look at the on at a time.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_org_qi4j_io_input"></a>org.qi4j.io.Input</h4></div></div></div><p>This interface simply has a transferTo() method, which takes an Output. The formal definition is;</p><pre class="programlisting brush: java">public interface Input&lt;T, SenderThrowableType extends Throwable&gt;
{
    &lt;ReceiverThrowableType extends Throwable&gt; void transferTo( Output&lt;? super T, ReceiverThrowableType&gt; output )
        throws SenderThrowableType, ReceiverThrowableType;
}
</pre><p>What on earth is all this genericized Exceptions? Well, it abstracts away the explicit Exception that implementations
may throw (or not). So instead of demanding that all I/O must throw the java.io.IOException, as is the case in the
JDK classes, it is up to the implementation to declare what it may throw. That is found in the SenderThrowable generic
of the interface.</p><p>But hold on a second. Why is an Input throwing a "sender" exception? Well, think again. The Input is feeding "something"
with data. It takes it from some source and "sends it" to the downstream chain, eventually reaching an Output, which
likewise is the ultimate "receiver".</p><p>So, then, the method transferTo() contains the declaration of the downstream receiver’s possible Exception
(ReceiverThrowable) which the transferTo() method may also throw as the data may not be accepted and such exception
will bubble up to the transferTo() method (the client’s view of the transfer).</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_org_qi4j_io_output"></a>org.qi4j.io.Output</h4></div></div></div><p>The output interface is likewise fairly simple;</p><pre class="programlisting brush: java">public interface Output&lt;T, ReceiverThrowableType extends Throwable&gt;
{
[...snip...]

    &lt;SenderThrowableType extends Throwable&gt; void receiveFrom( Sender&lt;? extends T, SenderThrowableType&gt; sender )
        throws ReceiverThrowableType, SenderThrowableType;
}
</pre><p>It can simply receive data from a org.qi4j.io.Sender.</p><p>Hey, hold on! Why is it not receiving from an Input? Because the Input is the client’s entry point and of no use to
the Output as such. Instead, the Output will tell the Sender (which is handed to from the Input or an transformation)
to which Receiver the content should be sent to.</p><p>Complicated? Perhaps not trivial to get your head around it at first, but the chain is;</p><p>Input passes a Sender to the Output which tells the Sender which Receiver the data should be sent to.</p><p>The reason for this is that we need to separate the concerns properly. Input is a starting point, but it emits something
which is represented by the Sender. Likewise the destination is an Output, but it receives the data via its Receiver
interface. For O/S resources, they are handled purely inside the Input and Output implementations, where are the
Sender/Receiver are effectively dealing with the data itself.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_org_qi4j_io_transforms"></a>org.qi4j.io.Transforms</h4></div></div></div><p>The 3 component in the Qi4j Core I/O API is the transformations that are possible. Interestingly enough, with the
above separation of concerns, we don’t need an InputOutput type that can both receive and send data. Instead, we
simply need to prepare easy to use static factory methods, which are found in the org.qi4j.io.Transforms class. Again,
it is fairly straight forward to create your own Transforms if you need something not provided here.</p><p>The current transformations available are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
filter - takes a Specification and only forwards data items conforming to the Specification.
</li><li class="listitem">
map - takes a org.qi4j.functional.Function to convert an item from one type to (potentially) another, and any
     possible change along the way.
</li><li class="listitem">
filteredMap - is a combination of a filter and a map. If the Specification is satisfied, the map function is
     applied, otherwise the item is passed through unaffected.
</li><li class="listitem">
lock - A wrapper which protects the Input or Output from simultaneous access. Not a transformation by itself,
     but implemented in the same fashion.
</li></ul></div><p>There are also a couple of handy map functions available, such as</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Log
</li><li class="listitem">
ProgressLog
</li><li class="listitem">
Counter
</li><li class="listitem">
ByteBuffer2String
</li><li class="listitem">
Object2String
</li><li class="listitem">
String2Bytes
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_writing_a_map_function"></a>Writing a Map Function?</h4></div></div></div><p>Let us take a closer look at the implementation of a map function, namely Counter mentioned above and also used in
the section First Example above.</p><p>The implementation is very straight forward.</p><pre class="programlisting brush: java">public static class Counter&lt;T&gt;
    implements Function&lt;T, T&gt;
{
    private volatile long count = 0;

    public long getCount()
    {
        return count;
    }

    @Override
    public T map( T t )
    {
        count++;
        return t;
    }
}
</pre><p>On each call to the map() method, increment the counter field. The client can then retrieve that value after the
transfer is complete, or in a separate thread to show progress.</p><p>Speaking of "progress", so how is the ProgressLog implemented? Glad you asked;</p><pre class="programlisting brush: java">public static class ProgressLog&lt;T&gt;
    implements Function&lt;T, T&gt;
{
    private Counter&lt;T&gt; counter;
    private Log&lt;String&gt; log;
    private final long interval;

    public ProgressLog( Logger logger, String format, long interval )
    {
        this.interval = interval;
        if( logger != null &amp;&amp; format != null )
        {
            log = new Log&lt;String&gt;( logger, format );
        }
        counter = new Counter&lt;T&gt;();
    }

    public ProgressLog( long interval )
    {
        this.interval = interval;
        counter = new Counter&lt;T&gt;();
    }

    @Override
    public T map( T t )
    {
        counter.map( t );
        if( counter.count % interval == 0 )
        {
            logProgress();
        }
        return t;
    }

    // Override this to do something other than logging the progress
    protected void logProgress()
    {
        if( log != null )
        {
            log.map( counter.count + "" );
        }
    }
}
</pre><p>It combines the Counter and the Log implementations, so that the count is forwarded to the Log at a given interval, such
as every 1000 items. This may not be what you think a ProgressLog should look like, but it serves as a good example on
how you can combine the general principles found in the Qi4j Core API package.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_how_to_write_a_filter_specification"></a>How to write a filter specification?</h4></div></div></div><p>The filter transform takes a specification implementation which has a very simple method, isSatisfiedBy() (read more
about that in <a class="xref" href="#core-functional" title="6.5.&#xA0;Core Functional API">Function</a>.</p><pre class="programlisting brush: java">public interface Specification&lt;T&gt;
{
[...snip...]

    boolean satisfiedBy( T item );
}
</pre><p>The only thing that the implementation need to do is return <span class="strong"><strong>true</strong></span> or <span class="strong"><strong>false</strong></span> for whether the item passed in is within
the limits of the Specification. Let’s say that you have a IntegerRangeSpecification, which could then be implemented
as</p><pre class="programlisting brush: java">public static class IntegerRangeSpecification
    implements Specification&lt;Integer&gt;
{

    private int lower;
    private int higher;

    public IntegerRangeSpecification( int lower, int higher )
    {
        this.lower = lower;
        this.higher = higher;
    }

    @Override
    public boolean satisfiedBy( Integer item )
    {
        return item &gt;= lower &amp;&amp; item &lt;= higher;
    }
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_ready_to_use_components"></a>Ready-to-use components</h4></div></div></div><p>Input and Output implementations at first glance look quite scary. Taking a closer look and it can be followed. But to
simplify for users, the org.qi4j.io.Inputs and org.qi4h.io.Outputs contains static factory methods for many useful
sources and destinations.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_org_qi4j_io_inputs"></a>org.qi4j.io.Inputs</h4></div></div></div><p>The current set of ready-to-use Input implementations are;</p><pre class="programlisting brush: java">
/**
 * Read lines from a UTF-8 encoded textfile.
 *
 * If the filename ends with .gz, then the data is automatically unzipped when read.
 *
 * @param source textfile with lines separated by \n character
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final File source )
[...snip...]


/**
 * Read lines from a textfile with the given encoding.
 *
 * If the filename ends with .gz, then the data is automatically unzipped when read.
 *
 * @param source   textfile with lines separated by \n character
 * @param encoding encoding of file, e.g. "UTF-8"
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final File source, final String encoding )
[...snip...]


/**
 * Read lines from a textfile at a given URL.
 *
 * If the content support gzip encoding, then the data is automatically unzipped when read.
 *
 * The charset in the content-type of the URL will be used for parsing. Default is UTF-8.
 *
 * @param source textfile with lines separated by \n character
 *
 * @return Input that provides lines from the textfiles as strings
 */
public static Input&lt;String, IOException&gt; text( final URL source )
[...snip...]


/**
 * Read a file using ByteBuffer of a given size. Useful for transferring raw data.
 *
 * @param source
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; byteBuffer( final File source, final int bufferSize )
[...snip...]


/**
 * Read an inputstream using ByteBuffer of a given size.
 *
 * @param source
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; byteBuffer( final InputStream source, final int bufferSize )
[...snip...]


/**
 * Combine many Input into one single Input. When a transfer is initiated from it all items from all inputs will be transferred
 * to the given Output.
 *
 * @param inputs
 * @param &lt;T&gt;
 * @param &lt;SenderThrowableType&gt;
 *
 * @return
 */
public static &lt;T, SenderThrowableType extends Throwable&gt; Input&lt;T, SenderThrowableType&gt; combine( final Iterable&lt;Input&lt;T, SenderThrowableType&gt;&gt; inputs )
[...snip...]


/**
 * Create an Input that takes its items from the given Iterable.
 *
 * @param iterable
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Input&lt;T, RuntimeException&gt; iterable( final Iterable&lt;T&gt; iterable )
[...snip...]


/**
 * Create an Input that allows a Visitor to write to an OutputStream. The stream is a BufferedOutputStream, so when enough
 * data has been gathered it will send this in chunks of the given size to the Output it is transferred to. The Visitor does not have to call
 * close() on the OutputStream, but should ensure that any wrapper streams or writers are flushed so that all data is sent.
 *
 * @param outputVisitor
 * @param bufferSize
 *
 * @return
 */
public static Input&lt;ByteBuffer, IOException&gt; output( final Visitor&lt;OutputStream, IOException&gt; outputVisitor,
                                                     final int bufferSize
)
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_org_qi4j_io_outputs"></a>org.qi4j.io.Outputs</h4></div></div></div><p>The current set of ready-to-use Input implementations are;</p><pre class="programlisting brush: java">
/**
 * Write lines to a text file with UTF-8 encoding. Separate each line with a newline ("\n" character). If the writing or sending fails,
 * the file is deleted.
 * &lt;p/&gt;
 * If the filename ends with .gz, then the data is automatically GZipped.
 *
 * @param file the file to save the text to
 *
 * @return an Output for storing text in a file
 */
public static Output&lt;String, IOException&gt; text( final File file )
[...snip...]


/**
 * Write lines to a text file. Separate each line with a newline ("\n" character). If the writing or sending fails,
 * the file is deleted.
 * &lt;p/&gt;
 * If the filename ends with .gz, then the data is automatically GZipped.
 *
 * @param file the file to save the text to
 *
 * @return an Output for storing text in a file
 */
public static Output&lt;String, IOException&gt; text( final File file, final String encoding )
[...snip...]


/**
 * Write lines to a Writer. Separate each line with a newline ("\n" character).
 *
 * @param writer the Writer to write the text to
 * @return an Output for storing text in a Writer
 */
public static Output&lt;String, IOException&gt; text( final Writer writer )
[...snip...]


/**
 * Write lines to a StringBuilder. Separate each line with a newline ("\n" character).
 *
 * @param builder the StringBuilder to append the text to
 * @return an Output for storing text in a StringBuilder
 */
public static Output&lt;String, IOException&gt; text( final StringBuilder builder )
[...snip...]


/**
 * Write ByteBuffer data to a file. If the writing or sending of data fails the file will be deleted.
 *
 * @param file
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;ByteBuffer, IOException&gt; byteBuffer( final File file )
[...snip...]


/**
 * Write ByteBuffer data to an OutputStream.
 *
 * @param stream
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;ByteBuffer, IOException&gt; byteBuffer( final OutputStream stream )
[...snip...]


/**
 * Write byte array data to a file. If the writing or sending of data fails the file will be deleted.
 *
 * @param file
 * @param bufferSize
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;byte[], IOException&gt; bytes( final File file, final int bufferSize )
[...snip...]


/**
 * Do nothing. Use this if you have all logic in filters and/or specifications
 *
 * @param &lt;T&gt;
 *
 * @return
 */
public static &lt;T&gt; Output&lt;T, RuntimeException&gt; noop()
[...snip...]


/**
 * Use given receiver as Output. Use this if there is no need to create a "transaction" for each transfer, and no need
 * to do batch writes or similar.
 *
 * @param &lt;T&gt;
 * @param receiver receiver for this Output
 *
 * @return
 */
public static &lt;T, ReceiverThrowableType extends Throwable&gt; Output&lt;T, ReceiverThrowableType&gt; withReceiver( final Receiver&lt;T, ReceiverThrowableType&gt; receiver )
[...snip...]


/**
 * Write objects to System.out.println.
 *
 * @return
 */
public static Output&lt;Object, RuntimeException&gt; systemOut()
[...snip...]


/**
 * Write objects to System.err.println.
 */
public static Output&lt;Object, RuntimeException&gt; systemErr()
[...snip...]


/**
 * Add items to a collection
 */
public static &lt;T&gt; Output&lt;T, RuntimeException&gt; collection( final Collection&lt;T&gt; collection )
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="core-spi"></a>6.7. Core Extension SPI</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>The Qi4j Core Runtime has a number of extension points, which we call the <span class="emphasis"><em>Qi4j Core Extension SPI</em></span>. These are defined
interfaces used <span class="strong"><strong>only</strong></span> by the Core Runtime and <span class="strong"><strong>never</strong></span> directly by application code. <a class="xref" href="#extensions" title="8.&#xA0;Extensions">Extensions</a> are assembled in
applications during the bootstrap phase.</p><p>There are currently 4 Core SPI extensions;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
EntityStore SPI
</li><li class="listitem">
Cache SPI
</li><li class="listitem">
Indexing/Query SPI
</li><li class="listitem">
Metrics SPI
</li></ul></div><p>Qi4j Runtime Extensions implementations may depend on Qi4j Libraries, but Libraries are NOT ALLOWED to depend on
Extensions. Applications code is NOT ALLOWED to depend on extensions. And application code SHOULD NOT depend on the
Core Extension SPI. If you think that is needed, please contact qi4j-dev forum at Google Groups, to see if your usecase
can be solved in a support manner, or that we need to extend the Core API to support it.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="core-spi-metrics"></a>Qi4j Metrics SPI</h4></div></div></div><p>It is very easy to create an extension for the Metrics SPI, simply by implementing the MetricsProvider. If only a
subset of the factories/types are supported, there is a convenience adapter call MetricsProviderAdapter in the Metrics
SPI package.</p></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="libraries"></a>7. Libraries</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview_4">7.1. Overview</a></span></dt><dt><span class="section"><a href="#library-alarm">7.2. Alarms</a></span></dt><dt><span class="section"><a href="#library-caching">7.3. Caching</a></span></dt><dt><span class="section"><a href="#library-circuitbreaker">7.4. Circuit Breaker</a></span></dt><dt><span class="section"><a href="#library-constraints">7.5. Constraints</a></span></dt><dt><span class="section"><a href="#library-conversion">7.6. Conversion</a></span></dt><dt><span class="section"><a href="#library-cxf">7.7. CXF WebService</a></span></dt><dt><span class="section"><a href="#library-eventsourcing">7.8. Event Sourcing</a></span></dt><dt><span class="section"><a href="#library-eventsourcing-jdbm">7.9. Event Sourcing - JDBM</a></span></dt><dt><span class="section"><a href="#library-eventsourcing-rest">7.10. Event Sourcing - ReST</a></span></dt><dt><span class="section"><a href="#library-fileconfig">7.11. FileConfig</a></span></dt><dt><span class="section"><a href="#library-http">7.12. HTTP</a></span></dt><dt><span class="section"><a href="#library-jmx">7.13. JMX</a></span></dt><dt><span class="section"><a href="#library-locking">7.14. Locking</a></span></dt><dt><span class="section"><a href="#library-logging">7.15. Logging</a></span></dt><dt><span class="section"><a href="#library-neo4j">7.16. Neo4j</a></span></dt><dt><span class="section"><a href="#library-osgi">7.17. OSGi</a></span></dt><dt><span class="section"><a href="#library-rdf">7.18. RDF</a></span></dt><dt><span class="section"><a href="#library-rest-client">7.19. ReST Client</a></span></dt><dt><span class="section"><a href="#library-rest-client-primer">7.20. ReST - HATEOAS Primer</a></span></dt><dt><span class="section"><a href="#library-rest-common">7.21. ReST Common</a></span></dt><dt><span class="section"><a href="#library-rest-server">7.22. ReST Server</a></span></dt><dt><span class="section"><a href="#library-scheduler">7.23. Scheduler</a></span></dt><dt><span class="section"><a href="#library-script-beanshell">7.24. Beanshell Scripting</a></span></dt><dt><span class="section"><a href="#library-script-groovy">7.25. Groovy Scripting</a></span></dt><dt><span class="section"><a href="#library-script-javascript">7.26. Javascript Scripting</a></span></dt><dt><span class="section"><a href="#library-script-jruby">7.27. JRuby Scripting</a></span></dt><dt><span class="section"><a href="#lang-scala">7.28. Scala Support</a></span></dt><dt><span class="section"><a href="#library-servlet">7.29. Servlet</a></span></dt><dt><span class="section"><a href="#library-shiro">7.30. Shiro Security</a></span></dt><dt><span class="section"><a href="#library-shiro-web">7.31. Shiro Web Security</a></span></dt><dt><span class="section"><a href="#library-spring">7.32. Spring Integration</a></span></dt><dt><span class="section"><a href="#library-sql">7.33. SQL</a></span></dt><dt><span class="section"><a href="#library-struts-codebehind">7.34. Struts - Code Behind</a></span></dt><dt><span class="section"><a href="#library-struts-convention">7.35. Struts - Convention</a></span></dt><dt><span class="section"><a href="#library-struts-plugin">7.36. Struts - Plugin</a></span></dt><dt><span class="section"><a href="#library-uid">7.37. UID</a></span></dt><dt><span class="section"><a href="#library-uowfile">7.38. UoWFile</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview_4"></a>7.1. Overview</h3></div></div></div><p>The Qi4j Libraries are of varying maturity level and we try to maintain a STATUS (dev-status.xml) file indicating
how good the codebase, documentation and unit tests are for each of the libraries. This is highly subjective and
potentially different individuals will judge this differently, but at least it gives a ballpark idea of the situation
for our users.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-alarm"></a>7.2. Alarms</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-some">tests</p><p>The process control and industrial automation industry has for decades been struggling with a large number of unreliable
data points, such as sensors, fuses and potentially malfunctioning valves and actuators. This industry quickly developed
the concept of <span class="strong"><strong>Alarm Point</strong></span> as an abstraction for indication that something is not working correctly. These
<span class="emphasis"><em>Alarm Points</em></span> could then be grouped and aggregated, along a well-defined set of rules, to provide human operators a
clear view of what is going on in a plant.</p><p>The enterprise software has always assumed a much more "reliable" environment where the computers either work or they
don’t. Very little thought has been spent on what happens when many independent systems interact and what the
consequences are to other systems when one fails. The <span class="emphasis"><em>Alarm Point</em></span> concepts becomes a natural fit for the enterprise
world of today, where <span class="emphasis"><em>Alarm Points</em></span> allows for fine-grained notification and view into the health of one or more
systems.</p><p>In Qi4j, we are building upon this powerful abstraction, from decades of field experience.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_overview_5"></a>Overview</h4></div></div></div><p>An <span class="emphasis"><em>Alarm Point</em></span> is of an <span class="emphasis"><em>Alarm Class</em></span> and of an <span class="emphasis"><em>Alarm Category</em></span>. The <span class="emphasis"><em>Alarm Class</em></span> defines the <span class="strong"><strong>severity</strong></span> of the
<span class="emphasis"><em>Alarm Point</em></span> and the <span class="emphasis"><em>Alarm Category</em></span> defines which <span class="strong"><strong>part</strong></span> of the system it belongs to. <span class="emphasis"><em>Alarm Category</em></span> can be
extended by the developer, and the package contains the <span class="emphasis"><em>SimpleAlarmCategory</em></span> as an example, where a Description
property has been added.</p><p>An <span class="emphasis"><em>Alarm Point</em></span> also has a <span class="emphasis"><em>System Name</em></span>, which should be the subsystem or application name.</p><p><span class="emphasis"><em>Alarm Points</em></span> are <span class="strong"><strong>triggered</strong></span> and an <span class="emphasis"><em>Alarm Trigger</em></span> may cause the <span class="emphasis"><em>Alarm Status</em></span> to change. IF, and only if, the
<span class="emphasis"><em>Alarm Status</em></span> changes, and <span class="emphasis"><em>Alarm Event</em></span> is generated. The <span class="emphasis"><em>Alarm Model</em></span> used for an <span class="emphasis"><em>Alarm Point</em></span> defines which
<span class="emphasis"><em>Alarm Status</em></span>, <span class="emphasis"><em>Alarm Trigger</em></span> and <span class="emphasis"><em>Alarm Event</em></span> that are possible.</p><p><span class="emphasis"><em>Alarm Points</em></span> may also have user-defined properties. These are primarily used for reporting and auditing.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_point"></a>Alarm Point</h4></div></div></div><p>The <span class="emphasis"><em>Alarm Point</em></span> is the central API for applications. <span class="emphasis"><em>Alarm Points</em></span> are entities and normally dormant on in the
Entity Store. The <span class="emphasis"><em>Alarm Point</em></span> is a small workflow state-machine, and the <span class="emphasis"><em>Alarm Model</em></span> associated with the <span class="emphasis"><em>Alarm
Point</em></span> defines the workflow.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_event"></a>Alarm Event</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_class"></a>Alarm Class</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_category"></a>Alarm Category</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_proxy"></a>Alarm Proxy</h4></div></div></div><p>Sometimes it is much more convenient to hold on to Alarm Points all the time, instead of reviving them from the Entity
Store every time they are to be modified. Therefor, there is a convenience class available who does all the grunt work,
called the <span class="emphasis"><em>Alarm Proxy</em></span>. By creating an <span class="emphasis"><em>Alarm Proxy</em></span>, all the UnitOfWork handling is done for you. You still need to
provide an <span class="emphasis"><em>Identity</em></span> of the Alarm, which must survive restarts. The code could look something like this;</p><pre class="programlisting brush: java">@Service
private AlarmProxy.Factory factory;

private AlarmProxy myAlarmPoint;
[...snip...]

@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    new AlarmSystemAssembler().assemble( module );
    [...snip...]

        myAlarmPoint = factory.create( "This Alarm Identity", "ProActiveCRM", "Sales", AlarmClass.B );
        myAlarmPoint.history().maxSize().set( 20 );
        [...snip...]

        myAlarmPoint.activate();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_alarm_models"></a>Alarm Models</h4></div></div></div><p>The Qi4j Alarm library comes with 3 <span class="emphasis"><em>Alarm Models</em></span> which should be sufficient for most uses. These are based on decades
of experience from the industrial automation industry and user feedback.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_simple_alarm_model"></a>Simple Alarm Model</h4></div></div></div><p>The <span class="emphasis"><em>Simple Alarm Model</em></span> is the most basic one, with only two <span class="emphasis"><em>Alarm Status</em></span>, <span class="strong"><strong><span class="emphasis"><em>Normal</em></span></strong></span> and <span class="strong"><strong><span class="emphasis"><em>Activated</em></span></strong></span>. The only
<span class="emphasis"><em>Alarm Triggers</em></span> are <span class="emphasis"><em>activate</em></span> and <span class="emphasis"><em>deactivate</em></span>, where <span class="emphasis"><em>activate</em></span> on a <span class="emphasis"><em>Normal</em></span> status will bring it to <span class="emphasis"><em>Activated</em></span>
status and an <span class="emphasis"><em>Activated Alarm Event</em></span> is generated.</p><div class="informaltable"><table cellspacing="0" cellpadding="0" border="1" width="80%"><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /></colgroup><thead><tr><th align="left" valign="top"> <span class="strong"><strong>Old Status</strong></span> </th><th align="left" valign="top"> <span class="strong"><strong>Trigger</strong></span> </th><th align="left" valign="top"> <span class="strong"><strong>Event</strong></span> </th><th align="left" valign="top"> <span class="strong"><strong>New Status</strong></span> </th><th align="left" valign="top"> </th></tr></thead><tbody></tbody></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_standard_alarm_model"></a>Standard Alarm Model</h4></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_extended_alarm_model"></a>Extended Alarm Model</h4></div></div></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-caching"></a>7.3. Caching</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-none">tests</p><p>Caching Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-circuitbreaker"></a>7.4. Circuit Breaker</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Circuit Breaker library provides a way to guard your application
against faulty external systems (e.g. mail servers  being down, web
services being down). It is used by many Qi4j Extensions and Libraries.</p><p>There’s a couple of differences between this implementation and others
seen on the net, but we’ve also heavily borrowed from others. The
first difference is that we’ve not focused on performance at all. For
some reason other implementations make a point about doing "atomic
changes" with various tricks, to ensure good performance. Since this is
used to guard access to external systems, where latencies range in
milliseconds and up, that seems completely useless, so we’ve just put
"synchronized" on all methods, which should be safe. "It works" is
better than "it’s fast" for these types of things.</p><p>Second, other implementations have had really crude logic for what types
of exceptions cause the circuit to break. The most crude is "all", more
advanced ones allow exceptions that be excepted to be registered, but in
real cases this is not enough. Case in point is JDBC exceptions where
you want to fail on "connect exception" but not necessarily "invalid SQL
syntax". So instead we’ve leveraged <code class="literal">Specification</code> from <a class="link" href="#core-functional" title="6.5.&#xA0;Core Functional API">Core Functional API</a> where
you get to provide your own specification that can use any logic to
determine whether a particular exception is ok or not.</p><p>Third, there’s a big focus on manageability through JMX. A
circuitbreaker can be easily exposed in JMX as an MBean, where you can
track service levels and see exception messages, and trip/enable circuit
breakers.</p><p>Fourth, if an external system is unavailable due to a circuitbreaker
tripping it should be possible to expose this to other Qi4j services.
There is a standard implementation of the Availability interface that
delegates to a circuit breaker and the Enabled configuration flag, which
is what we’d suspect will be used in most cases where external systems
are invoked.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_direct_usage"></a>Direct usage</h4></div></div></div><p>The CircuitBreaker can be used directly, even without using anything else from the Qi4j SDK.</p><p>Here is a code snippet that demonstrate how to create a CircuitBreaker and how it behave:</p><pre class="programlisting brush: java">// Create a CircuitBreaker with a threshold of 3, a 250ms timeout, allowing IllegalArgumentExceptions
CircuitBreaker cb = new CircuitBreaker( 3, 250, CircuitBreakers.in( IllegalArgumentException.class ) );

[...snip...]

// Service levels goes down but does not cause a trip
cb.throwable( new IOException() );

[...snip...]

// Service level goes down and causes a trip
cb.throwable( new IOException() );
cb.throwable( new IOException() );

[...snip...]

// Turn on the CB again
cb.turnOn();

[...snip...]

// Service levels goes down and causes a trip
cb.throwable( new IOException() );
cb.throwable( new IOException() );
cb.throwable( new IOException() );

[...snip...]

// Wait until timeout

[...snip...]

// CircuitBreaker is back on

</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_service_circuit_breaker"></a>Service Circuit Breaker</h4></div></div></div><p>As a facility you can make your Services extends <code class="literal">AbstractBreakOnThrowable</code>, set them a <code class="literal">CircuitBreaker</code> as
<code class="literal">MetaInfo</code> during assembly and annotate methods with <code class="literal">@BreaksCircuitOnThrowable</code>. Doing this will :</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
add a circuit breaker accessor to the Service (<code class="literal">CircuitBreaker getCircuitBreaker()</code>) ;
</li><li class="listitem">
allow exposition of the circuit breaker in JMX ;
</li><li class="listitem">
update the circuit breaker on annotated methods invocation success and thrown exceptions using the <code class="literal">BreakCircuitConcern</code>.
</li></ul></div><p>Here is how to declare such a Service:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.services( TestService.class ).setMetaInfo( new CircuitBreaker() );
}
[...snip...]

public interface TestService
        extends AbstractBreakOnThrowable, ServiceComposite
{

    @BreaksCircuitOnThrowable
    int successfulMethod();

    @BreaksCircuitOnThrowable
    void throwingMethod();

    [...snip...]

}
</pre><p>Remember to annotate methods which when they throw throwables should cause circuit breakers to trip and go back on
invocation success with the <code class="literal">@BreaksCircuitOnThrowable</code> annotation.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_exposing_service_circuit_breakers_in_jmx"></a>Exposing Service Circuit Breakers in JMX</h5></div></div></div><p>To expose their circuit breaker in JMX, your Services using one must implement the <code class="literal">ServiceCircuitBreaker</code> interface.
Note that if you already extends <code class="literal">AbstractBreakOnThrowable</code> you don’t need to do anything else as it already extends
<code class="literal">ServiceCircuitBreaker</code>.</p><p>Here is how it goes:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    module.importedServices( MBeanServer.class ).importedBy( MBeanServerImporter.class ); // JMX Library
    module.services( CircuitBreakerManagement.class ).instantiateOnStartup(); // CircuitBreakers in JMX
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_interactive_sample"></a>Interactive sample</h4></div></div></div><p>A gradle task runSample is defined in this library as a shortcut to run a
simple interactive example. You’ll need a MBean client to connect to the
sample, VisualVM with its MBean plugin does the job. See <a class="xref" href="#build-system" title="11.9.&#xA0;Build System">Build System</a>
if you need some guidance.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-constraints"></a>7.5. Constraints</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Constraints library provide a bunch of often used Constraints based on the
Qi4j Constraints api described in <a class="xref" href="#def-constraint">Constraint</a>.</p><p>Remember that you are not limited to constraints presents in this library, you
are encouraged to write your own constraints. See <a class="xref" href="#howto-create-constraint" title="3.17.&#xA0;Create a Constraint">Create a Constraint</a>
or take a look at this library source code to learn how to write your own.</p><p>You can use theses constraints on Properties or on method arguments.
Here are some examples:</p><pre class="programlisting brush: java">@Contains( "foo" ) Property&lt;String&gt; containsString();

@Email Property&lt;String&gt; email();

@URL Property&lt;String&gt; url();

@URI Property&lt;String&gt; uri();

@GreaterThan( 10 ) Property&lt;Integer&gt; greaterThan();

@InstanceOf( List.class ) Property&lt;Collection&gt; instanceOf();

@LessThan( 10 ) Property&lt;Integer&gt; lessThan();

@Matches( "a*b*c*" ) Property&lt;String&gt; matches();

@MaxLength( 3 ) Property&lt;String&gt; maxLength();

@MinLength( 3 ) Property&lt;String&gt; minLength();

@NotEmpty Property&lt;String&gt; notEmptyString();

@NotEmpty Property&lt;Collection&gt; notEmptyCollection();

@NotEmpty Property&lt;List&gt; notEmptyList();

@Range( min = 0, max = 100 ) Property&lt;Integer&gt; range();

@OneOf( { "Bar", "Xyzzy" } ) Property&lt;String&gt; oneOf();

void testParameters(@GreaterThan(10) Integer greaterThan);
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-conversion"></a>7.6. Conversion</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-some">tests</p><p>The Conversion Library provides support for converting composite types.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_entities_to_values"></a>Entities to Values</h4></div></div></div><p>To convert Entities to Values, use the EntityToValueService. It is easily assembled:</p><pre class="programlisting brush: java">module.services( EntityToValueService.class );
</pre><p>Let’s say we have an interface defining state:</p><pre class="programlisting brush: java">public interface PersonState
{

    Property&lt;String&gt; firstName();

    Property&lt;String&gt; lastName();

    Property&lt;Date&gt; dateOfBirth();

}
</pre><p>An EntityComposite using the state as a Private Mixin:</p><pre class="programlisting brush: java">@Mixins( PersonMixin.class )
public interface PersonEntity
    extends EntityComposite
{

    String firstName();

    String lastName();

    Integer age();

    @Optional
    Association&lt;PersonEntity&gt; spouse();

    ManyAssociation&lt;PersonEntity&gt; children();

}
[...snip...]

public static abstract class PersonMixin
    implements PersonEntity
{

    @This
    private PersonState state;
    [...snip...]

}
</pre><p>And a ValueComposite extending this very same state;</p><pre class="programlisting brush: java">public interface PersonValue
    extends PersonState, ValueComposite
{

    @Optional
    Property&lt;String&gt; spouse();

    @Optional
    Property&lt;List&lt;String&gt;&gt; children();

}
</pre><p>Here is how to convert an EntityComposite to a ValueComposite:</p><pre class="programlisting brush: java">EntityToValueService conversion = module.findService( EntityToValueService.class ).get();
PersonValue value = conversion.convert( PersonValue.class, entity );
</pre><p>Associations are converted to Identity strings.</p><p>If your Entities and Values cannot use the same state type, you can annotate the Value that is the target of the
conversion with the <code class="literal">@Unqualified</code> annotation. Then, the lookup of the Value Property will be performed using the
<span class="strong"><strong>unqualified</strong></span> name only, and not via the default of the full qualified name. In other words, this means that the
Property may be declared in the different interfaces and still be matched.</p><p>Here is an example:</p><pre class="programlisting brush: java">@Unqualified
public interface PersonValue2
    extends ValueComposite
{

    Property&lt;String&gt; firstName();

    Property&lt;String&gt; lastName();

    Property&lt;Date&gt; dateOfBirth();

    @Optional
    Property&lt;String&gt; spouse();

    @Optional
    Property&lt;List&lt;String&gt;&gt; children();

}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-cxf"></a>7.7. CXF WebService</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>CXF WebService Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-eventsourcing"></a>7.8. Event Sourcing</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Event Sourcing Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-eventsourcing-jdbm"></a>7.9. Event Sourcing - JDBM</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Event Sourcing - JDBM Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-eventsourcing-rest"></a>7.10. Event Sourcing - ReST</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Event Sourcing - ReST Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-fileconfig"></a>7.11. FileConfig</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The FileConfig library provide a service for accessing application-specific directories.</p><p>A lot of the Qi4j Libraries and Extensions make use of this library to locate files.</p><pre class="programlisting brush: java">public interface FileConfiguration
{
[...snip...]

    File configurationDirectory();

    File dataDirectory();

    File temporaryDirectory();

    File cacheDirectory();

    File logDirectory();

}
</pre><p>To use it you simply need to declare the FileConfiguration Service in your application assembly:</p><pre class="programlisting brush: java">module.services( FileConfigurationService.class );
</pre><p>These will default to the platform settings, but can be overridden manually, either one-by-one or as a whole.</p><p>You can override defaults by adding org.qi4j.library.fileconfig.FileConfiguration_OS.properties files to your
classpath where OS is one of win, mac or unix.</p><p>You can also override all properties definitions at assembly time by setting a FileConfigurationOverride object
as meta info of this service:</p><pre class="programlisting brush: java">FileConfigurationOverride override = new FileConfigurationOverride().
        withConfiguration( confDir ).
        withData( dataDir ).
        withTemporary( tempDir ).
        withCache( cacheDir ).
        withLog( logDir );
module.services( FileConfigurationService.class ).setMetaInfo( override );
</pre><p>And finally, to get the FileConfiguration Service in your application code, simply use the following:</p><pre class="programlisting brush: java">@Service FileConfiguration fileconfig;</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-http"></a>7.12. HTTP</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The HTTP library provides a Jetty based embedded HTTP service with support for easy event listeners, servlets and
filters assembly as Services.</p><p>It’s an easy way to embedd a servlet container and reuse everything that can be run in it (JAX-*, Restlet, Wicket,
Vaadin, GWT etc..). If instead you want to run a Qi4j Application in a servlet container, see <a class="xref" href="#library-servlet" title="7.29.&#xA0;Servlet">Servlet Library</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_create_an_eventlistenerservice"></a>Create an EventListenerService</h4></div></div></div><p>EventListeners in HttpService are assembled as Services, so one have to declare a ServiceComposite like this:</p><pre class="programlisting brush: java">@Mixins( FooServletContextListener.class )
public interface FooServletContextListenerService
        extends ServletContextListener, ServiceComposite
{
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_create_a_servletservice"></a>Create a ServletService</h4></div></div></div><p>Servlets in HttpService are assembled as Services, so one have to declare a ServiceComposite like this:</p><pre class="programlisting brush: java">@Mixins( HelloWorldServlet.class )
public interface HelloWorldServletService
        extends Servlet, ServiceComposite
{
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_create_a_filterservice"></a>Create a FilterService</h4></div></div></div><p>It’s the same for Filters. As an example here is the bundled UnitOfWorkFilterService declaration:</p><pre class="programlisting brush: java">@Mixins( UnitOfWorkFilter.class )
public interface UnitOfWorkFilterService extends Filter, ServiceComposite
{
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_jetty_service"></a>Jetty Service</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_2"></a>Assembly</h5></div></div></div><p>The HTTP library provide a JettyServiceAssembler and a fluent API to easily assemble Servlets and Filters.</p><pre class="programlisting brush: java">// Assemble the JettyService
new JettyServiceAssembler().assemble( module );

// Set HTTP port as JettyConfiguration default
JettyConfiguration config = module.forMixin( JettyConfiguration.class ).declareDefaults();
config.hostName().set( "127.0.0.1" );
config.port().set( HTTP_PORT );

// Serve /helloWorld with HelloWorldServletService
addServlets( serve( "/helloWorld" ).with( HelloWorldServletService.class ) ).to( module );

// Filter requests on /* through provided UnitOfWorkFilterService
addFilters( filter( "/*" ).through( UnitOfWorkFilterService.class ).on( REQUEST ) ).to( module );
</pre><p>This library can be used alonside the JMX library, described in <a class="xref" href="#library-jmx" title="7.13.&#xA0;JMX"> JMX Library</a>. If it is
visible and that you enable Jetty statistics configuration property they will be
automatically exposed through JMX.</p><p>Here is a simple example from the unit tests showing what’s necessary but inside a simple
Module for the sake of clarity:</p><pre class="programlisting brush: java">new JettyServiceAssembler().assemble( module );
new JMXAssembler().assemble( module ); // Assemble both JettyService and JMX

JettyConfiguration config = module.forMixin( JettyConfiguration.class ).declareDefaults();
config.hostName().set( "127.0.0.1" );
config.port().set( 8441 );
config.statistics().set( Boolean.TRUE ); // Set statistics default to TRUE in configuration

// Hello world servlet related assembly
addServlets( serve( "/hello" ).with( HelloWorldServletService.class ) ).to( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration"></a>Configuration</h5></div></div></div><p>Underlying Jetty engine configuration is exposed as a Qi4j Service Configuration.
The only one that is mandatory is the port.</p><p>See org.qi4j.library.http.JettyConfiguration for a reference of all available
configuration properties.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_secure_jetty_service"></a>Secure Jetty Service</h4></div></div></div><p>The HTTP library provides a second HttpService that brings SSL support.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_3"></a>Assembly</h5></div></div></div><p>Simply change from JettyServiceAssembler to SecureJettyServiceAssembler:</p><pre class="programlisting brush: java">new SecureJettyServiceAssembler().assemble( module );
[...snip...]

addServlets( serve( "/hello" ).with( HelloWorldServletService.class ) ).to( module );
addFilters( filter( "/*" ).through( UnitOfWorkFilterService.class ).on( REQUEST ) ).to( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration_2"></a>Configuration</h5></div></div></div><p>You must at least configure a KeyStore using the three related properties. All the other
ones have sensible defaults.</p><p>If you want, or need, to do client certificate authentication you’ll need to configure at
least a "trust store", a KeyStore that contains your trusted trust anchors.</p><p>Here is some code that set HTTP port a well as a KeyStore and a TrustStore as
SecureJettyConfiguration default during assembly:</p><pre class="programlisting brush: java">SecureJettyConfiguration config = module.forMixin( SecureJettyConfiguration.class ).declareDefaults();
config.hostName().set( "127.0.0.1" );
config.port().set( HTTPS_PORT );

config.keystorePath().set( SERVER_KEYSTORE_PATH );
config.keystoreType().set( "JCEKS" );
config.keystorePassword().set( KS_PASSWORD );

config.truststorePath().set( TRUSTSTORE_PATH );
config.truststoreType().set( "JCEKS" );
config.truststorePassword().set( KS_PASSWORD );

config.wantClientAuth().set( Boolean.TRUE );
</pre><p>See org.qi4j.library.http.SecureJettyConfiguration for a reference of all available
configuration properties.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging"></a>Logging</h4></div></div></div><p>The SLF4J logger used by this library is named "org.qi4j.library.http".</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-jmx"></a>7.13. JMX</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-some">tests</p><p>The JMX library provides a service that exposes a Qi4j app in
JMX automatically, giving you an opportunity to inspect the app much as
you would with the <a class="xref" href="#tools-envisage" title="9.2.&#xA0;Envisage">Envisage Tool</a> tool.</p><pre class="programlisting brush: java">
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new JMXAssembler().assemble( module );

    module.services( JMXConnectorService.class ).instantiateOnStartup();
    module.entities( JMXConnectorConfiguration.class );
    module.forMixin( JMXConnectorConfiguration.class ).declareDefaults().port().set( 1099 );
}
</pre><p>Note that you need to run it with -Dcom.sun.management.jmxremote so that the
JVM starts the MBeanServer.</p><p><span class="inlinemediaobject"><img src="images/library-jmx.png" alt="library-jmx.png" /></span></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-locking"></a>7.14. Locking</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Locking Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-logging"></a>7.15. Logging</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>First of all, Qi4j is taking a fresh look at all things that we take for granted. Logging is one such thing.</p><p>It should (but is not) obvious that Logging are used for three very distinct purposes, and in our opinion the concepts
are not related and should not be abstracted in the same fashion, as has been the norm in Log4j, JDK logging, Commons
Logging and most other similar packages and APIs.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="strong"><strong>Tracing</strong></span> - Developers often need to trace where the application has been, recording the sequence of execution to see if
the logic is correct. This is often a choice when stepping through with a debugger is not possible for whatever reason.
</li><li class="listitem">
<span class="strong"><strong>Debugging</strong></span> - Developers like to get additional information out from a running system. This could be information about
conditions, events or unexpected results that we want to record and analyse later.
</li><li class="listitem">
<span class="strong"><strong>Logging</strong></span> - The requirements of an application sometimes specifies that events or conditions should be recorded for
auditing purposes. These are often described as domain events and written to a special log file and/or printed to
log printer.
</li></ul></div><p>Although similar in nature, the audience are very different in Logging vs Debugging/Tracing and their requirements are
not only different, but if not handled properly the debug log is mixed up with the audit logs, which in turn can lead
to turning off whole or parts of the domain logging by mistake. We want to avoid this, and instead crystalize the needs
for each scenario and audience.</p><p>Another drastic difference from previous frameworks is that we don’t have an Appender notion. All messages are entities
which are stored in a configured entity store. This means that especially the domain log can be more easily be given a
user interface suitable for the domain, without complex parsing of message strings</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging_2"></a>Logging</h4></div></div></div><p>Logging is still not finalized and will need a lot more thought before considered done.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_debugging"></a>Debugging</h4></div></div></div><p>To produce debugging output in your code you just need to add the field</p><pre class="programlisting brush: java">@Optional @This Debug debug;</pre><p>and then check for null at each usage</p><pre class="programlisting brush: java">if( dev != null )
{
    dev.debug( "Debugging is made easier." );
}</pre><p>The Debug mixin can be either added to the composite declaration, or it can be added as a contextual fragment during
bootstrap.</p><p>You will also need to declare a DebugService to be visible to the composite where the debug output is coming from. And
the DebugService in turn will use the default UnitOfWork and associated entity store, which must also be configured and
visible.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_tracing"></a>Tracing</h4></div></div></div><p>Tracing is the process of tracking all the methods that has been called. There are two levels of tracing available in
Qi4j. Either Trace All or trace where a annotation has been given.</p><p>If the TraceAllConcern is added to a composite, and there is a TraceService visible, then all method calls into that
composite is traced.</p><p>If a subset of the methods want to be traced, you can annotate those methods with @Trace in either the Composite Type
interface or the mixin implementation. You will also need to add the TraceConcern to the composite.</p><pre class="programlisting brush: java">public interface ImportantRepository
{
    @Trace
    void addImportantStuff( ImportantStuff stuff );

    @Trace
    void removeImportantStuff( ImportantStuff stuff );

    ImportantStuff findImportantStuff( String searchKey );
}</pre><p>In the above sample code, the findImportantStuff() method is not traced, whereas the other two will be traced if there
is a TraceConcern declared on the composite, and a TraceService visible from that composite.</p><p>The fact that each TraceConcern (and TraceAllConcern) will use the TraceService that is visible, allows you to enable
or disable tracing per module, simply by adding or removing a TraceService with Visibility.module in each module you
want it, or expose Visibility.layer and turn on/off tracing by layers. The TraceConcern has the TraceService as
optional.</p><p>The recommended way to enable tracing is to use contexual fragments, a feature that allows you to add concerns,
sideeffects and mixins to composites during the bootstrap phase instead of hard-coded into the composite declaration.</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    module.addService( CameraService )
        .withConcerns( TraceAllConcern.class )
        .withMixins( Debug.class );
}</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-neo4j"></a>7.16. Neo4j</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-some">tests</p><p>The Neo4J Library provides a Neo4J embedded database as a Qi4j Service.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_4"></a>Assembly</h4></div></div></div><p>Simply assemble the Service:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    module.services( EmbeddedDatabaseService.class );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_usage"></a>Usage</h4></div></div></div><p>The embedded Neo4J database files are stored in the <code class="literal">data</code> directory defined using the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a>.</p><pre class="programlisting brush: java">@Service EmbeddedDatabaseService neo4jService;

public void doSomething()
{
    GraphDatabaseService db = neo4jService.database();
    [...snip...]

}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-osgi"></a>7.17. OSGi</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-some">tests</p><p>OSGi Library allows you to import OSGi services as Qi4j Services and to export Qi4j Services as OSGi Services both
leveraging the Qi4j Availability and OSGi FallbackStrategy mechanisms.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_export_qi4j_services_to_an_osgi_bundle"></a>Export Qi4j services to an OSGi Bundle</h4></div></div></div><pre class="programlisting brush: java">interface MyQi4jService
    extends OSGiEnabledService
{
    // ...
}
[...snip...]

public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    BundleContext bundleContext = // ...
    [...snip...]

    module.services( OSGiServiceExporter.class ).
        setMetaInfo( bundleContext );
    module.services( MyQi4jService.class );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_import_osgi_services_in_a_qi4j_module"></a>Import OSGi services in a Qi4j Module</h4></div></div></div><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
    throws AssemblyException
{
[...snip...]

    module.services( OSGiServiceImporter.class ).
        setMetaInfo( new OSGiImportInfo( bundleContext,
                                         MyOSGiService.class,
                                         MyOtherOSGiService.class ) ).
        setMetaInfo( new MyFallbackStrategy() );
}
</pre><p>The fallback strategy is invoked when the OSGi service is not available and a method call is invoked.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-rdf"></a>7.18. RDF</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>RDF Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-rest-client"></a>7.19. ReST Client</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-some">tests</p><p>Rickard sent a very interesting <a class="xref" href="#library-rest-client-primer" title="7.20.&#xA0;ReST - HATEOAS Primer"> HATEOAS Primer</a> to the mailing list in October 2011, as the starting
point for the renovation of the ReST Client Library. You should read that to get the full background on the choices
made in this library.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_usage_2"></a>Usage</h4></div></div></div><p>This library leverages the <a class="ulink" href="http://restlet.org" target="_top">Restlet library</a>, so keep its documentation nearby as well.</p><p>This library expects the client code to build up handlers on how to react to resources and errors.
It is a more declarative approach than a typical ReST client application, which often isn’t HATEOAS at all, and
<a class="ulink" href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven" target="_top">Roy Fielding is upset that ReST now means something else</a> than it was originally intended.
We try to be true to Dr. Fielding’s intentions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_establish_client"></a>Establish Client</h5></div></div></div><p>The first thing that must be done is to create a ContextResourceClient.
Let’s walk through the different steps typically needed.</p><pre class="programlisting brush: java">Client client =   new Client( Protocol.HTTP );

ContextResourceClientFactory contextResourceClientFactory = module.newObject( ContextResourceClientFactory.class, client );
contextResourceClientFactory.setAcceptedMediaTypes( MediaType.APPLICATION_JSON );
</pre><p>Above we create the Client instance and a ContextResourceClientFactory, which takes a client via @Uses annotation. We
also set the accepted media type to JSON.</p><p>We then create the global handler, which will be set to all ContextResourceClient instances that this factory creates.</p><pre class="programlisting brush: java">contextResourceClientFactory.setErrorHandler( new ErrorHandler().onError( ErrorHandler.AUTHENTICATION_REQUIRED, new ResponseHandler()
{
    boolean tried = false;

    @Override
    public HandlerCommand handleResponse( Response response, ContextResourceClient client )
    {
            if (tried)
                throw new ResourceException( response.getStatus() );

            tried = true;
            client.getContextResourceClientFactory().getInfo().setUser( new User("rickard", "secret") );

            // Try again
            return refresh();
    }
} ).onError( ErrorHandler.RECOVERABLE_ERROR, new ResponseHandler()
{
    @Override
    public HandlerCommand handleResponse( Response response, ContextResourceClient client )
    {
        // Try to restart
        return refresh();
    }
} ) );
</pre><p>Above, we try to handle that autheorization is required by setting user credentials and then try again. The client
could do a pop-up box instead, have its own cached entries, contact a credentials server or many other things.</p><p>We also added another handler that does a <span class="emphasis"><em>refresh()</em></span> on any recoverable error.</p><p>Note that the ErrorHandler.AUTHENTICATION_REQUIRED and ErrorHandler.RECOVERABLE_ERROR are not enums or constants, but
Specifications and it is possible to implement your own.</p><p>We then simply proceed to create the <span class="emphasis"><em>ContextResourceClient</em></span>, by giving the factory the bookmarkable reference of the
ReST API.</p><pre class="programlisting brush: java">Reference ref = new Reference( "http://localhost:8888/" );
crc = contextResourceClientFactory.newClient( ref );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_using_contextclientresource"></a>Using ContextClientResource</h5></div></div></div><p>Once we have the ContextResourceClient, we can proceed with using it.
The general approach is to register handlers for potential results when invoking the method on the ReST resource.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_query_without_value"></a>Query without Value</h5></div></div></div><pre class="programlisting brush: java">crc.onResource( new ResultHandler&lt;Resource&gt;()
{
    @Override
    public HandlerCommand handleResult( Resource result, ContextResourceClient client )
    {
        return query( "querywithoutvalue" );
    }
} ).
onQuery( "querywithoutvalue", new ResultHandler&lt;TestResult&gt;()
{
    @Override
    public HandlerCommand handleResult( TestResult result, ContextResourceClient client )
    {
        Assert.assertThat( result.xyz().get(), CoreMatchers.equalTo( "bar" ) );
        return null;
    }
} );

crc.start();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_query_and_command"></a>Query and Command</h5></div></div></div><pre class="programlisting brush: java">crc.onResource( new ResultHandler&lt;Resource&gt;()
{
    @Override
    public HandlerCommand handleResult( Resource result, ContextResourceClient client )
    {
        return query( "querywithvalue", null );
    }
} ).onProcessingError( "querywithvalue", new ResultHandler&lt;TestQuery&gt;()
{
    @Override
    public HandlerCommand handleResult( TestQuery result, ContextResourceClient client )
    {
        ValueBuilder&lt;TestQuery&gt; builder = module.newValueBuilderWithPrototype( result );

        builder.prototype().abc().set( "abc" + builder.prototype().abc().get() );

        return query( "querywithvalue", builder.newInstance() );
    }
} ).onQuery( "querywithvalue", new ResultHandler&lt;TestResult&gt;()
{
    @Override
    public HandlerCommand handleResult( TestResult result, ContextResourceClient client )
    {
        return command( "commandwithvalue", null );
    }
} ).onProcessingError( "commandwithvalue", new ResultHandler&lt;Form&gt;()
{
    @Override
    public HandlerCommand handleResult( Form result, ContextResourceClient client )
    {
        result.set( "abc", "right" );

        return command( "commandwithvalue", result );
    }
} );

crc.start();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_query_list_and_command"></a>Query List and Command</h5></div></div></div><pre class="programlisting brush: java">crc.onResource( new ResultHandler&lt;Resource&gt;()
{
    @Override
    public HandlerCommand handleResult( Resource result, ContextResourceClient client )
    {
        return query( "commandwithvalue" );
    }
} ).onQuery( "commandwithvalue", new ResultHandler&lt;Links&gt;()
{
    @Override
    public HandlerCommand handleResult( Links result, ContextResourceClient client )
    {
        Link link = LinksUtil.withId( "right", result );

        return command( link );
    }
} ).onCommand( "commandwithvalue", new ResponseHandler()
{
    @Override
    public HandlerCommand handleResponse( Response response, ContextResourceClient client )
    {
        System.out.println( "Done" );
        return null;
    }
} );

crc.start();
[...snip...]

crc.onResource( new ResultHandler&lt;Resource&gt;()
{
    @Override
    public HandlerCommand handleResult( Resource result, ContextResourceClient client )
    {
        return query( "commandwithvalue" ).onSuccess( new ResultHandler&lt;Links&gt;()
        {
            @Override
            public HandlerCommand handleResult( Links result, ContextResourceClient client )
            {
                Link link = LinksUtil.withId( "right", result );

                return command( link ).onSuccess( new ResponseHandler()
                {
                    @Override
                    public HandlerCommand handleResponse( Response response, ContextResourceClient client )
                    {
                        System.out.println( "Done" );
                        return null;
                    }
                } );
            }
        } );
    }
} );

crc.start();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_query_list_and_command_progressive"></a>Query List and Command Progressive</h5></div></div></div><pre class="programlisting brush: java">crc.onResource( new ResultHandler&lt;Resource&gt;()
{
    @Override
    public HandlerCommand handleResult( Resource result, ContextResourceClient client )
    {
        return query( "commandwithvalue" ).onSuccess( new ResultHandler&lt;Links&gt;()
        {
            @Override
            public HandlerCommand handleResult( Links result, ContextResourceClient client )
            {
                Link link = LinksUtil.withId( "right", result );

                return command( link ).onSuccess( new ResponseHandler()
                {
                    @Override
                    public HandlerCommand handleResponse( Response response, ContextResourceClient client )
                    {
                        System.out.println( "Done" );
                        return null;
                    }
                } );
            }
        } );
    }
} );

crc.start();
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-rest-client-primer"></a>7.20. ReST - HATEOAS Primer</h3></div></div></div><p>The Qi4j ReST Client implements HATEOAS (Hypermedia As The Engine Of Application State) to the full extent intended
by Roy Fielding. The ReST Client Library enables the creation of HATEOAS applications that are NOT using the URL space,
and it is NOT about doing RPC calls over HTTP using a common exchange format (like JSON).</p><p>The <a class="xref" href="#library-rest-server" title="7.22.&#xA0;ReST Server"> ReST Server Library</a> is a corresponding library for creating usecase-driven ReST servers, and with that the
corresponding client becomes very thin, as all business rules remain on the server where they belong.</p><p><span class="strong"><strong>The main point is to support exposing REST resources that focus on use cases and hypermedia.</strong></span></p><p>On the client, we have been thinking a lot about what Roy wrote in his thesis, which boils down to "client makes GET
request, based on relation of link invoked and response (headers+hypermedia) make a decision, and then follow links or
invoke forms to perform state transitions".
It’s a state machine.
This is different from your average REST client today in that this model explicitly says that you need to do a GET
first (otherwise you have nothing to react to), that the "rel" of the link you followed is important (otherwise context
is unknown), and that the client should not make assumptions about what comes back (otherwise you cannot deal with
exceptions, on system and application level).</p><p>The current REST client approach which is imperative:</p><pre class="programlisting brush: java">result = client.get(somelink)</pre><p>does not allow for any of the above. Instead, the client code should first register handlers for what to do in various
circumstances, and then simply perform one operation: "refresh". This will trigger the first GET to the bookmarked URL,
and after that the handlers will do all the work, based on the result. A handler may continue the work by invoking new
requests, or it may abort. "refresh" does not return any value, and usually does not throw any exceptions.</p><p>Example:</p><pre class="programlisting brush: java">crc.onResource( new ResultHandler&lt;Resource&gt;()
{
   @Override
   public void handleResult( Resource result, ContextResourceClient client )
   {
       // This may throw IAE if no link with relation
       // "querywithoutvalue" is found in the Resource
       client.query( "querywithoutvalue", null );
   }
} ).
onQuery( "querywithoutvalue", TestResult.class, new ResultHandler&lt;TestResult&gt;()
{
   @Override
   public void handleResult( TestResult result, ContextResourceClient client )
   {
       Assert.assertThat( result.xyz().get(), CoreMatchers.equalTo( "bar" ) );
   }
} );

crc.refresh();</pre><p>The client first builds up the set of handlers, and describe what they should react to. The client then invokes
"refresh" which will trigger the first GET on the bookmark URL. This will return a representation of that context as a
Resource, and the handler for that is invoked. This then invokes the link with relation "querywithoutvalue" with no
input (no request parameters needed). The result of that is then handled by another handler, and the invocation of
"refresh" then returns successfully. Note that the first handler may not directly handle the "result" of
client.query("querywithoutvalue, null) as it cannot be assumed what happens next. All you know is that you are
following a link.</p><p>On crc (ContextResourceClient) it is also possible to registers handlers that are always applied, such as error
handlers. Here is the setup of crc:</p><pre class="programlisting brush: java">// Create Restlet client and bookmark Reference
Client client = new Client( Protocol.HTTP );
Reference ref = new Reference( "http://localhost:8888/" );
ContextResourceClientFactory contextResourceClientFactory = module.newObject( ContextResourceClientFactory.class, client, new NullResponseHandler() );
contextResourceClientFactory.setAcceptedMediaTypes( MediaType.APPLICATION_JSON );

// Handle logins
contextResourceClientFactory.setErrorHandler( new ErrorHandler().onError( ErrorHandler.AUTHENTICATION_REQUIRED, new ResponseHandler()
{
   // Only try to login once
   boolean tried = false;

   @Override
   public void handleResponse( Response response, ContextResourceClient client )
   {
           // If we have already tried to login, fail!
           if (tried)
               throw new ResourceException( response.getStatus() );

           tried = true;
           client.getContextResourceClientFactory().getInfo().setUser( new User("rickard", "secret") );

           // Try again
           client.refresh();
   }
} ).onError( ErrorHandler.RECOVERABLE_ERROR, new ResponseHandler()
{
   @Override
   public void handleResponse( Response response, ContextResourceClient client )
   {
       // Try to restart this scenario
       client.refresh();
   }
} ) );

crc = contextResourceClientFactory.newClient( ref );</pre><p>These general handlers cover what to do for login and error handling, for example.
In the traditional REST client this is not as easy to do, as you are more or less assuming a "happy path" all the time.
In the above scenario there could be any number of steps between doing "refresh" and getting to the meat of the use
case, such as doing a signup for the website, login, redirects to other servers, error handling and retries, etc.
It becomes possible to blend general application and error handling logic with use case specific handlers.</p><p>That’s basically it. This is where I want to go with support for REST, as a way to truly leverage the REST ideas and
make it very easy to do REST applications <span class="strong"><strong>and</strong></span> clients based on Qi4j, by keeping the application logic on the server.
In the long run there would also be a JavaScript version of the client, with the same characteristics, so that you can
easily build a jQuery UI for Qi4j REST apps.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-rest-common"></a>7.21. ReST Common</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-none">tests</p><p>ReST Common Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-rest-server"></a>7.22. ReST Server</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-none">tests</p><p>ReST Server Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-scheduler"></a>7.23. Scheduler</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The Scheduler library provides an easy way to schedule tasks using cron expressions if needed.</p><p>An optional Timeline allows you to browse past and future task runs.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging_3"></a>Logging</h4></div></div></div><p>The SLF4J Logger used by this library is named "org.qi4j.library.scheduler".</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_5"></a>Assembly</h4></div></div></div><p>Use SchedulerAssembler to add the Scheduler service to your Application. This
Assembler provide a fluent api to programmatically configure configuration defaults and activate the
Timeline service assembly that allow to browse in past and future Task runs.</p><p>Here is a full example:</p><pre class="programlisting brush: java">new SchedulerAssembler().visibleIn( Visibility.layer )
    .withConfigAssembly( configModuleAssembly )
    .withTimeline()
    .assemble( moduleAssembly );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_3"></a>Configuration</h4></div></div></div><p>SchedulerConfiguration defines configuration properties details:</p><pre class="programlisting brush: java">/**
 * @return Number of worker threads, optional and defaults to the number of available cores.
 */
@Optional
Property&lt;Integer&gt; workersCount();

/**
 * @return Size of the queue to use for holding tasks before they are run, optional and defaults to 10.
 */
@Optional
Property&lt;Integer&gt; workQueueSize();

/**
 * @return If the scheduler must stop without waiting for running tasks, optional and defaults to false.
 */
@UseDefaults
Property&lt;Boolean&gt; stopViolently();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_writing_tasks"></a>Writing Tasks</h4></div></div></div><p>To write a schedulable Task, compose an EntityComposite using Task to be able to schedule it.</p><p>The Task contract is quite simple:</p><pre class="programlisting brush: java">public interface Task
        extends Runnable
{

    Property&lt;String&gt; name();

    @UseDefaults
    Property&lt;List&lt;String&gt;&gt; tags();

}
</pre><p>Tasks have a mandatory name property and an optional tags property. Theses properties get copied in
each TimelineRecord created when the Timeline feature is activated.</p><p>The run() method of Tasks is wrapped in a UnitOfWork when called by the Scheduler.
Thanks to the UnitOfWork handling in Qi4j, you can split the work done in your Tasks in
several UnitOfWorks, the one around the Task#run() invocation will then be paused.</p><p>Here is a simple example:</p><pre class="programlisting brush: java">interface MyTaskEntity
    extends Task, EntityComposite
{
    Property&lt;String&gt;; myTaskState();
    Association&lt;AnotherEntity&gt; anotherEntity();
}

abstract class MyTaskMixin
    implements Runnable
{
    @This MyTaskEntity me;

    public void run()
    {
        me.myTaskState().set( me.anotherEntity().get().doSomeStuff( me.myTaskState().get() ) );
    }
}</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_scheduling_tasks"></a>Scheduling Tasks</h4></div></div></div><p>Tasks are scheduled using the Scheduler service. This creates a Schedule associated to
the Task that allows you to know if it is running, to change it’s cron expression and set it’s
durability.</p><p>By default, a Schedule is not durable. In other words, it do not survive an Application
restart. To make a Schedule durable, set it’s durable property to true once its scheduled.</p><p>There are two ways to schedule a Task using the Scheduler service: once or with a cron
expression.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_scheduling_once"></a>Scheduling once</h5></div></div></div><p>This is the easiest way to run a background Task once after a given initial delay in seconds.</p><pre class="programlisting brush: java">@Service Scheduler scheduler;

public void method()
{
    MyTaskEntity myTask = ...;
    Schedule schedule = scheduler.scheduleOnce( myTask, 10 ); // myTask will be run in 10 seconds from now
}</pre><p>Note that there is no point in making such a Schedule durable because it won’t be run repeatedly.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_scheduling_using_a_cron_expression"></a>Scheduling using a cron expression</h5></div></div></div><p>Cron expression parsing is based on the GNU crontab manpage that can be found here:
<a class="ulink" href="http://unixhelp.ed.ac.uk/CGI/man-cgi?crontab+5" target="_top">http://unixhelp.ed.ac.uk/CGI/man-cgi?crontab+5</a> .</p><p>The following extensions are used:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
a mandatory field is added at the begining: seconds.
</li><li class="listitem">
a special string is added: @minutely
</li><li class="listitem">
a special character is added: ? to choose between dayOfMonth and dayOfWeek
</li></ul></div><p>The ? special char has the same behavior as in the Quartz Scheduler expression. The wikipedia page
<a class="ulink" href="http://en.wikipedia.org/wiki/CRON_expression" target="_top">http://en.wikipedia.org/wiki/CRON_expression</a>
explains Quartz Scheduler expression, not simple cron expressions. You’ll find there about the ? special
char and maybe that some other extensions you would like to use are missing in this project.</p><p>To sum up, cron expressions used here have a precision of one second. The following special strings can be used:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
@minutely
</li><li class="listitem">
@hourly
</li><li class="listitem">
@midnight or @daily
</li><li class="listitem">
@weekly
</li><li class="listitem">
@monthly
</li><li class="listitem">
@annualy or @yearly
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_observing_the_timeline"></a>Observing the Timeline</h4></div></div></div><p>Timeline allow to browse in past and future Task runs. This feature is available only if you activate
the Timeline assembly in the SchedulerAssembler}, see above.</p><p>Once activated, Task success and failures are recorded. Then, the Timeline
service allow to browse in past (recorded) and in anticipated (future) Task runs.</p><p>Use the following in your code to get a Timeline Service injected:</p><pre class="programlisting brush: java">@Service Timeline timeline;</pre><p>Here is the actual Timeline contract:</p><pre class="programlisting brush: java">public interface Timeline
{
[...snip...]

    Iterable&lt;TimelineRecord&gt; getLastRecords( int maxResults );
    [...snip...]

    Iterable&lt;TimelineRecord&gt; getNextRecords( int maxResults );
    [...snip...]

    Iterable&lt;TimelineRecord&gt; getRecords( DateTime from, DateTime to );
    [...snip...]

    Iterable&lt;TimelineRecord&gt; getRecords( long from, long to );
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-script-beanshell"></a>7.24. Beanshell Scripting</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Beanshell Scripting Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-script-groovy"></a>7.25. Groovy Scripting</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Groovy Scripting Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-script-javascript"></a>7.26. Javascript Scripting</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Javascript Scripting Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-script-jruby"></a>7.27. JRuby Scripting</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>JRuby Scripting Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="lang-scala"></a>7.28. Scala Support</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-servlet"></a>7.29. Servlet</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>This library provide the necessary boilerplate code to bootstrap a Qi4j Application in a Servlet container plus some
facilities. It aims at a very simple need and is provided as an example integration.</p><p>If instead you want to run a servlet container inside a Qi4j Application, see <a class="xref" href="#library-http" title="7.12.&#xA0;HTTP"> HTTP Library</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_application_bootstrap"></a>Application Bootstrap</h4></div></div></div><p>Extends <code class="literal">AbstractQi4jServletBootstrap</code> to easily bind a Qi4j <code class="literal">Application</code> activation/passivation to your webapp
lifecycle.</p><p>Use <code class="literal">Qi4jServletSupport#application(javax.servlet.ServletContext)</code> to get a handle on the <code class="literal">Application</code> from the
<code class="literal">ServletContext</code>.</p><p>Here is an example ServletContextListener:</p><pre class="programlisting brush: java">public static class FooServletContextListener
        extends AbstractQi4jServletBootstrap
{

    public ApplicationAssembly assemble( ApplicationAssemblyFactory applicationFactory )
            throws AssemblyException
    {
        ApplicationAssembly appass = applicationFactory.newApplicationAssembly();
        [...snip...]

        return appass;
    }

}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_facilities_2"></a>Facilities</h4></div></div></div><p><code class="literal">Qi4jServlet</code> and <code class="literal">Qi4jFilter</code> respectively provide base class for easy access to the <code class="literal">Application</code> from the
<code class="literal">ServletContext</code>.</p><p>Here is a sample servlet that simply output the assembled Application name:</p><pre class="programlisting brush: java">public static class FooServlet
        extends Qi4jServlet
{

    @Override
    protected void doGet( HttpServletRequest req, HttpServletResponse resp )
            throws ServletException, IOException
    {
        // Output the assembled Application's name as an example
        resp.getWriter().println( application().name() );
    }

}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging_4"></a>Logging</h4></div></div></div><p>The SLF4J logger used by this library is named "org.qi4j.library.servlet".</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-shiro"></a>7.30. Shiro Security</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>This library provides integration with the <a class="ulink" href="http://shiro.apache.org/" target="_top">Apache Shiro</a> Java Security Framework.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>If you are working on a HTTP based application, see the <a class="xref" href="#library-shiro-web" title="7.31.&#xA0;Shiro Web Security"> Shiro Web Security Library</a> that leverages this very library
and is directly usable with the <a class="xref" href="#library-http" title="7.12.&#xA0;HTTP"> HTTP Library</a>, the <a class="xref" href="#library-servlet" title="7.29.&#xA0;Servlet">Servlet Library</a> or any other Servlet based stack.</p></td></tr></table></div><p>“Apache Shiro is a powerful and easy-to-use Java security framework that performs authentication, authorization,
cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any
application – from the smallest mobile applications to the largest web and enterprise applications.” says the Apache
Shiro website.</p><p>Altough Apache Shiro can be used as-is with Qi4j Applications, this library provides integrations that can come in
handy. If your use case do not fit any of theses integrations, look at their respective code. You should find out
pretty easily how to compose the provided code to write your integration. Don’t hesitate to
<a class="link" href="#community-contributing" title="11.7.&#xA0;Contributing to Qi4j">contribute</a> interesting integrations to this very library.</p><p>We invite you to read the comprehensive <a class="ulink" href="http://shiro.apache.org/documentation.html" target="_top">Apache Shiro documentation</a>, we will
mostly discuss Qi4j related matters here.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_basic_usage"></a>Basic usage</h4></div></div></div><p>For standalone applications, you can use plain Shiro easily. The only thing to do is to register a configured
SecurityManager when activating your Qi4j Application. It can be done outside the application, before its activation,
"à là" by-hand ;</p><pre class="programlisting brush: java">IniSecurityManagerFactory factory = new IniSecurityManagerFactory( "classpath:standalone-shiro.ini" );
SecurityManager securityManager = factory.getInstance();
SecurityUtils.setSecurityManager( securityManager );
</pre><p>note that this example code register the SecurityManager as a VM static singleton.</p><p>However we recommend to use the provided IniSecurityManagerService that does exactly this when activated and unregister
the SecurityManager when passivated:</p><pre class="programlisting brush: java">new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
</pre><p>You can change the INI resource path through the ShiroIniConfiguration:</p><pre class="programlisting brush: java">public interface ShiroIniConfiguration
        extends ConfigurationComposite
{

    /**
     * Resource path of the ini configuration file.
     * "classpath:", "file": and "url:" prefixes are supported.
     * Defaulted to "classpath:shiro.ini".
     */
    @Optional
    Property&lt;String&gt; iniResourcePath();

}
</pre><p>Remember that this setup use a ThreadLocal SecurityManager singleton. Among other things it means that, althoug the
IniSecurityManagerService is activated on Application activation, if you need to use Shiro in other Services that are
activated on Application activation you should tell Qi4j about this dependency by injecting the SecurityManagerService
in the laters.</p><p>Once started you must remember to register the SecurityManager in Shiro’s ThreadContext ;</p><pre class="programlisting brush: java">
@Service
private IniSecurityManagerService securityManagerService;

[...snip...]

public void interactionBegins()
{
    ThreadContext.bind( securityManagerService.getSecurityManager() );
}

[...snip...]

public void interactionEnds()
{
    ThreadContext.unbindSubject();
    ThreadContext.unbindSecurityManager();
}
</pre><p>that’s how Shiro works.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_security_concern"></a>Security Concern</h4></div></div></div><p>This library provides the <code class="literal">SecurityConcern</code> that should be used alongside the provided method annotations that mimic
Apache Shiro annotations:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
The <code class="literal">@RequiresAuthentication</code> annotation requires the current Subject to have been authenticated during their current
  session for the annotated class/instance/method to be accessed or invoked.
</li><li class="listitem">
The <code class="literal">@RequiresGuest</code> annotation requires the current Subject to be a "guest", that is, they are not authenticated or
  remembered from a previous session for the annotated class/instance/method to be accessed or invoked.
</li><li class="listitem">
The <code class="literal">@RequiresPermissions</code> annotation requires the current Subject be permitted one or more permissions in order to
  execute the annotated method.
</li><li class="listitem">
The <code class="literal">@RequiresRoles</code> annotation requires the current Subject to have all of the specified roles. If they do not have
  the role(s), the method will not be executed and an AuthorizationException is thrown.
</li><li class="listitem">
The <code class="literal">@RequiresUser</code> annotation requires the current Subject to be an application user for the annotated
  class/instance/method to be accessed or invoked. An <span class="emphasis"><em>application user</em></span> is defined as a Subject that has a known
  identity, either known due to being authenticated during the current session or remembered from <span class="emphasis"><em>RememberMe</em></span> services
  from a previous session.
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_realms_services"></a>Realms Services</h4></div></div></div><p>All the above is sufficient as long as you use the ini file to store user credentials and permissions or a Realm that
has no dependency on your application code and can be specified in the ini file to be instanciated by Shiro outside the
Qi4j scope.</p><p>One usecase where it’s not sufficient comes quickly as you would like to provide user credentials and permissions
from Entities stored in an EntityStore or perform any custom logic involving your Qi4j Application.</p><p>Let’s look at a complete example using a Realm Service that extends one of the Shiro provided Realm which use in-memory
credientials and configuring it ;</p><pre class="programlisting brush: java">@Mixins( MyRealmMixin.class )
public interface MyRealmService
        extends Realm, ServiceComposite, ServiceActivation
{
}

[...snip...]

public class MyRealmMixin
        extends SimpleAccountRealm
        implements ServiceActivation
{

    private final PasswordService passwordService;

    public MyRealmMixin()
    {
        super();
        passwordService = new DefaultPasswordService();
        PasswordMatcher matcher = new PasswordMatcher();
        matcher.setPasswordService( passwordService );
        setCredentialsMatcher( matcher );
    }

    public void activateService()
            throws Exception
    {
        // Create a test account
        addAccount( "foo", passwordService.encryptPassword( "bar" ) );
    }

    [...snip...]


}

@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
    module.services( MyRealmService.class );

    [...snip...]

}

</pre><p>We start by defining a Realm Service and its Mixin that’s based on SimpleAccountRealm that we configure to handle hashed
passwords. For the sake of the example it is shown how to hash a password using Shiro built in mecanisms. Then comes
the Assembly where we simply reuse the Standalone Shiro Assembly and declare our Realm as a Service. It works the same
way when using the <a class="xref" href="#library-shiro-web" title="7.31.&#xA0;Shiro Web Security"> Shiro Web Security Library</a>.</p><p>Note that under the hood, assembled Realm Services are added to the ones configured in the INI file.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_security_domain"></a>Security Domain</h4></div></div></div><p>Going further, if you want to persist credentials and permissions in an EntityStore, the Shiro Security Library
provides skeletons to easily setup some usecases consisting of Shiro setup facilities and base state model for you to
compose with.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_passwords"></a>Passwords</h5></div></div></div><p>Password storage is not a simple subject. Shiro provide best practice mecanisms using salt and repeated-hashing out of
the box. It is possible to setup your Realm so that hashed passwords are stored in a future proof manner, meaning that
you can change the used algorithms while retaining compatibility with passwords already stored.</p><p>Shiro use the
<a class="ulink" href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/crypto/hash/format/Shiro1CryptFormat.html" target="_top">Shiro1CryptFormat</a>
which is a fully reversible <a class="ulink" href="http://packages.python.org/passlib/modular_crypt_format.html" target="_top">Modular Crypt Format</a> (MCF).</p><p>This library provides a <code class="literal">PasswordRealmService</code> to be used with a <code class="literal">PasswordSecurable</code>. Let’s look at a complete
example.</p><p>First you need to define your User (or Account, or whatever fits your domain), for the sake of the example we define a
UserFactory too. Note that the factory uses the PasswordService implemented by the PasswordRealm to hash the password:</p><pre class="programlisting brush: java">public interface User
        extends PasswordSecurable
{
}

[...snip...]

@Mixins( UserFactoryMixin.class )
public interface UserFactory
{

    User createNewUser( String username, String password );

}

[...snip...]

public static class UserFactoryMixin
        implements UserFactory
{

    @Structure
    private Module module;

    @Service
    private PasswordService passwordService;

    @Override
    public User createNewUser( String username, String password )
    {
        EntityBuilder&lt;User&gt; userBuilder = module.currentUnitOfWork().newEntityBuilder( User.class );
        User user = userBuilder.instance();
        user.subjectIdentifier().set( username );
        user.password().set( passwordService.encryptPassword( password ) );
        return userBuilder.newInstance();
    }

}

</pre><p>Now comes the assembly that reuse what’s described above and add both the password domain assembly plus your custom User
entity and its factory:</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
    new PasswordDomainAssembler().withConfig( configModule ).assemble( module );

    module.entities( User.class );
    module.services( UserFactory.class );

    [...snip...]

}

</pre><p>And finally here is how to create a new user and below how to perform a login:</p><pre class="programlisting brush: java">User user = userFactory.createNewUser( "foo", "bar" );

[...snip...]

Subject currentUser = SecurityUtils.getSubject();
currentUser.login( new UsernamePasswordToken( "foo", "bar" ) );

</pre><p>In this setup, password hashing use the Shiro’s default (Salted SHA-256 with 500.000 iterations). If you <span class="emphasis"><em>need</em></span> to
change this you can do it using PasswordRealmConfiguration properties:</p><pre class="programlisting brush: java">/**
 * Sets the name of the MessageDigest algorithm that will be used to compute hashes.
 */
@Optional
Property&lt;String&gt; hashAlgorithmName();

/**
 * Sets the number of hash iterations that will be performed during hash computation.
 */
@Optional
Property&lt;Integer&gt; hashIterationsCount();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_permissions_amp_roles"></a>Permissions &amp; Roles</h5></div></div></div><p>In the same vein, this library provide a domain state skeleton with support in <code class="literal">PasswordRealmService</code>. It allows you to
easily store roles, permissions and assignment to your accounts.</p><p>Let’s look at the previous example with permissions added.</p><p>First you need to add the RoleAssignee type to your account:</p><pre class="programlisting brush: java">public interface User
        extends PasswordSecurable, RoleAssignee
{
}

</pre><p>Assembly is straight forward:</p><pre class="programlisting brush: java">new StandaloneShiroAssembler().withConfig( configModule ).assemble( module );
new PasswordDomainAssembler().withConfig( configModule ).assemble( module );
new PermissionsDomainAssembler().assemble( module );

module.entities( User.class );
module.services( UserFactory.class );

</pre><p>And here is how to use all this:</p><pre class="programlisting brush: java">UnitOfWork uow = module.newUnitOfWork();

User user = userFactory.createNewUser( "foo", "bar" );
Role role = roleFactory.create( "role-one", "permission-one", "permission-two" );
role.assignTo( user );

uow.complete();

[...snip...]

uow = module.newUnitOfWork();

Subject currentUser = SecurityUtils.getSubject();
currentUser.login( new UsernamePasswordToken( "foo", "bar" ) );

if ( !currentUser.hasRole( "role-one" ) ) {
    fail( "User 'foo' must have 'role-one' role." );
}

if ( !currentUser.isPermitted( "permission-one" ) ) {
    fail( "User 'foo' must have 'permission-one' permission." );
}

[...snip...]

uow.discard();
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_other_authentication_mecanisms"></a>Other authentication mecanisms</h4></div></div></div><p>For other authentication mecanisms you can leverage Shiro extensions available in the Shiro distribution or as external
libraries. There’s support for text files, simple JDBC, LDAP, CAS SSO, OAuth, OpenID, X.509 Certificates etc…</p><p>Take the PasswordRealmService as a start and extend/rewrite it to suit your needs.</p><p>If you happen to come with a Qi4j integration that could be valuable in this very library, don’t hesitate to
<a class="link" href="#community-contributing" title="11.7.&#xA0;Contributing to Qi4j">contribute</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging_5"></a>Logging</h4></div></div></div><p>All code from this library use the <code class="literal">org.qi4j.library.shiro</code> logger.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-shiro-web"></a>7.31. Shiro Web Security</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>This library provides integration with the <a class="ulink" href="http://shiro.apache.org/" target="_top">Apache Shiro</a> Java Security Framework.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This library only contains web related information. Most of the documentation can be found in the
<a class="xref" href="#library-shiro" title="7.30.&#xA0;Shiro Security"> Shiro Security Library</a> that this very library leverages.</p></td></tr></table></div><p>“Apache Shiro is a powerful and easy-to-use Java security framework that performs authentication, authorization,
cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any
application – from the smallest mobile applications to the largest web and enterprise applications.” says the Apache
Shiro website.</p><p>We invite you to read the comprehensive <a class="ulink" href="http://shiro.apache.org/documentation.html" target="_top">Apache Shiro documentation</a>, we will
mostly discuss Qi4j related matters here.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_servlet_context"></a>Servlet Context</h4></div></div></div><p>In a servlet context, being through the <a class="xref" href="#library-servlet" title="7.29.&#xA0;Servlet">Servlet Library</a>, the <a class="xref" href="#library-http" title="7.12.&#xA0;HTTP"> HTTP Library</a> or your custom Qi4j application
bootstrap, plain Shiro is usable. A WebEnvironment must be globally available and ShiroFilter must be registered.</p><p>If you use a custom Qi4j application boostrap or the <a class="xref" href="#library-servlet" title="7.29.&#xA0;Servlet">Servlet Library</a> you can directly use Shiro’s provided
EnvironmentLoaderListener and ShiroFilter.</p><p>If you use the <a class="xref" href="#library-http" title="7.12.&#xA0;HTTP"> HTTP Library</a> you can either directly use Shiro classes or use the assembly API as follows:</p><pre class="programlisting brush: java">new JettyServiceAssembler().assemble( module );
[...snip...]

new HttpShiroAssembler().withConfig( configModule ).assemble( module );
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-spring"></a>7.32. Spring Integration</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Spring Integration Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-sql"></a>7.33. SQL</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>The SQL Library provides facilities for working with SQL databases.</p><p>The center piece is the DataSource support that comes with
<a class="xref" href="#library-circuitbreaker" title="7.4.&#xA0;Circuit Breaker">Circuit Breaker Library</a> and <a class="xref" href="#library-jmx" title="7.13.&#xA0;JMX"> JMX Library</a> support. Facilities for doing SQL I/O with the <a class="xref" href="#core-io" title="6.6.&#xA0;Core I/O API">I/O API</a> are provided.</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>See the <a class="xref" href="#sample-sql-support" title="5.7.&#xA0;SQL Support Sample">SQL Support Sample</a> that demonstrate combined use of <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a>, <a class="xref" href="#extension-es-sql" title="8.14.&#xA0;SQL EntityStore"> SQL EntityStore</a> and
<a class="xref" href="#extension-indexing-sql" title="8.19.&#xA0;SQL Index/Query">SQL Index/Query</a>.</p></td></tr></table></div><p>Moreover, supplementary libraries helps dealing with different connection pool implementations and schema migrations.
None of theses libraries depends on an actual JDBC driver, you are free to use the one that suits your needs.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_datasource_and_connection_pools"></a>DataSource and connection pools</h4></div></div></div><p>DataSource support comes in four flavors:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
using the <a class="ulink" href="http://jolbox.com/" target="_top">BoneCP</a> connection pool
</li><li class="listitem">
using the <a class="ulink" href="http://sourceforge.net/projects/c3p0/" target="_top">C3P0</a> connection pool
</li><li class="listitem">
using the <a class="ulink" href="http://commons.apache.org/dbcp/" target="_top">Apache DBCP</a> connection pool
</li><li class="listitem">
importing an existing DataSource provided at assembly time
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_connection_pools"></a>Connection Pools</h5></div></div></div><p>Connection Pools support is provided by supplementary libraries.</p><p><span class="strong"><strong>BoneCP</strong></span></p><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>BoneCP support resides in the <span class="strong"><strong>sql-bonecp</strong></span> module.</p><pre class="programlisting brush: java">// Assemble the BoneCP based Service Importer
new BoneCPDataSourceServiceAssembler().
        identifiedBy( DS_SERVICE_ID ).
        visibleIn( Visibility.module ).
        withConfig( config ).
        withConfigVisibility( Visibility.layer ).
        assemble( module );
</pre><p><span class="strong"><strong>C3P0</strong></span></p><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>C3P0 support resides in the <span class="strong"><strong>sql-c3p0</strong></span> module.</p><pre class="programlisting brush: java">// Assemble the C3P0 based Service Importer
new C3P0DataSourceServiceAssembler().
        identifiedBy( DS_SERVICE_ID ).
        visibleIn( Visibility.module ).
        withConfig( config ).
        withConfigVisibility( Visibility.layer ).
        assemble( module );
</pre><p><span class="strong"><strong>Apache DBCP</strong></span></p><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>Apache DBCP support resides in the <span class="strong"><strong>sql-dbcp</strong></span> module.</p><pre class="programlisting brush: java">// Assemble the Apache DBCP based Service Importer
new DBCPDataSourceServiceAssembler().
        identifiedBy( DS_SERVICE_ID ).
        visibleIn( Visibility.module ).
        withConfig( config ).
        withConfigVisibility( Visibility.layer ).
        assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_datasource"></a>DataSource</h5></div></div></div><p><span class="strong"><strong>Assembly</strong></span></p><pre class="programlisting brush: java">// Assemble a DataSource
new DataSourceAssembler().
        withDataSourceServiceIdentity( DS_SERVICE_ID ).
        identifiedBy( DS_ID ).
        visibleIn( Visibility.module ).
        assemble( module );
// Another DataSource managed by the same C3P0 connection pool
new DataSourceAssembler().
        withDataSourceServiceIdentity( DS_SERVICE_ID ).
        identifiedBy( OTHER_DS_ID ).
        visibleIn( Visibility.module ).
        assemble( module );
</pre><p>Assembled DataSources must be visible from the connection pool importer service.</p><p><span class="strong"><strong>Configuration</strong></span></p><p>You need to provide a DataSource Configuration Entity per assembled DataSource.
See <a class="xref" href="#howto-configure-service" title="3.15.&#xA0;Configure a Service">Configure a Service</a>.</p><pre class="programlisting brush: java">public interface DataSourceConfigurationState
        extends Enabled
{
    Property&lt;String&gt; driver();
    Property&lt;String&gt; url();
    @UseDefaults Property&lt;String&gt; username();
    @UseDefaults Property&lt;String&gt; password();
    @Optional Property&lt;Integer&gt; minPoolSize();
    @Optional Property&lt;Integer&gt; maxPoolSize();
    @Optional Property&lt;Integer&gt; loginTimeoutSeconds();
    @Optional Property&lt;Integer&gt; maxConnectionAgeSeconds();
    @Optional Property&lt;String&gt; validationQuery();
    @UseDefaults Property&lt;String&gt; properties();
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: plain">enabled=true
url=jdbc:derby:memory:testdb;create=true
driver=org.apache.derby.jdbc.EmbeddedDriver
username=
password=</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_importing_an_existing_datasource"></a>Importing an existing DataSource</h5></div></div></div><p>Importing an existing DataSource at assembly time is usefull when your Qi4j
Application runs in an environment where DataSource are already provided.</p><pre class="programlisting brush: java">new ExternalDataSourceAssembler( externalDataSource ).
        visibleIn( Visibility.module ).
        identifiedBy( "datasource-external-id" ).
        withCircuitBreaker( DataSources.newDataSourceCircuitBreaker() ).
        assemble( module );
</pre><p>This mechanism is provided as an integration convenience and using the embedded
connection pools described above is recommended.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_circuit_breaker_2"></a>Circuit Breaker</h4></div></div></div><p>Assemblers for managed and external DataSource takes an optional
CircuitBreaker and set it as <a class="xref" href="#def-metainfo">MetaInfo</a> of the DataSource.</p><pre class="programlisting brush: java">CircuitBreaker circuitBreaker = newDataSourceCircuitBreaker( 5 /* threshold */,
                                                             1000 * 60 * 5 /* 5min timeout */ );
new DataSourceAssembler().
        withDataSourceServiceIdentity( DS_SERVICE_ID ).
        identifiedBy( DS_ID ).
        visibleIn( Visibility.layer ).
        withCircuitBreaker( circuitBreaker ).
        assemble( module );
</pre><p>Then, when you gets injected or lookup a DataSource it will be automatically wrapped
by a CircuitBreaker proxy.</p><pre class="programlisting brush: java">@Service
DataSource dataSource; // Wrapped with a CircuitBreaker proxy
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_i_o"></a>I/O</h4></div></div></div><p>Here is a simple example:</p><pre class="programlisting brush: java">// Look up the DataSource
DataSource ds = module.findService( DataSource.class ).get();

// Instanciate Databases helper
Databases database = new Databases( ds );

// Assert that insertion works
assertTrue( database.update( "insert into test values ('someid', 'bar')" ) == 1 );
[...snip...]

// Select rows and load them in a List
List&lt;SomeValue&gt; rows = new ArrayList&lt;SomeValue&gt;();
database.query( "select * from test" ).transferTo( map( toValue, collection( rows ) ) );

// Transfer all rows to System.out
Inputs.iterable( rows ).transferTo( Outputs.systemOut() );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_jmx"></a>JMX</h4></div></div></div><p>Thanks to the <a class="xref" href="#library-jmx" title="7.13.&#xA0;JMX"> JMX Library</a> the Configuration of DataSources is exposed
through JMX.</p><pre class="programlisting brush: java">new DataSourceJMXAssembler().visibleIn( Visibility.module ).assemble( module );
</pre><p>Every DataSource visible from the DataSourceConfigurationManager Service
will get its Configuration available using a JMX client.</p><p>Note that the JMX support does not apply to existing DataSource imported as
described above.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_schema_migration"></a>Schema migration</h4></div></div></div><p>Database schema migration can be delegated to <a class="ulink" href="http://www.liquibase.org/" target="_top">Liquibase</a>.</p><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>Liquibase support resides in the <span class="strong"><strong>sql-liquibase</strong></span> module.</p><p><span class="strong"><strong>Assembly</strong></span></p><pre class="programlisting brush: java">new LiquibaseAssembler( Visibility.module ).
        withConfigIn( configModule, Visibility.layer ).
        assemble( module );
</pre><p>The LiquibaseService is activated on Application startup and if enabled it
applies the configured changelog.</p><p><span class="strong"><strong>Configuration</strong></span></p><pre class="programlisting brush: java">public interface LiquibaseConfiguration
        extends ConfigurationComposite, Enabled
{
    @UseDefaults Property&lt;String&gt; contexts();
    @UseDefaults Property&lt;String&gt; changeLog();
}
</pre><p>For the Liquibase service to be enabled you must set it’s Configuration
<code class="literal">enabled</code> Property to TRUE. <span class="strong"><strong>contexts</strong></span> and <span class="strong"><strong>changeLog</strong></span> are optional.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-struts-codebehind"></a>7.34. Struts - Code Behind</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Struts Code Behing Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-struts-convention"></a>7.35. Struts - Convention</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Struts Convention Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-struts-plugin"></a>7.36. Struts - Plugin</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Struts Plugin Library</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Library has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-uid"></a>7.37. UID</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>This library provides Services to easily generate unique identifiers and sequences of numbers.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_unique_identifiers"></a>Unique Identifiers</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new UuidServiceAssembler().withVisibility( layer ).assemble( moduleAssembly );
</pre><p>Usage is quite simple:</p><pre class="programlisting brush: java">@Service UuidService uuidService;

public void doSomething()
{
    String id1 = uuidService.generateUuid( 0 );
    // eg. 1020ECBB-098C-46E0-94DC-F78E2265EAA1-36

    String id2 = uuidService.generateUuid( 12 );
    // eg. 84E06578EAE3
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_sequencing"></a>Sequencing</h4></div></div></div><p>Sequencing is used to automatically generate a sequence of numbers.</p><p>The algorithm is that <code class="literal">currentSequenceValue</code> is the number that was last returned in a <code class="literal">newSequenceValue</code> call, and will
initially be zero. Persisting Sequencing services defines "initially" as the first run ever, as subsequent starts may
retrieve the <code class="literal">currentSequenceValue</code> from an EntityStore.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_transient_sequences"></a>Transient Sequences</h5></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new TransientSequencingAssembler().withVisibility( layer ).assemble( moduleAssembly );
</pre><p>Usage is quite simple:</p><pre class="programlisting brush: java">@Service Sequencing sequencing;

public void doSomething()
{
    sequencing.currentSequenceValue(); // return 0

    sequencing.newSequenceValue(); // return 1
    sequencing.currentSequenceValue(); // return 1
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_persisted_sequences"></a>Persisted Sequences</h5></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new PersistingSequencingAssembler().withVisibility( layer ).assemble( moduleAssembly );
</pre><p>Usage is quite simple:</p><pre class="programlisting brush: java">@Service Sequencing sequencing;

public void doSomething()
{
    sequencing.currentSequenceValue(); // return 0

    sequencing.newSequenceValue(); // return 1
    sequencing.currentSequenceValue(); // return 1
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="library-uowfile"></a>7.38. UoWFile</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-complete">tests</p><p>The UoWFile Library provides an easy way to bind file operations to UnitOfWorks.</p><p>In other words, using this library you can easily attach files to your
Composites, mostly EntityComposites, so that if the UoW gets discarded, changes
to files are discarded too. Concurrent modifications are properly handled.</p><p>Note that it has a performance impact relative to the files size as it
duplicates the file to keep a backup for eventual rollback. However, the API
provides a way to get non-managed handles on the attached files to keep your
read-only operations fast.</p><p>The location of files is left to the developer using a private mixin.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_logging_6"></a>Logging</h4></div></div></div><p>The SLF4J Logger used by this library is named "org.qi4j.library.uowfile".</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_add_an_attached_file_to_an_entity"></a>Add an attached file to an Entity</h4></div></div></div><p>Let’s say you have the following Entity:</p><pre class="programlisting brush: java">public interface TestedEntity
        extends EntityComposite,
        [...snip...]

{

    Property&lt;String&gt; name();

}
</pre><p>To add an attached file to it you first need to extends HasUoWFileLifecycle:</p><pre class="programlisting brush: java">public interface TestedEntity
        extends EntityComposite,
                HasUoWFileLifecycle
{

    Property&lt;String&gt; name();

}
</pre><p>This provides you with the following contract:</p><pre class="programlisting brush: java">public interface HasUoWFile
{

    /**
     * IMPORTANT Use this {@link File} only inside read-only {@link UnitOfWork}s
     */
    File attachedFile();

    File managedFile();
    [...snip...]

}
</pre><p>Next you need to write the UoWFileLocator mixin:</p><pre class="programlisting brush: java">public static abstract class TestedFileLocatorMixin
        implements UoWFileLocator
{

    @This
    private Identity meAsIdentity;

    @Override
    public File locateAttachedFile()
    {
        return new File( baseTestDir, meAsIdentity.identity().get() );
    }

}
</pre><p>Assemble all this as follow:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    new UoWFileAssembler().assemble( module );

    module.entities( TestedEntity.class ).withMixins( TestedFileLocatorMixin.class );
    [...snip...]

}
</pre><p>You can now use the following methods on your EntityComposite:</p><pre class="programlisting brush: java">File attachedFile = entity.attachedFile();
File managedFile = entity.managedFile();
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_going_plural"></a>Going plural</h4></div></div></div><p>Now if you want to attach several files to one entity, this library provides a
simple mechanism allowing you to use any enum as discriminator.</p><p>Let’s say you have the following Entity:</p><pre class="programlisting brush: java">public interface TestedEntity
        extends EntityComposite,
        [...snip...]

{

    Property&lt;String&gt; name();

}
</pre><p>It’s the very same as the one used to start the singular file support described
above.</p><p>To add an attached file to it you first need to write an enum and extends
HasUoWFilesLifecycle:</p><pre class="programlisting brush: java">public enum MyEnum
{

    fileOne, fileTwo

}

public interface TestedEntity
        extends EntityComposite,
                HasUoWFilesLifecycle&lt;MyEnum&gt;
{

    Property&lt;String&gt; name();

}
</pre><p>This provides you with the following contract:</p><pre class="programlisting brush: java">public interface HasUoWFiles&lt;T extends Enum&lt;T&gt;&gt;
{

    /**
     * IMPORTANT Use this {@link File} only inside read-only {@link UnitOfWork}s
     */
    File attachedFile( T key );

    /**
     * IMPORTANT Use these {@link File}s only inside read-only {@link UnitOfWork}s
     */
    Iterable&lt;File&gt; attachedFiles();

    File managedFile( T key );

    Iterable&lt;File&gt; managedFiles();
    [...snip...]

}
</pre><p>Next you need to write the UoWFileLocator mixin:</p><pre class="programlisting brush: java">public static abstract class TestedFilesLocatorMixin
        implements UoWFilesLocator&lt;MyEnum&gt;
{

    @This
    private Identity meAsIdentity;

    @Override
    public Iterable&lt;File&gt; locateAttachedFiles()
    {
        List&lt;File&gt; list = new ArrayList&lt;File&gt;();
        for ( MyEnum eachValue : MyEnum.values() ) {
            list.add( new File( baseTestDir, meAsIdentity.identity().get() + "." + eachValue.name() ) );
        }
        return list;
    }

    @Override
    public File locateAttachedFile( MyEnum key )
    {
        return new File( baseTestDir, meAsIdentity.identity().get() + "." + key.name() );
    }

}
</pre><p>Assemble all this as follow:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    new UoWFileAssembler().assemble( module );

    module.entities( TestedEntity.class ).withMixins( TestedFilesLocatorMixin.class );
    [...snip...]

}
</pre><p>You can now use the following methods on your EntityComposite:</p><pre class="programlisting brush: java">File attachedFileTwo = entity.attachedFile( MyEnum.fileTwo );
File managedFileOne = entity.managedFile( MyEnum.fileOne );
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="extensions"></a>8. Extensions</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview_6">8.1. Overview</a></span></dt><dt><span class="section"><a href="#extension-cache-ehcache">8.2. Ehcache Cache</a></span></dt><dt><span class="section"><a href="#extension-es-file">8.3. File EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-gae">8.4. Google AppEngine EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-hazelcast">8.5. Hazelcast EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-jclouds">8.6. JClouds EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-jdbm">8.7. JDBM EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-leveldb">8.8. LevelDB EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-mongodb">8.9. MongoDB EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-neo4j">8.10. Neo4j EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-preferences">8.11. Preferences EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-redis">8.12. Redis EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-riak">8.13. Riak EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-sql">8.14. SQL EntityStore</a></span></dt><dt><span class="section"><a href="#extension-es-voldemort">8.15. Voldemort EntityStore</a></span></dt><dt><span class="section"><a href="#extension-index-elasticsearch">8.16. ElasticSearch Index/Query</a></span></dt><dt><span class="section"><a href="#extension-index-rdf">8.17. OpenRDF Index/Query</a></span></dt><dt><span class="section"><a href="#extension-index-solr">8.18. Apache Solr Index/Query</a></span></dt><dt><span class="section"><a href="#extension-indexing-sql">8.19. SQL Index/Query</a></span></dt><dt><span class="section"><a href="#extension-metrics-yammer">8.20. Yammer Metrics</a></span></dt><dt><span class="section"><a href="#extension-migration">8.21. Migration</a></span></dt><dt><span class="section"><a href="#extension-reindexer">8.22. Reindexer</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview_6"></a>8.1. Overview</h3></div></div></div><p>We try to keep the Qi4j Core Runtime as lean as possible, and a lot of the power to the Qi4j Platform comes via its
Extension SPI, which defines clear ways to extend the platform. There are currently the following Extensions types,
each with possibly more than one implementation;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Entity Stores
</li><li class="listitem">
Index / Query Engines
</li><li class="listitem">
Entity Caches
</li><li class="listitem">
Metrics Gathering
</li><li class="listitem">
Reindexing
</li><li class="listitem">
Migration
</li></ul></div><p>This section will go through each of the available extensions.
The Qi4j Extensions are of varying maturity level and we try to maintain a STATUS (dev-status.xml) file indicating
how good the codebase, documentation and unit tests are for each of the libraries. This is highly subjective and
potentially different individuals will judge this differently, but at least it gives a ballpark idea of the situation
for our users.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-cache-ehcache"></a>8.2. Ehcache Cache</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Ehcache Cache</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-file"></a>8.3. File EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a source control friendly file system format.</p><p>Note that content should not be modified directly, and doing so may corrupt the data.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_6"></a>Assembly</h4></div></div></div><p>Assembly is done as follows:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    module.services( FileEntityStoreService.class );
    config.entities( FileEntityStoreConfiguration.class ).visibleIn( Visibility.layer );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_4"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the File EntityStore:</p><pre class="programlisting brush: java">public interface FileEntityStoreConfiguration
    extends ConfigurationComposite
{
[...snip...]

    @Optional
    Property&lt;String&gt; directory();
    [...snip...]

    @Optional @Range(min=1, max=10000)
    Property&lt;Integer&gt; slices();
}
</pre><p><code class="literal">directory</code> is optional and represent the directory where the File EntityStore will keep its persisted state.</p><p>It defaults to System.getProperty( "user.dir" ) + "/qi4j/filestore"
If the given path is not absolute, then it’s relative to the current working directory.
If you use the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> then this property value is ignored and FileConfig is prefered.</p><p><code class="literal">slices</code> defines how many slice directories the store should use.</p><p>Many operating systems run into performance problems when the number of files in a directory grows. If
you expect a large number of entities in the file entity store, it is wise to set the number of slices
(default is 1) to an approximation of the square root of number of expected entities.</p><p>For instance, if you estimate that you will have 1 million entities in the file entity store, you should
set the slices to 1000.</p><p>There is a limit of minimum 1 slice and maximum 10,000 slices, and if more slices than that is needed, you
are probably pushing this entitystore beyond its capabilities.</p><p>Note that the slices() can not be changed once it has been set, as it would cause the entity store not to
find the entities anymore.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-gae"></a>8.4. Google AppEngine EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-none">tests</p><p>AppEngine EntityStore</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-hazelcast"></a>8.5. Hazelcast EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by the <a class="ulink" href="http://www.hazelcast.com/" target="_top">Hazelcast</a> in-memory data grid.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_7"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new HazelcastEntityStoreAssembler().withConfigIn( configModule, Visibility.layer ).assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_5"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the Hazelcast EntityStore:</p><pre class="programlisting brush: java">public interface HazelcastConfiguration
        extends ConfigurationComposite
{

    @UseDefaults
    Property&lt;String&gt; configXmlLocation();

    @UseDefaults
    Property&lt;String&gt; mapName();

}
</pre><p><code class="literal">configXmlLocation</code> represent the location of the Hazelcast XML based configuration.</p><p><code class="literal">mapName</code> is the name of the used Hazelcast Map</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-jclouds"></a>8.6. JClouds EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a <a class="ulink" href="http://www.jclouds.org/" target="_top">JClouds</a> BlobStore.</p><p>It means you get access to a growing list of providers available at the
<a class="ulink" href="http://www.jclouds.org/" target="_top">JClouds</a> website that includes Amazon, VMWare, Azure,
and Rackspace.</p><p>For testing purpose theses providers are supported too:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Transient
</li><li class="listitem">
Filesystem
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_8"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new JCloudsMapEntityStoreAssembler().withConfigIn( config, Visibility.layer ).assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_6"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the JClouds EntityStore:</p><pre class="programlisting brush: java">/**
 * Name of the JClouds provider to use. Defaults to 'transient'.
 */
@Optional Property&lt;String&gt; provider();
@UseDefaults Property&lt;String&gt; identifier();
@UseDefaults Property&lt;String&gt; credential();
/**
 * Use this to fine tune your provider implementation according to JClouds documentation.
 */
@UseDefaults Property&lt;Map&lt;String, String&gt;&gt; properties();
/**
 * Name of the JClouds container to use. Defaults to 'qi4j-entities'.
 */
@Optional Property&lt;String&gt; container();
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-jdbm"></a>8.7. JDBM EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by an embedded <a class="ulink" href="http://code.google.com/p/jdbm2/" target="_top">JDBM2</a> database.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_9"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">@Override
public void assemble( ModuleAssembly module )
    throws AssemblyException
{
    JdbmEntityStoreAssembler assembler = new JdbmEntityStoreAssembler( Visibility.application );
    assembler.assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_7"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the JDBM EntityStore:</p><pre class="programlisting brush: java">public interface JdbmConfiguration
        extends ConfigurationComposite
{
[...snip...]

   @Optional
   Property&lt;String&gt; file();

   // JDBM RecordManager options

   @UseDefaults
   Property&lt;Boolean&gt; autoCommit();

   @UseDefaults
   Property&lt;Boolean&gt; disableTransactions();
}
</pre><p><code class="literal">file</code> is optional and represent the file where the JDBM EntityStore will keep its persisted state.</p><p>It defaults to System.getProperty( "user.dir" ) + "/qi4j/jdbmstore.data"
If the given path is not absolute, then it’s relative to the current working directory.
If you use the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> then this property value is ignored and FileConfig is prefered.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-leveldb"></a>8.8. LevelDB EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a <a class="ulink" href="https://code.google.com/p/leveldb/" target="_top">LevelDB</a> embedded database.</p><p>LevelDB is a fast key-value storage library written at Google that provides an ordered mapping from string keys to
string values.</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>the <code class="literal">entitystore-leveldb</code> module do not depends on LevelDB implementations. You have to add the dependency to the
implementation of your choice:
<a class="ulink" href="http://search.maven.org/#search%7Cga%7C1%7Cleveldbjni" target="_top">JNI</a> or
<a class="ulink" href="http://search.maven.org/#search%7Cgav%7C1%7Cg%3A%22org.iq80.leveldb%22%20AND%20a%3A%22leveldb%22" target="_top">Pure Java</a>.</p></td></tr></table></div><p>By default use the native implementation through JNI bindings and fallback to the pure Java implementation if not
available on the current platform. Used implementation can be forced in the configuration.</p><p>The LevelDB EntityStore relies on the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> to decide where it stores its database.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_10"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
    throws AssemblyException
{
[...snip...]

    new LevelDBEntityStoreAssembler().
        withConfig( config, Visibility.layer ).
        identifiedBy( "java-leveldb-entitystore" ).
        assemble( module );
        [...snip...]

}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_8"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the LevelDB EntityStore:</p><pre class="programlisting brush: java">public interface LevelDBEntityStoreConfiguration
    extends ConfigurationComposite
{

    /**
     * LevelDB flavour, can be 'java' or 'jni'.
     * By default, tries 'jni' and fallback to 'java'.
     */
    @Optional
    Property&lt;String&gt; flavour();

    @Optional
    Property&lt;Integer&gt; blockRestartInterval();

    @Optional
    Property&lt;Integer&gt; blockSize();

    @Optional
    Property&lt;Long&gt; cacheSize();

    @Optional
    Property&lt;Boolean&gt; compression();

    @Optional
    Property&lt;Integer&gt; maxOpenFiles();

    @Optional
    Property&lt;Boolean&gt; paranoidChecks();

    @Optional
    Property&lt;Boolean&gt; verifyChecksums();

    @Optional
    Property&lt;Integer&gt; writeBufferSize();

}
</pre><p>All configuration properties are defaulted to the implementation defaults meaning that you can use LevelDB EntityStore
service without configuration.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-mongodb"></a>8.9. MongoDB EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a <a class="ulink" href="http://www.mongodb.org/" target="_top">MongoDB</a> collection in which Entity state is stored as native
MongoDB BSON.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_11"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new MongoMapEntityStoreAssembler().withConfigModule( config ).assemble( module );
    [...snip...]

}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_9"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the MongoDB EntityStore:</p><pre class="programlisting brush: java">public interface MongoEntityStoreConfiguration
        extends ConfigurationComposite
{

    @Optional
    Property&lt;String&gt; hostname();

    @Optional
    Property&lt;Integer&gt; port();

    @UseDefaults
    Property&lt;List&lt;ServerAddress&gt;&gt; nodes();

    @UseDefaults
    Property&lt;String&gt; username();

    @UseDefaults
    Property&lt;String&gt; password();

    @Optional
    Property&lt;String&gt; database();

    @Optional
    Property&lt;String&gt; collection();

    @UseDefaults
    Property&lt;WriteConcern&gt; writeConcern();

    enum WriteConcern
    {

        /** Exceptions are raised for network issues, but not server errors */
        NORMAL,
        /** No exceptions are raised, even for network issues */
        NONE,
        /** Exceptions are raised for network issues, and server errors; waits on a server for the write operation */
        SAFE,
        /** Exceptions are raised for network issues, and server errors; waits on a majority of servers for the write operation */
        MAJORITY,
        /** Exceptions are raised for network issues, and server errors; the write operation waits for the server to flush the data to disk*/
        FSYNC_SAFE,
        /** Exceptions are raised for network issues, and server errors; the write operation waits for the server to group commit to the journal file on disk*/
        JOURNAL_SAFE,
        /** Exceptions are raised for network issues, and server errors; waits for at least 2 servers for the write operation*/
        REPLICAS_SAFE;

    }

}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-neo4j"></a>8.10. Neo4j EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Neo4j EntityStore</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-preferences"></a>8.11. Preferences EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by
<a class="ulink" href="http://docs.oracle.com/javase/7/docs/api/java/util/prefs/Preferences.html" target="_top">java.​util.​prefs.​Preferences</a>. It can be a good
candidate to store <a class="link" href="#def-configurationcomposite">Configuration Composites</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_12"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
    new PreferenceEntityStoreAssembler( Visibility.module ).assemble( module );
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-redis"></a>8.12. Redis EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a <a class="ulink" href="http://redis.io/" target="_top">Redis</a> database.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_13"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler.</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new RedisMapEntityStoreAssembler().withConfigModule( config ).assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_10"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the Redis client:</p><pre class="programlisting brush: java">public interface RedisEntityStoreConfiguration
        extends ConfigurationComposite
{

    /**
     * Redis host.
     *
     * Defaulted to 127.0.0.1.
     */
    @Optional
    Property&lt;String&gt; host();

    /**
     * Redis port.
     *
     * Defaulted to 6379.
     */
    @Optional
    Property&lt;Integer&gt; port();

    /**
     * Connection timeout in milliseconds.
     *
     * Defaulted to 2000.
     */
    @Optional
    Property&lt;Integer&gt; timeout();

    /**
     * Redis password.
     */
    @Optional
    Property&lt;String&gt; password();

    /**
     * Redis database.
     *
     * Defaulted to 0.
     */
    @Optional
    Property&lt;Integer&gt; database();

}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-riak"></a>8.13. Riak EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a <a class="ulink" href="http://basho.com/" target="_top">Riak</a> bucket.</p><p>The EntityStore comes in two flavours: HTTP or ProtocolBuffer based. See the Riak documentation.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_14"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assemblers.</p><p>For HTTP based Riak client:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new RiakHttpMapEntityStoreAssembler().withConfigModule( config ).assemble( module );
}
</pre><p>For ProtocolBuffer based Riak client:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    new RiakProtobufMapEntityStoreAssembler().withConfigModule( config ).assemble( module );
}
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_11"></a>Configuration</h4></div></div></div><p>Here are the configuration properties for the HTTP based Riak client:</p><pre class="programlisting brush: java">public interface RiakHttpEntityStoreConfiguration
        extends ConfigurationComposite
{

    /**
     * List of Riak URLs.
     *
     * Defaulted to http://127.0.0.1:8098/riak if empty.
     */
    @UseDefaults
    Property&lt;List&lt;String&gt;&gt; urls();

    /**
     * Riak Bucket where Entities state will be stored.
     *
     * Defaulted to "qi4j:entities".
     */
    @Optional
    Property&lt;String&gt; bucket();

    /**
     * Maximum total connections.
     *
     * Defaulted to 50. Use 0 for infinite number of connections.
     */
    @Optional
    Property&lt;Integer&gt; maxConnections();

    /**
     * The connection, socket read and pooled connection acquisition timeout in milliseconds.
     *
     * Defaulted to 0 (infinite).
     */
    @UseDefaults
    Property&lt;Integer&gt; timeout();

}
</pre><p>Here are the configuration properties for the ProtocolBuffer based Riak client:</p><pre class="programlisting brush: java">public interface RiakProtobufEntityStoreConfiguration
    extends ConfigurationComposite
{

    /**
     * List of Riak Protocol Buffer hosts.
     *
     * Each entry can contain either an IP address / hostname
     * or an IP address / hostname followed by a column and the host's port.
     *
     * Defaulted to 127.0.0.1 if empty.
     */
    @UseDefaults
    Property&lt;List&lt;String&gt;&gt; hosts();

    /**
     * Riak Bucket where Entities state will be stored.
     *
     * Defaulted to "qi4j:entities".
     */
    @Optional
    Property&lt;String&gt; bucket();

    /**
     * Maximum total connections.
     *
     * Defaulted to 50. Use 0 for infinite number of connections.
     */
    @Optional
    Property&lt;Integer&gt; maxConnections();

    /**
     * The connection timeout in milliseconds.
     *
     * Defaulted to 1000.
     */
    @Optional
    Property&lt;Integer&gt; connectionTimeout();

    /**
     * Idle connection time to live in milliseconds.
     *
     * Defaulted to 1000.
     */
    @Optional
    Property&lt;Integer&gt; idleConnectionTTL();

    /**
     * Max pool size.
     *
     * Defaulted to 0 (unlimited).
     */
    @UseDefaults
    Property&lt;Integer&gt; maxPoolSize();

    /**
     * Initial pool size.
     *
     * Defaulted to 0.
     */
    @UseDefaults
    Property&lt;Integer&gt; initialPoolSize();

    /**
     * Socket buffer size in KB.
     *
     * Defaulted to 16.
     */
    @Optional
    Property&lt;Integer&gt; socketBufferSizeKb();

}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-sql"></a>8.14. SQL EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>EntityStore service backed by a SQL database.</p><p>This extension fully leverage the <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a> meaning that you must use it to assemble your DataSource and that you
get <a class="link" href="#library-circuitbreaker" title="7.4.&#xA0;Circuit Breaker">Circuit Breaker</a> and <a class="link" href="#library-jmx" title="7.13.&#xA0;JMX">JMX</a> integration for free.</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>See the <a class="xref" href="#sample-sql-support" title="5.7.&#xA0;SQL Support Sample">SQL Support Sample</a> that demonstrate combined use of <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a>, <a class="xref" href="#extension-es-sql" title="8.14.&#xA0;SQL EntityStore"> SQL EntityStore</a> and
<a class="xref" href="#extension-indexing-sql" title="8.19.&#xA0;SQL Index/Query">SQL Index/Query</a>.</p></td></tr></table></div><p>The following SQL databases are supported:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.postgresql.org/" target="_top">PostgreSQL</a>
</li><li class="listitem">
<a class="ulink" href="http://www.mysql.com/" target="_top">MySQL</a> and <a class="ulink" href="http://mariadb.org/" target="_top">MariaDB</a>
</li><li class="listitem">
<a class="ulink" href="http://www.sqlite.org/" target="_top">SQLite</a>
</li><li class="listitem">
<a class="ulink" href="http://www.h2database.com/" target="_top">H2 Database Engine</a>
</li><li class="listitem">
<a class="ulink" href="http://db.apache.org/derby/" target="_top">Apache Derby</a> and <a class="ulink" href="http://www.oracle.com/technetwork/java/javadb/overview/index.htm" target="_top">Oracle JavaDB</a>
</li></ul></div><p>Each entity state is stored as a single row so maximum number of entities is the maximum number of rows per table
supported by the underlying SQL database.</p><p>Implementations per database Vendor share a generic codebase but can override about everything SQL. As a consequence
they can have strong differences in terms of performance if they use vendor specific extensions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_12"></a>Configuration</h4></div></div></div><p>SQL EntityStore Configuration is optional and provides only one configuration property: <code class="literal">schemaName</code> defaulted to
<span class="emphasis"><em>qi4j_es</em></span>. On SQL databases that don’t support schemas this configuration property is simply ignored.</p><p>The assembly snippets below show the DataSource assembly alongside the SQL EntityStore assembly. Remember to configure
the DataSource properly, see <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a> and <a class="xref" href="#howto-configure-service" title="3.15.&#xA0;Configure a Service">Configure a Service</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_postgresql"></a>PostgreSQL</h4></div></div></div><p>Maximum number of entities is unlimited.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    // DataSourceService
    new DBCPDataSourceServiceAssembler().
            identifiedBy( "postgresql-datasource-service" ).
            visibleIn( Visibility.module ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );

    // DataSource
    new DataSourceAssembler().
            withDataSourceServiceIdentity( "postgresql-datasource-service" ).
            identifiedBy( "postgresql-datasource" ).
            visibleIn( Visibility.module ).
            withCircuitBreaker();

    // SQL EntityStore
    new PostgreSQLEntityStoreAssembler().
            visibleIn( Visibility.application ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: java">enabled=true
url=jdbc:postgresql://localhost:5432/jdbc_test_db
driver=org.postgresql.Driver
username=jdbc_test_login
password=password</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_mysql_and_mariadb"></a>MySQL and MariaDB</h4></div></div></div><p>Maximum number of entities depends on the choosen storage engine.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    // DataSourceService
    new DBCPDataSourceServiceAssembler().
            identifiedBy( "mysql-datasource-service" ).
            visibleIn( Visibility.module ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );

    // DataSource
    new DataSourceAssembler().
            withDataSourceServiceIdentity( "mysql-datasource-service" ).
            identifiedBy( "mysql-datasource" ).
            visibleIn( Visibility.module ).
            withCircuitBreaker().
            assemble( module );

    // SQL EntityStore
    new MySQLEntityStoreAssembler().
            visibleIn( Visibility.application ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: plain">enabled=true
url=jdbc:mysql://localhost:3306/jdbc_test_db?profileSQL=true
driver=com.mysql.jdbc.Driver
username=root
password=</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_sqlite"></a>SQLite</h4></div></div></div><p>Maximum number of entities is unlimited.</p><p>The <a class="ulink" href="http://www.xerial.org/trac/Xerial/wiki/SQLiteJDBC" target="_top">Xerial SQLite JDBC</a> driver is recommended.
It provides native support on Linux, Windows and MaxOSX, pure Java on other OSes.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    // DataSourceService
    new DBCPDataSourceServiceAssembler().
            identifiedBy( "sqlite-datasource-service" ).
            visibleIn( Visibility.module ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );

    // DataSource
    new DataSourceAssembler().
            withDataSourceServiceIdentity( "sqlite-datasource-service" ).
            identifiedBy( "sqlite-datasource" ).
            visibleIn( Visibility.module ).
            withCircuitBreaker().
            assemble( module );

    // SQL EntityStore
    new SQLiteEntityStoreAssembler().
            visibleIn( Visibility.application ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: plain">enabled=true
url=jdbc:sqlite::memory:
driver=org.sqlite.JDBC
username=
password=</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_h2_database_engine"></a>H2 Database Engine</h4></div></div></div><p>Maximum number of entities is 2^64.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    // DataSourceService
    new DBCPDataSourceServiceAssembler().
            identifiedBy( "h2-datasource-service" ).
            visibleIn( Visibility.module ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );

    // DataSource
    new DataSourceAssembler().
            withDataSourceServiceIdentity( "h2-datasource-service" ).
            identifiedBy( "h2-datasource" ).
            visibleIn( Visibility.module ).
            withCircuitBreaker().
            assemble( module );

    // SQL EntityStore
    new H2SQLEntityStoreAssembler().
            visibleIn( Visibility.application ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: plain">enabled=true
url=jdbc:h2:mem:test
driver=org.h2.Driver
username=
password=</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_apache_derby_and_oracle_javadb"></a>Apache Derby and Oracle JavaDB</h4></div></div></div><p>Maximum number of entities is unlimited.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">public void assemble( ModuleAssembly module )
        throws AssemblyException
{
[...snip...]

    // DataSourceService
    new DBCPDataSourceServiceAssembler().
            identifiedBy( "derby-datasource-service" ).
            visibleIn( Visibility.module ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );

    // DataSource
    new DataSourceAssembler().
            withDataSourceServiceIdentity( "derby-datasource-service" ).
            identifiedBy( "derby-datasource" ).
            visibleIn( Visibility.module ).
            withCircuitBreaker().
            assemble( module );

    // SQL EntityStore
    new DerbySQLEntityStoreAssembler().
            visibleIn( Visibility.application ).
            withConfig( config ).
            withConfigVisibility( Visibility.layer ).
            assemble( module );
}
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: plain">enabled=true
url=jdbc:derby:memory:testdb;create=true
driver=org.apache.derby.jdbc.EmbeddedDriver
username=
password=</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-es-voldemort"></a>8.15. Voldemort EntityStore</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Voldemort EntityStore</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-index-elasticsearch"></a>8.16. ElasticSearch Index/Query</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-beta">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-good">tests</p><p>Index/Query services backed by <a class="ulink" href="http://www.elasticsearch.org/" target="_top">ElasticSearch</a> search engine built on top of
<a class="ulink" href="http://lucene.apache.org/" target="_top">Apache Lucene</a>.</p><div class="warning" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png" /></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>ElasticSearch does not support queries using regular expressions. It means that you can’t use
MatchesSpecification from the Query API. See the ElasticSearch issue
<a class="ulink" href="https://github.com/elasticsearch/elasticsearch/issues/988" target="_top">#988</a>.</p></td></tr></table></div><p>Three modes of operation are supported:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
in-memory ;
</li><li class="listitem">
on-filesystem ;
</li><li class="listitem">
clustered.
</li></ul></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_embedded_in_memory_or_on_filesystem"></a>Embedded: in Memory or on FileSystem</h4></div></div></div><p>Both in-memory and on-filesystem assemblies share the same configuration properties, see below.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_in_memory_assembly"></a>In Memory Assembly</h5></div></div></div><p>In-memory ElasticSearch Index/Query service relies on the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> to decide where it stores its
transaction logs as there’s no in-memory transaction log implementation in ElasticSearch.</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new ESMemoryIndexQueryAssembler().withConfigModule( configModule ).assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_on_filesystem_assembly"></a>On FileSystem Assembly</h5></div></div></div><p>Filesystem based ElasticSearch Index/Query service relies on the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> to decide where it stores its
index data, transaction logs etc…</p><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new ESFilesystemIndexQueryAssembler().withConfigModule( configModule ).assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration_13"></a>Configuration</h5></div></div></div><div class="important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png" /></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>By default queries can only traverse Aggregated Associations, if you want to be able to traverse all
Associations set the <code class="literal">indexNonAggregatedAssociations</code> configuration property to <code class="literal">TRUE</code>.</p></td></tr></table></div><p>Here are the configuration properties for both the in-memory and on-filesystem ElasticSearch Index/Query services:</p><pre class="programlisting brush: java">public interface ElasticSearchConfiguration
        extends ConfigurationComposite
{

    /**
     * Cluster name.
     * Defaults to 'qi4j_cluster'.
     */
    @Optional Property&lt;String&gt; clusterName();

    /**
     * Index name.
     * Defaults to 'qi4j_index'.
     */
    @Optional Property&lt;String&gt; index();

    /**
     * Set to true to index non aggregated associations as if they were aggregated.
     * WARN: Don't use this if your domain model contains circular dependencies.
     * Defaults to 'FALSE'.
     */
    @UseDefaults Property&lt;Boolean&gt; indexNonAggregatedAssociations();

}
</pre><p>All configuration properties are defaulted meaning that you can use ElasticSearch Index/Query service without
configuration.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_in_an_elasticsearch_cluster"></a>In an ElasticSearch cluster</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_15"></a>Assembly</h5></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new ESClusterIndexQueryAssembler().withConfigModule( configModule ).assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration_14"></a>Configuration</h5></div></div></div><p>Here are the configuration properties for the clustered ElasticSearch Index/Query service. Note that it inherits the
properties defined in the in-memory or on-filesystem configuration, see above.</p><pre class="programlisting brush: java">public interface ElasticSearchClusterConfiguration
        extends ElasticSearchConfiguration
{

    /**
     * Coma separated list of nodes host:port.
     * Defaults to '127.0.0.1:9300'.
     */
    @Optional Property&lt;String&gt; nodes();

    /**
     * Allows client to sniff the rest of the cluster, and add those into its list of machines to use.
     * In this case, note that the ip addresses used will be the ones that the other nodes were started
     * with (the “publish” address).
     * Defaults to FALSE.
     */
    @UseDefaults Property&lt;Boolean&gt; clusterSniff();

    /**
     * Set to true to ignore cluster name validation of connected nodes.
     * Defaults to FALSE.
     */
    @UseDefaults Property&lt;Boolean&gt; ignoreClusterName();

    /**
     * The time to wait for a ping response from a node.
     * Defaults to 5s.
     */
    @Optional Property&lt;String&gt; pingTimeout();

    /**
     * How often to sample / ping the nodes listed and connected.
     * Defaults to 5s.
     */
    @Optional Property&lt;String&gt; samplerInterval();

}
</pre><p>Again, all configuration properties are defaulted meaning that you can use ElasticSearch Index/Query service without
configuration.</p></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-index-rdf"></a>8.17. OpenRDF Index/Query</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>Index/Query services backed by <a class="ulink" href="http://www.openrdf.org/" target="_top">OpenRDF Sesame</a> framework for processing RDF data.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_in_memory"></a>In Memory</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new RdfMemoryStoreAssembler().assemble( module );
</pre><p>No configuration needed.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_on_filesystem"></a>On Filesystem</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_16"></a>Assembly</h5></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new RdfNativeSesameStoreAssembler().assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration_15"></a>Configuration</h5></div></div></div><p>Here are the configuration properties for the Native RDF Index/Query:</p><pre class="programlisting brush: java">public interface NativeConfiguration extends ConfigurationComposite
{
    @Optional @Matches( "([spoc][spoc][spoc][spoc],?)*" ) Property&lt;String&gt; tripleIndexes();

    @Optional Property&lt;String&gt; dataDirectory();

    @UseDefaults Property&lt;Boolean&gt; forceSync();
}
</pre></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_in_a_rdbms"></a>In a RDBMS</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_assembly_17"></a>Assembly</h5></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new RdfRdbmsSesameStoreAssembler().assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_configuration_16"></a>Configuration</h5></div></div></div><p>Here are the configuration properties for the RDBMS based RDF Index/Query:</p><pre class="programlisting brush: java">public interface RdbmsRepositoryConfiguration
{
    Property&lt;String&gt; jdbcDriver();
    Property&lt;String&gt; jdbcUrl();
    Property&lt;String&gt; user();
    Property&lt;String&gt; password();
}
</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-index-solr"></a>8.18. Apache Solr Index/Query</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-good">docs</p><p class="devstatus-tests-some">tests</p><p>Index/Query services backed by an embedded <a class="ulink" href="http://lucene.apache.org/solr/" target="_top">Apache Solr Search</a>.</p><div class="warning" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png" /></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Solr Index/Query service do not support the Qi4j Query API but only native Solr queries.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_assembly_18"></a>Assembly</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">new SolrAssembler().assemble( module );
</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_17"></a>Configuration</h4></div></div></div><p>Apache Solr Index/Query exclusively use the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a> to locate the directory where it persists its index.</p><p>You must provide <code class="literal">solrconfig.xml</code> and <code class="literal">schema.xml</code> files either from the classpath or in the configuration directory of
the <a class="xref" href="#library-fileconfig" title="7.11.&#xA0;FileConfig">FileConfig Library</a>.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-indexing-sql"></a>8.19. SQL Index/Query</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-brief">docs</p><p class="devstatus-tests-good">tests</p><p>This extension fully leverage the <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a> meaning that you must use it to assemble your DataSource and that you
get <a class="link" href="#library-circuitbreaker" title="7.4.&#xA0;Circuit Breaker">Cricuit Breaker</a> and <a class="link" href="#library-jmx" title="7.13.&#xA0;JMX">JMX</a> integration for free.</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>See the <a class="xref" href="#sample-sql-support" title="5.7.&#xA0;SQL Support Sample">SQL Support Sample</a> that demonstrate combined use of <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a>, <a class="xref" href="#extension-es-sql" title="8.14.&#xA0;SQL EntityStore"> SQL EntityStore</a> and
<a class="xref" href="#extension-indexing-sql" title="8.19.&#xA0;SQL Index/Query">SQL Index/Query</a>.</p></td></tr></table></div><p>The following SQL databases are supported:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.postgresql.org/" target="_top">PostgreSQL</a>
</li></ul></div><p>Implementations per database Vendor share a generic codebase but can override about everything SQL. As a consequence
they can have strong differences in terms of performance if they use vendor specific extensions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_18"></a>Configuration</h4></div></div></div><p>SQL Index/Query Configuration is optional and provides only one configuration property: <code class="literal">schemaName</code> defaulted to
<span class="emphasis"><em>qi4j_es</em></span>. On SQL databases that don’t support schemas this configuration property is simply ignored.</p><p>The assembly snippets below show the DataSource assembly alongside the SQL Index/Query assembly. Remember to configure
the DataSource properly, see <a class="xref" href="#library-sql" title="7.33.&#xA0;SQL">SQL Library</a> and <a class="xref" href="#howto-configure-service" title="3.15.&#xA0;Configure a Service">Configure a Service</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_postgresql_2"></a>PostgreSQL</h4></div></div></div><p>Assembly is done using the provided Assembler:</p><pre class="programlisting brush: java">// DataSourceService
new DBCPDataSourceServiceAssembler().
        identifiedBy( "postgres-datasource-service" ).
        visibleIn( Visibility.module ).
        withConfig( config ).
        withConfigVisibility( Visibility.layer ).
        assemble( mainModule );

// DataSource
new DataSourceAssembler().
        withDataSourceServiceIdentity( "postgres-datasource-service" ).
        identifiedBy( "postgres-datasource" ).
        visibleIn( Visibility.module ).
        withCircuitBreaker().
        assemble( mainModule );

// SQL Index/Query
new PostgreSQLIndexQueryAssembler().
        visibleIn( Visibility.application ).
        withConfig( config ).
        withConfigVisibility( Visibility.layer ).
        assemble( mainModule );
</pre><p>Sample DataSource configuration defaults:</p><pre class="programlisting brush: java">enabled=true
url=jdbc:postgresql://localhost:5432/jdbc_test_db
driver=org.postgresql.Driver
username=jdbc_test_login
password=password</pre><div class="important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png" /></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>The PostgreSQL ltree extension is needed on the used database, see below how to install it on your database.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_installing_ltree_on_postgresql_gt_9_1"></a>Installing ltree on PostgreSQL &gt;= 9.1 ==</h5></div></div></div><p>It’s bundled with PostgreSQL but you need to activate it on your database:</p><pre class="programlisting brush: bash">CREATE EXTENSION ltree;</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_installing_ltree_on_postgresql_8656_9_0"></a>Installing ltree on PostgreSQL ⇐ 9.0</h5></div></div></div><p>You need to install postgresql-contrib and import the module in your database.
The following applies to Debian based distributions, adapt it to yours:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Install the contrib package: sudo apt-get install postgresql-contrib
</li><li class="listitem">
Restart the database: sudo /etc/init.d/postgresql-8.4 restart
</li><li class="listitem">
Change to the database owner account (e.g., postgres).
</li><li class="listitem">
Change to the contrib modules' directory: /usr/share/postgresql/8.4/contrib/
</li><li class="listitem">
Load the SQL files using: psql -U user_name -d database_name -f module_name.sql
</li></ol></div><p>For example to install the needed ltree module:</p><pre class="programlisting brush: bash">psql -U postgres -d database_name -f ltree.sql</pre></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-metrics-yammer"></a>8.20. Yammer Metrics</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Yammer Metrics</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-migration"></a>8.21. Migration</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Migration</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="extension-reindexer"></a>8.22. Reindexer</h3></div></div></div><p class="remark"><em><span class="comment"></span></em></p><p class="devstatus-code-stable">code</p><p class="devstatus-docs-none">docs</p><p class="devstatus-tests-some">tests</p><p>Reindexer</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>This Extension has no documentation yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></td></tr></table></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="tools"></a>9. Tools</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_overview_7">9.1. Overview</a></span></dt><dt><span class="section"><a href="#tools-envisage">9.2. Envisage</a></span></dt><dt><span class="section"><a href="#tools-entity-viewer">9.3. Entity Viewer</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="_overview_7"></a>9.1. Overview</h3></div></div></div><p>The Qi4j SDK comes with usefull development tools. Theses tools can come in
handy when assembled into your <a class="xref" href="#def-application">Application</a> in development
<a class="xref" href="#def-application-mode">Application Mode</a>.</p><p>The tools are available in the <code class="literal">tools/</code> directory of the Qi4j SDK.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="tools-envisage"></a>9.2. Envisage</h3></div></div></div><p>Envisage is a Swing based visualization tool for the Qi4j Application model.
Visualizations can be printed to PDFs.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_usage_3"></a>Usage</h4></div></div></div><p>Envisage can be easily used directly and prior your Application activation:</p><pre class="programlisting brush: java">public static void main( String[] args )
    throws Exception
{
    Energy4Java energy4Java = new Energy4Java();

    ApplicationDescriptor applicationModel =
        energy4Java.newApplicationModel( new SchoolAssembler() );

    new Envisage().run( applicationModel );
}
</pre><p>As you can see, Envisage operates on the ApplicationModel, this means that you
can easily embedd it in your own Applications too.</p><p>Two gradle tasks runSample and runSchool are defined in this module as a
shortcut to run the examples. See <a class="xref" href="#build-system" title="11.9.&#xA0;Build System">Build System</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_screenshots"></a>Screenshots</h4></div></div></div><p><span class="inlinemediaobject"><img src="images/tools-envisage-structure.png" width="800" alt="tools-envisage-structure.png" /></span></p><p><span class="inlinemediaobject"><img src="images/tools-envisage-type.png" width="800" alt="tools-envisage-type.png" /></span></p><p><span class="inlinemediaobject"><img src="images/tools-envisage-stacked.png" width="800" alt="tools-envisage-stacked.png" /></span></p><p><span class="inlinemediaobject"><img src="images/tools-envisage-stacked-collapsed.png" width="800" alt="tools-envisage-stacked-collapsed.png" /></span></p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="tools-entity-viewer"></a>9.3. Entity Viewer</h3></div></div></div><p>EntityViewer is a Swing based Entities browser. It allows you to browse
Entities persisted in EntityStores.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_usage_4"></a>Usage</h4></div></div></div><p>EntityViewer can easily be used as follows:</p><pre class="programlisting brush: java">new EntityViewer().show( qi4j.spi(), applicationModel, application );
</pre><p>A gradle task runSample is defined in this module as a shortcut to run the
example. See <a class="xref" href="#build-system" title="11.9.&#xA0;Build System">Build System</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_screenshot"></a>Screenshot</h4></div></div></div><p><span class="inlinemediaobject"><img src="images/tools-entity-viewer.png" width="800" alt="tools-entity-viewer.png" /></span></p></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="glossary"></a>10. Glossary </h2></div></div></div><div class="glossary"><div class="titlepage"><div><div><h3 class="title"><a id="_glossary"></a>Glossary</h3></div></div></div><p>There are a lot of concepts in Qi4j which may have different meanings in other contexts. So in true DDD-style
ubiquitous language, we are here listing the definitions of the terms and concepts that are being used.</p><dl><dt>
<a id="def-abstract-mixin"></a>Abstract Mixin
</dt><dd><p>An Abstract Mixin is an implementation of the <a class="xref" href="#def-mixin-type">MixinType</a> interface, but is an abstract class and has not
implemented all the methods.</p><p>The Qi4j runtime can use multiple <a class="link" href="#def-mixin">Mixins</a> for each <a class="xref" href="#def-mixin-type">MixinType</a> interface. It is also possible to let
a <a class="xref" href="#def-generic-mixin">Generic Mixin</a> handle the remaining missing methods.</p></dd><dt>
<a id="def-abstract-modifier"></a>Abstract Modifier
</dt><dd><p>Abstract Modifiers are <a class="link" href="#def-modifier">Modifiers</a> that do not implement all the methods of the <a class="xref" href="#def-mixin-type">MixinType</a>
interface.</p><p>This works essentially in the same manner as the <a class="xref" href="#def-abstract-mixin">Abstract Mixin</a>. And the methods that are not implemented
will not be part of the <a class="xref" href="#def-invocation-stack">Invocation Stack</a> of those methods.</p></dd><dt>
<a id="def-application"></a>Application
</dt><dd><p>Application is the top level concept handled by the Qi4j runtime instance. It holds the information about the
<a class="link" href="#def-layer">Layers</a> in the application architecture. See <a class="xref" href="#def-structure">Structure</a> for more information.</p><p>There is one and only one Application instance per Qi4j Runtime instance.</p></dd><dt>
<a id="def-application-mode"></a>Application Mode
</dt><dd><p>During the Bootstrap phase an <a class="xref" href="#def-application">Application</a> is given a Mode that can be <span class="emphasis"><em>test</em></span>, <span class="emphasis"><em>development</em></span>, <span class="emphasis"><em>staging</em></span> or
<span class="emphasis"><em>production</em></span>.</p><p>See <a class="xref" href="#core-bootstrap-assembly" title="6.3.&#xA0;Core Bootstrap">Assembly</a>.</p></dd><dt>
<a id="def-association"></a>Association
</dt><dd><p>An Association is a reference to an <a class="xref" href="#def-entitycomposite">Entity Composite</a>.</p><p>References to <a class="link" href="#def-entitycomposite">Entities</a> must be maintained in <a class="link" href="#def-association">Associations</a>. It is illegal to
define a <a class="xref" href="#def-property">Property</a> with an <a class="xref" href="#def-entitycomposite">Entity Composite</a> as its type.</p></dd><dt>
<a id="def-composite"></a>Composite
</dt><dd><p>A Composite is an instance of a <a class="xref" href="#def-composite-type">Composite Type</a>.</p><p>However, we often speak of Composites when we actually mean CompositeType, similarly as we often speak of objects
when we really are talking of classes in OOP.</p></dd><dt>
<a id="def-composite-context"></a>Composite Context
</dt><dd><p>A Composite Context is a mechanism to separate the state of a <a class="xref" href="#def-transientcomposite">TransientComposite</a> across two or more threads.
If a thread modifies a value, only that thread will see the changes, another thread will have its values protected
by the thread boundaries. Use-cases for this include user credentials on which behalf the thread is executing.</p></dd><dt>
<a id="def-composite-metatype"></a>Composite Meta Type
</dt><dd><p>There are 5 Composite Meta Types defined in Qi4j, which each share the composition features but have distinct
semantic differences.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#def-entitycomposite">Entity Composite</a>
</li><li class="listitem">
<a class="xref" href="#def-valuecomposite">ValueComposite</a>
</li><li class="listitem">
<a class="xref" href="#def-servicecomposite">Service composite</a>
</li><li class="listitem">
<a class="xref" href="#def-configurationcomposite">Configuration Composite</a> (subtype of EntityComposite)
</li><li class="listitem">
<a class="xref" href="#def-transientcomposite">TransientComposite</a>
</li></ul></div></dd><dt>
<a id="def-composite-type"></a>Composite Type
</dt><dd><p>CompositeType is the Java interface that declares the composition, from which <a class="xref" href="#def-composite">Composite</a> instances can be
created.</p><p>Composite Type interfaces must be a sub-type of one of the 5 <a class="link" href="#def-composite-metatype">Composite Meta Types</a> defined in
Qi4j otherwise it can not be instantiated.</p></dd><dt>
<a id="def-concern"></a>Concern
</dt><dd><p>A concern is a stateless <a class="xref" href="#def-fragment">Fragment</a>, shared between invocations, that acts as an interceptor of the call to
the <a class="xref" href="#def-mixin">Mixin</a>. The Concern is a Java class, that either implements the <a class="xref" href="#def-mixin-type">MixinType</a> it can be used on, or
java.lang.reflect.InvocationHandler which allows it to be used on any arbitrary <a class="xref" href="#def-mixin-type">MixinType</a>.</p><p>Concerns have many purposes, but they are not intended to produce side effects (see <a class="xref" href="#def-sideeffect">SideEffect</a>). Use-cases
involves;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Transaction handling.
</li><li class="listitem">
Call Tracing.
</li><li class="listitem">
User security.
</li></ul></div><p>Concerns are established by the use of the @Concerns annotation on composites.</p><p>Concern is one of the 3 kinds of <a class="link" href="#def-modifier">Modifiers</a> defined in Qi4j.</p></dd><dt>
<a id="def-configurationcomposite"></a>Configuration Composite
</dt><dd><p>Service Composites can have configuration associated to it and that is done via
<a class="link" href="#def-configurationcomposite">Configuration Composites</a>, which are a subtype of <a class="xref" href="#def-entitycomposite">Entity Composite</a>, as they are
stored permanently in configured Entity Stores. Configuration Composites are also initialized automatically from
properties files first time. Note that on consequent start-ups the properties file is not read, as the configuration is
read from the EntityStore.</p><p>ConfigurationComposite is one of the 5 <a class="link" href="#def-composite-metatype">Composite Meta Types</a> defined in Qi4j.</p><p>See <a class="xref" href="#howto-configure-service" title="3.15.&#xA0;Configure a Service">Configure a Service</a> to learn how to use Configuration Composites.</p></dd><dt>
<a id="def-constraint"></a>Constraint
</dt><dd><p>Constraints are a kind of validators, which are consulted prior to invoking the method call. Qi4j currently only
supports ParameterConstraints on methods and value constraints on <a class="link" href="#def-property">Properties</a>, but future versions will
include Constraint types for checking complete method calls and return values.</p><p>See <a class="xref" href="#core-api-constraint" title="Constraint">Constraint</a> for better understanding of its details.</p><p>See <a class="xref" href="#library-constraints" title="7.5.&#xA0;Constraints">Constraints Library</a> for ready to use Constraints.</p><p>See <a class="xref" href="#howto-create-constraint" title="3.17.&#xA0;Create a Constraint">Create a Constraint</a> to learn how to write your own Constraints.</p><p>Constraint is one of the 3 kinds of <a class="link" href="#def-modifier">Modifiers</a> defined in Qi4j.</p></dd><dt>
<a id="def-entitycomposite"></a>Entity Composite
</dt><dd><p>An Entity Composite, or just Entity for short, is a persisted composite with an <a class="xref" href="#def-identity">Identity</a>. An entity only has
scope within an <a class="xref" href="#def-unitofwork">UnitOfWork</a> and is therefor inherently thread-safe.</p><p>EntityComposite is one of the 5 <a class="link" href="#def-composite-metatype">Composite Meta Types</a> defined in Qi4j.</p></dd><dt>
<a id="def-fragment"></a>Fragment
</dt><dd><p>A part of the implementation of a <a class="xref" href="#def-composite">Composite</a>. There are 4 fragment types:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#def-mixin">Mixin</a>
</li><li class="listitem">
<a class="xref" href="#def-concern">Concern</a>
</li><li class="listitem">
<a class="xref" href="#def-constraint">Constraint</a>
</li><li class="listitem">
<a class="xref" href="#def-sideeffect">SideEffect</a>.
</li></ul></div></dd><dt>
<a id="def-generic-fragment"></a>Generic Fragment
</dt><dd><p>Generic Fragments are <a class="link" href="#def-fragment">Fragments</a> that implements java.lang.reflect.InvocationHandler and potentially
capable of being used for all <a class="link" href="#def-mixin-type">MixinTypes</a>. This is the direct opposite of the Typed Fragments, which
implements the <a class="xref" href="#def-mixin-type">MixinType</a> interface.</p></dd><dt>
<a id="def-generic-mixin"></a>Generic Mixin
</dt><dd><p>A Generic Mixin implements the java.lang.reflect.InvocationHandler. The invoke() method will be called for all
<a class="xref" href="#def-mixin-type">MixinType</a> methods that the <a class="xref" href="#def-mixin">Mixin</a> has been matched with, through the matching rules.</p><p>It is potentially possible that the Generic Mixin also implements the <a class="xref" href="#def-mixin-type">MixinType</a> interface. In that case, the
concrete methods will be called, but if the <a class="xref" href="#def-mixin">Mixin</a> is also an abstract class, then the invoke() method will be
called for the methods that has been match but are not present.</p></dd><dt>
<a id="def-identity"></a>Identity
</dt><dd><p>TODO</p><p>This term has no definition yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></dd><dt>
<a id="def-invocation-stack"></a>Invocation Stack
</dt><dd><p>For each method, Qi4J will create and re-use an Invocation Stack. It will be built with the sequence of
<a class="link" href="#def-modifier">Modifiers</a> and an end-point that will link into the stateful <a class="xref" href="#def-mixin">Mixin</a>.</p><p>It is important to recognize that, for memory footprint reasons, Invocation Stacks are shared across
<a class="link" href="#def-composite">Composites</a> of the same <a class="xref" href="#def-composite-type">Composite Type</a>. They are however thread-safe, in that Qi4j will never
bind the same Invocation Stack to more than one <a class="xref" href="#def-composite">Composite</a> instance during a method call, but that between method
invocations the <a class="link" href="#def-modifier">Modifiers</a> in the Invocation Stack can not assume that it is bound to the same
<a class="xref" href="#def-composite">Composite</a> instance. Therefor, <a class="link" href="#def-modifier">Modifiers</a> are not expected to keep state between method
invocations, and when it needs to do that, then it should reference a <a class="xref" href="#def-mixin">Mixin</a> via the @This annotation. Qi4j will
during the binding of the Invocation Stack to the <a class="xref" href="#def-composite">Composite</a>, also ensure that all referenced
<a class="link" href="#def-mixin">Mixins</a> are correctly injected in the Invocation Stack.</p></dd><dt>
<a id="def-layer"></a>Layer
</dt><dd><p>Qi4j promotes a Layered application design, where Layers can only access lower Layers and not higher Layers or Layers at
the same level.</p></dd><dt>
<a id="def-manyassociation"></a>ManyAssociation
</dt><dd><p>TODO</p><p>This term has no definition yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></dd><dt>
<a id="def-metainfo"></a>MetaInfo
</dt><dd><p>TODO</p><p>This term has no definition yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></dd><dt>
<a id="def-mixin"></a>Mixin
</dt><dd><p>The Mixin is the instance providing the stateful representation of the <a class="xref" href="#def-mixin-type">MixinType</a>. This can either be a class
implementing the <a class="xref" href="#def-mixin-type">MixinType</a> or a java.lang.reflect.InvocationHandler that is generic to handle any or a subset
of <a class="xref" href="#def-mixin-type">MixinType</a>.</p></dd><dt>
<a id="def-mixin-type"></a>MixinType
</dt><dd><p>The MixinType is the static type of a part of the <a class="xref" href="#def-composite">Composite</a>. The MixinType is an interface that defines the methods
to be exposed in the <a class="xref" href="#def-composite">Composite</a>.</p></dd><dt>
<a id="def-modifier"></a>Modifier
</dt><dd><p>Modifiers are stateless interceptors of method calls, that forms an <a class="xref" href="#def-invocation-stack">Invocation Stack</a>. The top of the
<a class="xref" href="#def-invocation-stack">Invocation Stack</a> is linked to the <a class="xref" href="#def-composite">Composite</a> invocation handler and the bottom of the
<a class="xref" href="#def-invocation-stack">Invocation Stack</a> is linked to the <a class="link" href="#def-mixin">Mixins</a>. <a class="link" href="#def-invocation-stack">Invocation Stacks</a> are shared,
so Modifiers must assume that the member fields will only be valid within a single method invocation.</p><p>There are 3 kinds of Modifiers;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="xref" href="#def-constraint">Constraint</a>
</li><li class="listitem">
<a class="xref" href="#def-concern">Concern</a>
</li><li class="listitem">
<a class="xref" href="#def-sideeffect">SideEffect</a>
</li></ul></div></dd><dt>
<a id="def-module"></a>Module
</dt><dd><p>Modules defines the scope of the <a class="link" href="#def-composite">Composites</a>. Modules are wired with Assemblies, and can expose
<a class="link" href="#def-composite">Composites</a> as visible. Non-visible <a class="link" href="#def-composite">Composites</a> are not reachable from other Modules.</p></dd><dt>
<a id="def-private-mixin"></a>Private Mixin
</dt><dd><p>When a @This injection refers to a <a class="xref" href="#def-mixin-type">MixinType</a> which is not extended by the <a class="xref" href="#def-composite-type">Composite Type</a> the former
becomes a private <a class="xref" href="#def-mixin-type">MixinType</a>.</p></dd><dt>
<a id="def-property"></a>Property
</dt><dd><p>TODO</p><p>This term has no definition yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p><p>See the <a class="xref" href="#howto-leverage-properties" title="3.20.&#xA0;Leverage Properties">Leverage Properties</a> how-to.</p></dd><dt>
<a id="def-servicecomposite"></a>Service Composite
</dt><dd><p>Service Composite is a subtype of <a class="xref" href="#def-composite">Composite</a>, and has a range of features built into it.</p><p>ServiceComposite is one of the 5 <a class="link" href="#def-composite-metatype">Composite Meta Types</a> defined in Qi4j.</p><p>See the <a class="link" href="#core-api-service" title="Service Composite">Service Composite chapter</a>.</p></dd><dt>
<a id="def-sideeffect"></a>SideEffect
</dt><dd><p>A side effect is a stateless <a class="xref" href="#def-fragment">Fragment</a>, shared between invocations, that acts as an interceptor of the call to
the <a class="xref" href="#def-mixin">Mixin</a>. The SideEffect is a Java class, that either implements the <a class="xref" href="#def-mixin-type">MixinType</a> it can be used on, or
java.lang.reflect.InvocationHandler which allows it to be used on any arbitrary <a class="xref" href="#def-mixin-type">MixinType</a>.</p><p>SideEffects are executed after the completion of the method invocation and therefore cannot change parameters nor
eventually returned object.</p><p>SideEffects have many purposes. Use-cases
involves;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Sending emails.
</li><li class="listitem">
Call Tracing.
</li><li class="listitem">
Domain side effects modeling.
</li></ul></div><p>SideEffects are established by the use of the @SideEffects annotation on composites.</p><p>SideEffect is one of the 3 kinds of <a class="link" href="#def-modifier">Modifiers</a> defined in Qi4j.</p></dd><dt>
<a id="def-structure"></a>Structure
</dt><dd><p>Qi4j promotes a conventional view of application structure, that computer science has been using for decades.</p><p>The definition is as follows;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
One <a class="xref" href="#def-application">Application</a> per Qi4j runtime instance.
</li><li class="listitem">
One or more <a class="link" href="#def-layer">Layers</a> per <a class="xref" href="#def-application">Application</a>.
</li><li class="listitem">
Zero, one or more <a class="link" href="#def-module">Modules</a> per <a class="xref" href="#def-layer">Layer</a>.
</li><li class="listitem">
Zero, one or more Assemblies per <a class="xref" href="#def-module">Module</a>.
</li></ul></div><p>The principle of this Structure is to assist the programmer to create well modularized applications, that are easily
extended and maintained. Qi4j will restrict access between <a class="link" href="#def-module">Modules</a>, so that code can only reach
<a class="link" href="#def-composite">Composites</a> and Objects in <a class="link" href="#def-module">Modules</a> (including itself) of the same or lower
<a class="link" href="#def-layer">Layers</a>.</p><p>Each <a class="xref" href="#def-layer">Layer</a> has to be declared which lower <a class="link" href="#def-layer">Layer(s)</a> it uses, and it is not allowed that a lower
<a class="xref" href="#def-layer">Layer</a> uses a higher <a class="xref" href="#def-layer">Layer</a>, i.e. cyclic references.</p></dd><dt>
<a id="def-transientcomposite"></a>TransientComposite
</dt><dd><p>TransientComposite is a <a class="xref" href="#def-composite-metatype">Composite Meta Type</a> for all other cases. The main characteristics are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It can not be serialized nor persisted.
</li><li class="listitem">
hashcode/equals are not treated specially and will be delegated to <a class="link" href="#def-fragment">Fragment(s)</a> implementing those methods.
</li><li class="listitem">
It can not be used as a <a class="xref" href="#def-property">Property</a> type.
</li></ul></div></dd><dt>
<a id="def-unitofwork"></a>UnitOfWork
</dt><dd><p>TODO</p><p>This term has no definition yet. Learn how to contribute in <a class="xref" href="#community-docs" title="11.14.&#xA0;Writing Qi4j Documentation">Writing Documentation</a>.</p></dd><dt>
<a id="def-valuecomposite"></a>ValueComposite
</dt><dd><p>Usage of value objects is one of the most ignored and best return-on-investment the programmer can do. Values are
immutable and can be compared by value instead of memory reference. Concurrency is suddenly not an issue, since either
the value exists or it doesn’t, no need for synchronization. Values are typically very easy to test and very robust to
refactoring.</p><p>Qi4j defines values as a primary meta type through the ValueComposite, as we think the benefits of values are great.
The ValueComposite is very light-weight compared to the <a class="xref" href="#def-entitycomposite">Entity Composite</a>, and its value can still be persisted as
part of an <a class="xref" href="#def-entitycomposite">Entity Composite</a> via a <a class="xref" href="#def-property">Property</a>.</p><p>The characteristics of a ValueComposite compared to other <a class="link" href="#def-composite-metatype">Composite Meta Types</a> are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
It is Immutable.
</li><li class="listitem">
Its equals/hashCode works on the values of the ValueComposite.
</li><li class="listitem">
Can be used as <a class="xref" href="#def-property">Property</a> types, but will not be indexed and searchable.
</li></ul></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h2 class="title" style="clear: both"><a id="community"></a>11. Community</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#community-intro">11.1. Introduction</a></span></dt><dt><span class="section"><a href="#download">11.2. Download Qi4j</a></span></dt><dt><span class="section"><a href="#help">11.3. Get Help</a></span></dt><dt><span class="section"><a href="#codebase">11.4. Codebase</a></span></dt><dt><span class="section"><a href="#participate">11.5. Participate</a></span></dt><dt><span class="section"><a href="#playing-field">11.6. Playing Field</a></span></dt><dt><span class="section"><a href="#community-contributing">11.7. Contributing to Qi4j</a></span></dt><dt><span class="section"><a href="#issue-tracker">11.8. Issue Tracker</a></span></dt><dt><span class="section"><a href="#build-system">11.9. Build System</a></span></dt><dt><span class="section"><a href="#continuous-integration">11.10. Continuous Integration</a></span></dt><dt><span class="section"><a href="#contributors">11.11. People behind Qi4j</a></span></dt><dt><span class="section"><a href="#licensing">11.12. Licensing</a></span></dt><dt><span class="section"><a href="#licensing-faq">11.13. Licensing FAQ</a></span></dt><dt><span class="section"><a href="#community-docs">11.14. Writing Qi4j Documentation</a></span></dt></dl></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="community-intro"></a>11.1. Introduction</h3></div></div></div><div class="partintro"><div></div><p>Qi4j is an open development community effort with an Apache ver 2.0 open source license.</p>IntroductionQi4j is an open development community effort with an Apache ver 2.0 open source license.What does this really mean?First of all, we work together to achieve the visions of Qi4j, based on technical merits alone in an open and friendly
manner, mostly via qi4j-dev forum at Google Groups.. It means that everyone in the community are stake holders in the
resulting codebase, and noone can claim it is mine.Secondly, all source code, artwork and documentation produced in Qi4j are licensed very liberally under the Apache
License ver 2.0. This allows you to use our efforts in your own projects, whether they are open sourced, commercial or
any other arrangement you like, subject to a few terms like "Must re-distribute a Notice that your product contains
Qi4j" and such. See the License text for exact details, and please consult with IP rights lawyers about this and other
Open Source licenses.Thirdly, Qi4j invites everyone to participate. There are many ways to participate, not only by writing code. See list
in .</div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_what_does_this_really_mean"></a>What does this really mean?</h4></div></div></div><p>First of all, we work together to achieve the visions of Qi4j, based on technical merits alone in an open and friendly
manner, mostly via qi4j-dev forum at Google Groups.. It means that everyone in the community are stake holders in the
resulting codebase, and noone can claim it is mine.</p><p>Secondly, all source code, artwork and documentation produced in Qi4j are licensed very liberally under the Apache
License ver 2.0. This allows you to use our efforts in your own projects, whether they are open sourced, commercial or
any other arrangement you like, subject to a few terms like "Must re-distribute a Notice that your product contains
Qi4j" and such. See the License text for exact details, and please consult with IP rights lawyers about this and other
Open Source licenses.</p><p>Thirdly, Qi4j invites everyone to participate. There are many ways to participate, not only by writing code. See list
in <a class="xref" href="#participate" title="11.5.&#xA0;Participate">Participation Section</a>.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="download"></a>11.2. Download Qi4j</h3></div></div></div><p>Thank you for downloading this release of the Qi4j SDK. Qi4j is a framework for domain centric application
development, including evolved concepts from <a class="ulink" href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_top">AOP</a>,
<a class="ulink" href="http://en.wikipedia.org/wiki/Dependency_injection" target="_top">DI</a> and <a class="ulink" href="http://en.wikipedia.org/wiki/Domain-driven_design" target="_top">DDD</a>.</p><p>Using Gradle, Maven, SBT, Ivy or any other build system that provide dependency management? Learn how to
<a class="link" href="#howto-depend-on-qi4j" title="3.13.&#xA0;Depend on Qi4j in your build">depend on Qi4j in your build</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_latest_release"></a>Latest release</h4></div></div></div><div class="informaltable"><table cellspacing="0" cellpadding="0" border="1"><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th align="left" valign="top"> Download                                                                                                                       </th><th align="left" valign="top"> </th></tr></thead><tbody><tr><td align="left" valign="top"><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/release/org/org.qi4j/1.4/org.qi4j-1.4-bin.zip" target="_top">org.qi4j-1.4-bin.zip</a></p></td><td align="left" valign="top"><p>Qi4j SDK zip Binary Distribution</p></td></tr><tr><td align="left" valign="top"><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/release/org/org.qi4j/1.4/org.qi4j-1.4-bin.tgz" target="_top">org.qi4j-1.4-bin.tgz</a></p></td><td align="left" valign="top"><p>Qi4j SDK tar.gz Binary Distribution</p></td></tr><tr><td align="left" valign="top"><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/release/org/org.qi4j/1.4/org.qi4j-1.4-src.zip" target="_top">org.qi4j-1.4-src.zip</a></p></td><td align="left" valign="top"><p>Qi4j SDK zip Sources Distribution</p></td></tr><tr><td align="left" valign="top"><p><a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/release/org/org.qi4j/1.4/org.qi4j-1.4-src.tgz" target="_top">org.qi4j-1.4-src.tgz</a></p></td><td align="left" valign="top"><p>Qi4j SDK tar.gz Sources Distribution</p></td></tr></tbody></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_weekly_builds"></a>Weekly builds</h4></div></div></div><p>The Qi4j <a class="xref" href="#continuous-integration" title="11.10.&#xA0;Continuous Integration">Continuous Integration</a> produces the same distributions from the develop branch weekly.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="help"></a>11.3. Get Help</h3></div></div></div><p>Join the Google Groups qi4j-dev forum to discuss and get help, or help others on Stackoverflow.</p><p>If you found a bug or want to request a new feature, use the <a class="xref" href="#issue-tracker" title="11.8.&#xA0;Issue Tracker">Issue Tracker</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_questions_amp_answers"></a>Questions &amp; Answers</h4></div></div></div><p>To post question to and get answers from the Qi4j community, go to
<a class="ulink" href="http://stackoverflow.com/questions/tagged/qi4j" target="_top">StackOverflow</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_discussion"></a>Discussion</h4></div></div></div><p>To discuss with the Qi4j community, it is easiest to do so at the Google Groups
<a class="ulink" href="https://groups.google.com/forum/?fromgroups#!forum/qi4j-dev" target="_top">qi4j-dev forum</a>.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="codebase"></a>11.4. Codebase</h3></div></div></div><p>After the first 3 years of depending on the OPS4J project, the Qi4j community finally moved to GitHub on
the 1 November 2010. This should simplify the learning, as not only does developers have plenty of experience with
GitHub external link and the tools it provides, but also there are endless amount of documentation and user forums to
support each individual, off-loading some of that burden from us. This page only contain rudimentary information.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_public_access_repository"></a>Public Access Repository</h4></div></div></div><p>Qi4j differs slightly from the regular project, due to our specific needs and style of development. the main differences
are;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Qi4j uses the <span class="emphasis"><em>develop</em></span> branch for the day to day changes to the project. The <span class="emphasis"><em>master</em></span> branch is used for the
      latest releases. See below about the <span class="emphasis"><em>Git Development Model</em></span>.
</li><li class="listitem">
Qi4j uses a social contract to limit access to different areas of the project, instead of ACLs. The driving point
      is to relax the contribution criteria in less critical parts, to encourage a wider participation that otherwise
      would not be possible.
</li></ul></div><p>Qi4j used to have many repositories to accommodate for the authorization issue above, but eventually settled with a
single GitHub repository, and now only have 2 repositories;</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
qi4j-sdk
</li><li class="listitem">
qi4j-sandbox
</li></ul></div><p>The sandbox is where experimental code goes, and modules that are not ready to be shipped, or can not be shipped due to
licensing restrictions (e.g. Oracle doesn’t provide Coherence as automatic download for our testing, so can’t really
ship the coherence extension). The sandbox is a normal GitHub repository available to clone as;
git clone git://github.com/Qi4j/qi4j-sandbox.git</p><p>The Qi4j SDK is the main development codebase, and to start working with it you simply clone it;</p><pre class="programlisting brush: bash">git clone git://github.com/Qi4j/qi4j-sdk.git</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_web_access"></a>Web Access</h4></div></div></div><p><a class="ulink" href="http://github.com/Qi4j/qi4j-sdk" target="_top">http://github.com/Qi4j/qi4j-sdk</a></p><p><a class="ulink" href="http://github.com/Qi4j/qi4j-sandbox" target="_top">http://github.com/Qi4j/qi4j-sandbox</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_committer_access"></a>Committer Access</h4></div></div></div><p>Qi4j has a 3 level committer access system. The groups are "Core", "Platform" and "Community" and the roles are very
clear.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_developers"></a>Core Developers</h4></div></div></div><p>These are the guardians and stewards of the core technology and ultimate rulers of what is going on. The hope is that
a small group of benevolent dictators will manage to make Qi4j the best platform out there, and not listen in on the
voices of features and changes that derails the vision and principles of Qi4j.</p><div class="important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png" /></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Over the course of Qi4j’s history, there have been several occasions where brilliant developers got caught
up in <span class="emphasis"><em>feature improvements</em></span> which went against the fibers of Qi4j philosophy and technological direction. IF we would
have had an <span class="emphasis"><em>open door</em></span> policy to changes in Core, these <span class="emphasis"><em>improvements</em></span> would have degraded the excellence of Qi4j, and
we are not likely to invite anyone to the Core Developer team, unless the individual shows remarkable understanding of
the inner workings of Qi4j, the philosophy that drives Qi4j and prudence in working on highly sensitive codebases. In
return we will strive for making the Qi4j Core as small as possible, having most features in libraries and extensions.
We welcome any suggestions that breaks out pluggable functionality. We apologize in advance if this comes across as
elitist, but the purpose is to ensure a high quality Qi4j Runtime, stable over time and not bloating with unnecessary
features. Thanks for understanding.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_platform_developers"></a>Platform Developers</h4></div></div></div><p>These form the work force of Qi4j. They will work on the Extensions and Libraries, which eventually will make Qi4j the
most efficient way of programming in Java.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_community_developers"></a>Community Developers</h4></div></div></div><p>Any person who is interested in helping out with Qi4j will be granted access to Sandbox, Tests, IDE support, Tutorials,
Samples, HowTos, documentation and other (i.e. not Core, Libraries and Extensions). This will gauge their abilities
and commitment to the project, with an aim to make them Platform Developers.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_independents"></a>Independents</h4></div></div></div><p>Of course, Git’s distributed nature also allows anyone to fork our repositories, and have the patches find their way
back to Qi4j’s official repository. And GitHub’s pull-request system makes the management of this a lot easier, and
something that we encourage.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_how_to_join"></a>How to Join?</h4></div></div></div><p>To become a Community Developer, just subscribe to the qi4j-dev at Google Group and request it together
with your GitHub user id. For Community Developer, the bar is really, really low and nothing more than a desire to help
is required.</p><p>Community Developers who are active and keep contributing feedback, patches and/or documentation are likely to be
invited as Platform Developers, who has access to everything except the delicate qi4j-core, which we intend to keep a
lot more clean and stable than a free-for-all repository has a tendency to become over time.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_how_to_get_access_to_the_writable_central_repositories"></a>How to get Access to the writable central repositories?</h4></div></div></div><p>Once you have commit access to a repository, you will access it differently. This is the clone command needed, and
after that you will need to do the same as above for pubic access;</p><pre class="programlisting brush: bash">git clone git@github.com:Qi4j/qi4j-sdk.git
cd qi4j-sdk</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_commit_policy"></a>Commit Policy</h4></div></div></div><p>Qi4j generally uses a Commit-Then-Review policy on most changes. This allows a reasonable high velocity of development.</p><p>Commits are visible at GitHub and active contributors should review all incoming commits to ensure quality of
contributions and avoidance of mistakes.</p><p>For any given commit, any member of the community may raise concern(s) on the qi4j-dev forum at Google Groups. We
encourage as many people as possible to review the changes that are occurring. "With enough eyeballs every bug is
shallow." wrote Eric S. Raymond in "The Cathedral and The Bazaar" about open source.</p><p>Special rules applies to changes in the Core Test suite. Adding new tests are CTR, but modifying existing tests, either
to accommodate for code changes in Core or to tighten the constraints of them, MUST be discussed on the qi4j-dev forum
at Google Groups, prior to committing them to the <span class="emphasis"><em>develop</em></span> branch. We recommend that a different branch is used for
these changes, unless simply codesnippets are pasted to mail. This exists to ensure that we have a stable evolution of
Qi4j Runtime, and no surprises will occur in existing applications with new versions.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_git_development_model"></a>Git Development Model</h4></div></div></div><p>Courtesy of Vincent Driessen, we borrowed the Git branching model from this web page;
<a class="ulink" href="http://nvie.com/posts/a-successful-git-branching-model/" target="_top">http://nvie.com/posts/a-successful-git-branching-model/</a></p><p><span class="inlinemediaobject"><img src="images/git-model.png" alt="Git Development Model" /></span></p><p>The most important part of that excellent article can be found below.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_git_branching_model_used_at_qi4j"></a>Git Branching Model used at Qi4j</h4></div></div></div><p>It looks more complicated than it is. Here are the guidelines;</p><pre class="literallayout">Never commit to the 'master' branch while developing!!
The 'develop' branch is the equivalent of trunk in subversion.
Any changes that are not trivial, start a feature branch.
The following names are reserved for not feature branches; master, develop, hotfix/*, release/*</pre><p>Day-to-day development revolves around the develop branch and it is this branch that you typically clone from our
repository if you intend to contribute to Qi4j itself. If you create a new feature, or make some larger piece of
refactoring, then please create a <span class="emphasis"><em>feature branch</em></span> (see article for details).</p><p>Please try to remember the --no-fast-forward option during merge, so the feature branch is preserved in one piece and
can be rolled back easily if needed.</p><p>The release/* and hotfix/* branches are for release management only, and doesn’t affect most contributors from a commit
perspective. Release Managers - Check the article for the details.</p><p>For convenience you should install and use the gitflow git extension that implement this branching model by adding git
commands. See the gitflow web page; <a class="ulink" href="https://github.com/nvie/gitflow" target="_top">https://github.com/nvie/gitflow</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_how_do_i_do_my_first_commit"></a>How do I do my first commit?</h4></div></div></div><p>We strongly encourage people to read up on Git basics at for instance kernel.org. But some basic commands are discussed
here.</p><pre class="programlisting brush: bash">git status</pre><p>shows you what has not been committed.</p><pre class="programlisting brush: bash">git add &lt;filename&gt;</pre><p>all files(!) must be added. Directories are not considered and generally ignored. You can add with wildcards, even if
some files have already been added.</p><pre class="programlisting brush: bash">git commit -a -m "&lt;some message&gt;"</pre><p>This commits the current branch to the local repository. The -a means commit all files, and not only the ones that are
explicitly mentioned on this command. The message should be informative as it will follow the patch <span class="emphasis"><em>forever</em></span>.</p><pre class="programlisting brush: bash">git push origin develop</pre><p>Pushes the local commits back to the <span class="emphasis"><em>origin</em></span>, i.e. the place the clone came from, or to the location that you have
moved the <span class="emphasis"><em>origin</em></span> to be instead (see above).</p><pre class="programlisting brush: bash">git pull origin develop</pre><p>Pulls/downloads the changes of the <span class="emphasis"><em>develop</em></span> branch from the <span class="emphasis"><em>origin</em></span> of your local clone. In subversion terms, this
roughly corresponds to a <span class="emphasis"><em>svn update</em></span> of the trunk.</p><pre class="programlisting brush: bash">git branch</pre><p>Shows which branch we are working on.</p><pre class="programlisting brush: bash">git checkout -b my_new_feature_branch</pre><p>Creates a new branch with the given name, unless one already exist, and make the <span class="emphasis"><em>current</em></span> branch to be the
"my_new_feature_branch".</p><p>When you do a checkout of a branch, the local changes in the current branch that are not committed are not lost, but
are also <span class="emphasis"><em>moved along</em></span> to the new branch. And if those changes are then committed in the <span class="emphasis"><em>my_new_feature_branch</em></span> and
one switch back the changes are not there, now sitting in the <span class="emphasis"><em>my_new_feature_branch</em></span> only. This is very handy if one
forgets to create and move to a branch before modifying the <span class="emphasis"><em>develop</em></span> branch.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_using_github_pull_requests"></a>Using Github Pull Requests</h4></div></div></div><p>Pull requests let you tell others about changes you’ve pushed to a GitHub repository. Once a pull request is sent,
interested parties can review the set of changes, discuss potential modifications, and even push follow-up commits if
necessary.</p><p>Github’s guide to Pull Requests walks through the process of sending a hypothetical pull request and using the various
code review and management tools to take the change to completion. This guide can be found here;
<a class="ulink" href="https://help.github.com/articles/using-pull-requests" target="_top">https://help.github.com/articles/using-pull-requests</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_what_happened_to_the_emphasis_master_emphasis_branch"></a>What happened to the <span class="emphasis"><em>master</em></span> branch?</h4></div></div></div><p>In case you missed it above, check the model that we used for development. The intent is that the <span class="emphasis"><em>master</em></span> branch is
always in a good state and the HEAD is at a formal release (and has a tag for that).</p><p>Patches only enters the <span class="emphasis"><em>master</em></span> branch either from a <span class="emphasis"><em>hotfix/<span class="strong"><strong></strong></span> or a <span class="emphasis"><em>release/</em></span></em></span> branch, never directly from <span class="emphasis"><em>develop</em></span>
or feature branches.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="participate"></a>11.5. Participate</h3></div></div></div><p>Qi4j is a community based on open development principles. That means we do the work in open, discussions happen on
qi4j-dev forum at Google Groups and everyone is free to participate.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_principles_of_participation"></a>Principles of Participation</h4></div></div></div><p>(not enforced yet)
We borrow a lot of our principles in community building from OPS4J, which also provides us with the infrastructure
needs we have for the time being. OPS4J is unique that it allows everyone to participate and modify the codebase
without being voted into the community, like Apache and other communities. We want the spirit of this, but we are a bit
nervous that Qi4j will be too successful and too many people want to modify the core pieces and some will spoil more
than progress.
We have therefor concluded that we will, at least initially, confine the Qi4j Core to entrusted members of the
community only, whereas everyone is free to participate in the many other sub-projects, such as extensions, libraries
and integration solutions. By the introduction of Git, it is now much easier for people to work on any part of the
system, even if they have no official commit rights and allow people to review the work, then commit it and the right
person gets the credit.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_dev_team"></a>Core Dev Team</h4></div></div></div><p>The Core team are the Stewards and Guardians of the overall project. They ensure that all pieces of Qi4j are in good
standing and assist in all matters of the project. Only the Core Team will modify the official Qi4j Core repository.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_platform_team"></a>Platform Team</h4></div></div></div><p>The Platform team are the work horses of the project, and are adding a lot of value to our libraries and extensions.
These two repositories are where the bulk of the valuable code will eventually reside. The Platform Team consists of
people who are showing dedication to the project.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_community"></a>Community</h4></div></div></div><p>All remaining areas are open to anyone who ask (politely). Send GitHub ID to qi4j-dev forum at Google Groups together
with an introduction of yourself.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_additionally"></a>Additionally</h4></div></div></div><p>GitHub’s community features should not be understated. You are encouraged to clone our repostories, work on your own
features and do pull requests for Core and Platform teams to pick up. It is wise to send a message to
qi4j-dev forum at Google Groups before issuing a pull request along with an explanation of what the patch is for and
the rationale behind it.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="playing-field"></a>11.6. Playing Field</h3></div></div></div><p>Qi4J is a collaborative effort of open development, and we need to have some rules in place to make that work. Below is
an evolving list of rules and guidelines that we try to follow.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_coding_standard"></a>Coding Standard</h4></div></div></div><p>The coding standard at Qi4j promotes whitespace to aid in reading the code. Opening braces are placed on new lines,
spaces are between operators and so forth. We are following the OPS4J coding standards, as they have IDEA, Eclipse and
Checkstyle templates prepared or in the works. These are slowly evolving, and it is likely we will evolve with them.
The coding standards can be found in <a class="ulink" href="https://scm.ops4j.org/repos/ops4j/projects/community/resources/" target="_top">https://scm.ops4j.org/repos/ops4j/projects/community/resources/</a></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_design_and_implementation_work"></a>Design and Implementation work</h4></div></div></div><p>We want all discussions around the design and implementation to happen on the Google Group qi4j-dev.
But we also recognize that instant messaging, voice and face-2-face are important tools to
increase productivity. The participants are expected to convey in a comprehensible format (not just a copy/paste of
the IM log) any new development, ideas and progress that occur during those sessions. The decisions for any multiple
choices should be made on the qi4j-dev forum at Google Groups only.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_committers"></a>Committers</h4></div></div></div><p>The term "committer" is often used in open development efforts, and in Qi4j it refers to the individuals who has commit
rights to a particular part of the codebase. Some areas in Qi4j codebase are open to everyone, others are based on
meritocracy where individuals who has been contributing to the subproject are invited by the existing committers.
People who has not contributed to a subproject over the last 12 months are no longer considered committers, although
the commit rights will not be revoked. Note that "rights" in this context is a social contract, as no ACL is in place
to stop a Community member to mess up the Qi4j Core. It is mostly a matter of loss of reputation at stake, since
it is easy to revert these and if found to be malicious the member will have all commit rights revoked.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_votes_on_releases"></a>Votes on releases</h4></div></div></div><p>All committers agree that all releases should be voted upon before the release is made. Releases should happen early
and often, to shorten the feedback loop. All committers of the subproject being released has a binding vote. Everyone
else has a vote of recommendation. Releases can be vetoed for two reasons; Incompatibility and Legal.
Incompatibility is not a reason within the 0.x series and not a reason between major versions, such as 1.3 → 2.0.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_reverts_of_commits"></a>Reverts of commits</h4></div></div></div><p>There are cases when we need to revert commits made by people. Common sense should rule, but the above cases of
incompatibility and legal reasons are two obvious examples. Sabotage, misunderstandings and mistakes are others.
When such cause arises, the issue should be brought to the qi4j-dev forum at Google Groups, explained why the commit
should be reverted, and if noone objects within 48 hours, the commit can be reverted. If the concern results in a
debate, then the issue is resolved in a simple majority vote among the committers.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_infrastructure_issues"></a>Infrastructure issues</h4></div></div></div><p>Any infrastructure requests or problems, should be directed to qi4j-dev forum at Google Groups.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_trademarks_patents_and_licenses"></a>Trademarks, Patents and Licenses</h4></div></div></div><p>Qi4J is licensed under the Apache License version 2.0. All committers agree that all their contributions are licensed
under this license to Qi4j, other committers and the general public. The Copyright of each contribution is held by the
contributor, and no Copyright assigns are required.</p><p>All committers assert that no patents are hidden within their contributions or that if such patent exists then such
patent is freely licensed to Qi4j, other committers and the general public.</p><p>All contributors agree that the Qi4j project may change to a later version of the Apache License, if/when such license
becomes available and the Core Dev Team at that time finds it appropriate.</p><p>"Qi4j" is a trademark of the Qi4j Community, Niclas Hedhman, Rickard Öberg, and all copyright owners of the Qi4j
codebase. If Qi4j is registered as a trademark, then that person/entity agrees that such registration is to the benefit
of the Qi4j Community and all copyright owners of the Qi4j codebase, and only acts as an agent on their behalf. Failure
to do so, the registrant looses the right to participate in the Qi4j effort, and potentially face legal actions.</p><p>Qi4j is a community effort and is currently no organization. This may change into a non-profit, membership organization
at some later point in time.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="community-contributing"></a>11.7. Contributing to Qi4j</h3></div></div></div><p>The Qi4j community is an open source community centered around software and components for Composite Oriented
Programming on Java/Scala, and related design methodologies that are enhanced by using Qi4j, like Domain Driven
Design, DCI (Data, Context, Interaction) and HATEOAS REST.</p><p>The Qi4j community is an open community, in so far as it welcomes any member that accepts the basic criteria of
contribution and adheres to the community’s Code of Conduct.</p><p>Note that you can contribute to Qi4j also by contributing documentation or giving feedback on the current documentation.
Basically, at all the places where you can get help, there’s also room for contributions.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="google-groups"></a>Google Groups qi4j-dev forum</h4></div></div></div><p>To discuss with the Qi4j community, it is easiest to do so at the Google Groups
<a class="ulink" href="https://groups.google.com/forum/?fromgroups#!forum/qi4j-dev" target="_top">qi4j-dev forum</a>. This forum is open
to everyone and regular open source forum etiquette applies. Failure to be respectful may cause the poster to be
expelled. The forum is a light and friendly one, where we are all friends working on a marvelous way of writing Java
code.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="issue-tracker"></a>11.8. Issue Tracker</h3></div></div></div><p>Report a <span class="emphasis"><em>bug</em></span> or add a <span class="emphasis"><em>feature request</em></span>:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://team.ops4j.org/browse/QI" target="_top">http://team.ops4j.org/browse/QI</a>
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="build-system"></a>11.9. Build System</h3></div></div></div><p>Qi4j community migrated away from Maven after several years of frustration, especially around release management,
versioning and cross-module dependency resolution issues, in Feb 2011. The tool of choice is now Gradle, and it
doesn’t require any installation, there are gradlew and gradlew.bat in the root folder of the Qi4j SDK that will
bootstrap Gradle if not done so already.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_versions"></a>Versions</h4></div></div></div><p>By default, the build system produces a "zero build". It means that there is no version assigned to the build, and
a "0" is used in the produced artifacts. This is due to our disagreement (with Maven community) that the "next" version
name/number is known prior to the release. This is in our opinion a delayed decision. To build a particular version,
you specify a "version" property on the command-line, like</p><pre class="programlisting brush: bash">./gradlew -Dversion=2.0-FLAVOUR install</pre><p>If a "version" property is not defined, the build system will refuse to make a release and upload.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_tasks"></a>Tasks</h4></div></div></div><p>Gradle is very flexible, and we have defined (or in the process of defining) the following tasks (same as Ant’s targets).</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_clean"></a>clean</h5></div></div></div><p>Clean up of all build output and restoring the code base to a fresh state.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_check"></a>check</h5></div></div></div><p>This is the default build, which compiles the code and run the tests, but nothing else. A quick way to check that
nothing broke.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_install"></a>install</h5></div></div></div><p>Is roughly the same as Maven’s install goal. It produces the test reports and javadocs and installs all the Jars into
the local disk repository, for consumption by other applications.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_buildall"></a>buildAll</h5></div></div></div><p>Produces all the archives, javadocs, manuals and website content. The output is generated to qi4j-sdk/build.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_release"></a>release</h5></div></div></div><p>Uploads the release artifacts to the distribution servers and creates the release output into the
qi4j-sdk/build/distributions directory.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_configuration_19"></a>Configuration</h4></div></div></div><p>Build System configuration is done through Gradle properties.</p><p>This can be done in many ways, see
<a class="ulink" href="http://gradle.org/docs/current/userguide/tutorial_this_and_that.html#sec:gradle_properties_and_system_properties" target="_top">Gradle properties and system properties</a>.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_signing"></a>Signing</h5></div></div></div><p>Artifact signing is done using PGP. You need to provide Gradle the following properties</p><pre class="literallayout">signing.keyId=FB751943
signing.password=foobar
signing.secretKeyRingFile=/home/foo/.gnupg/secring.gpg</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_artifact_upload"></a>Artifact Upload</h5></div></div></div><p>Artifact upload behavior depends on the version assigned to the build.</p><p>By default RELEASES are signed, SNAPSHOTS are not.
Signing can be turned on or off by setting the <code class="literal">uploadSigned</code> property to false.</p><p>By default RELEASES must satisfy ReleaseSpecification, SNAPSHOT don’t.
ReleaseSpecification usage can be turned on or off by setting the <code class="literal">uploadReleaseSpec</code> property to false.</p><p>By default RELEASES and SNAPHOTS are uploaded using WEBDAV.
Used Wagon can be overriden by setting the <code class="literal">uploadWagon</code> property.</p><p>By default RELEASES and SNAPSHOTS are uploaded to Cloudbees.
Target repository can be overriden by setting the <code class="literal">uploadRepository</code> property.</p><p>No username/password is provided by default.
If needed set them using the <code class="literal">uploadUsername</code> and <code class="literal">uploadPassword</code> properties.</p><p>For example here is how to deploy all artifacts as unsigned SNAPSHOTs to a given repository:</p><pre class="programlisting brush: bash">./gradlew uploadArchives -Dversion=2.0-SNAPSHOT -PuploadReleaseSpec=false \
    -PuploadWagon=what:ever:wagon -PuploadRepository=http://what.ever.repository/url \
    -PuploadUsername=foo -PuploadPassword=bar</pre><p>And here is how to deploy a signed release to the local filesystem:</p><pre class="programlisting brush: bash">./gradlew uploadArchives -Dversion=2.0 -PuploadRepository=file:///path/to/local/repository</pre><p>See the <a class="ulink" href="http://www.gradle.org/docs/current/userguide/maven_plugin.html#wagonLibs" target="_top">Gradle documentation</a> about
supported protocols.</p></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="continuous-integration"></a>11.10. Continuous Integration</h3></div></div></div><p>Qi4j community uses CloudBees Jenkins service to automate the Qi4j SDK build.</p><p>The dedicated Jenkins instance can be found at <a class="ulink" href="https://qi4j.ci.cloudbees.com/" target="_top">https://qi4j.ci.cloudbees.com/</a>.</p><p>Tests jobs allow developers to detect and fix integration problems, broken/incompatible code, conflicting changes
continuously.</p><p>Upload jobs deploy SNAPSHOT artifacts for easy dependency on development builds:
<a class="ulink" href="https://repository-qi4j.forge.cloudbees.com/snapshot/" target="_top">https://repository-qi4j.forge.cloudbees.com/snapshot/</a></p><p>Distributions jobs make it easy to get the latest deliverables.</p><p><span class="inlinemediaobject"><img src="images/cloudbees.png" alt="cloudbees.png" /></span></p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="contributors"></a>11.11. People behind Qi4j</h3></div></div></div><p>Qi4j was started by Niclas Hedhman and Rickard Öberg, a.k.a "The Founders".</p><p>There are many types of contributors to open source projects, this one included, and we urge you to take a look at
<a class="ulink" href="http://www.oss-watch.ac.uk/resources/rolesinopensource.xml" target="_top">http://www.oss-watch.ac.uk/resources/rolesinopensource.xml</a> to see how you can contribute, even if you don’t have the
expertise or time required for the source code evolution.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_core_dev_team_2"></a>Core Dev Team</h4></div></div></div><p>The Core Dev Team are the people who has shown significant commitment towards the project and act as the guardians of
the project. The following people are currently in the Core Dev Team.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Kent Sølvsten
</li><li class="listitem">
Marc Grue
</li><li class="listitem">
Niclas Hedhman
</li><li class="listitem">
Paul Merlin
</li><li class="listitem">
Phillipe van Dyck
</li><li class="listitem">
Rickard Öberg
</li><li class="listitem">
Stanislav Muhametsin
</li><li class="listitem">
Tibor Mlynarik
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_contributors"></a>Contributors</h4></div></div></div><p>People who has contributed over the years (and remembered to add themselves) can be seen below. For a more accurate
list, please use GitHub’s commit tracking tool chain. These people are largely inactive now.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Alex Shneyderman
</li><li class="listitem">
Alin Dreghiciu
</li><li class="listitem">
Arvid Huss
</li><li class="listitem">
Chris Chapman
</li><li class="listitem">
David Leangen
</li><li class="listitem">
Edward Yakop
</li><li class="listitem">
Georg Ragaller
</li><li class="listitem">
Jan Kronquist
</li><li class="listitem">
Johan Svensson
</li><li class="listitem">
Lan Boon Ping
</li><li class="listitem">
Michael Hunger
</li><li class="listitem">
Muhd Kamil bin Mohd Baki
</li><li class="listitem">
Nino Saturnino Martinez Vazquez Wael
</li><li class="listitem">
Peter Neubauer
</li><li class="listitem">
Richard Wallace
</li><li class="listitem">
Sianny Halim
</li><li class="listitem">
Sonny Gill
</li><li class="listitem">
Tao Wen
</li><li class="listitem">
Tobias Ivarsson
</li><li class="listitem">
Tonny Kohar
</li></ul></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="licensing"></a>11.12. Licensing</h3></div></div></div><p>All original source code in Qi4j is licensed under the Apache License version 2.0 (see below).</p><p>The codebase may contain source code that were licensed under BSD and MIT licenses by its creator. These licenses are
said to be compatible at source code level with the Apache License 2.0.</p><p>All binary artifacts produced at Qi4j are potentially licensed under many licenses. See NOTICE and LICENSE files in
the distributions.</p><p>No source code nor artifacts produced by the Qi4j community contains any viral licenses, such as GPL, LGPL and others.
However, Qi4j extensions and libraries MAY depend on other libraries, including LGPL and GPL. Each extension and
library is REQUIRED to clearly indicate this in the NOTICE file located in the sub-project root directory, in the
root of the released file AND in the dev-status.xml which will be rendered on the Qi4j website for each
library/extension.</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_trademarks"></a>Trademarks</h4></div></div></div><p>Qi4j and the Qi4j logos are trademarks of Rickard Öberg, Niclas Hedhman and all members of the Qi4j Core Team.
The trademark owners hereby grant users a "fair use" license to use these trademarks to mark products and services
related to the Qi4j project, provided that;
  a. the Qi4j project is notified of its use in advance,
  b. the Qi4j project is not misrepresented,
  c. the products and services allow to be listed as references on the Qi4j website.</p><p>No license is provided to Qi4j and the Qi4j logo for products and services unrelated or only marginally related to
the Qi4j project. Read the Licensing FAQ and/or contact the Qi4j community for details.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_apache_license_2_0"></a>Apache License 2.0</h4></div></div></div><p>Version 2.0, January 2004
<a class="ulink" href="http://www.apache.org/licenses/" target="_top">http://www.apache.org/licenses/</a></p><p>TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Definitions.
</li></ol></div><p>"License" shall mean the terms and conditions for use, reproduction, and
distribution as defined by Sections 1 through 9 of this document.</p><p>"Licensor" shall mean the copyright owner or entity authorized by the copyright
owner that is granting the License.</p><p>"Legal Entity" shall mean the union of the acting entity and all other entities
that control, are controlled by, or are under common control with that entity.
For the purposes of this definition, "control" means (i) the power, direct or
indirect, to cause the direction or management of such entity, whether by
contract or otherwise, or (ii) ownership of fifty percent (50%) or more of the
outstanding shares, or (iii) beneficial ownership of such entity.</p><p>"You" (or "Your") shall mean an individual or Legal Entity exercising
permissions granted by this License.</p><p>"Source" form shall mean the preferred form for making modifications, including
but not limited to software source code, documentation source, and
configuration files.</p><p>"Object" form shall mean any form resulting from mechanical transformation or
translation of a Source form, including but not limited to compiled object
code, generated documentation, and conversions to other media types.</p><p>"Work" shall mean the work of authorship, whether in Source or Object form,
made available under the License, as indicated by a copyright notice that is
included in or attached to the work (an example is provided in the Appendix
below).</p><p>"Derivative Works" shall mean any work, whether in Source or Object form, that
is based on (or derived from) the Work and for which the editorial revisions,
annotations, elaborations, or other modifications represent, as a whole, an
original work of authorship. For the purposes of this License, Derivative Works
shall not include works that remain separable from, or merely link (or bind by
name) to the interfaces of, the Work and Derivative Works thereof.</p><p>"Contribution" shall mean any work of authorship, including the original
version of the Work and any modifications or additions to that Work or
Derivative Works thereof, that is intentionally submitted to Licensor for
inclusion in the Work by the copyright owner or by an individual or Legal
Entity authorized to submit on behalf of the copyright owner. For the purposes
of this definition, "submitted" means any form of electronic, verbal, or
written communication sent to the Licensor or its representatives, including
but not limited to communication on electronic mailing lists, source code
control systems, and issue tracking systems that are managed by, or on behalf
of, the Licensor for the purpose of discussing and improving the Work, but
excluding communication that is conspicuously marked or otherwise designated in
writing by the copyright owner as "Not a Contribution."</p><p>"Contributor" shall mean Licensor and any individual or Legal Entity on behalf
of whom a Contribution has been received by Licensor and subsequently
incorporated within the Work.</p><p>`2. Grant of Copyright License. Subject to the terms and conditions of this
License, each Contributor hereby grants to You a perpetual, worldwide,
non-exclusive, no-charge, royalty-free, irrevocable copyright license to
reproduce, prepare Derivative Works of, publicly display, publicly perform,
sublicense, and distribute the Work and such Derivative Works in Source or
Object form.</p><p>`3. Grant of Patent License. Subject to the terms and conditions of this
License, each Contributor hereby grants to You a perpetual, worldwide,
non-exclusive, no-charge, royalty-free, irrevocable (except as stated in this
section) patent license to make, have made, use, offer to sell, sell, import,
and otherwise transfer the Work, where such license applies only to those
patent claims licensable by such Contributor that are necessarily infringed by
their Contribution(s) alone or by combination of their Contribution(s) with the
Work to which such Contribution(s) was submitted. If You institute patent
litigation against any entity (including a cross-claim or counterclaim in a
lawsuit) alleging that the Work or a Contribution incorporated within the Work
constitutes direct or contributory patent infringement, then any patent
licenses granted to You under this License for that Work shall terminate as of
the date such litigation is filed.</p><p>`4. Redistribution. You may reproduce and distribute copies of the Work or
Derivative Works thereof in any medium, with or without modifications, and in
Source or Object form, provided that You meet the following conditions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
You must give any other recipients of the Work or Derivative Works a copy
      of this License; and
</li><li class="listitem">
You must cause any modified files to carry prominent notices stating that
      You changed the files; and
</li><li class="listitem">
You must retain, in the Source form of any Derivative Works that You
      distribute, all copyright, patent, trademark, and attribution notices
      from the Source form of the Work, excluding those notices that do not
      pertain to any part of the Derivative Works; and
</li><li class="listitem">
If the Work includes a "NOTICE" text file as part of its distribution,
      then any Derivative Works that You distribute must include a readable
      copy of the attribution notices contained within such NOTICE file,
      excluding those notices that do not pertain to any part of the Derivative
      Works, in at least one of the following places: within a NOTICE text file
      distributed as part of the Derivative Works; within the Source form or
      documentation, if provided along with the Derivative Works; or, within a
      display generated by the Derivative Works, if and wherever such
      third-party notices normally appear. The contents of the NOTICE file are
      for informational purposes only and do not modify the License. You may
      add Your own attribution notices within Derivative Works that You
      distribute, alongside or as an addendum to the NOTICE text from the Work,
      provided that such additional attribution notices cannot be construed as
      modifying the License.
</li></ol></div><p>You may add Your own copyright statement to Your modifications and may provide
additional or different license terms and conditions for use, reproduction, or
distribution of Your modifications, or for any such Derivative Works as a
whole, provided Your use, reproduction, and distribution of the Work otherwise
complies with the conditions stated in this License.</p><p>`5. Submission of Contributions. Unless You explicitly state otherwise, any
Contribution intentionally submitted for inclusion in the Work by You to the
Licensor shall be under the terms and conditions of this License, without any
additional terms or conditions. Notwithstanding the above, nothing herein shall
supersede or modify the terms of any separate license agreement you may have
executed with Licensor regarding such Contributions.</p><p>`6. Trademarks. This License does not grant permission to use the trade names,
trademarks, service marks, or product names of the Licensor, except as required
for reasonable and customary use in describing the origin of the Work and
reproducing the content of the NOTICE file.</p><p>`7. Disclaimer of Warranty. Unless required by applicable law or agreed to in
writing, Licensor provides the Work (and each Contributor provides its
Contributions) on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied, including, without limitation, any warranties
or conditions of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
PARTICULAR PURPOSE. You are solely responsible for determining the
appropriateness of using or redistributing the Work and assume any risks
associated with Your exercise of permissions under this License.</p><p>`8. Limitation of Liability. In no event and under no legal theory, whether in
tort (including negligence), contract, or otherwise, unless required by
applicable law (such as deliberate and grossly negligent acts) or agreed to in
writing, shall any Contributor be liable to You for damages, including any
direct, indirect, special, incidental, or consequential damages of any
character arising as a result of this License or out of the use or inability to
use the Work (including but not limited to damages for loss of goodwill, work
stoppage, computer failure or malfunction, or any and all other commercial
damages or losses), even if such Contributor has been advised of the
possibility of such damages.</p><p>`9. Accepting Warranty or Additional Liability. While redistributing the Work or
Derivative Works thereof, You may choose to offer, and charge a fee for,
acceptance of support, warranty, indemnity, or other liability obligations
and/or rights consistent with this License. However, in accepting such
obligations, You may act only on Your own behalf and on Your sole
responsibility, not on behalf of any other Contributor, and only if You agree
to indemnify, defend, and hold each Contributor harmless for any liability
incurred by, or claims asserted against, such Contributor by reason of your
accepting any such warranty or additional liability.</p><p>END OF TERMS AND CONDITIONS</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="licensing-faq"></a>11.13. Licensing FAQ</h3></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_combined_amp_derived_work"></a>Combined &amp; Derived Work</h4></div></div></div><p><span class="strong"><strong>Q</strong></span>: Can I use Qi4j Core in my commercial applications under a closed-source, proprietary license?</p><p><span class="strong"><strong>A</strong></span>: Yes. The Apache License is very business-friendly. Please observe the obligations on your part, especially
regarding notices, trademarks and patent licensing terms.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_trademarks_2"></a>Trademarks</h4></div></div></div><p><span class="strong"><strong>Q</strong></span>: My company has invested a lot of time to learn and understand the Qi4j platform, and we think we are really good
at writing Qi4j applications and would like to start training others. Can we advertise that we are "Qi4j experts" or
that we conduct "Advanced Qi4j training"?</p><p><span class="strong"><strong>A</strong></span>: Yes, the "fair use" license to the Qi4j trademarks allows third-party to use the Qi4j marks in such manner. If in
doubt, contact the Qi4j Community.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h3 class="title"><a id="community-docs"></a>11.14. Writing Qi4j Documentation</h3></div></div></div><p>The documents use the asciidoc format, see:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.methods.co.nz/asciidoc/" target="_top">Aciidoc Reference</a>
</li><li class="listitem">
<a class="ulink" href="http://powerman.name/doc/asciidoc" target="_top">AsciiDoc cheatsheet</a>
</li></ul></div><p>The cheatsheet is really useful!</p><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="community-docs-overall-flow"></a>Overall Flow</h4></div></div></div><p>Each (sub)project has its own documentation, in <span class="emphasis"><em>src/docs/</em></span> and all the Asciidoc documents have the <code class="literal">.txt</code> file extension.</p><p>The documents can use code snippets which will extract code from the project. This is preferred way to include
source code in the documentation, since any refactoring will be reflected in the documentation.</p><p>The above files are all consumed by the build of the manual (by adding them as dependencies).
To get content included in the manual, it has to be explicitly included by a document in the manual as well.</p><p>The whole documentation set is generated from the <span class="emphasis"><em>*manual*</em></span> module in the <code class="literal">qi4j-sdk</code>, and we are currently only creating the website.
The User Guide and Reference Manual are future projects.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_headings_and_document_structure"></a>Headings and document structure</h4></div></div></div><p>Each document starts over with headings from level zero (the document title).
Each document should have an id.
In some cases sections in the document need to have id’s as well, this depends on where they fit in the overall structure.
To be able to link to content, it has to have an id.
Missing id’s in mandatory places will produce warnings, or even fail (depending on severity), the build.</p><p>This is how a document should start:</p><pre class="programlisting brush: plain">[[unique-id-verbose-is-ok,Remember This Caption]]
= The Document Title =</pre><p>To push the headings down to the right level in the output, the <code class="literal">leveloffset</code>
attribute is used when including the document inside of another document.</p><p>Subsequent headings in a document should use the following syntax:</p><pre class="programlisting brush: plain">== Subheading ==

... content here ...

=== Subsubheading ===

content here ...</pre><p>Asciidoc comes with one more syntax for headings, but in this project it’s not used.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_writing"></a>Writing</h4></div></div></div><p>Try to put one sentence on each line.
Lines without empty lines between them still belongs to the same paragraph.
This makes it easy to move content around, and also easy to spot (too) long sentences.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_gotchas"></a>Gotchas</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
A chapter can’t be empty. (the build will fail on the docbook xml validity check)
</li><li class="listitem">
The document title should be "underlined" by the same
  number of <code class="literal">=</code> as there are characters in the title.
</li><li class="listitem">
Always leave a blank line at the end of documents
  (or the title of the next document might end up in the last
  paragraph of the document)
</li><li class="listitem">
As <code class="literal">{}</code> are used for Asciidoc attributes, everything inside will be treated as an attribute.
  What you have to do is to escape the opening brace: <code class="literal">\{</code>.
  If you don’t, the braces and the text inside them will be removed without any warning being issued!
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_links"></a>Links</h4></div></div></div><p>To link to other parts of the manual the id of the target is used.
This is how such a reference looks:</p><pre class="programlisting brush: plain">&lt;&lt;community-docs-overall-flow&gt;&gt;</pre><p>Which will render like: <a class="xref" href="#community-docs-overall-flow" title="Overall Flow">Documentation Flow</a></p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Just write "see &lt;&lt;target-id&gt;&gt;" and similar, that’s enough in most cases.</p></td></tr></table></div><p>If you need to link to another document with your own link text, this is what to do:</p><pre class="programlisting brush: plain">&lt;&lt;target-id, link text that fits in the context&gt;&gt;</pre><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Having lots of linked text may work well in a web context but is a pain in print, and we aim for both!</p></td></tr></table></div><p>External links are added like this:</p><pre class="programlisting brush: plain">http://www.qi4j.org/[Link text here]</pre><p>Which renders like: <a class="ulink" href="http://www.qi4j.org/" target="_top">Link text here</a></p><p>For short links it may be better not to add a link text, just do:</p><pre class="programlisting brush: plain">http://www.qi4j.org/</pre><p>Which renders like: <a class="ulink" href="http://www.qi4j.org/" target="_top">http://www.qi4j.org/</a></p><p>It’s ok to have a dot right after the URL, it won’t be part of the link.</p><pre class="programlisting brush: plain">http://www.qi4j.org/.</pre><p>Which renders like: <a class="ulink" href="http://www.qi4j.org/" target="_top">http://www.qi4j.org/</a>.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_text_formatting"></a>Text Formatting</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<span class="strong"><strong>Bold</strong></span> - just don’t do it, the editor in charge is likely to remove it anyhow!
</li><li class="listitem">
_Italics_ is rendered as <span class="emphasis"><em>Italics</em></span>
</li><li class="listitem">
+methodName()+ is rendered as <code class="literal">methodName()</code> and is used for literals as well
</li><li class="listitem">
`command` is rendered as <code class="literal">command</code> (typically used for command-line)
</li><li class="listitem">
'my/path/' is rendered as <span class="emphasis"><em>my/path/</em></span> (used for file names and paths)
</li></ul></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_admonitions"></a>Admonitions</h4></div></div></div><p>These are very useful and should be used where appropriate.
Choose from the following (write all caps and no, we can’t easily add new ones):</p><div class="note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/admon/note.png" /></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>Note.</p></td></tr></table></div><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Tip.</p></td></tr></table></div><div class="important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png" /></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Important</p></td></tr></table></div><div class="caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/admon/caution.png" /></td><th align="left">Caution</th></tr><tr><td align="left" valign="top"><p>Caution</p></td></tr></table></div><div class="warning" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png" /></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Warning</p></td></tr></table></div><p>Here’s how it’s done:</p><pre class="programlisting brush: plain">NOTE: Note.</pre><p>A multiline variation:</p><pre class="programlisting brush: plain">[TIP]
Tiptext.
Line 2.</pre><p>Which is rendered as:</p><div class="tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/admon/tip.png" /></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Tiptext.
Line 2.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_images"></a>Images</h4></div></div></div><div class="important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/admon/important.png" /></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p><span class="emphasis"><em>All images in the entire manual share the same namespace.</em></span></p></td></tr></table></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_images_files"></a>Images Files</h5></div></div></div><p>To include an image file, make sure it resides in the <span class="emphasis"><em>images/</em></span> directory relative to the document you’re including it from.
Then go:</p><pre class="programlisting brush: plain">image::logo-standard.png[]</pre><p>Which is rendered as:</p><div class="informalfigure"><a class="ulink" href="images/logo-standard.png" target="_top">
<span class="inlinemediaobject"><img src="images/logo-standard.png" alt="logo-standard.png" /></span>
</a></div><p>Please note that the <span class="emphasis"><em>images/</em></span> directory is added automatically and not part of the link.</p><p>There are also global resources, residing in <span class="emphasis"><em>manual/src/resources</em></span>, which will be copied to the root of the documentation.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_code_snippets"></a>Code Snippets</h4></div></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_import_from_codebase"></a>Import from codebase</h5></div></div></div><p>Most source code that is included in the documentation should be extract via <code class="literal">SNIPPET</code> markers and then included in document with;</p><pre class="programlisting brush: plain"> [snippet,java]
 -----------
 source=tutorials/introduction/tenminutes/src/main/java/org/qi4j/demo/tenminute/OrderEntity.java
 tag=mainClass
 -----------</pre><p>The source file is relative to the <code class="literal">qi4j-sdk</code> root, and the <span class="emphasis"><em>tag</em></span> is defined in the source file.
The above could be bringing in content that looks like;</p><pre class="programlisting brush: plain">package org.qi4j.demo.tenminute;

import org.qi4j.api.concern.Concerns;
import org.qi4j.api.entity.EntityComposite;
import org.qi4j.api.sideeffect.SideEffects;

// START SNIPPET: sideEffect
@SideEffects( MailNotifySideEffect.class )
// START SNIPPET: mainClass
@Concerns({PurchaseLimitConcern.class, InventoryConcern.class})
public interface OrderEntity
    extends Order, HasSequenceNumber, HasCustomer,
            HasLineItems, Confirmable, EntityComposite
{
// END SNIPPET: sideEffect
}
// END SNIPPET: mainClass</pre><p>which will be rendered as;</p><pre class="programlisting brush: java">@Concerns( { PurchaseLimitConcern.class, InventoryConcern.class } )
public interface OrderEntity
    extends Order, Confirmable,
            HasSequenceNumber, HasCustomer, HasLineItems,
            EntityComposite
{
}
</pre><p>Note that
1. The START and END doesn’t need to be matching.
1. The AsciiDoc plugin will remove the <span class="emphasis"><em>START SNIPPET</em></span> and <span class="emphasis"><em>END SNIPPET</em></span> lines.
1. If you have more than one START/END section with the same tag, the plugin will insert a "[…snip…]" for the excluded lines.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_explicitly_defined_in_the_document"></a>Explicitly defined in the document</h5></div></div></div><div class="warning" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/icons/admon/warning.png" /></td><th align="left">Warning</th></tr><tr><td align="left" valign="top"><p>Use this kind of code snippets as little as possible.
  They are well known to get out of sync with reality after a while.</p></td></tr></table></div><p>This is how to do it:</p><pre class="programlisting brush: plain"> [source,java]
 ----
 HashMap&lt;String,String&gt; result = new HashMap&lt;String,String&gt;();
 for( String name : names )
 {
     if( !"".equals( name ) )
         result.put( name, value );
 }
 ----</pre><p>Which is rendered as:</p><pre class="programlisting brush: java"> HashMap&lt;String,String&gt; result = new HashMap&lt;String,String&gt;();
 for( String name : names )
 {
     if( !"".equals( name ) )
         result.put( name, value );
 }</pre></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h5 class="title"><a id="_source_code_highlighting"></a>Source code Highlighting</h5></div></div></div><p>If there’s no suitable syntax highlighter, just omit the language: <code class="literal">[source]</code>.</p><p>Currently the following syntax highlighters are enabled:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Bash
</li><li class="listitem">
Groovy
</li><li class="listitem">
Java
</li><li class="listitem">
JavaScript
</li><li class="listitem">
Python
</li><li class="listitem">
Ruby
</li><li class="listitem">
Scala
</li><li class="listitem">
XML
</li></ul></div><p>For other highlighters we could add see <a class="ulink" href="http://alexgorbatchev.com/SyntaxHighlighter/manual/brushes/" target="_top">http://alexgorbatchev.com/SyntaxHighlighter/manual/brushes/</a>.</p></div></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_attributes"></a>Attributes</h4></div></div></div><p>Common attributes you can use in documents:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
</li><li class="listitem">
</li></ul></div><p>These can substitute part of URLs that point to for example APIdocs or source code.</p></div><div class="section"><div class="titlepage"><div><p xmlns="" class="returntotop"><a href="#idp140267582218080">Return to top</a></p><div><h4 class="title"><a id="_toolchain"></a>Toolchain</h4></div></div></div><p>Useful links when configuring the docbook toolchain:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<a class="ulink" href="http://www.methods.co.nz/asciidoc" target="_top">http://www.methods.co.nz/asciidoc</a>
</li><li class="listitem">
<a class="ulink" href="http://powerman.name/doc/asciidoc" target="_top">http://powerman.name/doc/asciidoc</a>
</li><li class="listitem">
alexgorbatchev.com/SyntaxHighlighter/manual/brushes/
</li><li class="listitem">
<a class="ulink" href="http://www.docbook.org/tdg/en/html/docbook.html" target="_top">http://www.docbook.org/tdg/en/html/docbook.html</a>
</li><li class="listitem">
<a class="ulink" href="http://www.sagehill.net/docbookxsl/index.html" target="_top">http://www.sagehill.net/docbookxsl/index.html</a>
</li><li class="listitem">
<a class="ulink" href="http://docbook.sourceforge.net/release/xsl/1.76.1/doc/html/index.html" target="_top">http://docbook.sourceforge.net/release/xsl/1.76.1/doc/html/index.html</a>
</li><li class="listitem">
<a class="ulink" href="http://docbook.sourceforge.net/release/xsl/1.76.1/doc/fo/index.html" target="_top">http://docbook.sourceforge.net/release/xsl/1.76.1/doc/fo/index.html</a>
</li></ul></div></div></div></div></div>

 <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3118496-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
 </script>  

</body></html>
